/*!
 * 
 * 		SAP UI development toolkit for HTML5 (SAPUI5)
 * 		(c) Copyright 2009-2015 SAP SE. All rights reserved
 * 	
 */
jQuery.sap.declare("sap.suite.ui.commons.TimelineItem");jQuery.sap.require("sap.suite.ui.commons.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.suite.ui.commons.TimelineItem",{metadata:{publicMethods:["setCustomMessage"],library:"sap.suite.ui.commons",properties:{"dateTime":{type:"any",group:"Misc",defaultValue:null},"filterValue":{type:"string",group:"Misc",defaultValue:null},"icon":{type:"string",group:"Misc",defaultValue:null},"iconTooltip":{type:"string",group:"Misc",defaultValue:null},"maxCharacters":{type:"int",group:"Behavior",defaultValue:null},"replyCount":{type:"int",group:"Misc",defaultValue:null},"status":{type:"string",group:"Misc",defaultValue:null},"title":{type:"string",group:"Misc",defaultValue:null},"text":{type:"string",group:"Misc",defaultValue:null},"userName":{type:"string",group:"Misc",defaultValue:null},"userNameClickable":{type:"boolean",group:"Misc",defaultValue:false},"userPicture":{type:"sap.ui.core.URI",group:"Misc",defaultValue:null}},aggregations:{"customAction":{type:"sap.ui.core.CustomData",multiple:true,singularName:"customAction"},"customReply":{type:"sap.ui.core.Control",multiple:false},"embeddedControl":{type:"sap.ui.core.Control",multiple:false},"replyList":{type:"sap.m.List",multiple:false},"suggestionItems":{type:"sap.m.StandardListItem",multiple:true,singularName:"suggestionItem",deprecated:true}},events:{"userNameClicked":{parameters:{"uiElement":{type:"sap.ui.core.Control"}}},"replyPost":{parameters:{"value":{type:"string"}}},"replyListOpen":{},"customActionClicked":{parameters:{"value":{type:"string"},"key":{type:"string"},"linkObj":{type:"sap.m.Link"}}},"suggest":{deprecated:true,parameters:{"suggestValue":{type:"string"}}},"suggestionItemSelected":{deprecated:true,parameters:{"selectedItem":{type:"sap.ui.core.Item"}}}}}});sap.suite.ui.commons.TimelineItem.M_EVENTS={'userNameClicked':'userNameClicked','replyPost':'replyPost','replyListOpen':'replyListOpen','customActionClicked':'customActionClicked','suggest':'suggest','suggestionItemSelected':'suggestionItemSelected'};sap.ui.define(["sap/ui/core/Control","sap/m/Text","sap/m/Toolbar","sap/m/ToolbarDesign","sap/m/Link","sap/m/TextArea","sap/m/Popover","sap/m/PlacementType","sap/m/ToolbarSpacer","sap/m/Button","sap/m/List","sap/m/ListMode","sap/m/StandardListItem","sap/ui/Device","sap/suite/ui/commons/util/ManagedObjectRegister","sap/suite/ui/commons/util/DateUtils"],function(C,T,a,b,L,c,P,d,e,B,f,g,S,D,M,h){"use strict";var j=sap.suite.ui.commons.TimelineItem,r=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons"),k={"Warning":"sapSuiteUiCommonsTimelineStatusWarning","Error":"sapSuiteUiCommonsTimelineStatusError","Success":"sapSuiteUiCommonsTimelineStatusSuccess","Information":"sapSuiteUiCommonsTimelineStatusInformation"};j.prototype.init=function(){this._customReply=false;this._objects=new M();this._nMaxCharactersMobile=500;this._nMaxCharactersDesktop=800;this._sTextShowMore=r.getText("TIMELINE_TEXT_SHOW_MORE");this._registerControls();this._registerPopup();this._orientation="V";};j.prototype.setCustomMessage=function(m){this._objects.getInfoText().setText(m);this._objects.getInfoBar().setVisible(m&&m.length>0);this.invalidate();};j.prototype.applyFocusInfo=function(){this.focus();this.getParent()._moveScrollBar(true);};j.prototype.getFocusDomRef=function(){return this.$("outline")[0];};j.prototype._replyPost=function(){var i=this._objects.getReplyInputArea().getValue();this.fireReplyPost({value:i});};j.prototype._registerPopup=function(){var t=this;this._objects.register("fullText",function(){var o=new T(t.getId()+"-fullText",{text:t.getText()});o.addStyleClass("sapSuiteUiCommonsTimelineItemPopoverText");return o;});this._objects.register("fullTextCloseIcon",function(){var i=new sap.ui.core.Icon({src:"sap-icon://decline",press:function(){t._objects.getFullTextPopover().close();}});i.addStyleClass("sapSuiteUiCommonsTimelineItemPopoverCloseIcon");return i;});this._objects.register("fullTextPopover",function(){var p=new P({placement:d.Bottom,showArrow:false,showHeader:true,contentMinWidth:'300px',contentWidth:'450px',endButton:t._objects.getFullTextCloseIcon(),resizable:true,title:r.getText("TIMELINE_FULLTEXT_TITLE"),content:[t._objects.getFullText()]});p.addStyleClass("sapSuiteUiCommonsTimelineItemShowMorePopover");return p;});};j.prototype._openReplyDialog=function(){if(this._customReply){this.getCustomReply().openBy(this._objects.getReplyLink());this.fireReplyListOpen();}else{this.fireReplyListOpen();this._objects.getReplyInputArea().setValue('');this._oldReplyInputArea='';this._list=this.getReplyList();if(this._list!==null){this.setAggregation("replyList",null,true);this._objects.getReplyPop().addContent(this._list);}this._objects.getReplyPop().addContent(this._objects.getReplyInputArea());this._objects.getReplyPop().openBy(this._objects.getReplyLink());}};j.prototype._callParentFn=function(){var i=Array.prototype.slice.call(arguments),n=i.shift(),p=this.getParent();if(p&&(typeof p[n]==="function")){return p[n].apply(p,i);}};j.prototype._getCorrectGroupIcon=function(){var i="",I=function(){return this.getParent()&&this.getParent()._renderDblSided;}.bind(this),l=this._isGroupCollapsed();if(this._orientation==="H"){i="navigation-right-arrow";if(!l){i=this._callParentFn("_isLeftAlignment")||I()?"navigation-down-arrow":"navigation-up-arrow";}}else{i="navigation-down-arrow";if(l){i=this._callParentFn("_isLeftAlignment")||I()?"navigation-right-arrow":"navigation-left-arrow";}}return i;};j.prototype.onclick=function(E){var t=this,i,$,l,I;if(jQuery.sap.containsOrEquals(this.$("outline").get(0),E.target)){if(this._isGroupHeader){i=t._objects.getGroupCollapseIcon&&t._objects.getGroupCollapseIcon();$=t.$();l=i.$();I=t._isGroupCollapsed();if(I){$.removeClass("sapSuiteUiCommonsTimelineGroupCollapsed");$.addClass("sapSuiteUiCommonsTimelineGroupExpanded");}else{$.addClass("sapSuiteUiCommonsTimelineGroupCollapsed");$.removeClass("sapSuiteUiCommonsTimelineGroupExpanded");}t._performExpandCollapse(t._groupID);i.setSrc(t._getCorrectGroupIcon());}}};j.prototype._performExpandCollapse=function(G){var s=function(q,t){var u=q.find(".sapSuiteUiCommonsTimelineItemBarV"),v,w;if(t.get(0)){v=t.attr("groupId");w=!this._isGroupCollapsed(v);if(w){u.addClass("sapSuiteUiCommonsTimelineGroupNextExpanded");}else{u.removeClass("sapSuiteUiCommonsTimelineGroupNextExpanded");}}}.bind(this),i=function(){if(this.getParent()){this.getParent()._collapsedGroups[G]=!I;};}.bind(this),$=this.$(),I=this._isGroupCollapsed(G),l=$.parent(),m,n,o,p;i();if(this._orientation==="H"){m=this.$("line");}else{m=$.find(".sapSuiteUiCommonsTimelineGroupHeaderBarWrapper");n=l.next().children().first();o=l.prev().children(":visible:last");if(o.get(0)){s(o,$);}if(I){p=l.children().last();s(p,n);}else{s($,n);}}I?m.hide():m.show();this._callParentFn("_performExpandCollapse",G,I);};j.prototype._getStatusColorClass=function(){var s=this.getStatus();return k[s]||"";};j.prototype._getLineIcon=function(){var t=this,i;this._objects.register("imageControl",function(){var s="sap-icon://circle-task-2",l=t.getText()==="GroupHeader";if(!l){s=t.getIcon()?t.getIcon():"activity-items";}i=new sap.ui.core.Icon(t.getId()+'-icon',{src:s,tooltip:t.getIconTooltip()});i.addStyleClass("sapSuiteUiCommonsTimelineBarIcon");return i;});return this._objects.getImageControl();};j.prototype._isGroupCollapsed=function(i){var p=this.getParent();i=i||this._groupID;return p&&p._collapsedGroups&&p._collapsedGroups[i];};j.prototype._getCollapsedText=function(){var s=this.getText().substring(0,this._nMaxCollapsedLength);var n=s.lastIndexOf(" ");if(n>0){this._sShortText=s.substr(0,n);}else{this._sShortText=s;}return this._sShortText;};j.prototype._toggleTextExpanded=function(s){var $=s.oSource.$(),i=jQuery("#"+this.getId()+"-realtext"),l=$.height(),t=$.position().top,m=i.parent().position().top,O=10;this._objects.getFullText().setText(this.getText());var n=m-t-l-O,w=jQuery(window).height()-$.offset().top,o=200;if(w<o){n-=(o-w);};this._objects.getFullTextPopover().setOffsetY(Math.floor(n));this._objects.getFullTextPopover().openBy(this._objects.getExpandButton());};j.prototype._getButtonExpandCollapse=function(){var t=this;this._objects.register("expandButton",function(){return new B(t.getId()+"-fullTextBtn",{text:t._sTextShowMore,press:t._toggleTextExpanded.bind(t)});});return this._objects.getExpandButton();};j.prototype._checkTextIsExpandable=function(){this._nMaxCollapsedLength=this.getMaxCharacters();if(this._nMaxCollapsedLength===0){this._nMaxCollapsedLength=D.system.phone?this._nMaxCharactersMobile:this._nMaxCharactersDesktop;}return this.getText().length>this._nMaxCollapsedLength;};j.prototype.onBeforeRendering=function(){var t=this;if(!this._list){this._list=this.getReplyList();}if(this.getReplyCount()>0){this._objects.getReplyLink().setText(r.getText("TIMELINE_REPLY")+" ("+this.getReplyCount()+")");}else if(this._list&&this._list.getItems().length>0){this._objects.getReplyLink().setText(r.getText("TIMELINE_REPLY")+" ("+this._list.getItems().length+")");}this._objects.getSocialBar().removeAllContent();if(this._callParentFn("getEnableSocial")){this._objects.getSocialBar().addContent(this._objects.getReplyLink());}this._actionList=this.getCustomAction();for(var i=0;i<this._actionList.length;i++){var l=this._actionList[i].getKey();var v=this._actionList[i].getValue();var m=new L({text:v,tooltip:l});m.addStyleClass("sapSuiteUiCommonsTimelineItemActionLink");m.attachPress({"value":v,"key":l},function(E,o){t.fireCustomActionClicked({"value":o.value,"key":o.key,"linkObj":this});});this._objects.getSocialBar().addContent(m);}};j.prototype._getUserPictureControl=function(){var u=this.getUserPicture(),s="2rem",t=this;if(!u){return null;}this._objects.register("userPictureControl",function(){var i=sap.m.ImageHelper.getImageControl(t.getId()+"-userPictureControl",null,t,{height:s,width:s,src:u,tooltip:r.getText("TIMELINE_USER_PICTURE")});i.setDensityAware(false);return i;});this._objects.getUserPictureControl().setSrc(u);return this._objects.getUserPictureControl();};j.prototype._getUserNameLinkControl=function(){var t=this;if(this.getUserNameClickable()){this._objects.register("userNameLink",function(){var l=new L(t.getId()+"-userNameLink",{text:t.getUserName(),tooltip:t.getUserName(),press:function(E){t.fireUserNameClicked({uiElement:this});}});l.addStyleClass("sapUiSelectable");return l;});this._objects.getUserNameLink().setText(this.getUserName());this._objects.getUserNameLink().setTooltip(this.getUserName());return this._objects.getUserNameLink();}};j.prototype._registerControls=function(){var t=this;this._objects.register("infoText",new T(this.getId()+"-infoText",{maxLines:1,width:"100%"}));this._objects.register("infoBar",new a(this.getId()+"-infoBar",{id:this.getId()+"-customMessageInfoBar",content:[this._objects.getInfoText()],design:b.Info,visible:false}));this._objects.register("replyLink",function(){var l=new L(t.getId()+"-replyLink",{text:r.getText("TIMELINE_REPLY"),press:[t._openReplyDialog,t]});l.addStyleClass("sapSuiteUiCommonsTimelineItemActionLink");return l;});this._objects.register("socialBar",function(){var s=new a(t.getId()+"-socialBar",{});s.data("sap-ui-fastnavgroup",null);return s;});this._objects.register("replyInputArea",new c(this.getId()+"-replyInputArea",{height:"4rem",width:"100%"}));this._objects.register("replyPop",function(){return new P(t.getId()+"-replyPop",{initialFocus:t._objects.getReplyInputArea(),title:r.getText("TIMELINE_REPLIES"),placement:d.Vertical,footer:new a({content:[new e(),new B(t.getId()+"-replyButton",{text:r.getText("TIMELINE_REPLY"),press:function(){t._replyPost();t._objects.getReplyPop().close();}})]}),contentHeight:"15rem",contentWidth:"20rem"})});};j.prototype.exit=function(){this._objects.destroyAll();};j.prototype.getDateTimeWithoutStringParse=function(){var o=this.getProperty("dateTime");return h.parseDate(o,false);};j.prototype.setCustomReply=function(R){if(R){this._customReply=true;this.setAggregation("customReply",R,true);}else{this._customReply=false;}};j.prototype.setReplyList=function(i){if(i===null)return;this.setAggregation("replyList",i,true);var t=this;this.getReplyList().attachUpdateFinished(function(E){var F=t._objects.getReplyInputArea().getDomRef("inner");if(F){jQuery(F.id).focus();}});};j.prototype.getDateTime=function(){var o=this.getProperty("dateTime");return h.parseDate(o);};return j;});
