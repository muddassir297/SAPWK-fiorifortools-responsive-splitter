/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','./library','sap/ui/core/Control','sap/ui/Device'],function(q,l,C,D){"use strict";var I=C.extend("sap.suite.ui.microchart.InteractiveBarChart",{metadata:{library:"sap.suite.ui.microchart",properties:{displayedBars:{type:"int",group:"Appearance",defaultValue:3},labelWidth:{type:"sap.ui.core.Percentage",group:"Appearance",defaultValue:"40%"},selectionEnabled:{type:"boolean",group:"Behavior",defaultValue:true},min:{type:"float",group:"Appearance"},max:{type:"float",group:"Appearance"}},defaultAggregation:"bars",aggregations:{bars:{type:"sap.suite.ui.microchart.InteractiveBarChartBar",multiple:true,bindable:"bindable"}},events:{selectionChanged:{parameters:{selectedBars:{type:"sap.suite.ui.microchart.InteractiveBarChartBar[]"},bar:{type:"sap.suite.ui.microchart.InteractiveBarChartBar"},selected:{type:"boolean"}}},press:{}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}}}});I.MIN_BAR_WIDTH_IN_PX=1;I.BAR_VALUE_PADDING_LEFT_IN_PX=4;I.BAR_VALUE_PADDING_RIGHT_IN_PX=4;I.SELECTION_AREA_BORDER_IN_PX=1;I.DIVIDER_WIDTH_IN_PX=1;I.AREA_HEIGHT_MINVALUE=18;I.BAR_HEIGHT_FONT_SMALLER=22;I.BAR_HEIGHT_MINVALUE=6;I.BAR_HEIGHT_LABEL_HIDE=16;I.CHART_WIDTH_FONT_SMALLER=288;I.LABEL_WIDTH_MINVALUE=80;I.CHART_WIDTH_MINVALUE=130;I.AREA_HEIGHT_INTERACTIVE_MINVALUE=48;I.AREA_HEIGHT_INTERACTIVE_MINVALUE_COMPACT=32;I.AREA_HEIGHT_PADDING_STAGE1=34;I.AREA_HEIGHT_PADDING_STAGE1_COMPACT=32;I.AREA_HEIGHT_PADDING_STAGE2=28;I.AREA_HEIGHT_PADDING_STAGE2_COMPACT=31;I.prototype.init=function(){this._iVisibleBars=0;this._bInteractiveMode=true;this._bMinMaxValid=null;this._fDividerPositionRight=0;this._iAreaHeightInteractiveMinValue;this._iAreaHeightPaddingStage1;this._iAreaHeightPaddingStage2;this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.microchart");this._bThemeApplied=true;if(!sap.ui.getCore().isInitialized()){this._bThemeApplied=false;sap.ui.getCore().attachInit(this._handleCoreInitialized.bind(this));}else{this._handleCoreInitialized();}};I.prototype._handleCoreInitialized=function(){this._bThemeApplied=sap.ui.getCore().isThemeApplied();if(!this._bThemeApplied){sap.ui.getCore().attachThemeChanged(this._handleThemeApplied,this);}};I.prototype._handleThemeApplied=function(){this._bThemeApplied=true;this.invalidate();sap.ui.getCore().detachThemeChanged(this._handleThemeApplied,this);};I.prototype.onBeforeRendering=function(){this._bCompact=this._isCompact();this._bInteractiveMode=true;this._setResponsivenessData();this._bMinMaxValid=this._checkIfMinMaxValid();if(this.getAggregation("bars")&&this.getDisplayedBars()){this._iVisibleBars=Math.min(this.getAggregation("bars").length,this.getDisplayedBars());}if(!this.data("_parentRenderingContext")&&q.isFunction(this.getParent)){this.data("_parentRenderingContext",this.getParent());}this._deregisterResizeHandler();sap.ui.getCore().detachIntervalTimer(this._checkContentDensity,this);};I.prototype.onAfterRendering=function(){this._sResizeHandlerId=sap.ui.core.ResizeHandler.register(this,this._onResize.bind(this));this._adjustToParent();this._calcBarsWidth();this._onResize();sap.ui.getCore().attachIntervalTimer(this._checkContentDensity,this);};I.prototype.exit=function(){this._deregisterResizeHandler();sap.ui.getCore().detachIntervalTimer(this._checkContentDensity,this);};I.prototype.onclick=function(e){if(!this.getSelectionEnabled()){return;}if(this._bInteractiveMode){var i=q(e.target).attr("id")||q(e.target).parents(".sapSuiteIBCBarInteractionArea").attr("id"),f=this.$().find(".sapSuiteIBCBarInteractionArea"),a,h;if(i){a=i.substring(i.lastIndexOf("-")+1);if(isNaN(a)){return;}else{a=parseInt(a,10);}this._toggleSelected(a);h=f.index(this.$().find(".sapSuiteIBCBarInteractionArea[tabindex='0']"));this._switchTabindex(h,a,f);}}else{this.firePress();if(D.browser.msie){this.$().focus();e.preventDefault();}}};I.prototype.onsapenter=function(e){if(this._bInteractiveMode){var i=this.$().find(".sapSuiteIBCBarInteractionArea").index(e.target);if(i!==-1){this._toggleSelected(i);}e.preventDefault();e.stopImmediatePropagation();}else{this.firePress();}};I.prototype.onsapspace=I.prototype.onsapenter;I.prototype.onsapup=function(e){var f=this.$().find(".sapSuiteIBCBarInteractionArea");var i=f.index(e.target);if(f.length>0){this._switchTabindex(i,i-1,f);}e.preventDefault();e.stopImmediatePropagation();};I.prototype.onsapdown=function(e){var f=this.$().find(".sapSuiteIBCBarInteractionArea");var i=f.index(e.target);if(f.length>0){this._switchTabindex(i,i+1,f);}e.preventDefault();e.stopImmediatePropagation();};I.prototype.onsaphome=function(e){var f=this.$().find(".sapSuiteIBCBarInteractionArea");var i=f.index(e.target);if(i!==0&&f.length>0){this._switchTabindex(i,0,f);}e.preventDefault();e.stopImmediatePropagation();};I.prototype.onsapend=function(e){var f=this.$().find(".sapSuiteIBCBarInteractionArea"),i=f.index(e.target),L=f.length;if(i!==L-1&&L>0){this._switchTabindex(i,L-1,f);}e.preventDefault();e.stopImmediatePropagation();};I.prototype.onsapleft=I.prototype.onsapup;I.prototype.onsapright=I.prototype.onsapdown;I.prototype.getSelectedBars=function(){var b=this.getAggregation("bars"),s=[],i;for(i=0;i<b.length;i++){if(b[i].getSelected()){s.push(b[i]);}}return s;};I.prototype.setSelectedBars=function(s){var b=this.getAggregation("bars"),i,a;this._deselectAllSelectedBars();if(!s){return this;}if(s instanceof l.InteractiveBarChartBar){s=[s];}if(q.isArray(s)){for(i=0;i<s.length;i++){a=this.indexOfAggregation("bars",s[i]);if(a>=0){b[a].setProperty("selected",true,true);}else{q.sap.log.warning("setSelectedBars method called with invalid InteractiveBarChartBar element");}}}this.invalidate();return this;};I.prototype._isCompact=function(){return q("body").hasClass("sapUiSizeCompact")||this.$().is(".sapUiSizeCompact")||this.$().closest(".sapUiSizeCompact").length>0;};I.prototype._setResponsivenessData=function(){if(this._bCompact){this._iAreaHeightInteractiveMinValue=I.AREA_HEIGHT_INTERACTIVE_MINVALUE_COMPACT;this._iAreaHeightPaddingStage1=I.AREA_HEIGHT_PADDING_STAGE1_COMPACT;this._iAreaHeightPaddingStage2=I.AREA_HEIGHT_PADDING_STAGE2_COMPACT;}else{this._iAreaHeightInteractiveMinValue=I.AREA_HEIGHT_INTERACTIVE_MINVALUE;this._iAreaHeightPaddingStage1=I.AREA_HEIGHT_PADDING_STAGE1;this._iAreaHeightPaddingStage2=I.AREA_HEIGHT_PADDING_STAGE2;}};I.prototype._checkContentDensity=function(){if(this.$().length>0){var c=this._isCompact();if(c!==this._bCompact){this._bCompact=c;this.invalidate();}}};I.prototype._adjustToParent=function(){var t=this.$();if(this.data("_parentRenderingContext")&&this.data("_parentRenderingContext")instanceof sap.m.FlexBox){var p=this.data("_parentRenderingContext").$();var P=p.width()-2;var i=p.height()-2;t.outerWidth(P);t.outerHeight(i);}};I.prototype._calcBarsWidth=function(){var m=this.getMin(),t=this.$(),M=this.getMax(),d=I.DIVIDER_WIDTH_IN_PX,L=parseFloat(this.getLabelWidth()),b,f,B,a,c,e,g,h,v,E;if(!this._bMinMaxValid){return this;}if(this._bFullWidth){L=100;b=100;}else{b=100-L;}f=Math.abs(M-m);if(m>=0&&M>=0){c=0;e=1;}else if(m<0&&M<0){c=1;e=0;}else{c=Math.abs(m/f);e=Math.abs(M/f);}if(this._bFullWidth){if(e>=c){g=e*100;h=c*100;}else{g=c*100;h=0;}t.find(".sapSuiteIBCBarLabel").css("width",g+"%");t.find(".sapSuiteIBCBarLabel").css("left",h+"%");}else{t.find(".sapSuiteIBCBarLabel").css("width",L+"%");t.find(".sapSuiteIBCBarLabel").css("left","");}t.find(".sapSuiteIBCBarWrapper").css("width",b+"%");if(c>0){t.find(".sapSuiteIBCBarWrapperNegative").width("calc("+c*100+"% - "+d+"px)");}else{t.find(".sapSuiteIBCBarWrapperNegative").width("0%");}if(e>0){t.find(".sapSuiteIBCBarWrapperPositive").width("calc("+e*100+"% - "+d+"px)");}else{t.find(".sapSuiteIBCBarWrapperPositive").width("0%");}B=this.$("bar-negative-0").parent().width();a=this.$("bar-positive-0").parent().width();for(var i=0;i<this._iVisibleBars;i++){v=this.getBars()[i].getValue();if(!this.getBars()[i]._bNullValue||v!==0){if(v>0){E=Math.min(Math.max(v,m),M);this.$("bar-positive-"+i).css("width",this._calcPercent(E,f,Math.max(0,m),e,a));}else{E=Math.max(Math.min(v,M),m);this.$("bar-negative-"+i).css("width",this._calcPercent(E,f,Math.min(0,M),c,B));}}}};I.prototype._calcPercent=function(b,d,c,s,a){var r,R;r=Math.abs((b-c)/(d*s)*100);R=(r/(d*s)*s).toFixed(2)*100;if((r>0&&(R/100*a)<1)){return I.MIN_BAR_WIDTH_IN_PX+"px";}return r+"%";};I.prototype._deselectAllSelectedBars=function(){var b=this.getAggregation("bars"),B=b.length,i;for(i=0;i<B;i++){b[i].setProperty("selected",false,true);}};I.prototype._toggleSelected=function(i){var b=this.getAggregation("bars"),B=b[i];if(i<0||i>=b.length){return;}var $=this.$("interactionArea-"+i);if(B.getSelected()){$.removeClass("sapSuiteIBCBarSelected");B.setProperty("selected",false,true);}else{$.addClass("sapSuiteIBCBarSelected");B.setProperty("selected",true,true);}$.attr("aria-selected",B.getSelected());this.fireSelectionChanged({selectedBars:this.getSelectedBars(),bar:B,selected:B.getSelected()});};I.prototype._showValueOutsideBar=function(){var c=this.$(),b,v,B,f,a,d,e,g=this.$("bar-positive-0").parent().width(),h=this.$("bar-negative-0").parent().width();b=c.find(".sapSuiteIBCBarValue");if(b.length===0){return;}for(var i=0;i<this._iVisibleBars;i++){B=(b.eq(i).width()+I.BAR_VALUE_PADDING_LEFT_IN_PX+I.BAR_VALUE_PADDING_RIGHT_IN_PX);f=this.$("bar-positive-"+i).width();a=this.$("bar-negative-"+i).width();d=g-f;e=h-a;if(this.getBars()[i].getValue()>=0||(this.getBars()[i]._bNullValue&&this.getMin()+this.getMax()>=0)){if(B>f&&B>d){b.eq(i).css("visibility","hidden");}else{b.eq(i).css("visibility","inherit");}if(B>f){v=this.$("bar-positive-"+i).width()+I.BAR_VALUE_PADDING_LEFT_IN_PX;b.eq(i).css({"left":v});b.eq(i).addClass("sapSuiteIBCBarValueOutside");}else{b.eq(i).css({"left":""});b.eq(i).removeClass("sapSuiteIBCBarValueOutside");}}else{if(B>a&&B>e){b.eq(i).css("visibility","hidden");}else{b.eq(i).css("visibility","inherit");}if(B>a){v=this.$("bar-negative-"+i).width()+I.BAR_VALUE_PADDING_RIGHT_IN_PX;b.eq(i).css({"right":v});b.eq(i).addClass("sapSuiteIBCBarValueOutside");}else{b.eq(i).css({"right":""});b.eq(i).removeClass("sapSuiteIBCBarValueOutside");}}}};I.prototype._checkIfMinMaxValid=function(){var m=this.getMin(),M=this.getMax();if(isNaN(m)||isNaN(M)){q.sap.log.warning("Min or Max value for InteractiveBarChart is not provided.");return false;}if(m>M){q.sap.log.warning("Min value for InteractiveBarChart is larger than Max value.");return false;}return true;};I.prototype.validateProperty=function(p,v){if(p==="labelWidth"&&(v!==null||v!==undefined)){var V=parseFloat(v);if(V<0||V>100){q.sap.log.warning("LabelWidth for InteractiveBarChart is not between 0 and 100.");v=null;}}return C.prototype.validateProperty.apply(this,[p,v]);};I.prototype._switchTabindex=function(o,n,f){if(o>=0&&o<f.length&&n>=0&&n<f.length){f.eq(o).removeAttr("tabindex");f.eq(n).attr("tabindex","0");f.eq(n).focus();}};I.prototype._isChartEnabled=function(){return this.getSelectionEnabled()&&this._bInteractiveMode;};I.prototype._resizeVertically=function(f){var a,m,b,t=this.$(),s=t.find(".sapSuiteIBCBarInteractionArea"),c=t.height(),i=0,v=this._iVisibleBars;if(this._bInteractiveMode){i=1;}m=parseInt(s.css("margin-bottom"),10)+parseInt(s.css("margin-top"),10);a=((c-((m+2*I.SELECTION_AREA_BORDER_IN_PX)*v))/v);if(a+i<this._iAreaHeightInteractiveMinValue){if(this._bInteractiveMode){this._bInteractiveMode=false;t.addClass("sapSuiteIBCNonInteractive");if(this.getSelectionEnabled()){var A=this.$().find(".sapSuiteIBCBarInteractionArea[tabindex='0']");this._iActiveElement=this.$().find(".sapSuiteIBCBarInteractionArea").index(A);A.removeAttr("tabindex");this.$().attr("tabindex","0");}this.$().attr("role","button");this.$().attr("aria-multiselectable","false");this.$().attr("aria-disabled",!this._isChartEnabled());}}else{if(!this._bInteractiveMode){this._bInteractiveMode=true;t.removeClass("sapSuiteIBCNonInteractive");if(this.getSelectionEnabled()){this.$().removeAttr("tabindex");if(!this._iActiveElement||this._iActiveElement<0){this._iActiveElement=0;}this.$().find(".sapSuiteIBCBarInteractionArea").eq(this._iActiveElement).attr("tabindex","0");}this.$().attr("role","listbox");this.$().attr("aria-multiselectable","true");this.$().attr("aria-disabled",!this._isChartEnabled());}}s.height(a);if(a<=this._iAreaHeightPaddingStage2){t.addClass("sapSuiteIBCStage2");}else{t.removeClass("sapSuiteIBCStage2");if(a<=this._iAreaHeightPaddingStage1){t.addClass("sapSuiteIBCStage1");}else{t.removeClass("sapSuiteIBCStage1");}}var B=this.$().find(".sapSuiteIBCBar");if(B.length>0){b=B[0].getBoundingClientRect().height;}if(b<=I.BAR_HEIGHT_FONT_SMALLER){t.addClass("sapSuiteIBCSmallFont");}if(b<=I.BAR_HEIGHT_LABEL_HIDE){t.find(".sapSuiteIBCBarValue").css("visibility","hidden");f.labelsVisible=false;}else{t.find(".sapSuiteIBCBarValue").css("visibility","inherit");}if(a<I.AREA_HEIGHT_MINVALUE){t.css("visibility","hidden");f.labelsVisible=false;f.chartVisible=false;}};I.prototype._resizeHorizontally=function(f){if(!f.chartVisible){return;}var t=this.$(),s=t.find(".sapSuiteIBCBarInteractionArea"),b=t.find(".sapSuiteIBCBarLabel"),B=parseFloat(this.getLabelWidth())/100*s.eq(0).width(),a=0,c=t.width(),d,e=false;if(c<I.CHART_WIDTH_FONT_SMALLER){t.addClass("sapSuiteIBCSmallFont");B=parseFloat(this.getLabelWidth())/100*s.eq(0).width();}if(this._bFullWidth){a=6;}for(var i=0;i<b.length;i++){b.eq(i).css("width",B+"px");if(b.eq(i).children(".sapSuiteIBCBarLabelText").prop("clientWidth")<b.eq(i).children(".sapSuiteIBCBarLabelText").prop("scrollWidth")-a){e=true;}b.eq(i).css("width","100%");}if(B<I.LABEL_WIDTH_MINVALUE&&e){t.addClass("sapSuiteIBCFullWidth");this._bFullWidth=true;this._calcBarsWidth();}else{t.removeClass("sapSuiteIBCFullWidth");this._bFullWidth=false;this._calcBarsWidth();}var $=this.$().find(".sapSuiteIBCBar");if($.length>0){d=$[0].getBoundingClientRect().height;}if(c<I.CHART_WIDTH_MINVALUE||d<I.BAR_HEIGHT_MINVALUE){t.css("visibility","hidden");f.labelsVisible=false;f.chartVisible=false;}else if(d<=I.BAR_HEIGHT_LABEL_HIDE){t.find(".sapSuiteIBCBarValue").css("visibility","hidden");f.labelsVisible=false;}};I.prototype._onResize=function(){var t=this.$(),f={chartVisible:true,labelsVisible:true};t.css("visibility","visible");t.removeClass("sapSuiteIBCSmallFont");this._resizeVertically(f);this._resizeHorizontally(f);if(f.labelsVisible){this._showValueOutsideBar();}};I.prototype._deregisterResizeHandler=function(){if(this._sResizeHandlerId){sap.ui.core.ResizeHandler.deregister(this._sResizeHandlerId);this._sResizeHandlerId=null;}};return I;});
