sap.ui.define(["sap/f/FlexibleColumnLayout","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/generic/app/util/ModelUtil","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/FlexibleColumnLayoutHandler","sap/suite/ui/generic/template/lib/testableHelper","sap/m/routing/Targets"],function(F,a,b,M,C,c,t,T){"use strict";function d(R,i,v,w,x){var y={};y={viewName:v,controlId:i,controlAggregation:x};var z=R.getTargets();z.addTarget(w,y);}function e(N,i){if(N.oTemplateContract.oFlexibleColumnLayoutHandler){N.oTemplateContract.oFlexibleColumnLayoutHandler.createMessagePageTargets(d.bind(null,N.oRouter,i,"sap.suite.ui.generic.template.fragments.MessagePage"));}else{d(N.oRouter,i,"sap.suite.ui.generic.template.fragments.MessagePage","messagePage","pages");}}function g(N){var i=N.oTemplateContract.oNavigationHost.getId();var v=N.oAppComponent.getConfig(),w,x;if(!v.pages||!v.pages.length){throw new Error("Route Configuration missing");}if(v.pages.length>1){throw new Error("Currently only one Top route supported");}w=v.pages[0];N.oTemplateContract.mEntityTree={};x=k([],w,"root",0,null,N,i);N.oRouter.addRoute(x);j(x,N);f(x.target,w,0,null,N,i);e(N,i);return w.entitySet;}function f(v,R,L,w,N,x,y){var i,z;if(R.pages){z=R.pages.length;for(i=0;i<z;i++){h(v,R.pages[i],(L+1),w,N,x,y);}}}function h(v,R,L,i,N,w,x){if(R.component){var y={parent:i&&i.entitySet,navigationProperty:R.navigationProperty,level:L,children:[]};var z=k(v,R,R.component.list?"aggregation":"detail",L,i,N,w);y.sRouteName=z.name;y.entitySet=z.entitySet;if(x){x.push(z.entitySet);}var E=N.oTemplateContract.mEntityTree[z.entitySet];if(!E||E.level>y.level){N.oTemplateContract.mEntityTree[z.entitySet]=y;}N.oRouter.addRoute(z);j(z,N);f(z.target,R,L,z,N,w,y.children);}}function j(R,N){var Q=jQuery.extend({},R);Q.name=R.name+"query";Q.pattern=R.pattern+"{?query}";N.oRouter.addRoute(Q);}function k(v,R,O,L,i,N,w){var x=jQuery.isArray(v)?v:[v];var y,z;y=R.navigationProperty||R.entitySet;z=jQuery.extend({},R);z.path="/"+R.entitySet;z.operation=O;z.viewLevel=L;z.template=R.component?(R.component.name||R.component):R.template;switch(O){case"root":z.name="root";z.pattern="";break;case"aggregation":z.name=y+"~aggregation";z.pattern=y;break;default:z.name=y;z.pattern=y+"({keys"+L+"})";break;}if(i){z.name=i.name+"/"+z.name;z.pattern=i.pattern+"/"+z.pattern;z.parentEntitySet=i.entitySet;}if(z.viewLevel===1){N.oTemplateContract.routeViewLevel1={pattern:z.pattern,name:z.name};}var A;var B=z.name;if(N.oTemplateContract.oFlexibleColumnLayoutHandler){A=N.oTemplateContract.oFlexibleColumnLayoutHandler.adaptRoutingInfo(z,B,x);}else{A="pages";z.target=B;}d(N.oRouter,w,z.name,B,A);var E=new Promise(function(G){N.mRouteToComponentResolve[z.name]=G;});N.oTemplateContract.mRouteToTemplateComponentPromise[z.name]=E;return z;}function I(N,S){var H;if(!N.oHashChanger.getHash()){H="";if(S&&S.route&&S.route.length===1){H=S.route[0];N.navigate(H,true);}}N.oRouter.initialize();N.fnInitializationResolve();}function r(N,E,K,S,v){var i,L,w,V,x=[];if(K&&S&&v){L=K.length;for(i=0;i<L;i++){w=K[i].PropertyPath;V=S[w][0];x.push(new a(w,b.EQ,V));}if(N.oAppComponent.getTransactionController().getDraftController().getDraftContext().isDraftEnabled(E)){var y=new a({filters:[new a("IsActiveEntity","EQ",false),new a("SiblingEntity/IsActiveEntity","EQ",null)],and:false});x.push(y);}var z=new a(x,true);v.read("/"+E,{filters:[z],success:function(R){var A,i,B,G;if(R&&R.results){B=R.results.length;for(i=0;i<B;i++){A=R.results[i];if(A&&A.IsActiveEntity){break;}A=null;}if(!A){A=R.results[0];}}if(A){G=v.getKey(A);}if(G){N.navigate(G,true);}I(N,S);},error:function(A){I(N,S);}});}}function l(i,v){if((i&&v)||(v==="display")){return{mode:"unsupported"};}var R={mode:"display",force:"false"};R.mode=v||i||R.mode;R.force=!!v;return R;}function D(i,N,E,S,v){var w=n(i,N,E,S,v);var H;if(w.bNavigationWithTechnicalKeyPossible){H=i.createKey(E,S);if(H){N.navigate(H,true);}}else if(w.bNavigationWithSemanticKeyPossible){r(N,E,w.aSemanticKey,S,i);return;}I(N,S);}function m(K,v){var i,L,S=false,w,x;if(v&&K){L=K.length;for(i=0;i<L;i++){S=true;w=K[i];x=w.name||w.PropertyPath;if(!v[x]||v[x].length>1){S=false;break;}}}return S;}function n(i,N,E,S,v){if(!N.oRouter.getRoute(E)){return{};}if(N.oAppComponent.getManifestEntry("sap.ui.generic.app").pages[0].pages[0].navigation&&N.oAppComponent.getManifestEntry("sap.ui.generic.app").pages[0].pages[0].navigation[v.mode]){return{};}var w=i.getMetaModel().getODataEntitySet(E);if(!w){return{};}var x=i.getMetaModel().getODataEntityType(w.entityType);if(m(x.key.propertyRef,S)){return{bNavigationWithTechnicalKeyPossible:true};}var y=x["com.sap.vocabularies.Common.v1.SemanticKey"];if(m(y,S)){return{bNavigationWithSemanticKeyPossible:true,aSemanticKey:y};}return{};}function p(N){var G=N.oAppComponent.getModel("_templPrivGlobal");G.setProperty("/generic/forceFullscreenCreate",true);}function P(N,E,S){var v;v=N.oAppComponent.getModel();v.attachMetadataFailed(N.fnInitializationResolve);v.getMetaModel().loaded().then(function(){var w;var x=S.preferredMode&&S.preferredMode[0];var y=S.mode&&S.mode[0];var z=l(x,y);if(S.DraftUUID){S.DraftUUID=["00000000-0000-0000-0000-000000000000"];}if(S.IsActiveEntity){S.IsActiveEntity=["true"];}switch(z.mode){case"create":p(N);var A=C.create(N.oAppComponent.getTransactionController().getDraftController(),E,"/"+E,v,N.oTemplateContract.oApplicationProxy.setEditableNDC);A.then(function(K){I(N,S);N.navigateToContext(K,"",true,4);},function(K){N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),text:K.messageText,description:"",icon:"sap-icon://message-error",replaceURL:true});});N.oTemplateContract.oBusyHelper.setBusy(A,true);break;case"createWithContext":p(N);w=v.getMetaModel().getODataEntitySet(E);var B=w["com.sap.vocabularies.Common.v1.DraftRoot"];if(B&&B.NewAction){var G=v.getMetaModel().getODataFunctionImport(B.NewAction.String.split("/")[1]);var U={};if(G&&G.parameter){for(var i=0;i<G.parameter.length;i++){if(G.parameter[i].mode==="In"&&S[G.parameter[i].name][0]){U[G.parameter[i].name]=S[G.parameter[i].name][0];}}sap.ui.core.BusyIndicator.show();v.callFunction("/"+G.name,{success:function(K,R){I(N,S);sap.ui.core.BusyIndicator.hide();var L=new M(v);var O=L.getContextFromResponse(K);if(O){N.navigateToContext(O,null,true,4);}else{N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),replaceURL:true});}},error:function(K){sap.ui.core.BusyIndicator.hide();N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),replaceURL:true});},method:"POST",urlParameters:U});}else{N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),replaceURL:true});}}break;case"edit":var H=n(v,N,E,S,z);if(H.bNavigationWithTechnicalKeyPossible||H.bNavigationWithSemanticKeyPossible){var J=C.edit(N.oAppComponent.getTransactionController(),E,"/"+v.createKey(E,S),v,N.oTemplateContract,N.fnInitializationResolve);J.then(function(R){N.navigate(R.context.getPath(),true);I(N);},function(K){if(K.lockedByUser){if(!z.force){D(v,N,E,S,z);}else{N.fnInitializationResolve();N.navigateToMessagePage({title:N.oTemplateContract.getText("LOCKED_OBJECT_POPOVER_TITLE"),text:N.oTemplateContract.getText("LOCKED_OBJECT_POPOVER_TITLE"),description:N.oTemplateContract.getText("ST_GENERIC_LOCKED_OBJECT_POPOVER_TEXT",[K.lockedByUser]),icon:"sap-icon://message-error",replaceURL:true});}}else if(K.draftAdminReadResponse){N.fnInitializationResolve();N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),text:N.oTemplateContract.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE"),description:N.oTemplateContract.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC"),icon:"sap-icon://message-error",replaceURL:true});}});}else{I(N,S);}break;case"display":D(v,N,E,S,z);break;default:N.fnInitializationResolve();N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),text:N.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),description:N.oTemplateContract.getText("PARAMETER_COMBINATION_NOT_SUPPORTED",[y,x]),icon:"sap-icon://message-error",replaceURL:true});}});}function s(N){var i=N.oAppComponent.getManifestEntry("sap.ui.generic.app");if(i.settings&&i.settings.flexibleColumnLayout){N.oTemplateContract.oFlexibleColumnLayoutHandler=new c(N.oTemplateContract.oNavigationHost,N);}var E=g(N);var v=N.oAppComponent.getComponentData();var S=v&&v.startupParameters;if(E&&S&&!N.oHashChanger.getHash()){P(N,E,S);}else{I(N);}}function o(R){var i,v,w;if(R){i=R.pattern;v=R.navigationProperty||R.entitySet;if(i&&v){w=i.indexOf("{?query}");if(w>0){i=i.substring(0,w);}w=-1;v+="({keys";w=i.indexOf(v);if(w>0){i=i.substring(w);}if(R.navigationProperty){i=i.replace(R.navigationProperty,R.entitySet);}i="/"+i;}}return i;}function q(R,E,i){var v,K,w;if(R.operation==="root"){return null;}if(R.operation==="aggregation"){v=R.pattern;}else{if(i){v=i;}else{v=o(R);}}if(v.indexOf("/")!==0){v="/"+v;}K=E.getParameter("arguments");if(K){for(w in K){if(w!=="?query"){v=v.replace("{"+w+"}",K[w]);}}return v;}}function u(i,N){var v,w,E;v=i.getPath().substring(1);w=v.split("(");if(w[0]){E=w[0];}if(N){v=v.replace(E,N);if(v.indexOf("/")===0){v=v.substring(1);}}return{entitySet:E,path:v};}var g=t.testableStatic(g,"routingHelpergenerateRoutingMetadataAndGetRootEntitySet");var I=t.testableStatic(I,"routingHelper_initialiseRouting");var r=t.testableStatic(r,"routingHelper_readObject");var P=t.testableStatic(P,"routingHelper_processStartupParameters");return{startupRouter:s,determinePath:q,determineNavigationPath:u};});
