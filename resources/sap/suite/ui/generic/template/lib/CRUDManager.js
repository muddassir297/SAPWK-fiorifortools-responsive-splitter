sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/m/MessageToast","sap/ui/generic/app/util/ModelUtil","sap/ui/generic/app/util/ActionUtil","sap/suite/ui/generic/template/lib/MessageUtils","sap/m/MessageBox","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/m/Table","sap/ui/table/AnalyticalTable"],function(q,B,M,a,A,b,c,C,t,T,d){"use strict";var r=Promise.reject();r.catch(q.noop);function g(o,e,s,f,h){function k(O,i,j,P){b.handleError(O,o,s,j,P);return(i||q.noop)(j);}function l(){b.handleTransientMessages(s.oApplication.getDialogFragmentForView.bind(null,null));}var E;function m(i){return new Promise(function(j,I){var J=o.getOwnerComponent();var K=J.getBindingContext();var L=J.getModel();L.read(K.getPath(),{urlParameters:{"$expand":"DraftAdministrativeData"},success:function(R){if(!R.DraftAdministrativeData){if(i){return k(b.operations.editEntity,I,i);}return j({});}if(R.DraftAdministrativeData.InProcessByUser){var U=R.DraftAdministrativeData.InProcessByUserDescription||R.DraftAdministrativeData.InProcessByUser;i=i||new Error(f.getText("ST_GENERIC_DRAFT_LOCKED_BY_USER",[" ",U]));return k(b.operations.editEntity,I,i,i);}return j({draftAdministrativeData:R.DraftAdministrativeData});},error:k.bind(null,b.operations.editEntity,I)});});}function n(i,U,P){if(P.draftAdministrativeData){return Promise.resolve(P);}return new Promise(function(j,I){s.oTransactionController.editEntity(o.getView().getBindingContext(),!U).then(function(R){e.rebindHeaderData(R.context.getPath());l(R);return j({context:R.context});},function(R){if(R&&R.response&&R.response.statusCode==="409"&&i&&!U){b.removeTransientMessages();return m(R).then(j,I);}else{k(b.operations.editEntity,I,R,R);}});});}E=function(U){var i=f.isDraftEnabled();var R;var j=o.getOwnerComponent();var I=j.getBindingContext();if(i&&!U){var J=s.oDraftController.getDraftContext();var P=J.hasPreserveChanges(I);if(!P){R=m().then(n.bind(null,true,true));}}R=R||n(i,U,{});if(i){s.oApplication.editingStarted(I,R);}return R;};function p(U){if(h.isBusy()){return r;}var R=E(U);h.setBusy(R);return R;}function u(i,j,I,J,N){var R=new Promise(function(K,L){var O=function(P){o.getOwnerComponent().getComponentContainer().bindElement(I.getPath());return k(b.operations.deleteEntity,L,P);};if(i&&J){s.oDraftController.getDraftForActiveEntity(I).then(function(P){s.oTransactionController.deleteEntity(P.context).then(function(){if(!N){s.oApplication.showMessageToast(f.getText("ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED"));}return K();});},O);}else{s.oTransactionController.deleteEntity(I).then(function(){var P=a.getEntitySetFromContext(I);var Q=s.oDraftController.getDraftContext();var S=Q.isDraftRoot(P);var U=f.getText("ST_GENERIC_OBJECT_DELETED");if(!i&&S){U=f.getText(j?"ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED":"ST_GENERIC_DRAFT_WITHOUT_ACTIVE_DOCUMENT_DELETED");}if(!N){s.oApplication.showMessageToast(U);}return K();},O);}});return R;}function v(i,N,R,j){if(h.isBusy()){j();return;}var I=o.getView().getBindingContext();var J=s.oDraftController.isActiveEntity(I);var K=s.oDraftController.hasActiveEntity(I);var S;if(i){S=Promise.resolve(I);}else if(K&&!J){S=s.oApplication.getDraftSiblingPromise(I);}else{S=Promise.resolve();}S.then(function(L){var O=u(J,K,I,i,N);O.then(R,j);if(K&&!J){var P=function(){return{context:L};};var Q=O.then(P);s.oApplication.cancellationStarted(I,Q);}},j);}function w(i,N){var R=new Promise(function(j,I){s.oApplication.performAfterSideEffectExecution(v.bind(null,i,N,j,I));});h.setBusy(R);return R;}function x(P){var R=new Promise(function(I,J){s.oTransactionController.deleteEntities(P).then(function(K){var L=[];var O=sap.ui.getCore().getMessageManager().getMessageModel().getData();for(var i=0;i<O.length;i++){var N=O[i].getTarget();for(var j=0;j<P.length;j++){if(N.indexOf(P[j])>-1){L.push(N);break;}}}return I(L);},function(i){return J(i);});});R.then(function(j){var I=[];for(var i=0;i<P.length;i++){if(j.indexOf(P[i])===-1){I.push(P[i]);}}s.oApplication.adaptAfterDeletion(I,e.getViewLevel());});return R;}function y(i,j){if(h.isBusy()){j();return;}s.oTransactionController.triggerSubmitChanges().then(function(R){l();i(R.context);},k.bind(null,b.operations.saveEntity,j));}function z(){var R=new Promise(function(i,j){s.oApplication.performAfterSideEffectExecution(y.bind(null,i,j));});h.setBusy(R);return R;}function D(){if(h.isBusy()){return r;}var R=new Promise(function(i,j){var I=o.getView().getBindingContext();var J=s.oDraftController.activateDraftEntity(I);s.oApplication.activationStarted(I,J);J.then(function(K){var L=o.getOwnerComponent();var N=L.getComponentContainer();var P=K.context.getPath();function O(){N.unbindElement();e.rebindHeaderData(P);}var Q=e.getPreprocessorsData().rootContextExpand;if(Q){o.getView().getModel().read(P,{urlParameters:{"$select":Q.join(","),"$expand":Q.join(",")},success:O,error:O});}else{O();}l();return i(K);},k.bind(null,b.operations.activateDraftEntity,j));});h.setBusy(R);return R;}function F(P,S,R,j){if(h.isBusy()){j();return;}var I=P.functionImportPath;var J=P.contexts;var K=P.sourceControl;var L=P.label;var N=P.navigationProperty;var O=P.operationGrouping;var Q=new A({controller:o,contexts:J,applicationController:s.oApplicationController,operationGrouping:O});var U=function(Y,Z){if(Y.pages){for(var i in Y.pages){var $=Y.pages[i];if($.component.list!=true&&$.entitySet===Z){return true;}else{var _=U($,Z);if(_){return true;}}}}return false;};var V=function(i,Y){var Z=i.getAppComponent().getConfig();if(Y&&Y.sPath){var $=Y.sPath.split("(")[0].replace("/","");return U(Z.pages[0],$);}return false;};var W=function(i){var Y,Z,$,_;if(q.isArray(i)&&i.length===1){Y=i[0];}else{Y={response:{context:i.context}};}Z=Y.response&&Y.response.context;$=o.getOwnerComponent();_=V($,Z);if(_&&Z&&Z!==Y.actionContext&&Z.getPath()!=="/undefined"){if(K){f.navigateFromListItem(Z,K);}else{s.oNavigationController.navigateToContext(Z,N,false);}}if(i.length>0){var a1=f.getTableBinding(K);var b1=a1&&a1.binding;if(b1&&b1.oEntityType){f.setEnabledToolbarButtons(K);var c1=$.getComponentContainer();var d1=c1&&c1.getSettings();var e1=d1&&d1.routeConfig;if(e1){if(sap.suite.ui.generic.template.js.AnnotationHelper.isListReportTemplate(e1)){f.setEnabledFooterButtons(K,o);}}}}R(i);};var X=function(i){if(q.isArray(i)){if(i.length===1){i=i[0].error;}else{i=null;}}var Y={context:J};k(b.operations.callAction,null,i,Y);j(i);};Q.call(I,L).then(W,X);}function G(P,S){var R=new Promise(function(i,j){s.oApplication.performAfterSideEffectExecution(F.bind(null,P,S,i,j));});h.setBusy(R);return R;}function H(i){if(!i){throw new Error("Unknown Table");}var j="";var I="";var J=o.getOwnerComponent().getEntitySet();var K,L,N,O;var V=o.getView();var P=V.getModel();var Q=V.getBindingContext();if(Q){I=f.getTableBinding(i).path;O=P.getMetaModel();L=O.getODataEntitySet(J);K=O.getODataEntityType(L.entityType);N=O.getODataAssociationSetEnd(K,I);if(N){J=N.entitySet;}I="/"+I;j=Q.getPath()+I;}else{j="/"+J;}var R=C.create(s.oDraftController,J,j,P,s.oApplication.setEditableNDC);s.oApplication.getBusyHelper().setBusy(R);return R.then(function(S){return{newContext:S,tableBindingPath:I};},k.bind(null,b.operations.addEntry,function(S){throw S;}));}var k=t.testable(k,"handleError");return{editEntity:p,deleteEntity:w,deleteEntities:x,saveEntity:z,activateDraftEntity:D,callAction:G,addEntry:H};}return B.extend("sap.suite.ui.generic.template.lib.CRUDManager.js",{constructor:function(o,e,s,f,h){q.extend(this,g(o,e,s,f,h));}});});
