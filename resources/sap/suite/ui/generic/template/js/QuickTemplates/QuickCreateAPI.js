sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/generic/app/transaction/DraftContext","sap/m/MessageToast"],function(M,D,a){"use strict";var Q=M.extend("sap.suite.ui.generic.template.js.QuickTemplates.QuickCreateAPI",{metadata:{library:"sap.suite.ui.generic.template",properties:{},events:{objectCreated:{parameters:{context:{type:"sap.ui.model.Context"}}},destroyed:{parameters:{collectionItemGuid:{type:"String"}}},autofillLineItems:{parameters:{numberOfLineItems:{type:"Number"}}}}}});Q.EVENT_CONSTANTS={EventChannel:"sap.fiori.cp.quickactions.EventChannel",QUICKCREATE_LINE_ITEMS_FOUND:"LineItemsFound",QUICKCREATE_VIEW_CREATED:"QuickCreateViewCreated"};Q.CopilotModelName="FioriCopilotODataModel";Q._Instances={};Q.getInstance=function(c){if(!c){return undefined;}if(c.copilotEntity){return Q._Instances[c.copilotEntity.getODataKey()];}else{return Q._Instances[c];}};Q.createAPI=function(c,C,o){function g(){return o.getView().getBindingContext().getObject();}function b(){return o.getQuickCreateItem();}function d(){return C;}function e(){return c;}function f(){return sap.ui.getCore().getModel(Q.CopilotModelName);}function u(i){if(this._bDestroyed){return;}var G=this.getQuickCreateItem();if(G.draftid===i){return;}G.draftid=i;G.copilotEntity.update(G,{error:jQuery.proxy(function(H){jQuery.sap.log.error(H,"","QuickCreateAPI");},this)});}function h(){return C.getAggregation("rootControl");}function j(){return this.oRootView;}function s(i){this.oRootView=i;this.calculateViewHeight(this.oRootView,true);}function k(){if(this.oRootView&&this.oRootView.getController()&&this.oRootView.getController().bDraftEnabled!==undefined){return this.oRootView.getController().bDraftEnabled;}if(!this.oRootView||!this.oRootView.getBindingContext()){return undefined;}var i=new D(this.getQuickCreateModel());return i.hasDraft(this.oRootView.getBindingContext());}function l(){var i=this.getComponentInstance().getModel();if(!i&&this.oRootView){i=this.oRootView.getModel();}return i;}function m(){return o.isCurrentUserCreator();}function n(){if(!this.oRootView){return undefined;}return this.oRootView.getBindingContext();}function p(){var i=this.getQuickCreateRootBindingContext();if(i&&i.getObject()){return i.getObject().__metadata.type;}return undefined;}function _(i,G,P){var H=P.numberOfLineItems;if(H<=0){return;}this.fireAutofillLineItems({numberOfLineItems:H});}function q(){this._attachToModelBindingChanges();if(!this.oRootView){var V=o.oViewUtils.findFirstViewFromControlHierarchy(this.getRootControl());if(V){this.setRootView(V);}}}function r(){if(!this._bBindingChangeAttached){var i=C.getModel();if(i){var G=i.addBinding.bind(i);var H=this;i.addBinding=function(I){G(I);I.attachEvent("change",H._onDataBindingChanged);};this._bBindingChangeAttached=true;}}}function t(){return new Promise(jQuery.proxy(function(i,G){var H=this.getCopilotModel();H.read("/"+H.getKey(this.getQuickCreateItem()),{success:jQuery.proxy(function(I,R){if(I.modeljson){var J=this.getQuickCreateModel();this._loadingJSON=true;if(this.isDraftEnabled()){J.oData=JSON.parse(I.modeljson);}else{var K=JSON.parse(I.modeljson);J.mChangedEntities=K.mChangedEntities;J.mChangeHandles=K.mChangeHandles;J.mDeferredRequests=K.mDeferredRequests;J.oData=K.oData;}J.updateBindings();}if(i){i();}delete this._loadingJSON;},this),error:jQuery.proxy(function(I){if(G){G(I);}},this)});},this));}function v(){if(!this._oUpdateModelJSONTimer){this._oUpdateModelJSONTimer=setTimeout(this._updateModelJSON,2000);}}function w(){if(this._loadingJSON||this._bDestroyed||!this.isCurrentUserCreator()){return;}this._oUpdateModelJSONTimer=null;var G=this.getQuickCreateItem();var H=this.getQuickCreateModel();var I="";if(this.isDraftEnabled()){var J={};var K=Object.keys(H.mChangedEntities);var L=Object.keys(H.oData);var N={};jQuery.each(L,jQuery.proxy(function(i,P){if(H.mChangedEntities[P]){N={};jQuery.extend(N,H.oData[P]);jQuery.extend(N,H.mChangedEntities[P]);J[P]=N;}else{J[P]=H.oData[P];}},this));jQuery.each(K,jQuery.proxy(function(i,P){if(!J[P]){J[P]=H.mChangedEntities[P];}},this));I=JSON.stringify(J);}else{var O={};O.mChangedEntities=H.mChangedEntities;O.mChangeHandles=H.mChangeHandles;O.mDeferredRequests=H.mDeferredRequests;O.oData=H.oData;I=JSON.stringify(O);}if(I===G.modeljson){return;}G.modeljson=I;G.copilotEntity.update(G,{error:jQuery.proxy(function(i){jQuery.sap.log.error(i,"","QuickCreateAPI");},this)});}function x(){return new Promise(jQuery.proxy(function(i,G){var H=this.getQuickCreateModel();if(this.oRootView&&this.oRootView.getBindingContext()){if(this.isDraftEnabled()){H.remove(this.oRootView.getBindingContext().getPath(),{success:function(){a.show("Draft has been discarded");i();},error:function(I){G(I);}});}else{H.resetChanges();i();}}else{i();}},this));}function y(V,i){if(V){o.calculateViewHeight(V,i);}}function z(i){o.setComponentContainerHeight(i);}function A(i){if(this._bDestroyed){return;}this.fireObjectCreated({context:i});}function B(){sap.ui.getCore().getEventBus().publish(Q.EVENT_CONSTANTS.EventChannel,Q.EVENT_CONSTANTS.QUICKCREATE_VIEW_CREATED,{api:this});}function E(){if(this._bDestroyed){return;}if(this._oUpdateModelJSONTimer){clearTimeout(this._oUpdateModelJSONTimer);this._oUpdateModelJSONTimer=null;}delete Q._Instances[this._InstanceKey];if(c&&!c._bIsBeingDestroyed&&!c.bIsDestroyed){c.destroy();}this.oRootView=undefined;sap.ui.getCore().getEventBus().unsubscribe(Q.EVENT_CONSTANTS.EventChannel,Q.EVENT_CONSTANTS.QUICKCREATE_LINE_ITEMS_FOUND,this._onLineItemsFound,this);this.fireDestroyed({collectionItemGuid:this._InstanceKey});M.prototype.destroy.call(this);this._bDestroyed=true;}var F=new Q();jQuery.extend(F,{getCollectionItem:g.bind(F),getQuickCreateItem:b.bind(F),updateDraftID:u.bind(F),getRootControl:h.bind(F),isDraftEnabled:k.bind(F),isCurrentUserCreator:m.bind(F),getQuickCreateRootBindingContext:n.bind(F),getQuickCreateRootEntityType:p.bind(F),_onComponentContainerAfterRendering:q.bind(F),calculateViewHeight:y.bind(F),setComponentContainerHeight:z.bind(F),getQuickCreateModel:l.bind(F),objectCreated:A.bind(F),destroy:E.bind(F),getRootView:j.bind(F),setRootView:s.bind(F),getComponentInstance:d.bind(F),getComponentContainer:e.bind(F),_onDataBindingChanged:v.bind(F),_attachToModelBindingChanges:r.bind(F),loadQuickCreateModelFromJSON:t.bind(F),_updateModelJSON:w.bind(F),getCopilotModel:f.bind(F),discardQuickCreateDraft:x.bind(F),_onLineItemsFound:_.bind(F),fireQuickCreateViewCreated:B.bind(F)});c.addEventDelegate({onAfterRendering:F._onComponentContainerAfterRendering});F._InstanceKey=F.getCollectionItem().copilotEntity.getODataKey();if(Q._Instances[F._InstanceKey]){Q._Instances[F._InstanceKey].destroy();}delete Q._Instances[F._InstanceKey];Q._Instances[F._InstanceKey]=F;sap.ui.getCore().getEventBus().subscribe(Q.EVENT_CONSTANTS.EventChannel,Q.EVENT_CONSTANTS.QUICKCREATE_LINE_ITEMS_FOUND,F._onLineItemsFound,F);C.oQuickCreateAPI=F;return C.oQuickCreateAPI;};return Q;},true);
