sap.ui.define(["sap/viz/ui5/controls/VizFrame","sap/viz/ui5/controls/VizFrameRenderer","sap/viz/ui5/data/FlattenedDataset","sap/viz/ui5/data/DimensionDefinition","sap/viz/ui5/data/MeasureDefinition","sap/viz/ui5/controls/common/feeds/FeedItem","sap/viz/ui5/format/ChartFormatter","sap/viz/ui5/api/env/Format","sap/ui/model/Sorter","sap/suite/ui/generic/template/AnalyticalListPage/control/visualfilterbar/FilterItemChart","sap/ui/model/json/JSONModel"],function(V,a,F,D,M,b,C,c,S,d,J){"use strict";var e=d.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemChartLine",{metadata:{properties:{labelWidthPercent:{type:"float",group:"Misc",defaultValue:1/3},fixedCount:{type:"int",defaultValue:6}},aggregations:{dataset:{type:"sap.viz.ui5.data.Dataset",multiple:false}}},renderer:{}});e.prototype.init=function(){this._chart=new V({vizType:"line",legendVisible:false});this.setControl(this._chart);this._chart.setModel(new J());this._generateFiller=true;this._sorters=[];d.prototype.init.apply(this,arguments);};e.prototype._updateBinding=function(){var f=this.getEntitySet();var g=this.getDimensionField();var h=this.getDimensionFieldDisplay();var i=this.getDimensionFieldIsDateTime();var m=this.getMeasureField();var u=this.getUnitField();var j=this.getDimensionFilterExternal();var s=[],k=[];s=this.getSortOrder();var o=d._getSorter(s);this._sorters=o.sorter;k=o.sortFields;if(!f||!m||!g||!h)return;var l=false;if(i&&this._chart.getVizType()!="timeseries_line"){this._chart=new V({vizType:"timeseries_line",legendVisible:false});l=true;}else if(!i&&this._chart.getVizType()!="line"){this._chart=new V({vizType:"line",legendVisible:false});l=true;}if(l){this.setControl(this._chart);this._chart.setWidth(this.getWidth());this._chart.setHeight(this.getHeight());this._attachChartEvents();}var v=this._getVizProps(i);if(l||JSON.stringify(v)!=JSON.stringify(this.lastVizProps))this._chart.setVizProperties(v);this.lastVizProps=v;var n=this._chart.getFeeds();var p=true;if(n&&n.length==2){var q=n[0];var r=n[1];p=q.getValues()!=h||r.getValues()!=m;}if(l||p){this._chart.removeAllFeeds();var t=[h],w=[m];this._chart.addFeed(new b({"uid":i?"timeAxis":"categoryAxis","type":"Dimension","values":t}));this._chart.addFeed(new b({"uid":"valueAxis","type":"Measure","values":w}));}var x=[m,g,k];if(g!=h)x.push(h);if(u)x.push(u);var y=[];if(j&&j.aFilters&&j.aFilters.length>0)y=[j];this.setDataset(this._getDataSet(f,x,y,m,g,h));this._chart.setDataset(this._getChartDataSet(f,y,m,g,h));this._applyDimensionFilter();this._chart.setBusy(true);};e.prototype._getVizProps=function(i){var v;if(i){v={general:{background:{color:"transparent"},layout:{padding:0}},plotArea:{colorPalette:["#006ca7"],dataLabel:{formatString:this._formattingId,visible:true},window:{start:"firstDataPoint",end:"lastDataPoint"},gridline:{visible:false},background:{color:"transparent"}},valueAxis:{visible:false},timeAxis:{title:{visible:false},axisTick:{visible:false},hoverShadow:{color:"transparent"},levels:["day","month"],levelConfig:{year:{visible:false}}},tooltip:{visible:false},title:{visible:false},interaction:{selectability:{mode:"MULTIPLE"},enableDeselectAll:false}};}else{v={general:{background:{color:"transparent"},layout:{padding:0}},plotArea:{colorPalette:["#006ca7"],dataLabel:{formatString:this._formattingId,visible:true,position:"inside"},gridline:{visible:false},background:{color:"transparent"}},valueAxis:{visible:false},categoryAxis:{title:{visible:false},axisTick:{visible:false},hoverShadow:{color:"transparent"},label:{angle:0,rotation:"auto"}},tooltip:{visible:false},title:{visible:false},interaction:{selectability:{mode:"MULTIPLE"},enableDeselectAll:false}};}return v;};e.prototype._getDataSet=function(f,s,g,m,h,i){var j=this;var k=this.getFixedCount();var l=this.getDimensionFieldIsDateTime();var n=new F({data:{path:"/"+f,startIndex:0,length:k,sorter:this._sorters,filters:g,parameters:{select:s.join(",")},events:{dataReceived:function(p){j._onDataReceived(p);}}},dimensions:new D({name:i,value:"{"+h+"}",displayValue:{parts:[i,m],formatter:function(p,q){var n=j.getDataset();if(!n)return"";var r=n.getBinding("data");if(!r)return"";r.getContexts(0,k);return"";}},dataType:l?"date":"string"}),measures:[new M({name:m,value:"{"+m+"}"})]});var o=n.getBinding("data");if(o)o.getContexts(0,k);return n;};e.prototype._getChartDataSet=function(f,g,m,h,i){var j=this.getDimensionFieldIsDateTime();var k=new F({data:{path:"/"+f},dimensions:new D({name:i,value:"{"+h+"}",displayValue:{parts:[i],formatter:function(l){return l&&typeof l=="string"&&l.indexOf("__DUMMY_")==0?"":l;}},dataType:j?"date":"string"}),measures:[new M({name:m,value:"{"+m+"}"})]});return k;};e.prototype._onDataReceived=function(f){var g=this.getDataset();if(!g)return;var p=this._propsToCopy();var h=[];var k=this.getFixedCount();var l=g.getBinding("data").getContexts(0,k);for(var i=0;i<l.length;i++){var m=l[i];var r={};for(var j=0;j<p.length;j++){var n=p[j];r[n]=m.getObject(n);}h.push(r);}if(this._generateFiller){if(this.getDimensionFieldIsDateTime())h=this._generateDateTimeFiller(l,h,k);else h=this._generateStringFiller(l,h,k);}this._adjustMinMax(h);var o={};var q=this.getEntitySet();o[q]=h;this._chart.setModel(new J(o));d.prototype._onDataReceived.apply(this,arguments);this._chart.rerender();};e.prototype._adjustMinMax=function(f){var m=this.getMeasureField();var g=0;var h=100;for(var i=0;i<f.length;i++){var r=f[i];var v=parseFloat(r[m]);if(isNaN(v))v=0;if(i==0){g=h=v;}else{g=Math.min(g,v);h=Math.max(h,v);}}var j=parseInt(this.getHeight(),10)*0.4;var k=h-g;var l=2;if(k!=0){var p=(j-2*l)/j;var n=(k-k*p)/2;g-=n;h+=n;}this._chart.setVizScales([{feed:"valueAxis",min:g,max:h}]);};e.prototype._propsToCopy=function(){var p=[this.getDimensionField(),this.getDimensionFieldDisplay(),this.getMeasureField(),this.getUnitField()];return p;};e.prototype._generateDateTimeFiller=function(f,g,h){var j=this.getDimensionField();var p=this._getPeriodIncrementFn();var k=new Date();k=new Date(k.getUTCFullYear(),k.getUTCMonth(),k.getUTCDate());var l=k;var m=k;var r=0;var n=[];for(var i=0;i<h;i++){var o=null;if(r<g.length){var q=g[r][j];if(k.getUTCFullYear()==q.getUTCFullYear()&&k.getUTCMonth()==q.getUTCMonth()&&k.getUTCDate()==q.getUTCDate()){o=g[r];g[r][j]=new Date(q.getUTCFullYear(),q.getUTCMonth(),q.getUTCDate());r++;}}if(!o){o=this._createDummyRowDate(k);}n.splice(0,0,o);m=k;k=p.apply(this,[k]);}var s=p.apply(this,[l,true]);var o=this._createDummyRowDate(s);n.splice(0,0,o);var t=p.apply(this,[m,false,true]);var o=this._createDummyRowDate(t);n.push(o);return n;};e.prototype._createDummyRowDate=function(f){var p=this._propsToCopy();var g=this.getDimensionField();var h=this.getDimensionFieldDisplay();var m=this.getMeasureField();var r={};for(var j=0;j<p.length;j++){var i=p[j];r[i]="";}r[g]=f;r[h]=f;r[m]=null;return r;};e.prototype._getPeriodIncrementFn=function(){var f=this.getMeasureSortDescending();var g=function(h,o,H){var m=h.getTime();var i=(f?-1:1);if(o)i*=-1;m=m+i*(H?86400000/4:86400000);return new Date(m);};return g;};e.prototype._generateStringFiller=function(f,g,h){var p=this._propsToCopy();var k=this.getDimensionField();for(var i=f.length;i<h;i++){var r={};for(var j=0;j<p.length;j++){var l=p[j];r[l]="";}r[k]="__DUMMY_"+i;g.splice(0,0,r);}return g;};return e;},true);
