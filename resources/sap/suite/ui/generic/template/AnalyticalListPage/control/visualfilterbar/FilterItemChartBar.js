sap.ui.define(["sap/viz/ui5/controls/VizFrame","sap/viz/ui5/data/FlattenedDataset","sap/viz/ui5/data/DimensionDefinition","sap/viz/ui5/data/MeasureDefinition","sap/viz/ui5/controls/common/feeds/FeedItem","sap/viz/ui5/format/ChartFormatter","sap/viz/ui5/api/env/Format","sap/ui/model/Sorter","sap/suite/ui/generic/template/AnalyticalListPage/control/visualfilterbar/FilterItemChart","sap/ui/model/json/JSONModel"],function(V,F,D,M,a,C,b,S,c,J){"use strict";var d=c.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemChartBar",{metadata:{properties:{labelWidthPercent:{type:"float",group:"Misc",defaultValue:1/3},fixedCount:{type:"int",defaultValue:3}},aggregations:{dataset:{type:"sap.viz.ui5.data.Dataset",multiple:false}}},renderer:{}});d.prototype.init=function(){this._chart=new V({vizType:"bar",legendVisible:false});this.setControl(this._chart);this._chart.setModel(new J());this._sorters=[];c.prototype.init.apply(this,arguments);};d.prototype._updateBinding=function(){var e=this.getEntitySet();var f=this.getDimensionField();var g=this.getDimensionFieldDisplay();var m=this.getMeasureField();var u=this.getUnitField();var h=this.getDimensionFilterExternal();var s=[],i=[];s=this.getSortOrder();var o=c._getSorter(s);this._sorters=o.sorter;i=o.sortFields;if(!e||!m||!f||!g)return;var v={general:{background:{color:"transparent"}},plotArea:{colorPalette:["#006ca7"],dataLabel:{formatString:this._formattingId,visible:true,position:"inside"},gridline:{visible:false},background:{color:"transparent"},gap:{barSpacing:0.5}},valueAxis:{visible:false},categoryAxis:{title:{visible:false},axisTick:{visible:false},axisLine:{visible:false},hoverShadow:{color:"transparent"},layout:{width:this.getLabelWidthPercent()}},tooltip:{visible:false},title:{visible:false},interaction:{selectability:{mode:"MULTIPLE"},enableDeselectAll:false}};if(JSON.stringify(v)!=JSON.stringify(this.lastVizProps))this._chart.setVizProperties(v);this.lastVizProps=v;var j=this._chart.getFeeds();var k=true;if(j&&j.length==2){var l=j[0];var n=j[1];k=l.getValues()!=g||n.getValues()!=m;}var p=[g],q=[m];if(k){this._chart.removeAllFeeds();this._chart.addFeed(new a({"uid":"categoryAxis","type":"Dimension","values":p}));this._chart.addFeed(new a({"uid":"valueAxis","type":"Measure","values":q}));}var r=[m,f,i];if(f!=g)r.push(g);if(u)r.push(u);var t=[];if(h&&h.aFilters&&h.aFilters.length>0)t=[h];this.setDataset(this._getDataSet(e,r,t,m,f,g));this._chart.setDataset(this._getChartDataSet(e,t,m,f,g));this._applyDimensionFilter();this._chart.setBusy(true);};d.prototype._getDataSet=function(e,s,f,m,g,h){var i=this;var j=this.getFixedCount();var k=new F({data:{path:"/"+e,startIndex:0,length:j,sorter:this._sorters,filters:f,parameters:{select:s.join(",")},events:{dataReceived:function(n){i._onDataReceived(n);}}},dimensions:new D({name:h,value:"{"+g+"}",displayValue:{parts:[h,m],formatter:function(n,o){var k=i.getDataset();if(!k)return"";var p=k.getBinding("data");if(!p)return"";p.getContexts(0,j);return"";}}}),measures:[new M({name:m,value:"{"+m+"}"})]});var l=k.getBinding("data");if(l)l.getContexts(0,j);return k;};d.prototype._getChartDataSet=function(e,f,m,g,h){var i=new F({data:{path:"/"+e},dimensions:new D({name:h,value:"{"+g+"}",displayValue:{parts:[h],formatter:function(j){var j=j instanceof Date?j.toDateString():j;return j&&typeof j=="string"&&j.indexOf("__DUMMY_")==0?"":j;}}}),measures:[new M({"name":m,"value":"{"+m+"}"})]});return i;};d.prototype._onDataReceived=function(e){var f=this.getDataset();if(!f)return;var g=this.getDimensionField();var h=this.getDimensionFieldDisplay();var p=[g,h,this.getMeasureField(),this.getUnitField()];var k=[];var l=this.getFixedCount();var m=f.getBinding("data").getContexts(0,l);for(var i=0;i<m.length;i++){var n=m[i];var r={};for(var j=0;j<p.length;j++){var o=p[j];r[o]=n.getObject(o);}k.push(r);}for(var i=m.length;i<l;i++){var r={};for(var j=0;j<p.length;j++){var o=p[j];r[o]="";}r[g]="__DUMMY_"+i;k.push(r);}var q={};var s=this.getEntitySet();q[s]=k;this._chart.setModel(new J(q));c.prototype._onDataReceived.apply(this,arguments);this._chart.rerender();};return d;},true);
