sap.ui.define(["sap/suite/ui/commons/HeaderContainer","sap/suite/ui/generic/template/AnalyticalListPage/controller/VisualFilterDialogController","sap/suite/ui/commons/HeaderCell","sap/suite/ui/commons/HeaderCellItem","sap/m/Label","sap/ui/comp/odata/ODataModelUtil","sap/ui/comp/smartfilterbar/FilterProvider","sap/suite/ui/generic/template/AnalyticalListPage/control/visualfilterbar/VisualFilterProvider","sap/ui/comp/smartvariants/PersonalizableInfo","sap/ui/comp/smartvariants/SmartVariantManagement","sap/ui/model/Filter","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/m/Link","sap/ui/comp/odata/MetadataAnalyser","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms"],function(H,V,a,b,L,O,F,c,P,S,d,e,T,f,M,g,h){"use strict";var k=H.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.SmartVisualFilterBar",{metadata:{properties:{entitySet:{type:"string",group:"Misc",defaultValue:null},config:{type:"object",group:"Misc",defaultValue:null},persistencyKey:{type:"string",group:"Misc",defaultValue:null}},associations:{smartVariant:{type:"sap.ui.core.Control",multiple:false}},events:{filterChange:{}}},renderer:{}});k.prototype.init=function(){if(H.prototype.init)H.prototype.init.apply(this,arguments);this.labelHeight=2.0;this.compHeight=7.9;this.cellHeightPadding=1;this.cellHeight=(this.labelHeight+this.compHeight+this.cellHeightPadding)+"rem";this.cellWidth=320;this._dialogFilters={};this._compactFilters={};this._oVariantConfig={};this._smartFilterContext;this.addStyleClass("sapSuiteVisualFilterBar");};k.prototype.propagateProperties=function(){H.prototype.propagateProperties.apply(this,arguments);this._initMetadata();};k.prototype._initMetadata=function(){if(!this.bIsInitialised)O.handleModelInit(this,this._onMetadataInit);};k.prototype._onMetadataInit=function(){if(this.bIsInitialised)return;this._annoProvider=this._createVisualFilterProvider();if(!this._annoProvider)return;this.bIsInitialised=true;this._updateFilterBar();};k.prototype._createVisualFilterProvider=function(){var m=this.getModel();var i=this.getEntitySet();if(!m||!i)return null;return new c(this);};k.prototype._getBasicGroupTitle=function(){return this.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE");};k.prototype._getFieldGroupForProperty=function(E,C){return this._annoProvider?this._annoProvider._getFieldGroupForProperty(E,C):undefined;};k.prototype._getGroupList=function(){return this._annoProvider?this._annoProvider.getGroupList():[];};k.prototype._getGroupMap=function(){return this._annoProvider?this._annoProvider.getGroupMap():{};};k.prototype._getMeasureMap=function(){return this._annoProvider?this._annoProvider.getMeasureMap():{};};k.prototype._getDimensionMap=function(){return this._annoProvider?this._annoProvider.getDimensionMap():{};};k.prototype.setSmartFilterContext=function(C){this._smartFilterContext=C;};k.prototype._updateFilterBar=function(){var i=this._getAnnotationSettings();if(i&&i.filterList){var j=this._convertSettingsToConfig(i);}else{this.setConfig({filterCompList:[]});return;}var v=this._getVariantConfig();if(v&&v.config){j.filterCompList.forEach(function(l){if(v.config[l.component.properties.parentProperty]){jQuery.extend(true,l,v.config[l.component.properties.parentProperty]);}});this._oVariantConfig=j;return;}this.setConfig(j);return;};k.prototype._getAnnotationSettings=function(){return this._annoProvider?this._annoProvider.getVisualFilterConfig():null;};k.prototype._convertSettingsToConfig=function(s,I){var l={filterCompList:[]};var m=this._getGroupList();var n={};for(var i=0;i<m.length;i++){var o=m[i];for(var j=0;j<o.fieldList.length;j++){var p=o.fieldList[j];n[p.name]={name:o.name,label:o.label};}}var q=this._getGroupMap();var r=q["_BASIC"];var t=[];if(r&&r.fieldList){for(var i=0;i<r.fieldList.length;i++)t.push(r.fieldList[i].name);}var u=this._getMeasureMap(),v=s.filterList,w={};for(var i=0;i<v.length;i++){var x=v[i];var y=x.dimension.field;var z=u[x.collectionPath][x.measure.field];var A=false;if(z.fieldInfo[h.ISOCurrency]){A=true;}var C={shownInFilterBar:x.selected,component:{type:x.type,properties:{sortOrder:x.sortOrder,measureField:x.measure.field,parentProperty:x.parentProperty?x.parentProperty:undefined}}};if(!I){var B={shownInFilterDialog:x.selected||t.indexOf(y)!=-1,cellHeight:this.cellHeight,group:n[x.parentProperty],component:{cellHeight:this.compHeight+"rem",properties:{scaleFactor:x.scaleFactor,filterRestriction:x.filterRestriction,width:this.cellWidth+"px",height:this.compHeight+"rem",entitySet:x.collectionPath?x.collectionPath:this.getEntitySet(),dimensionField:y,dimensionFieldDisplay:x.dimension.fieldDisplay,dimensionFilter:x.dimensionFilter,measureSortDescending:x.measure.descending===true||x.measure.descending=="true",unitField:z?z.fieldInfo.unit:"",isCurrency:A,isMandatory:x.isMandatory,outParameter:x.outParameter?x.outParameter:undefined,inParameters:x.inParameters?x.inParameters:undefined}}};jQuery.extend(true,C,B);l.filterCompList.push(C);}else{w[x.parentProperty]=C;}}return I?w:l;};k.prototype._setVariantModified=function(){if(this._oVariantManagement)this._oVariantManagement.currentVariantSetModified(true);};k.prototype._onFilterChange=function(j){this._setVariantModified();var l=this.getItems();var m=[];for(var i=0;i<l.length;i++)m.push(l[i].getSouth().getContent());this.fireFilterChange({filterList:j.getParameter('filterList'),property:j.getParameter('property'),filterRestriction:j.getParameter('filterRestriction')});this._updateFilterItemList(m);};k.prototype._updateFilterItemList=function(j){var l=[];for(var i=0;i<j.length;i++){var m=j[i];var n=m.getDimensionFilter();if(!n)n=[];l.push({dimensionField:m.getDimensionField(),inParameters:m.getInParameters(),parentProperty:m.getParentProperty(),filterList:n,filterItem:m});}for(var i=0;i<l.length;i++){var m=l[i].filterItem;var o=this._combineFilterLists(l,i);m.setDimensionFilterExternal(o);}};k.prototype._combineFilterLists=function(i,j){var p={},l=(i.length>0&&i[j]&&i[j].inParameters)?i[j].inParameters:undefined,m=(i.length>0&&i[j]&&i[j].parentProperty)?i[j].parentProperty:undefined,n=[];var o=new sap.ui.model.Filter({aFilters:[],and:true});if(l){var r=function(t){t.sPath=v;};for(var q=(l.length-1);q>-1;q--){var s=l[q].localDataProperty,v=l[q].valueListProperty;if(s!==m&&n.indexOf(s)===-1){p=this._smartFilterContext.getFilters([s]);if(p&&p.length>0){if(p[0].aFilters){p[0].aFilters.forEach(r.bind(this));}else{r(p[0]);}n.push(s);o.aFilters.push(p[0]);}}}}return o;};k.prototype._createTitleToolbar=function(p,i){var t=new L({text:{path:"i18n>VIS_FILTER_TITLE_MD",formatter:function(){return i.getTitle();}}});var s=new f({text:{path:"_filter>/"+i.getParentProperty(),formatter:function(C){if(C){var l=0;if(typeof C==="object"){if(C.value){l++;}if(C.items){l+=C.items.length;}if(C.ranges){l+=C.ranges.length;}}else{l++;}var m=this.getModel("i18n");var r=m.getResourceBundle();return r.getText("VISUAL_FILTER_SELECTED_FILTERS",[l]);}return"";}},visible:{path:"_filter>/"+i.getParentProperty(),formatter:function(C){if(!C){return false;}if(typeof C==="object"){return(C.value||(C.items&&C.items.length)||(C.ranges&&C.ranges.length))?true:false;}else if(C){return true;}return false;}},enabled:"{= !${_templPriv>/alp/visualFilter/"+i.getParentProperty()+"/hasMultiUnit} }",press:function(l){V.launchAllFiltersPopup(s,i,l.getSource().getModel('i18n'));},layoutData:new sap.m.ToolbarLayoutData({shrinkable:false})});var j=new e({design:sap.m.ToolbarDesign.Transparent,width:this.cellWidth+"px",content:[t,new T(),s]});j.addStyleClass("alr_visualFilterTitleToolbar");return j;};k.prototype.getTitleByFilterItemConfig=function(i,u,s){var p=i.component.properties;var j=p.entitySet;var m=this.getModel();if(!m)return"";var l="/"+j+"/";var n=m.getData(l+p.measureField+"/#@sap:label");var o=m.getData(l+p.dimensionField+"/#@sap:label");if(!u)u="";if(!s)s="";var t="";var r=this.getModel("i18n").getResourceBundle();if(s&&u)t=r.getText("VIS_FILTER_TITLE_MD_UNIT_CURR",[n,o,s,u]);else if(u)t=r.getText("VIS_FILTER_TITLE_MD_UNIT",[n,o,u]);else if(s)t=r.getText("VIS_FILTER_TITLE_MD_UNIT",[n,o,s]);else t=r.getText("VIS_FILTER_TITLE_MD",[n,o]);return t;};k.prototype._onTitleChange=function(j){var s=j.getSource();var l=this.getItems();for(var i=0;i<l.length;i++){var m=l[i];var n=m.getSouth().getContent();if(n==s){var o=m.getNorth().getContent().getContent()[0];if(s.getProperty("isMandatory")){o.addStyleClass("sapMLabelRequired");}o.setText(n.getTitle());o.setTooltip(n.getTitle());break;}}};k.prototype._getSupportedFilterItemList=function(){if(!this._supportedFilterItemList){this._supportedFilterItemList=[{type:"Bar",className:"sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemChartBar",iconLink:"sap-icon://horizontal-bar-chart",textKey:"VISUAL_FILTER_CHART_TYPE_BAR"},{type:"Donut",className:"sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemChartDonut",iconLink:"sap-icon://donut-chart",textKey:"VISUAL_FILTER_CHART_TYPE_Donut"},{type:"Line",className:"sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemChartLine",iconLink:"sap-icon://line-charts",textKey:"VISUAL_FILTER_CHART_TYPE_Line"}];}return this._supportedFilterItemList;};k.prototype._getSupportedFilterItemMap=function(){if(!this._supportedFilterItemMap){this._supportedFilterItemMap={};var j=this._getSupportedFilterItemList();for(var i=0;i<j.length;i++){var l=j[i];this._supportedFilterItemMap[l.type]=l;}}return this._supportedFilterItemMap;};k.prototype.setConfig=function(j,s,l){var m=this.getProperty("config");this.setProperty("config",j);this.removeAllItems();if(!j.filterCompList){jQuery.sap.log.warning("Expecting a filterCompList as part of the configuration");return;}var n=this._getDimensionMap();var o=[];for(var i=0;i<j.filterCompList.length;i++){var p=j.filterCompList[i];if(!p.shownInFilterBar)continue;var q=p.component;q.type=this._resolveChartType(q.type);var r=jQuery.extend({},q.properties);var t=n[r.entitySet][r.dimensionField];r.dimensionFieldIsDateTime=t?t.fieldInfo.type=="Edm.DateTime":false;var u=this._createFilterItemOfType(q.type,r);u.setModel(this.getModel());u.setModel(this.getModel("_templPriv"),"_templPriv");if(u.attachFilterChange)u.attachFilterChange(this._onFilterChange,this);if(u.attachTitleChange)u.attachTitleChange(this._onTitleChange,this);var v=this._createTitleToolbar(r,u);var w=new a({height:p.cellHeight,north:new b({height:this.labelHeight+"rem",content:v}),south:new b({height:q.cellHeight,content:u})});o.push(u);this.addItem(w);}if(m&&!s){this.fireFilterChange({filterItemList:o});}if(!l){this._updateFilterItemList(o);}};k.prototype._resolveChartType=function(t){var i=this._getSupportedFilterItemMap();var j=i[t];if(!j){var l;for(l in i){j=i[l];break;}jQuery.sap.log.error("Could not resolve the filter component type: \""+t+"\", falling back to "+l);t=l;}return t;};k.prototype._createFilterItemOfType=function(t,p){var i=this._getSupportedFilterItemMap();var j=i[t];var l=j.className;jQuery.sap.require(l);var m=jQuery.sap.getObject(l);var n=new m(p);return n;};k.prototype.getConfig=function(I){var j=this.getProperty("config"),v={};if(!j)return{filterCompList:[]};var l=0;var m=this.getItems();for(var i=0;i<j.filterCompList.length;i++){var n=j.filterCompList[i];if(I){v[n.component.properties.parentProperty]={shownInFilterBar:n.shownInFilterBar,component:{type:n.component.type,properties:{measureField:n.component.properties.measureField,sortOrder:n.component.properties.sortOrder,parentProperty:n.component.properties.parentProperty}}};}else{if(!n.shownInFilterBar)continue;var o=m[l];if(!o){jQuery.sap.log.error("The configured selected filter bar items do not correspond to the actual filter bar items.  Could be an error during initialization, e.g. a chart class not found");return{filterCompList:[]};}l++;var p=o.getSouth().getContent();n.component.properties=p.getP13NConfig();}}return I?v:j;};k.prototype.setSmartVariant=function(s){this.setAssociation("smartVariant",s);if(s){var p=new P({type:"sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.SmartVisualFilterBar",keyName:"persistencyKey"});p.setControl(this);}this._oVariantManagement=this._getVariantManagementControl(s);if(this._oVariantManagement){this._oVariantManagement.addPersonalizableControl(p);this._oVariantManagement.initialise(this._variantInitialised,this);this._oVariantManagement.attachSave(this._onVariantSave,this);}else if(s){if(typeof s==="string")jQuery.sap.log.error("Variant with id="+s+" cannot be found");else if(s instanceof sap.ui.core.Control)jQuery.sap.log.error("Variant with id="+s.getId()+" cannot be found");}else{jQuery.sap.log.error("Missing SmartVariant");}};k.prototype._getVariantManagementControl=function(s){var o=null;if(s){o=typeof s=="string"?sap.ui.getCore().byId(s):s;if(o&&!(o instanceof S)){jQuery.sap.log.error("Control with the id="+s.getId?s.getId():s+" not of expected type");return null;}}return o;};k.prototype._variantInitialised=function(){if(!this._oCurrentVariant)this._oCurrentVariant="STANDARD";};k.prototype._onVariantSave=function(){if(this._oCurrentVariant=="STANDARD")this._oCurrentVariant={config:this.getConfig(true)};};k.prototype.applyVariant=function(v,C){this._oCurrentVariant=v;if(this._oCurrentVariant=="STANDARD")this._oCurrentVariant=null;if(this._oCurrentVariant&&this._oCurrentVariant.config&&this._oCurrentVariant.config.filterCompList){this._oCurrentVariant.config=null;}if(this._oCurrentVariant&&this._oCurrentVariant.config==null){var i=this._getAnnotationSettings();if(i&&i.filterList){this._oCurrentVariant.config=this._convertSettingsToConfig(i,true);}}this._updateFilterBar();if(this._oVariantManagement){this._oVariantManagement.currentVariantSetModified(false);}};k.prototype._getVariantConfig=function(){return this._oCurrentVariant;};k.prototype.fetchVariant=function(){if(!this._oCurrentVariant||this._oCurrentVariant=="STANDARD"){var i=this._getAnnotationSettings();if(i&&i.filterList){this._oCurrentVariant={config:this._convertSettingsToConfig(i,true)};return this._oCurrentVariant;}else{return{config:null};}}return{config:this.getConfig(true)};};k.prototype.clearFilters=function(){var j=this.getProperty('config');for(var i=0;i<j.filterCompList.length;i++){var l=j.filterCompList[i];l.component.properties.dimensionFilter=[];}this.setConfig(j);};k.prototype.mergeCompactFilters=function(j,I){this._compactFilters={};if(!j){return;}this._compactFilters=j;var A,D={},p=[];var C=(I&&g.readProperty(this,"_oVariantConfig.filterCompList.length"))?this._oVariantConfig:this.getConfig();if(Object.keys(C).length<0){jQuery.sap.log.error('Config not ready for visual filter');return;}if(C&&C.filterCompList.length>0){A=C.filterCompList;for(var i=0;i<A.length;i++){var o=A[i].component.properties,s=o.outParameter,l=o.parentProperty,m=[];o.dimensionFilter=[];if(s){var m=[];if(this._compactFilters[s]){p.push(s);m=this._addToFiltersFromCompact(s);}}o.dimensionFilter=m;D[l]=m;}}this.setConfig(C,true);};k.prototype._addToFiltersFromCompact=function(p){var i=[],I=this._compactFilters[p]&&(typeof this._compactFilters[p]!=='object'),l=this._compactFilters[p].items,m=this._compactFilters[p].ranges,n=this._compactFilters[p].value;if(this._compactFilters[p].low){var s=this._compactFilters[p].low;if(this._compactFilters[p].high){s+="-"+this._compactFilters[p].high;}i.push({dimValue:s,dimValueDisplay:s});}if(I){i.push({dimValue:this._compactFilters[p],dimValueDisplay:this._compactFilters[p]});}if(l){for(var j=0;j<l.length;j++){i.push({dimValue:l[j].key,dimValueDisplay:l[j].text});}}if(m){for(var j=0;j<m.length;j++){i.push({dimValue:m[j].tokenText?m[j].tokenText:g.createTitleFromCode(m[j]),dimValueDisplay:m[j].tokenText,keyField:m[j].keyField,operation:m[j].operation,tokenText:m[j].tokenText,value1:m[j].value1,value2:m[j].value2});}}if(n){i.push({dimValue:n,dimValueDisplay:n,bIsUserTypedIn:true});}return i;};return k;},true);
