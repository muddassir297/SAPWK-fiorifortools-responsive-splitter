sap.ui.define(["sap/viz/ui5/controls/VizFrame","sap/viz/ui5/controls/VizFrameRenderer","sap/viz/ui5/data/FlattenedDataset","sap/viz/ui5/data/DimensionDefinition","sap/viz/ui5/data/MeasureDefinition","sap/viz/ui5/controls/common/feeds/FeedItem","sap/viz/ui5/format/ChartFormatter","sap/viz/ui5/api/env/Format","sap/ui/model/Sorter","sap/suite/ui/generic/template/AnalyticalListPage/control/visualfilterbar/FilterItemChart","sap/ui/model/json/JSONModel"],function(V,a,F,D,M,b,C,c,S,d,J){"use strict";var e=d.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemChartDonut",{metadata:{properties:{labelWidthPercent:{type:"float",group:"Misc",defaultValue:1/2}},aggregations:{dataset:{type:"sap.viz.ui5.data.Dataset",multiple:false},totalDataset:{type:"sap.viz.ui5.data.Dataset",multiple:false}}},renderer:{}});e.prototype.init=function(){this._chart=new V({vizType:"donut",legendVisible:false});this.setControl(this._chart);this._chart.setModel(new J());this._otherField="__IS_OTHER__";this._otherID="__OTHER__";this._measureScaledField="__MEASURE_SCALED__";this._percentField="__PERCENT__";this._sorters=[];d.prototype.init.apply(this,arguments);};e.prototype._updateBinding=function(){var f=this.getEntitySet();var g=this.getDimensionField();var h=this.getDimensionFieldDisplay();var m=this.getMeasureField();var u=this.getUnitField();var i=this.getDimensionFilterExternal();var s=[],j=[];s=this.getSortOrder();var o=d._getSorter(s);this._sorters=o.sorter;j=o.sortFields;if(!f||!m||!g||!h)return;var v={general:{layout:{paddingRight:10,padding:0},background:{color:"transparent"}},legend:{visible:true,itemMargin:1.5},legendGroup:{layout:{alignment:"center",width:((this.getLabelWidthPercent()*100)+"%")}},plotArea:{innerRadiusRatio:0.65,colorPalette:["#006ca7","#55A1C4","#8BBDD4"],background:{visible:false}},tooltip:{visible:false},title:{visible:false},interaction:{selectability:{mode:"MULTIPLE"},enableDeselectAll:false}};if(JSON.stringify(v)!=JSON.stringify(this.lastVizProps))this._chart.setVizProperties(v);this.lastVizProps=v;var k=this._chart.getFeeds();var l=true;if(k&&k.length==2){var n=k[0];var p=k[1];l=n.getValues()!=h||p.getValues()!=this._measureScaledField;}if(l){this._chart.removeAllFeeds();var q=[h],r=[this._measureScaledField];this._chart.addFeed(new b({"uid":"color","type":"Dimension","values":q}));this._chart.addFeed(new b({"uid":"size","type":"Measure","values":r}));}var t=[m,g,j];if(g!=h)t.push(h);if(u)t.push(u);var w=[];if(i&&i.aFilters&&i.aFilters.length>0)w=[i];this._totalReady=false;this.setDataset(this._getDataSet(f,t,w,m,g,h));this.setTotalDataset(this._getTotalDataSet(f,w,m,g,h));this._chart.setDataset(this._getChartDataSet(f,w,m,g,h));this._applyDimensionFilter();this._chart.setBusy(true);};e.prototype._getDataSet=function(f,s,g,m,h,i){var j=this;var k=4;var l=new F({data:{path:"/"+f,startIndex:0,length:k,sorter:this._sorters,filters:g,parameters:{select:s.join(",")},events:{dataReceived:function(o){j._topTwoReady=true;j._onDataReceived(o);}}},dimensions:new D({name:i,value:"{"+h+"}",displayValue:{parts:[i,m],formatter:function(o,p){var l=j.getDataset();if(!l)return"";var q=l.getBinding("data");if(!q)return"";q.getContexts(0,k);return"";}}}),measures:[new M({name:m,value:m})]});var n=l.getBinding("data");if(n)n.getContexts(0,k);return l;};e.prototype._getTotalDataSet=function(f,g,m,h,i){var j=this;var k=1;var t=new F({data:{path:"/"+f,startIndex:0,length:k,filters:g,parameters:{select:m},events:{dataReceived:function(n){j._onTotalReceived(n);}}},dimensions:new D({name:i,value:"{"+h+"}",displayValue:{parts:[i,m],formatter:function(n,o){var t=j.getTotalDataset();if(!t)return"";var p=t.getBinding("data");if(!p)return"";p.getContexts(0,k);return"";}}}),measures:[new M({name:m,value:m})]});var l=t.getBinding("data");if(l)l.getContexts(0,k);return t;};e.prototype._getChartDataSet=function(f,g,m,h,i){var j=this;var k=3;var l=new F({data:{path:"/"+f},dimensions:new D({name:i,value:"{"+h+"}",displayValue:{parts:[i,this._percentField],formatter:function(n,p){var l=j._chart.getDataset();if(!l)return"";var o=l.getBinding("data");if(!o)return"";o.getContexts(0,k);return n+": "+p+"%";}}}),measures:[new M({name:this._measureScaledField,value:{path:this._measureScaledField,formatter:function(v){return v;}}})]});return l;};e.prototype._getMaxScaleFactor=function(f,g){var m;for(var i=0;i<f.length;i++){var h=f[i];var v=Math.abs(parseFloat(h.getObject(g)));m=i==0?v:Math.max(m,v);}return this._getScaleFactor(m);};e.prototype._onDataReceived=function(f){if(f.getParameter('data').results.length===0){this._chart.setBusy(false);return;}if(!(this._totalReady&&this._topTwoReady))return;var g=this.getDataset();var t=this.getTotalDataset(t);if(!g||!t)return;var h=this.getDimensionField();var k=this.getDimensionFieldDisplay();var m=this.getMeasureField();var u=this.getUnitField();var p=[h,k,m,u];var l=[];var n=t.getBinding("data").getContexts(0,1);if(n.length!=1)return;var o=n[0];var q=g.getBinding("data").getContexts();var r=q.length>3?2:q.length;var s=parseFloat(o.getObject(m));var v=parseFloat(o.getObject(m));var w=0;for(var i=0;i<r;i++){var x=q[i];var y={};for(var j=0;j<p.length;j++){var z=p[j];y[z]=x.getObject(z);if(z==m){y[this._measureScaledField]=y[z];}}l.push(y);w+=parseFloat(y[this._measureScaledField]);s-=parseFloat(y[m]);}if(q.length>3){var A=this.getModel("i18n");var y={};y[this._otherField]=true;y[h]=this._otherID;y[k]=A?A.getResourceBundle().getText("VIS_FILTER_DONUT_OTHER"):"";y[m]=s;y[this._measureScaledField]=v-w;y[u]="";l.push(y);}var B=sap.ui.core.format.NumberFormat.getFloatInstance({style:"short",minFractionDigits:this._minFractionalDigits,maxFractionDigits:this._maxFractionalDigits});for(var i=0;i<l.length;i++){var E=l[i][this._measureScaledField]/v*100;l[i][this._percentField]=B.format(E);}if(l){this._determineUnit(l);}var G={};var H=this.getEntitySet();G[H]=l;this._chart.setModel(new J(G));d.prototype._onDataReceived.apply(this,arguments);this._totalReady=false;this._topTwoReady=false;this._chart.rerender();};e.prototype._getScaledValue=function(v,s,k){var f=this._maxFractionalDigits*10;var g=k?parseFloat(v):Math.abs(parseFloat(v));var h=Math.round(g*f/s)/f;return h;};e.prototype._onTotalReceived=function(f){this._totalReady=true;this._onDataReceived(f);};e.prototype._onChartSelectData=function(f){var g=this.getDimensionField();var s=this._chart.vizSelection();var h=this._chart.getDataset().getBinding("data");var r=false;var p=[];for(var i=0;i<s.length;i++){var j=s[i].data;var k=h.getContexts(j._context_row_number,1)[0].getObject();if(k[this._otherField]){r=true;s.splice(i,1);}else{var l={};l[g]=j[g];p.push({data:l});}}if(r){var m=this.getModel("i18n");var n=this.getDimensionFieldDisplay();var p=[];var l={};if(g===n){l[g]=m?m.getResourceBundle().getText("VIS_FILTER_DONUT_OTHER"):"";}else{l[n]=this._otherID;}p.push({data:l});this._ignoreNextSelectionChange=true;this._chart.vizSelection(p,{deselection:true});this._chart.rerender();}else{d.prototype._onChartSelectData.apply(this,arguments);}};return e;},true);
