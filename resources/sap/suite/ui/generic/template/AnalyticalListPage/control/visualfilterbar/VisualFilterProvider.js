sap.ui.define(["sap/ui/comp/odata/MetadataAnalyser","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms"],function(M,F,V){"use strict";var c=function(f){this._filter=f;this._oMetadataAnalyser=new M(f.getModel());this._groupList=[];this._groupListByName={};this._groupMap={};this._measureList=[];this._measureMap={};this._dimensionMap={};this._selectionFieldsLength=0;this._selectionFieldsParsed=0;this._annotationData={Filters:[]};this._allSelectionFields;this._initMetadata();};c.prototype._initMetadata=function(){var e=this._filter.getEntitySet();var a=this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);this._getFieldAnnotations(e,a);this._getVisualFilterAnnotation(a);};c.prototype.getVisualFilterConfig=function(){return this._filterConfig;};c.prototype._getFieldAnnotations=function(e,a){if(!e)return;var b=this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);if(!b)return;var m=this._filter.getModel();var d=m.getMetaModel();if(!a||!d)return;var g={};var f={};var h=this._oMetadataAnalyser.getFieldGroupAnnotation(b);for(var i=0;i<h.length;i++){var k=h[i];var l={name:k.groupName,label:k.groupLabel,fieldList:k.fields};f[l.name]=l;for(var j=0;j<k.fields.length;j++)g[k.fields[j]]=l;}var n=d.getODataEntityType(a);var s=n[V.SelectionFields];var o={};if(s){for(var i=0;i<s.length;i++){var p=s[i];o[p.PropertyPath]=p;}}var u={};var q=this._oMetadataAnalyser.getFieldsByEntityTypeName(b);for(var i=0;i<q.length;i++){var r=q[i];var t=r.name;var v=d.getODataProperty(n,t);var w=v["sap:aggregation-role"];if(w=="dimension"){var x={name:t,fieldInfo:r,propInfo:v};var l=g[t];if(l){for(var j=0;j<l.fieldList.length;j++){if(l.fieldList[j]==t){l.fieldList[j]=x;break;}}}else{var L=n[V.Label]?n[V.Label].String:undefined;var y=o[t]?"_BASIC":(n[L]||n.name);var l=f[y];if(!l){l={name:y,label:y=="_BASIC"?this._filter.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE"):y,fieldList:[]};f[y]=l;}l.fieldList.push(x);g[t]=l;}u[l.name]=true;}}var z=[];if(u["_BASIC"]){z.push(f["_BASIC"]);delete f["_BASIC"];}for(var i=0;i<h.length;i++){var y=h[i].groupName;if(y=="_BASIC")continue;if(u[y])z.push(f[y]);delete f[y];}for(var y in f){if(u[y])z.push(f[y]);delete f[y];}f={};for(var i=0;i<z.length;i++){var l=z[i];f[l.name]=l;}};c.prototype.getGroupList=function(){return this._groupList?this._groupList:[];};c.prototype.getGroupMap=function(){return this._groupMap?this._groupMap:{};};c.prototype.getMeasureMap=function(){return this._measureMap;};c.prototype.getDimensionMap=function(){return this._dimensionMap;};c.prototype.getEntityType=function(e){return this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);};c.prototype._updateGroupList=function(e,a,p,d){var i=function(g){return g.PropertyPath===p;};var b=this._allSelectionFields.filter(i);b=(b.length>0)?true:false;var m=this._filter.getModel().getMetaModel();var f=m.getODataEntityType(e);f=f[V.Label]?f[V.Label].String:f.name;var u=function(g,h){for(var k in h._groupList){var j=h._groupList[k],l=false;if(j.name===g){var n=j.fieldList;for(var o in n){if(n[o].name===d){l=true;}else{continue;}}if(!l){var q=m.getODataEntityType(a);var r=h._oMetadataAnalyser.getFieldsByEntityTypeName(a);for(var k in r){if(r[k].name===d){var s=m.getODataProperty(q,r[k].name);n.push({name:r[k].name,fieldInfo:r[k],propInfo:s});}}}}else{continue;}}};if(b){u('_BASIC',this);}else{u(f,this);}};c.prototype._createDimensionMap=function(e,a){var b,m=this._filter.getModel(),d=m.getMetaModel(),f,g={},p,h,i,j={};if(!d)return false;f=d.getODataEntityType(a);b=this._oMetadataAnalyser.getFieldsByEntityTypeName(a);for(var k in b){p=d.getODataProperty(f,b[k].name);if(b[k]['aggregationRole']==='dimension'){h={name:b[k].name,fieldInfo:b[k],propInfo:p};g[b[k].name]=h;}else if(b[k]['aggregationRole']==='measure'){i={name:b[k].name,label:b[k].fieldLabel,fieldInfo:b[k],propInfo:p};j[b[k].name]=i;}}if(Object.keys(g).length>0){this._dimensionMap[e]=g;}if(Object.keys(j).length>0){this._measureMap[e]=j;}};c.prototype._createGroupList=function(f,p,i,e){var g;if(i){g=this._filter.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE");this._addToGroupListByName('_BASIC',g,f,p);}else{g=e;this._addToGroupListByName(e,g,f,p);}};c.prototype._addToGroupListByName=function(g,a,f,p){if(this._groupListByName[g]===undefined){this._groupListByName[g]=[];this._groupListByName[g].push({name:g,label:a,fieldList:[]});this._groupListByName[g][0].fieldList.push({name:f.name,fieldInfo:f,propInfo:p});}else{this._groupListByName[g][0].fieldList.push({name:f.name,fieldInfo:f,propInfo:p});}};c.prototype._setGroupListForDialog=function(){if(Object.keys(this._groupListByName).length>0){for(var k in this._groupListByName){this._groupList.push(this._groupListByName[k][0]);}}var g={};for(var i=0;i<this._groupList.length;i++){var a=this._groupList[i];g[a.name]=a;}this._groupMap=g;};c.prototype._sortVisualFilter=function(d,e){if(e.filterList){e.filterList.sort(function(a,b){var I,f;if(d){for(var i=0;i<d.length;i++){if(d[i].PropertyPath===a.parentProperty){I=i;}if(d[i].PropertyPath===b.parentProperty){f=i;}if(I&&f){break;}}}if((I<f)||(!I&&a.isMandatory)){return-1;}if((I>f)||(!f&&b.isMandatory)){return 1;}return 0;});}return e;};c.prototype._getScaleFactor=function(e,a){if(a.indexOf("com.sap.vocabularies.UI.v1.DataPoint")>-1){a=a.toString();if(a.charAt(0)==="@"){a=a.slice(1);}var E=e[a];return E.ValueFormat.ScaleFactor.Decimal;}};c.prototype._getVisualFilterAnnotation=function(e){var m=this._filter.getModel();var a=m.getMetaModel();if(!e||!a)return null;var b=a.getODataEntityType(e);if(!b)return null;this._allSelectionFields=b[V.SelectionFields];var d=this._filter._smartFilterContext.getFilterBarViewMetadata(),i,f,g,G,h,v,j,k,l=[],n,p;for(var o in d){l=d[o].fields;G=d[o].groupName;for(var P in l){i=l[P].filterable;f=l[P].filterRestriction;if(f==="auto"){f="multiple";}if(f!=="interval"&&i!=="false"){n=l[P];j=l[P].fieldName;g=l[P].isMandatory;h=l[P].requiredFilterField;for(var q in l[P]){if(q.indexOf(V.ValueList)>-1&&l[P][q].PresentationVariantQualifier){k=(G==="_BASIC")||g||h;p=a.getODataProperty(b,j);v=l[P][q];this._createGroupList(n,p,k,G);this._getAnnotationFromValueList(e,k,v,j,f,g);}}}}}this._setGroupListForDialog();this._filterConfig=this._getConfig(this._annotationData);};c.prototype._getAnnotationFromValueList=function(e,i,v,p,f,I,a){var P=e;if(v!==undefined){var b={Filters:[]},d=F.readProperty(v,"PresentationVariantQualifier.String"),g=F.readProperty(v,"CollectionPath"),h=F.readProperty(v,"Parameters"),j=F.readProperty(g,"String"),P=this.getEntityType(j);if(d){var q=d,k=this._oMetadataAnalyser.getPresentationVariantAnnotation(P,q),l={},m=F.readProperty(k,"chartAnnotation.annotation.Dimensions.0.PropertyPath");if(m){this._createDimensionMap(g.String,P);this._updateGroupList(e,P,p,m);l=this._createConsumeableObjectFromAnnotation(k,g,i,h,p,f,I,a);b.Filters.push(l);this._annotationData.Filters.push(l);}}}};c.prototype._getDescendingFromSortOrder=function(s,S){var b;s.filter(function(e,i,a){if(e.Property.PropertyPath==S){b=!(e.Descending.Bool==="false");}});return b;};c.prototype._fieldExist=function(e,f){var a=this._oMetadataAnalyser.getFieldsByEntityTypeName(e);for(var i=0;i<a.length;i++){if(a[i].name===f){return true;}}return false;};c.prototype._createSortObject=function(p){var s,S={};if(p.chartAnnotation.chartType==="com.sap.vocabularies.UI.v1.ChartType/Line"){s=p.chartAnnotation.annotation.Dimensions[0].PropertyPath;}else{s=p.chartAnnotation.annotation.Measures[0].PropertyPath;}S.Field={"String":s};S.Descending={"Boolean":true};return S;};c.prototype._createSortOrderFromAnnotation=function(p,e){var a={};a.SortOrder=[];var s=p.annotation.SortOrder;if(s!==undefined&&s.length>0){for(var i=0;i<s.length;i++){var S=s[i].Property.PropertyPath;if(S){var o={};if(this._fieldExist(e,S)){o.Field={"String":S};o.Descending={"Boolean":this._getDescendingFromSortOrder(s,S)};}else{o=this._createSortObject(p);}a.SortOrder.push(o);}}}else{a.SortOrder.push(this._createSortObject(p));}return a;};c.prototype._createConsumeableObjectFromAnnotation=function(p,a,i,b,d,f,I,e){var g={};var s=p.sortOrderFields;g=this._createSortOrderFromAnnotation(p,this.getEntityType(a.String));var h=p.chartAnnotation.annotation.ChartType.EnumMember.split("/");var j=h[h.length-1];if(j){g.Type={"String":j};}var D=p.chartAnnotation.annotation.DataPoint;if(D){var k=D[0].AnnotationPath;var l=this._getScaleFactor(e,k);g.scaleFactor={"String":l};}else{g.scaleFactor={"String":undefined};}if(f){g.filterRestriction={"String":f};}else{g.filterRestriction={"String":undefined};}var m=p.chartAnnotation.annotation.Dimensions[0].PropertyPath;if(m){g.Dimensions=[];var n={};n.Field={"String":m};s.filter(function(C,E,G){if(C.name==m){n.Descending={"Boolean":C.descending};}});g.Dimensions.push(n);}var o=p.chartAnnotation.annotation.Measures[0].PropertyPath;if(o){g.Measures=[];var q={};q.Field={"String":o};var r=(p.annotation.SortOrder&&p.annotation.SortOrder.length>0)?p.annotation.SortOrder[0]:undefined;if(r){r=((r.Descending)&&(r.Descending.Boolean))?r.Descending.Boolean:undefined;}if(r){q.Descending={"Boolean":r};}else{q.Descending={"Boolean":"true"};}g.Measures.push(q);}if(i){g.Selected={"Boolean":"true"};}else{g.Selected={"Boolean":"false"};}if(a){g.CollectionPath=a;}if(b&&b.length>0){g.InParameters=[];for(var t in b){var u=b[t]?b[t]:undefined,v=(u&&u.RecordType)?u.RecordType:undefined,w=(u.ValueListProperty&&u.ValueListProperty.String)?u.ValueListProperty.String:undefined,x=(u.LocalDataProperty&&u.LocalDataProperty.PropertyPath)?u.LocalDataProperty.PropertyPath:undefined;if(u&&v&&w&&x){if(g.OutParameter===undefined&&(v===V.ValueListParameterOut||v===V.ValueListParameterInOut)&&w===m&&x===d){g.OutParameter=x;}if(v===V.ValueListParameterIn||v===V.ValueListParameterInOut){var y=this._filter.getModel().getMetaModel(),z=this.getEntityType(a.String),A=y.getODataEntityType(z),B=y.getODataProperty(A,w);if(B['sap:filterable']===undefined||B['sap:filterable']=="true"){g.InParameters.push({localDataProperty:x,valueListProperty:w});}else{jQuery.sap.log.error('IN Parameter valueListProperty: '+w+' is not sap:filterable');}}}}if(g.InParameters.length===0){g.InParameters=undefined;}}if(d){g.ParentProperty=d;}g.isMandatoryProperty=I;return g;};c.prototype._getConfig=function(a){var b={filterList:[]};if(!a)return b;var f={};var d={};var e=a.Filters;for(var i=0;i<e.length;i++){var g=e[i];var p=g.ParentProperty;var h=g.Dimensions[0].Field.String;var l=g.CollectionPath.String;var m=this._dimensionMap[l][h];if(!m){jQuery.sap.log.error("Unknown Dimension :"+h);continue;}var n=g.Measures[0].Field.String;var o=this._measureMap[l][n];if(!o){jQuery.sap.log.error("Unknown Measure :"+n);continue;}var q=m.fieldInfo.description;if(!q)q=h;if(!f[h])f[h]=[];if(!d[p])d[p]=[];var r={type:g.Type.String,selected:g.Selected.Boolean=="true",dimension:{field:h,fieldDisplay:q},measure:{field:g.Measures[0].Field.String,descending:g.Measures[0].Descending.Boolean=="true"},sortOrder:g.SortOrder,scaleFactor:g.scaleFactor.String};r.collectionPath=g.CollectionPath.String;r.outParameter=g.OutParameter;r.inParameters=g.InParameters;r.parentProperty=g.ParentProperty;r.filterRestriction=g.filterRestriction.String;r.isMandatory=g.isMandatoryProperty;d[p].push(r);f[h].push(r);}var u={};for(var i=0;i<this._groupList.length;i++){var s=this._groupList[i];for(var j=0;j<s.fieldList.length;j++){var t=s.fieldList[j];var e=d[t.name];if(!e)continue;u[s.name]=true;for(var k=0;k<e.length;k++)b.filterList.push(e[k]);}}for(var i=this._groupList.length-1;i>=0;i--){var s=this._groupList[i];if(u[s.name])continue;this._groupList.splice(i,1);delete this._groupMap[s.name];}b=this._sortVisualFilter(this._allSelectionFields,b);return b;};return c;},true);
