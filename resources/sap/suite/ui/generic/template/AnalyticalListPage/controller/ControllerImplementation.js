sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/model/json/JSONModel","sap/m/ObjectIdentifier","sap/m/Table","sap/m/Text","sap/ui/comp/smartfield/SmartField","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/base/EventProvider","sap/suite/ui/generic/template/AnalyticalListPage/extensionAPI/ExtensionAPI","sap/ui/core/ResizeHandler","sap/suite/ui/generic/template/AnalyticalListPage/controller/SmartChartController","sap/suite/ui/generic/template/AnalyticalListPage/controller/DetailController","sap/suite/ui/generic/template/AnalyticalListPage/controller/FilterBarController","sap/suite/ui/generic/template/AnalyticalListPage/controller/ToolbarController","sap/suite/ui/generic/template/AnalyticalListPage/controller/KpiTagController","sap/suite/ui/generic/template/AnalyticalListPage/control/KpiTag","sap/suite/ui/generic/template/AnalyticalListPage/controller/VisualFilterBarController","sap/suite/ui/generic/template/AnalyticalListPage/controller/VisualFilterDialogController","sap/suite/ui/generic/template/lib/MessageUtils","sap/m/MessageBox","sap/ui/table/Table","sap/ui/table/AnalyticalTable","sap/ui/model/odata/AnnotationHelper","sap/ui/model/analytics/odata4analytics","sap/suite/ui/generic/template/AnalyticalListPage/util/ModelUtil"],function(q,B,J,O,T,a,S,b,E,c,R,d,D,F,f,K,g,V,h,M,j,U,A,k,l,m){"use strict";var n="sap.suite.ui.generic.template.customData",o="sap.suite.ui.generic.template.genericData",C="chart",p="visual",r="Filter";function N(e){if(e){for(var P in e){e[P]=null;}}}return{getMethods:function(t,s){var u=new E();var v;var w={attachSearchButtonPressed:function(e,i,$){return u.attachEvent("SearchButtonPressed",e,i,$);},detachSearchButtonPressed:function(e,i){return u.detachEvent("SearchButtonPressed",e,i);},fireSearchButtonPressed:function(e){return u.fireEvent("SearchButtonPressed",e);}};function x(){var e={};e[n]={};var i=w.oController.getOwnerComponent().getModel("_templPriv");e[o]={chartVariantId:w.oSmartChart&&w.oSmartChart.getCurrentVariantId(),filterMode:i.getProperty('/alp/filterMode'),contentView:i.getProperty('/alp/contentView'),autoHide:i.getProperty('/alp/autoHide')};var $=s.byId("editStateFilter");if($){e[o].editStateFilter=$.getSelectedKey();}s.getCustomAppStateDataExtension(e[n]);return e;}function y(){var e=new b(w.oSmartFilterbar.getDataSuiteFormat());var $=s.getVisibleSelectionsWithDefaults();for(var i=0;i<$.length;i++){if(!e.getValue($[i])){e.addSelectOption($[i],"I","EQ","");}}return{selectionVariant:e.toJSONString(),tableVariantId:w.oSmartTable.getCurrentVariantId(),customData:x()};}function z(e){e=e||y();try{t.oCommonUtils.getNavigationHandler().storeInnerAppState(e);}catch(i){q.sap.log.error("AnalyticalListPage.fnStoreCurrentAppStateAndAdjustURL: "+i);}}function G(){var e=s.getOwnerComponent();var i=e.getModel("_templPriv");i.setProperty("/listReport/isLeaf",e.getIsLeaf());}function H(){var e=q.sap.getObject("sap.ushell.Container.getUser");var i=s.getOwnerComponent().getAppComponent().getMetadata().getManifestEntry("sap.ui");var $=(i&&i.icons&&i.icons.icon)||"";var _={bookmarkIcon:$,bookmarkCustomUrl:function(){z();return hasher.getHash()?("#"+hasher.getHash()):window.location.href;},bookmarkServiceUrl:function(){var b1=w.oSmartTable.getTable();var c1=b1.getBinding("rows")||b1.getBinding("items");return c1?c1.getDownloadUrl()+"&$top=0&$inlinecount=allpages":"";},isShareInJamActive:!!e&&e().isJamActive()};var a1=s.getOwnerComponent().getModel("_templPriv");a1.setProperty("/listReport/share",_);}function I(e){if(e&&e.editStateFilter!==undefined){var i=s.byId("editStateFilter");if(i){i.setSelectedKey((e.editStateFilter===null)?0:e.editStateFilter);}}var $=w.oController.getOwnerComponent().getModel("_templPriv");if(e.chartVariantId){w.oSmartChart.setCurrentVariantId(e.chartVariantId);}if(e.filterMode){$.setProperty('/alp/filterMode',e.filterMode);w.filterBarController.handleFilterSwitch(e.filterMode);}if(e.contentView){$.setProperty('/alp/contentView',e.contentView);}if(e.autoHide){$.setProperty('/alp/autoHide',e.autoHide);}}function L(e){s.restoreCustomAppStateDataExtension(e||{});}function P(e){e=e||{};if(e.hasOwnProperty(n)&&e.hasOwnProperty(o)){I(e[o]);L(e[n]);}else{if(e._editStateFilter!==undefined){I({editStateFilter:e._editStateFilter});delete e._editStateFilter;}L(e);}}var Q;function W(e,i){var $=e&&e.property;return $.filter(function(_){return typeof _[i]!=="undefined";});}function X(i){var $=i.getModel(),_=$&&$.getMetaModel(),a1=_&&_.getODataEntityType(i.getEntityType()),b1=_&&_.getODataEntityType(i.getEntityType(),true),c1=a1&&W(a1,"com.sap.vocabularies.Common.v1.FilterDefaultValue"),d1,e1,f1,g1,h1,i1,j1=[];try{e1=new l.Model(new l.Model.ReferenceByModel($));i1=e1&&e1.findQueryResultByName(i.getEntitySet());f1=i1&&i1.getParameterization();g1=f1&&_.getODataEntitySet(f1.getEntitySet().getQName());h1=g1&&_.getODataEntityType(g1.entityType);j1=h1?W(h1,"defaultValue"):[];}catch(e){q.sap.log.Error(e);}if(c1.length>0||j1.length>0){d1={"SelectionVariantID":"default","SelectOptions":[],"Parameters":[]};c1.forEach(function(k1){var l1=_.createBindingContext(b1+"/property/[${path:'name'}===\'"+k1.name+"']/com.sap.vocabularies.Common.v1.FilterDefaultValue"),m1={"PropertyName":k1.name,"Ranges":[{"Sign":"I","Option":"EQ","Low":k.format(l1),"High":null}]};d1.SelectOptions.push(m1);});j1.forEach(function(k1){var l1={"PropertyName":"$Parameter."+k1.name,"PropertyValue":k1.defaultValue};d1.Parameters.push(l1);});}return d1;}function Y(e){var i=e.getSource(),$=X(i);if($){i.setDataSuiteFormat(JSON.stringify($),true);}Q=t.oCommonUtils.getNavigationHandler().parseNavigation();s.onInitSmartFilterBarExtension(e);}function Z(){var e=w.oSmartFilterbar.isCurrentVariantStandard()?w.oController.getOwnerComponent().getDefaultFilterMode():w.oSmartFilterbar.getMode();w.filterBarController.setDefaultFilter(e);Q.done(function(_,a1,b1){if(b1!==sap.ui.generic.app.navigation.service.NavType.initial){var c1=_&&_.bNavSelVarHasDefaultsOnly;var d1=new b(_.selectionVariant);var e1=d1.getParameterNames().concat(d1.getSelectOptionsPropertyNames());for(var i=0;i<e1.length;i++){w.oSmartFilterbar.addFieldToAdvancedArea(e1[i]);}if(!c1||w.oSmartFilterbar.getCurrentVariantId()===""){w.oSmartFilterbar.clearVariantSelection();w.oSmartFilterbar.clear();w.oSmartFilterbar.setDataSuiteFormat(_.selectionVariant,true);}if(_.tableVariantId){w.oSmartTable.setCurrentVariantId(_.tableVariantId);}var f1=w.oController.getOwnerComponent().getModel("_templPriv");if(b1===sap.ui.generic.app.navigation.service.NavType.xAppState&&f1.getProperty('/alp/filterMode')===p){var g1=w.oSmartFilterbar.getFilterData();w.alr_visualFilterBar.mergeCompactFilters(g1);}P(_.customData);if(!c1){w.oSmartFilterbar.search();}}});Q.fail(function(i){if(i instanceof Error){i.showMessageBox();}});var $=w.oController.getOwnerComponent().getModel("_filter");$.setData(w.oSmartFilterbar.getFilterData());}return{onInit:function(){var e=s.getOwnerComponent();w.hideVisualFilter=e.getHideVisualFilter();w.hideVisualFilter=(w.hideVisualFilter===undefined||w.hideVisualFilter!==true)?false:true;w.oSmartFilterbar=s.byId("analyticalListPageFilter");w.oSmartTable=s.byId("table");w.oPage=s.byId("page");w.oSmartChart=s.byId("chart");w.oContentContainer=s.byId("alr_contentContainer");w.alr_chartContainer=s.byId("alr_chartContainer");w.alr_detailContainer=s.byId("alr_detailContainer");w.alr_compactFilterContainer=s.byId("alr_compactFilterContainer");w.alr_visualFilterContainer=s.byId("alr_visualFilterContainer");w.alr_visualFilterToolbar=s.byId("alr_visualFilterToolbar");w.alr_visualFilterBar=s.byId("alr_visualFilterBar");w.alp_clearButton=s.byId("alp_clearFilters");w.alr_visualFilterFiltersBtn=s.byId("alr_visualFilterFiltersButton1");w.alp_goFiltersBtn=s.byId("alp_goFilters");w.alr_filterContainer=s.byId("alr_filterContainer");w.alr_pageFooterBar=s.byId("alr_pageFooterBar");w.alr_pageVariant=e.getProperty('smartVariantManagement')||e.getProperty('smartVariantManagement')===undefined?s.byId("alrPageVariant"):null;w.oKpiTagContainer=s.byId("alrKpiTagContainer");w.chartController=new d();w.detailController=new D();w.toolbarController=new f();w.oController=s;w.filterBarController=new F();w.filterBarController.init(w);w.toolbarController.setState(w);w.chartController.setState(w);w.detailController.setState(w);K.init(w);if(!w.hideVisualFilter){w.visualFilterBarContainer=new V();w.visualFilterBarContainer.init(w);w.visualFilterDialogContainer=new h();w.visualFilterDialogContainer.init(w);}G();H();if(w.alp_goFiltersBtn){var i=e.getShowGoButtonOnFilterBar()?true:false;w.alp_goFiltersBtn.setVisible(i);}var $=e.getShowClearButtonOnFilterBar()?true:false;w.alp_clearButton.setVisible($);w.oTitle.attachEvent("_titlePress",function(){if(!w.oPage.getHeaderExpanded()){w.alr_visualFilterToolbar.addContent(w.filterSwitch);}else{w.alr_visualFilterToolbar.removeContent(w.filterSwitch);}});s.byId("template::FilterText").attachBrowserEvent("click",function(){s.byId("page").setHeaderExpanded(true);w.alr_visualFilterToolbar.addContent(w.filterSwitch);});var _=e.getModel("_templPriv");_.setProperty("/listReport/isHeaderExpanded",true);v=t.oCommonUtils.getDialogFragment("sap.suite.ui.generic.template.fragments.ShareSheet",{shareEmailPressed:function(){z();sap.m.URLHelper.triggerEmail(null,t.oCommonUtils.getText("EMAIL_HEADER",[t.oCommonUtils.getText("PAGEHEADER")]),document.URL);},shareJamPressed:function(){z();var g1=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:document.URL,share:t.oCommonUtils.getText("PAGEHEADER")}}});g1.open();}},"share",function(g1,h1){var i1=sap.ui.getCore().getLibraryResourceBundle("sap.m");h1.setProperty("/emailButtonText",i1.getText("SEMANTIC_CONTROL_SEND_EMAIL"));h1.setProperty("/jamButtonText",i1.getText("SEMANTIC_CONTROL_SHARE_IN_JAM"));h1.setProperty("/bookmarkButtonText",i1.getText("SEMANTIC_CONTROL_SAVE_AS_TILE"));var j1=q.sap.getObject("sap.ushell.Container.getUser");h1.setProperty("/jamVisible",!!j1&&j1().isJamActive());});var a1=w.oSmartTable.getTable();var b1="sapUiSizeCompact",c1="sapUiSizeCondensed";if(a1 instanceof U||a1 instanceof A){var d1=s.getView();var e1=q(document.body);if(e1.hasClass(b1)||d1.hasStyleClass(b1)){var f1=e.getComponentContainer().getSettings().condensedTableLayout;if(f1===false){w.oSmartTable.addStyleClass(b1);}else{w.oSmartTable.addStyleClass(c1);}}}},handlers:{onBack:function(){t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){window.history.back();},q.noop,w);},addEntry:function(e){var i=e.getSource();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){t.oCommonEventHandlers.addEntry(i,false,w.oSmartFilterbar);},q.noop,w);},deleteEntries:function(e){t.oCommonEventHandlers.deleteEntries(e);},onSelectionChange:function(e){var $=e.getSource(),_=$.getModel(),a1=$.getModel("_templPriv");var b1=_.getMetaModel(),c1=b1.getODataEntitySet(this.getOwnerComponent().getEntitySet()),d1=c1["Org.OData.Capabilities.V1.DeleteRestrictions"];var e1=(d1&&d1.Deletable&&d1.Deletable.Path)?d1.Deletable.Path:"";var f1=false;var g1=true;var h1=(e1&&e1!=="");var i1=t.oCommonUtils.getSelectedContexts($);if(i1.length>0){for(var i=0;i<i1.length;i++){var j1=_.getObject(i1[i].getPath());if(!(j1.IsActiveEntity&&j1.HasDraftEntity&&j1.DraftAdministrativeData&&j1.DraftAdministrativeData.InProcessByUser)){g1=false;}if(h1){if(_.getProperty(e1,i1[i])){h1=false;}}if(!g1&&!h1){f1=true;break;}}}a1.setProperty("/listReport/deleteEnabled",f1);},onChange:function(e){t.oCommonEventHandlers.onChange(e);},onSmartFieldUrlPressed:function(e){t.oCommonEventHandlers.onSmartFieldUrlPressed(e,w);},onContactDetails:function(e){t.oCommonEventHandlers.onContactDetails(e);},onSmartFilterBarInitialise:Y,onSmartFilterBarInitialized:Z,onEditStateFilterChanged:function(e){e.getSource().fireChange();},onFilterPress:function(e){w.filterBarController.showDialog();},onClearPress:function(e){w.filterBarController.clearFilters();s.onClearFilterExtension(e);},onGoPress:function(e){w.filterBarController.onGoFilter();},onSetHeaderState:function(e){w.oPage.setHeaderExpanded(!w.oPage.getHeaderExpanded());if(w.oPage.getHeaderExpanded()){e.getSource().setText(t.oCommonUtils.getText("VISUAL_FILTER_HIDE"));}else{e.getSource().setText(t.oCommonUtils.getText("VISUAL_FILTER_SHOW"));}},onVisualFilterToggle:function(e){w.alr_visualFilterBar.setVisible(!w.alr_visualFilterBar.getVisible());if(w.alr_visualFilterBar.getVisible()){e.getSource().setText(t.oCommonUtils.getText("VISUAL_FILTER_HIDE"));}else{e.getSource().setText(t.oCommonUtils.getText("VISUAL_FILTER_SHOW"));}setTimeout(function(){w.alr_visualFilterToolbar.toggleStyleClass("closed");},0);},onBeforeSFBVariantSave:function(){var e=y();if(!this.getOwnerComponent().getProperty('smartVariantManagement')){delete e.customData["sap.suite.ui.generic.template.genericData"].contentView;}w.oSmartFilterbar.setFilterData({_CUSTOM:e.customData});},onAfterSFBVariantLoad:function(){var e=w.oSmartFilterbar.getFilterData();if(e._CUSTOM!==undefined){P(e._CUSTOM);}else{var i=x();N(i[n]);N(i[o]);P(i);}z();},onBeforeRebindTable:function(e){t.oCommonEventHandlers.onBeforeRebindTable(e);s.onBeforeRebindTableExtension(e);},onBeforeRebindChart:function(e){},onShowDetails:function(e){t.oCommonEventHandlers.onShowDetails(e.getSource(),w);},onListNavigate:function(e){t.oCommonEventHandlers.onListNavigate(e.getSource(),w);},onCallActionFromToolBar:function(e){var i=t.oCommonUtils.getParentTable;t.oCommonUtils.getParentTable=function(){return w.oSmartTable;};t.oCommonEventHandlers.onCallActionFromToolBar(e,w);t.oCommonUtils.getParentTable=i;i=null;},onShowDetailsIntent:function(e){t.oCommonEventHandlers.onShowDetailsIntent(e,w.oSmartFilterbar);},onCallActionFromList:function(e){},onDataFieldForIntentBasedNavigation:function(e){t.oCommonEventHandlers.onDataFieldForIntentBasedNavigation(e,w);},onBeforeSemanticObjectLinkPopoverOpens:function(e){var i=e.getParameters();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){var $=t.oCommonUtils.getNavigationHandler();if($){var _=w.oSmartFilterbar.getDataSuiteFormat();$.processBeforeSmartLinkPopoverOpens(i,_);}else{i.open();}},q.noop,w,q.noop);},onAssignedFiltersChanged:function(e){if(e&&e.getSource()){if(w&&w.oSmartFilterbar&&w.filterBarController){s.byId("template::FilterText").setText(w.oSmartFilterbar.retrieveFiltersWithValuesAsText());}}},onToggleFiltersPressed:function(){var e=s.getOwnerComponent();var i=e.getModel("_templPriv");i.setProperty("/listReport/isHeaderExpanded",(i.getProperty("/listReport/isHeaderExpanded")===true)?false:true);},onSearchButtonPressed:function(){var e=s.getOwnerComponent().getModel();e.attachEventOnce("requestSent",function(){z();});var i=function($){M.handleError("getCollection",this,t.oServices,$.getParameters());var _=this.getView().byId("table");_.getTable().setBusy(false);M.handleTransientMessages(t.oServices.oApplication.getDialogFragmentForView.bind(null,null));}.bind(this);e.attachEvent("requestFailed",i);e.attachEventOnce("requestCompleted",function($){if($.getParameter("success")){e.detachEvent("requestFailed",i);}});w.fireSearchButtonPressed();},onSemanticObjectLinkPopoverLinkPressed:function(e){z();t.oCommonEventHandlers.onSemanticObjectLinkPopoverLinkPressed(e,w);},onAfterTableVariantSave:function(){z();},onAfterApplyTableVariant:function(){z();},onAfterChartVariantSave:function(){z();},onAfterApplyChartVariant:function(){z();},onSegmentButtonPressed:function(i){if(!i){w.oController.byId('alrPageVariant').currentVariantSetModified(true);w.oSmartFilterbar.setFilterData({_CUSTOM:x()});}z();},onShareListReportActionButtonPress:function(e){v.openBy(e.getSource());},onChartDeterminingDataFieldForAction:function(e){var i=t.oCommonUtils.getSelectedContexts(w.oSmartChart);var $=e.getSource();var _=t.oCommonUtils.getElementCustomData($);var a1=this.getView().getBindingPath();t.oCommonUtils.triggerAction(i,a1,_);},onDeterminingDataFieldForAction:function(e){var i=w.oSmartTable.getTable();var $=t.oCommonUtils.getSelectedContexts(i);if($.length===0){j.error(t.oCommonUtils.getText("ST_GENERIC_NO_ITEM_SELECTED"),{styleClass:t.oCommonUtils.getContentDensityClass()});}else{var _=e.getSource();var a1=t.oCommonUtils.getElementCustomData(_);var b1=w.oSmartTable.getTableBindingPath();t.oCommonUtils.triggerAction($,b1,a1,i);}},onDeterminingDataFieldForIntentBasedNavigation:function(e){var i=e.getSource();var $=t.oCommonUtils.getElementCustomData(i);var _=i.getParent().data(r);var a1=w.oSmartTable.getTable();var b1=t.oCommonUtils.getSelectedContexts(a1);if(_===C){b1=t.oCommonUtils.getSelectedContexts(w.oSmartChart);}var c1=!($.RequiresContext&&$.RequiresContext==="false");if(c1&&b1.length===0){j.error(t.oCommonUtils.getText("ST_GENERIC_NO_ITEM_SELECTED"),{styleClass:t.oCommonUtils.getContentDensityClass()});}else if(c1&&b1.length>1){j.error(t.oCommonUtils.getText("ST_GENERIC_MULTIPLE_ITEMS_SELECTED"),{styleClass:t.oCommonUtils.getContentDensityClass()});}else{var d1=c1?b1[0]:null;t.oCommonEventHandlers.onDataFieldForIntentBasedNavigationSelectedContext(d1,$,w);}},onAutoHideToggle:function(){w.chartController.updateTable();z();},onFullScreenToggled:function(e){var i=e.getParameter("fullScreen");var $=e.getSource().getModel("_templPriv");$.setProperty("/alp/fullScreen",i);}},extensionAPI:new c(t,s,w)};}};});
