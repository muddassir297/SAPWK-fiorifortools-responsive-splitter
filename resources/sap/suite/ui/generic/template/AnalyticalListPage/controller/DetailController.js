sap.ui.define(["sap/ui/base/EventProvider","sap/ui/comp/personalization/Util","sap/ui/table/AnalyticalTable","sap/ui/core/mvc/Controller","sap/ui/model/FilterType"],function(E,P,A,C,F){"use strict";var b=new E();var t=C.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.DetailController",{setState:function(s){var m=this;this.oState=s;this._enableExpandByFilter=true;this._enableUpdateExpandLevelInfo=false;this._isRebindTriggeredByChart=false;var a=this.oState.oSmartTable;var c=a.getTable();c.attachEvent("_rowsUpdated",function(e){m._updateRows("_rowsUpdated");});var o=this.oState.oController.getOwnerComponent();var T=this.oState.oController.getOwnerComponent().getModel("_templPriv");T.setProperty('/alp/autoHide',o.getAutoHide()?"filter":"highlight");a.attachInitialise(this._onSmartTableInit,this);a.attachBeforeRebindTable(this._onBeforeRebindTable,this);},_onSmartTableInit:function(){var s=this.oState.oSmartTable,a=s.getCustomToolbar(),T=a.getContent(),n;if(this.oState._pendingTableToolbarInit){a.insertContent(this.oState.alr_viewSwitchButtonOnTable,T.length);}if(this.oState._pendingTableToolbarInit){for(var i=0;i<T.length;i++){if(T[i].mProperties.text==="Settings"){n=i;}}a.insertContent(this.oState._autoHideToggleBtn,n);}delete this.oState._pendingTableToolbarInit;this.oState.oSmartTable.attachShowOverlay(function(e){this.oState.oSmartTable.getCustomToolbar().setEnabled(!e.getParameter("overlay").show);},this);},_onBindingDataReceived:function(){var a=this.oState.oSmartTable.getTable();if(a instanceof A){this._expandByFilter("bindingDataReceived");}if(!this.isFilter()){this._applyParamsToTableAsHighlight("bindingDataReceived");}},_onBeforeRebindTable:function(o){var v=this.oState.oSmartTable.fetchVariant(),l=v,c={};if(!v)return;if(this.isFilter())this._applyChartSelectionOnTableAsFilter(o);var g=[];var a=this.oState.oSmartTable.getTable().getColumns();for(var i=0;i<a.length;i++){var d=a[i];if(d.getGrouped&&d.getGrouped())g.push(d.getLeadingProperty?d.getLeadingProperty():P.getColumnKey(d));}this._updateExpandLevelInfo(g);var s=[];if(v.sort&&v.sort.sortItems){for(var i=0;i<v.sort.sortItems.length;i++){var f=v.sort.sortItems[i].operation==="Descending"?true:false;s.push(new sap.ui.model.Sorter(v.sort.sortItems[i].columnKey,f));}}else if(!l.sort){c.allTableSortRemoved=true;}this._isRebindTriggeredByChart=false;if(this.oState.oSmartFilterbar&&this.oState.oSmartFilterbar.getAnalyticBindingPath&&this.oState.oSmartFilterbar.getConsiderAnalyticalParameters()){try{var h=this.oState.oSmartFilterbar.getAnalyticBindingPath();if(h){this.oState.oSmartTable.setTableBindingPath(h);}}catch(e){jQuery.sap.log.warning("Mandatory parameters have no values","","AnalyticalListPage");}}this.oState.oController.onBeforeRebindTableExtension(o);},attachTableChange:function(d,f,l){return b.attachEvent("TableChange",d,f,l);},detachTableChange:function(f,l){return b.detachEvent("TableChange",f,l);},isFilter:function(){var T=this.oState.oController.getOwnerComponent().getModel("_templPriv");return T.getProperty("/alp/autoHide")==="filter";},applyParamsToTable:function(){this._isRebindTriggeredByChart=true;this.oState.oSmartTable.rebindTable();},_getBindingProperty:function(a,n){if(a.getProperty){return a.getProperty(n);}else{var p=a.oEntityType.property;for(var i=0;i<p.length;i++){if(p[i].name==n)return p[i];}return null;}},_isFilterDiff:function(f,a){if($.isArray(f)!=$.isArray(a))return true;if($.isArray(f))return this._isFilterListDiff(f,a);else return this._isFilterObjDiff(f,a);},_isFilterObjDiff:function(f,c){if(!f||!c)return true;for(var a in f){if(a=="aFilters"){if(this._isFilterListDiff(f.aFilters,c.aFilters))return true;}else if(f[a]!=c[a])return true;}return false;},_isFilterListDiff:function(l,L){if(!l||!L)return true;if(l.length!=L.length)return true;for(var i=0;i<l.length;i++){var f=l[i];var a=L[i];if(this._isFilterObjDiff(f,a))return true;}return false;},_getPageFilters:function(B){var p=this.oState.oSmartFilterbar.getFilters();for(var i=0;i<p.length;i++){if(p[i].aFilters!==undefined){var f=p[i].aFilters;for(var j=0;j<f.length;j++){var a=f[j];var n=a.sPath;if(!B.getProperty(n)){jQuery.sap.log.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}a.sPath=n;}}else{var a=p[i];var n=a.sPath;if(!B.getProperty(n)){jQuery.sap.log.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}a.sPath=n;}}return p;},_applyParamsToTableAsHighlight:function(u){if(!this.oState)return;var c=this.oState.oSmartChart.getChart();if(!c){return;}var p=this._getSelParamsFromChart(c);var d=c.getVisibleDimensions();var l=this.oState.oSmartChart._lastSelected;var a=this.oState.oSmartTable.getTable();var e=this._getTableBinding(a);if(!e){jQuery.sap.log.error("No table binding to apply the selection(s) to");return;}var f=[];for(var i=0;i<p.length;i++){var g=p[i];var h={};for(var n in g){if(d.indexOf(n)==-1||!this._getBindingProperty(e,n))continue;h[n]=g[n];}f.push(h);}var j=this.oState.oSmartChart.getDrillStackFilters();j.forEach(function(o){var n=o.sPath,m={};m[n]=o.oValue1;f.push(m);});if(!this._lastFilter){this._lastFilter=e.aApplicationFilter;}var k=this._getPageFilters(e);if(this._isFilterDiff(this._lastFilter,k)){e.filter(k,F.Application);this._lastFilter=k;}this._paramListFiltered=f;this._lastSelected=l;this._updateRows(u);},_expandByFilter:function(u){if(!this._enableExpandByFilter)return;var a=this.oState.oSmartTable.getTable();var c=this._getTableBinding(a);if(c&&this._lastBinding!=c){var m=this;c.attachDataReceived(this._onBindingDataReceived,this);c.attachEvent("change",function(g){if(m._expandingProgrammatically)return;var h=g.getParameter("reason");if(h=="expand"||h=="collapse")m._inUserChartSelectMode=false;});this._lastBinding=c;}if(u=="selection"||u=="bindingDataReceived")this._firstVisibleRelevantEventTS=new Date().getTime();if(u=="selection")this._inUserChartSelectMode=true;if(!this._inUserChartSelectMode)return;var r=this._getTableRows();for(var i=0;i<r.length;i++){var d=r[i];var e=d.getBindingContext();if(!e)continue;var f=a.getFirstVisibleRow()+i;if(this._isRowHighlighted(e.getObject())){if(a.isExpanded(f))continue;if(!d._bHasChildren)continue;if(!c.findNode(f))continue;this._expandingProgrammatically=true;a.expand(f);this._expandingProgrammatically=false;}else{if(!a.isExpanded(f))continue;if(!d._bHasChildren)continue;if(!c.findNode(f))continue;this._expandingProgrammatically=true;a.collapse(f);this._expandingProgrammatically=false;}}this._updateFirstVisibleRow(u);},_updateFirstVisibleRow:function(u){var a=this.oState.oSmartTable.getTable();var c=this._getTableBinding(a);var d=c.getTotalSize();if(d==0||(new Date().getTime()-this._firstVisibleRelevantEventTS)>250)return;var a=this.oState.oSmartTable.getTable();if(u=="selection"&&(!this._paramListFiltered||this._paramListFiltered.length==0)){a.setFirstVisibleRow(0);return;}var e=c.getContexts(0,d);for(var i=0;i<e.length;i++){var r=e[i].getObject();if(!this._isRowHighlighted(r))continue;if(this._lastSelected&&!this._rowMatch(this._lastSelected,r))continue;var l=a.getFirstVisibleRow();if(u=="selection"||this.isFilter()){a.setFirstVisibleRow(i);}else{if(i>l)a.setFirstVisibleRow(i);}break;}},_rowMatch:function(s,r){for(var n in s){if(n.indexOf("__")!=-1)continue;if(!r.hasOwnProperty(n))continue;if(s[n]!=r[n])return false;}return true;},_updateExpandLevelInfo:function(g){if(!this._enableUpdateExpandLevelInfo)return false;var T=this.oState.oSmartTable.getTable();if(!T.getNumberOfExpandedLevels)return false;var B=T.getBinding();if(!B)return false;var e=g.length;var l=false;if(e>=B.aMaxAggregationLevel.length){l=true;e=B.aMaxAggregationLevel.length-1;this.wasAtMaxLevel=true;}else{l=T.getNumberOfExpandedLevels()!=e||this.wasAtMaxLevel;this.wasAtMaxLevel=false;}if(l){if(e>=0){T.setNumberOfExpandedLevels(e);T.bindRows(T.getBindingInfo("rows"));}var a=T.getGroupedColumns();T.fireGroup({column:a[0],groupedColumns:a,type:sap.ui.table.GroupEventType.group});}return l;},_updateRows:function(u){var c=this.oState.oSmartChart.getChart();var p=this._getSelParamsFromChart(c);this._latestUpdateRow(p.length);var a=this.oState.oSmartTable.getTable();if(a instanceof A){this._expandByFilter(u);}},_getTableRows:function(){var a=this.oState.oSmartTable.getTable();if(a.getRows)return a.getRows();else return a.getItems();},_isRowHighlighted:function(r){var p=this._paramListFiltered;if(!p)return false;var m=true;for(var i=0;i<p.length;i++){var a=p[i];for(var n in a){if(!r.hasOwnProperty(n))continue;if(a[n]!=r[n]){m=false;break;}}if(m)return true;}return false;},_getTableBinding:function(a){return a.getBinding()?a.getBinding():a.getBinding("items");},_applyChartSelectionOnTableAsFilter:function(e){var f=this.oState.oSmartChart.getDrillStackFilters();e.mParameters.bindingParams.filters.push.apply(e.mParameters.bindingParams.filters,f);var c=this.oState.oSmartChart.getChart();if(!c){return;}var p=this._getSelParamsFromChart(c);if(p.length>0){var d=c.getVisibleDimensions();for(var i=0;i<p.length;i++){var a=p[i];for(var n in a){if(d.indexOf(n)==-1){jQuery.sap.log.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}e.mParameters.bindingParams.filters.push(new sap.ui.model.Filter({path:n,operator:sap.ui.model.FilterOperator.EQ,value1:a[n]}));}}}this._latestUpdateRow(p.length);},_latestUpdateRow:function(p){var a=this.isFilter();var r=this._getTableRows();var c=false;for(var i=0;i<r.length;i++){var d=r[i];if(!a){if(d.getBindingContext()){var e=d.getBindingContext().getObject();c=this._isRowHighlighted(e);}}var f=d.getDomRefs?d.getDomRefs(true):d.getDomRef();if(!f)continue;if(f.row)f.row.toggleClass("alr_rowHighlighted",(a&&p)?a:c);else $(f).toggleClass("alr_rowHighlighted",(a&&p)?a:c);}},_getSelParamsFromChart:function(c){var d=[];if(c._getVizFrame().vizSelection())d=c.getSelectedDataPoints().dataPoints;return this._getSelParamsFromDPList(d);},_getSelParamsFromDPList:function(d){if(!d)return[];var p=[];for(var i=0;i<d.length;i++){var a=d[i];var c=a.context;if(!c)continue;var e=c.getProperty(c.sPath);var f={};if(this._selectFilterByMeasure){for(var j=0;j<a.measures.length;j++){var n=a.measures[j];var v=e[n];f[n]=v;}}else{for(var n in e)f[n]=e[n];}p.push(f);}return p;}});return t;});
