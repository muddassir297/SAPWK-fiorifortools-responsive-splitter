// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
sap.ui.define(["sap/suite/ui/generic/template/AnalyticalListPage/util/KpiUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/suite/ui/generic/template/AnalyticalListPage/util/KpiAnnotationHelper"],function(K,V,a){"use strict";jQuery.sap.declare("sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter");sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter={};sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.formatFunctions={count:0};sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.NumberFormatFunctions={};sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.criticalityConstants={StateValues:{None:"None",Negative:"Error",Critical:"Warning",Positive:"Success"},ColorValues:{None:"Neutral",Negative:"Error",Critical:"Critical",Positive:"Good"}};function c(i,C){var S;if(C){S=C.None;if(i&&i.EnumMember){var v=i.EnumMember;if(e(v,"Negative")){S=C.Negative;}else if(e(v,"Critical")){S=C.Critical;}else if(e(v,"Positive")){S=C.Positive;}}}return S;}function e(S,i){return S&&S.indexOf(i,S.length-i.length)!==-1;}function b(v,i,n,o,t,p,C){var q={};q.EnumMember="None";if(v!==undefined){v=Number(v);if(e(i,"Minimize")||e(i,"Minimizing")){q.EnumMember="None";if(p||o){if(v<=p){q.EnumMember="Positive";}else if(v>o){q.EnumMember="Negative";}else{q.EnumMember="Critical";}}}else if(e(i,"Maximize")||e(i,"Maximizing")){q.EnumMember="None";if(t||n){if(v>=t){q.EnumMember="Positive";}else if(v<n){q.EnumMember="Negative";}else{q.EnumMember="Critical";}}}else if(e(i,"Target")){q.EnumMember="None";if(t&&p){if(v>=t&&v<=p){q.EnumMember="Positive";}else if(v<n||v>o){q.EnumMember="Negative";}else{q.EnumMember="Critical";}}}}return c(q,C);}function d(i,r,u,n){if(!i||!r){return;}i=Number(i);if(!u&&(i-r>=0)){return"Up";}if(!n&&(i-r<=0)){return"Down";}if(r&&u&&(i-r>=u)){return"Up";}if(r&&n&&(i-r<=n)){return"Down";}}function f(v,n,S,u){var i=true;var o=K.formatNumberForPresentation(v,i,n,S);return o+" "+(u?u:"");}function g(i,n,t,S,u){var o=true;if(!i){return;}i=Number(i);var D=i-t;var p=K.formatNumberForPresentation(D,o,n,S);return p+" "+(u?u:"");}function h(v,r,i){if(!r){return;}r=Number(r);if(i){return r+"%";}return r;}function j(v,t,n,S,u){var i=true;if(!t){return;}else{t=Number(t);var o=K.formatNumberForPresentation(t,i,n,S);return o+" "+(u?u:"");}}sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.resolvePathForKpiTargetValue=function(C,D){if(!D||!D.Value||!D.TargetValue){return"";}var S=C.getSetting("settings").getData();var v=K.getPathOrPrimitiveValue(D.Value);var t=K.getPathOrPrimitiveValue(D.TargetValue);var M=C.getSetting("dataModel");var o=M.getMetaModel();var E=o.getODataEntitySet(S.entitySet);var i=o.getODataEntityType(E.entityType);var n=o.getODataProperty(i,D.Value.Path);var u=K.getUnitofMeasure(S.model,n);var I=K.isBindingValue(t);var p=K.isBindingValue(v);var q=0;var r;if(D.ValueFormat){q=K.getPathOrPrimitiveValue(D.ValueFormat.NumberOfFractionalDigits);r=K.getPathOrPrimitiveValue(D.ValueFormat.ScaleFactor);}var w=K.isBindingValue(u);var x=false;var P="parts: ["+(p?v:"{path: 'DUMMY'}");P+=I?","+t:"";P+=w?","+u:"";P+="]";if(u==="%"){x=true;}if(q===""||q===undefined){q=0;if(x){q=1;}}r=r==""?undefined:r;var y=function(){var z=1;if(x){return j(p?arguments[0]:v,I?arguments[z++]:t,q,r,w?arguments[z++]:u);}else{return j(p?arguments[0]:v,I?arguments[z++]:t,q,r);}};var F=s(y,"formatReferenceValueCalculation");return"{"+P+", formatter: '"+F+"'}";};sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.resolvePathForKpiReferenceValue=function(C,D){var v=K.getPathOrPrimitiveValue(D.Value);var r=K.getPathOrPrimitiveValue(D.TrendCalculation.ReferenceValue);var i=K.isRelative(D);var I=K.isBindingValue(r);var p="parts: ["+v;p+=I?","+r:"";p+="]";var n=function(){var o=1;return h(arguments[0],I?arguments[o++]:r,i);};var F=s(n,"formatReferenceValueCalculation");return"{"+p+", formatter: '"+F+"'}";};sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.resolvePathForKpiValue=function(C,D){if(!D||!D.Value){return"";}var S=C.getSetting("settings").getData();var M=C.getSetting("dataModel");var o=M.getMetaModel();var E=o.getODataEntitySet(S.entitySet);var i=o.getODataEntityType(E.entityType);var n=o.getODataProperty(i,D.Value.Path);var u=K.getUnitofMeasure(S.model,n);var S=C.getSetting("settings").getData();var v=K.getPathOrPrimitiveValue(D.Value);var I=K.isBindingValue(u);var p=K.isBindingValue(v);var P="parts: ["+(p?v:"{path: 'DUMMY'}");P+=I?","+u:"";P+="]";var q=false;if(u==="%"){q=true;}var r=0;var t;if(D.ValueFormat){r=K.getPathOrPrimitiveValue(D.ValueFormat.NumberOfFractionalDigits);t=K.getPathOrPrimitiveValue(D.ValueFormat.ScaleFactor);}if(r===""||r===undefined){r=0;if(q){r=1;}}t=t==""?undefined:t;var w=function(){var x=1;if(q){return f(p?arguments[0]:v,r,t,I?arguments[x++]:u);}else{return f(p?arguments[0]:v,r,t);}};var F=s(w,"formatFieldWithScaleCalculation");return"{"+P+", formatter: '"+F+"'}";};sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.resolveKpiHeaderState=function(C,D){return k(C,D,sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.criticalityConstants.ColorValues);};sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.resolvePathForDeviation=function(C,D){if(!D||!D.Value||!D.TargetValue){return"";}var S=C.getSetting("settings").getData();var v=K.getPathOrPrimitiveValue(D.Value);var t=K.getPathOrPrimitiveValue(D.TargetValue);var M=C.getSetting("dataModel");var o=M.getMetaModel();var E=o.getODataEntitySet(S.entitySet);var i=o.getODataEntityType(E.entityType);var n=o.getODataProperty(i,D.Value.Path);var u=K.getUnitofMeasure(S.model,n);var I=K.isBindingValue(t);var p=K.isBindingValue(u);var q=K.isBindingValue(v);var r=false;var w=0;var x;if(D.ValueFormat){w=K.getPathOrPrimitiveValue(D.ValueFormat.NumberOfFractionalDigits);x=K.getPathOrPrimitiveValue(D.ValueFormat.ScaleFactor);}var P="parts: ["+(q?v:"{path: 'DUMMY'}");P+=I?","+t:"";P+=p?","+u:"";P+="]";if(u==="%"){r=true;}if(w===""||w===undefined){w=0;if(r){w=1;}}x=x==""?undefined:x;var y=function(){var z=1;if(r){return g(q?arguments[0]:v,w,I?arguments[z++]:t,x,p?arguments[z++]:u);}else{return g(q?arguments[0]:v,w,I?arguments[z++]:t,x);}};var F=s(y,"formatDeviationCalculation");return"{"+P+", formatter: '"+F+"'}";};sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.resolvePathForTrendIcon=function(C,D){if(!D||!D.Value||!D.Value.Path||!D.TrendCalculation){return"";}if(D.Trend){var t=K.getPathOrPrimitiveValue(D.Trend);return t;}var v=K.getPathOrPrimitiveValue(D.Value);var r=K.getPathOrPrimitiveValue(D.TrendCalculation.ReferenceValue);var i=K.getPathOrPrimitiveValue(D.TrendCalculation.DownDifference);var u=K.getPathOrPrimitiveValue(D.TrendCalculation.UpDifference);var I=K.isBindingValue(r);var n=K.isBindingValue(i);var o=K.isBindingValue(u);var p="parts: ["+v;p+=I?","+r:"";p+=n?","+i:"";p+=o?","+u:"";p+="]";var q=function(){var w=1;return d(arguments[0],I?arguments[w++]:r,n?arguments[w++]:i,o?arguments[w++]:u);};var F=s(q,"formatTrendDirection");return"{"+p+", formatter: '"+F+"'}";};sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.formatDPTitle=function(C,D){var S=C.getSetting("settings").getData();var M=C.getSetting("dataModel");var o=M.getMetaModel();var E=o.getODataEntitySet(S.entitySet);var i=o.getODataEntityType(E.entityType);var n=o.getODataProperty(i,D.Value.Path);var t=K.getPathOrPrimitiveValue(D.Title);var r="",u="";if(n["Org.OData.Measures.V1.Unit"]){var U=n["Org.OData.Measures.V1.Unit"];u=K.getPathOrPrimitiveValue(U);}else if(n["Org.OData.Measures.V1.ISOCurrency"]){var p=n["Org.OData.Measures.V1.ISOCurrency"];u=K.getPathOrPrimitiveValue(p);}var q=function(w,x){x=x||t;w=w||u;var y=(u==="%");return!y?this.getModel('i18n').getResourceBundle().getText("KPI_CARD_TITLE_UNIT",[x,w]):x;};var F=s(q,"formatTitleForDP");var I=K.isBindingValue(u),v=K.isBindingValue(t);var P="["+(I?u:"{path:'DUMMY'}")+", "+(v?t:"{path: 'DUMMY'}")+"]";r="{parts: "+P+", formatter: '"+F+"'}";return r;};function k(C,D,o){var S=o.None;if(D.Criticality){var i=D.Criticality?D.Criticality.EnumMember.split("/")[1]:undefined;var I=K.isBindingValue(i);if(I){S=i;}else{S=c(D.Criticality,o);}}else if(D.CriticalityCalculation&&D.Value&&D.Value){S=l(C,D,o);}return S;}function l(C,D,o){var v=K.getPathOrPrimitiveValue(D.Value);var i=K.isBindingValue(v);var I=D.CriticalityCalculation.ImprovementDirection.EnumMember;var n=D.CriticalityCalculation.DeviationRangeLowValue?K.getPathOrPrimitiveValue(D.CriticalityCalculation.DeviationRangeLowValue):undefined;var p=D.CriticalityCalculation.DeviationRangeHighValue?K.getPathOrPrimitiveValue(D.CriticalityCalculation.DeviationRangeHighValue):undefined;var t=D.CriticalityCalculation.ToleranceRangeLowValue?K.getPathOrPrimitiveValue(D.CriticalityCalculation.ToleranceRangeLowValue):undefined;var q=D.CriticalityCalculation.ToleranceRangeHighValue?K.getPathOrPrimitiveValue(D.CriticalityCalculation.ToleranceRangeHighValue):undefined;var r=K.isBindingValue(n);var u=K.isBindingValue(p);var w=K.isBindingValue(t);var x=K.isBindingValue(q);var P="parts: ["+(i?v:"{path:'DUMMY'}");P+=r?","+n:"";P+=u?","+p:"";P+=w?","+t:"";P+=x?","+q:"";P+="]";var y=function(){var z=1;return b(i?arguments[0]:v,I,r?arguments[z++]:n,u?arguments[z++]:p,w?arguments[z++]:t,x?arguments[z++]:q,o);};var F=s(y,"formatCriticalityCalculation");return"{"+P+", formatter: '"+F+"'}";}function s(i,n){if(!sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.formatFunctions[n]){sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.formatFunctions[n]=0;}sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.formatFunctions[n]++;var F=n+sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.formatFunctions[n];sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.formatFunctions[F]=i;return"sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.formatFunctions."+F;}sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.getAggregateNumber=function(C,E,D,S,o){var i=S&&S.SelectOptions;var p;var n=",filters:";var q=[];if(i){i.forEach(function(x){p=x.PropertyName.PropertyPath;x[p].forEach(function(R){if(R.Sign.EnumMember===V.SelectionRangeSignType+"/I"){var F={path:p,operator:R.Option.EnumMember.split("/")[1],value1:R.Low.String,value2:R.High?R.High.String:""};q.push(F);}});});}var r=D.Value.Path;var t="";n+=JSON.stringify(q);var P=a.resolveParameterizedEntitySet(C.getSetting("dataModel"),E,S);t+="{path: '"+P+"',length:1";var u=o.metaModel.getODataEntityType(E.entityType,false);var v=m(r,u);var w=[];w.push(r);if(v){w.push(v);}if(D.TrendCalculation&&D.TrendCalculation.ReferenceValue&&D.TrendCalculation.ReferenceValue.Path){w.push(D.TrendCalculation.ReferenceValue.Path);}return t+", parameters:{select:'"+w.join(",")+"'}"+n+"}";};sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.getAggregateNumber.requiresIContext=true;sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.resolveKpiHeaderState.requiresIContext=true;sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.resolvePathForTrendIcon.requiresIContext=true;sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.resolvePathForKpiValue.requiresIContext=true;sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.resolvePathForDeviation.requiresIContext=true;sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.resolvePathForKpiTargetValue.requiresIContext=true;sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter.formatDPTitle.requiresIContext=true;function m(n,E){var p=E.property;for(var i=0,o=p.length;i<o;i++){if(p[i].name==n){if(p[i].hasOwnProperty("sap:unit")){return p[i]["sap:unit"];}break;}}return null;}return sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter;},true);
