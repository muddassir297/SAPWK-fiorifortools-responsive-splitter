// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/services/Message','sap/ui/base/EventProvider','sap/ushell/ui/launchpad/TileState',"sap/ushell/components/flp/launchpad/PagingManager"],function(M,E,T,P){"use strict";var g=function(m,p){return p?sap.ushell.resources.i18n.getText(m,p):sap.ushell.resources.i18n.getText(m);};var D=E.extend("sap.ushell.components.flp.launchpad.DashboardManager",{metadata:{publicMethods:["getModel","getDashboardView","loadPersonalizedGroups","attachEvent","detachEvent","attachEventOnce","createTile","deleteCatalogTileFromGroup","resetGroupsOnFailure","createGroupAndSaveTile"]},analyticsConstants:{PERSONALIZATION:"FLP: Personalization",RENAME_GROUP:"FLP: Rename Group",MOVE_GROUP:"FLP: Move Group",DELETE_GROUP:"FLP: Delete Group",RESET_GROUP:"FLP: Reset Group",DELETE_TILE:"FLP: Delete Tile",ADD_TILE:"FLP: Add Tile",MOVE_TILE:"FLP: Move Tile"},constructor:function(i,s){if(sap.ushell.components.flp.launchpad.getDashboardManager&&sap.ushell.components.flp.launchpad.getDashboardManager()){return sap.ushell.components.flp.launchpad.getDashboardManager();}sap.ushell.components.flp.launchpad.getDashboardManager=jQuery.sap.getter(this.getInterface());this.oPageBuilderService=sap.ushell.Container.getService("LaunchPage");this.oModel=s.model;this.oConfig=s.config;this.oRouter=s.router;this.oSortableDeferred=$.Deferred();this.oSortableDeferred.resolve();this.aRequestQueue=[];this.aPendingCatalogQueue=[];this.bRequestRunning=false;this.tagsPool=[];this.registerEvents();this.oTileCatalogToGroupsMap={};this.tileViewUpdateQueue=[];this.tileViewUpdateTimeoutID=0;this.oPopover=null;this.tileUuid=null;this.segmentsStore=[];this.oGroupNotLockedFilter=new sap.ui.model.Filter("isGroupLocked",sap.ui.model.FilterOperator.EQ,false);this.bLinkPersonalizationSupported=this.oPageBuilderService.isLinkPersonalizationSupported()&&window.location.search.indexOf("new_links_container=true")!==-1;if(this.oRouter){var t=this.oRouter.getTarget('home');t.attachDisplay(function(e){this.oDashboardView=e.getParameter('view');}.bind(this));}this.oModel.bindProperty("/tileActionModeActive").attachChange(this._changeLinksScope.bind(this));},createMoveActionDialog:function(i){var G=this.oGroupNotLockedFilter,m=new sap.m.SelectDialog(i,{title:sap.ushell.resources.i18n.getText('moveTileDialog_title'),rememberSelections:false,search:function(e){var v=e.getParameter("value"),f=new sap.ui.model.Filter("title",sap.ui.model.FilterOperator.Contains,v),b=e.getSource().getBinding("items");b.filter([f,G]);},contentWidth:'400px',contentHeight:"auto",confirm:function(e){var c=e.getParameter("selectedContexts");this.publishMoveActionEvents(e,c,"move"+this.tileType);}.bind(this),cancel:function(){var c=jQuery('.sapUshellTile[tabindex="0"]')[0];if(c){c.focus();}},items:{path:"/groups",filters:[G],template:new sap.m.StandardListItem({title:"{title}"})}});return m;},publishMoveActionEvents:function(e,c,m){var o=sap.ui.getCore().getEventBus();if(c.length){o.publish("launchpad",m,{sTileId:this.tileUuid,sTileType:this.tileType,toGroupId:c[0].getObject().groupId,toIndex:c[0].getObject()[this.tileType==="link"?"links":"tiles"].length,source:e.getSource().getId()});o.publish("launchpad","scrollToGroup",{groupId:c[0].getObject().groupId,groupChanged:false,focus:false});}},_changeLinksScope:function(e){var t=this;if(this.bLinkPersonalizationSupported){var i=e.getSource().getValue();this.oModel.getProperty("/groups").forEach(function(G,a){t._changeGroupLinksScope(G,i?sap.m.GenericTileScope.Actions:sap.m.GenericTileScope.Display);});}},_changeGroupLinksScope:function(G,s){var t=this;G.links.forEach(function(l,i){t._changeLinkScope(l.content[0],s);});},_changeLinkScope:function(l,s){var L=l.getScope?l:l.getContent()[0];if(this.bLinkPersonalizationSupported&&L.setScope){L.setScope(s);}},registerEvents:function(){var e=sap.ui.getCore().getEventBus();e.subscribe("launchpad","addBookmarkTile",this._createBookmark,this);e.subscribe("sap.ushell.services.Bookmark","bookmarkTileAdded",this._addBookmarkToModel,this);e.subscribe("sap.ushell.services.Bookmark","catalogTileAdded",this._refreshGroupInModel,this);e.subscribe("sap.ushell.services.Bookmark","bookmarkTileDeleted",this.loadPersonalizedGroups,this);e.subscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);e.subscribe("launchpad","createGroupAt",this._createGroupAt,this);e.subscribe("launchpad","createGroup",this._createGroup,this);e.subscribe("launchpad","deleteGroup",this._deleteGroup,this);e.subscribe("launchpad","resetGroup",this._resetGroup,this);e.subscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);e.subscribe("launchpad","moveGroup",this._moveGroup,this);e.subscribe("launchpad","deleteTile",this._deleteTile,this);e.subscribe("launchpad","movetile",this._moveTile,this);e.subscribe("launchpad","movelink",this._moveLink,this);e.subscribe("launchpad","sortableStart",this._sortableStart,this);e.subscribe("launchpad","sortableStop",this._sortableStop,this);e.subscribe("renderCatalog",this.loadAllCatalogs,this);e.subscribe("showCatalog",this.updateTilesAssociation,this);e.subscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);e.subscribe("launchpad","convertTile",this._convertTile,this);this.oPageBuilderService.registerTileActionsProvider(this._addFLPActionsToTile.bind(this));},_addFLPActionsToTile:function(t){var l=this.bLinkPersonalizationSupported&&this.oPageBuilderService.isLinkPersonalizationSupported(t),a=[];a.push(this._getMoveTileAction(t));if(l){a.push(this._getConvertTileAction(t));}return a;},_getConvertTileAction:function(t){var e=sap.ui.getCore().getEventBus();return{text:t.isLink?sap.ushell.resources.i18n.getText('ConvertToTile'):sap.ushell.resources.i18n.getText('ConvertToLink'),press:function(s){e.publish("launchpad","convertTile",s);}};},_getMoveTileAction:function(t){var a=this;return{text:sap.ushell.resources.i18n.getText('moveTileDialog_action'),press:function(){a.tileType=a.oPageBuilderService.getTileType(t);a.tileUuid=a.getModelTileById(a.oPageBuilderService.getTileId(t),a.tileType==="link"?"links":"tiles").uuid;var m=a.tileType==="tile"?a.moveTileDialog:a.moveLinkDialog;if(a.tileType==="tile"||(a.tileType==="link")){if(!m){m=a.createMoveActionDialog("move"+a.tileType+"Dialog");m.setModel(a.oModel);if(a.tileType==="tile"){a.moveTileDialog=m;}else{a.moveLinkDialog=m;}}else{m.getBinding("items").filter([a.oGroupNotLockedFilter]);}m.open();}}};},_handleTileAppearanceAnimation:function(s){var p=["webkit",""];function a(e,t){for(var i=0;i<p.length;i++){t=t.toLowerCase();s.attachBrowserEvent(p[i]+t,function(o){if(o.originalEvent&&o.originalEvent.animationName==="sapUshellTileEntranceAnimation"){s.removeStyleClass("sapUshellTileEntrance")}},false);}}a(s,"AnimationEnd");s.addStyleClass("sapUshellTileEntrance");},destroy:function(){var e=sap.ui.getCore().getEventBus();e.unsubscribe("launchpad","addBookmarkTile",this._createBookmark,this);e.unsubscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);e.unsubscribe("launchpad","createGroupAt",this._createGroupAt,this);e.unsubscribe("launchpad","createGroup",this._createGroup,this);e.unsubscribe("launchpad","deleteGroup",this._deleteGroup,this);e.unsubscribe("launchpad","resetGroup",this._resetGroup,this);e.unsubscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);e.unsubscribe("launchpad","moveGroup",this._moveGroup,this);e.unsubscribe("launchpad","deleteTile",this._deleteTile,this);e.unsubscribe("launchpad","movetile",this._moveTile,this);e.unsubscribe("launchpad","movelink",this._moveLink,this);e.unsubscribe("launchpad","sortableStart",this._sortableStart,this);e.unsubscribe("launchpad","sortableStop",this._sortableStop,this);e.unsubscribe("renderCatalog",this.loadAllCatalogs,this);e.unsubscribe("showCatalog",this.updateTilesAssociation,this);e.unsubscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);sap.ushell.components.flp.launchpad.getDashboardManager=undefined;},_refreshTiles:function(){var t=this,G=this.oModel.getProperty("/groups");jQuery.each(G,function(n,o){jQuery.each(o.tiles,function(n,a){t.oPageBuilderService.refreshTile(a.object);});});},_sortableStart:function(){this.oSortableDeferred=$.Deferred();},_createBookmark:function(c,e,d){var t=d.group?d.group.object:"";delete d.group;this._addRequest($.proxy(function(){var r=sap.ushell.Container.getService("Bookmark").addBookmark(d,t),R=sap.ushell.resources.i18n;r.always($.proxy(this._checkRequestQueue,this));r.done(function(){if(sap.ushell.Container){sap.ushell.Container.getService('Message').info(R.getText('tile_created_msg'));}});r.fail(function(m){jQuery.sap.log.error("Failed to add bookmark",m,"sap.ushell.ui.footerbar.AddBookmarkButton");if(sap.ushell.Container){sap.ushell.Container.getService('Message').error(R.getText('fail_to_add_tile_msg'));}});},this));},_addBookmarkToModel:function(c,e,d){var t=d.tile,G,o=d.group,s,a,n,i,b,N,I;if(!d||!t){this.bIsGroupsModelDirty=true;if(!this.bGroupsModelLoadingInProcess){this._handleBookmarkModelUpdate();}return;}if(!o){G=this.getModel().getProperty("/groups");for(I=0;I<G.length;I++){if(G[I].isDefaultGroup===true){o=G[I].object;break;}}}s=this.oPageBuilderService;a=s.getTileType(t);n=this._getTileModel(t,s.isGroupLocked(o),a,this._addModelToTileViewUpdateQueue);i=this._getIndexOfGroupByObject(o);b=this.oModel.getProperty("/groups/"+i);b.tiles.push(n);b.visibilityModes=sap.ushell.utils.calcVisibilityModes(b,true);N=b.tiles.length;this._updateModelWithTileView(i,N);this.oModel.setProperty("/groups/"+i,b);},_refreshGroupInModel:function(c,e,G){var l=sap.ushell.Container.getService("LaunchPage"),s='Failed to refresh group with id:'+G+' in the model',t=this;l.getGroups().fail(jQuery.sap.log.error(s,null,"sap.ushell.components.flp.launchpad.DashboardManager")).done(function(a){a.some(function(o){if(l.getGroupId(o)===G){l.getDefaultGroup().done(function(d){var i=G===d.getId()?true:false,b=t._getGroupModel(o,i),f=t._getIndexOfGroupByObject(b.object);t.oModel.setProperty("/groups/"+f,b);});return true;}});});},_sortableStop:function(){this.oSortableDeferred.resolve();},_handleAfterSortable:function(f){return $.proxy(function(){var o=Array.prototype.slice.call(arguments);this.oSortableDeferred.done(function(){f.apply(null,o);});},this);},_addRequest:function(r){this.aRequestQueue.push(r);if(!this.bRequestRunning){this.bRequestRunning=true;this.aRequestQueue.shift()();}},_checkRequestQueue:function(){if(this.aRequestQueue.length===0){this.bRequestRunning=false;}else{this.aRequestQueue.shift()();}},_requestFailed:function(){this.aRequestQueue=[];this.bRequestRunning=false;},_createGroup:function(c,e,d){var G=this._getGroupModel(null),a=this.oModel.getProperty("/groups"),m=this.oModel;m.setProperty("/groupList-skipScrollToGroup",true);window.setTimeout(function(){m.setProperty("/groups/"+a.length,G);},500);window.setTimeout(function(){m.setProperty("/groupList-skipScrollToGroup",false);},1000);},_createGroupAt:function(c,e,d){var n=parseInt(d.location,10),G=this.oModel.getProperty("/groups"),o=this._getGroupModel(null,false,n===G.length,d),m=this.oModel,i;o.index=n;G.splice(n,0,o);for(i=0;i<G.length-1;i++){G[i].isLastGroup=false;}for(i=n+1;i<G.length;i++){G[i].index++;}m.setProperty("/groups",G);},_getIndexOfGroup:function(G){var n=null,a=this.oModel.getProperty("/groups");jQuery.each(a,function(b,o){if(o.groupId===G){n=b;return false;}});return n;},_getIndexOfGroupByObject:function(G){var n=null,a=this.oModel.getProperty("/groups"),s=this.oPageBuilderService.getGroupId(G);a.every(function(m,b){var c=this.oPageBuilderService.getGroupId(m.object);if(c===s){n=b;return false;}return true;}.bind(this));return n;},_getPathOfGroup:function(G){return"/groups/"+this._getIndexOfGroup(G);},_getPathOfTile:function(t){var G=this.oModel.getProperty("/groups"),n=null,a=null,s,e=function(b,o){if(o.uuid===t){a=b;return false;}};jQuery.each(G,function(b,o){jQuery.each(o.tiles,e);if(a!==null){n=b;s="tiles";return false;}jQuery.each(o.links,e);if(a!==null){n=b;s="links";return false;}});return n!==null?"/groups/"+n+"/"+s+"/"+a:null;},_moveInArray:function(a,n,b){if(b>=a.length){var k=b-a.length;while((k--)+1){a.push(undefined);}}a.splice(b,0,a.splice(n,1)[0]);},_updateGroupIndices:function(a){var k;for(k=0;k<a.length;k++){a[k].index=k;}},_deleteGroup:function(c,e,d){var t=this,G=d.groupId,s,a=this.oModel.getProperty("/groups"),n=this._getIndexOfGroup(G),i=a.length-1===n,o=null,r,m,b,B;b=i?n-1:n;this._destroyGroupModel("/groups/"+n);o=a.splice(n,1)[0].object;if(i){this.oModel.setProperty("/groups/"+b+"/isLastGroup",i);}s=sap.ushell.Container.getService("LaunchPage").getGroupId(o);m=this.oModel;m.setProperty("/groupList-skipScrollToGroup",true);m.setProperty("/groups",a);this._updateGroupIndices(a);if(b>=0){B=sap.ui.getCore().getEventBus();window.setTimeout($.proxy(B.publish,B,"launchpad","scrollToGroup",{groupId:this.oModel.getProperty("/groups")[b].groupId}),200);}window.setTimeout(function(){m.setProperty("/groupList-skipScrollToGroup",false);},1000);this._addRequest($.proxy(function(){var f=sap.ushell.Container.getService("LaunchPage").getGroupTitle(o);try{r=this.oPageBuilderService.removeGroup(o);}catch(h){this._resetGroupsOnFailure("fail_to_delete_group_msg");return;}r.done(function(){sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(this.analyticsConstants.PERSONALIZATION,this.analyticsConstants.DELETE_GROUP,[f,s]);this._showLocalizedMessage("group_deleted_msg",[f]);}.bind(this));r.fail(this._handleAfterSortable(t._resetGroupsOnFailureHelper("fail_to_delete_group_msg")));r.always($.proxy(this._checkRequestQueue,this));},this));},_resetGroup:function(c,e,d){var t=this,G=d.groupId,n=this._getIndexOfGroup(G),o=this.oModel.getProperty("/groups/"+n),s,a,r,b;this.oModel.setProperty("/groups/"+n+"/sortable",false);a=sap.ushell.Container.getService("LaunchPage").getGroupId(o.object);s=sap.ushell.Container.getService("LaunchPage").getGroupTitle(o.object);this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.resetGroup(o.object);}catch(f){this._resetGroupsOnFailure("fail_to_reset_group_msg");return;}r.done(this._handleAfterSortable($.proxy(function(G,o,R){sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(this.analyticsConstants.PERSONALIZATION,this.analyticsConstants.RESET_GROUP,[s,a]);var n=t._getIndexOfGroup(G);this._loadGroup(n,R||o.object,this._addAndUpdateModelWithTileView);this._showLocalizedMessage("group_reset_msg",[o.title]);this.oModel.setProperty("/groups/"+n+"/sortable",true);b=sap.ui.getCore().byId('dashboardGroups').getGroupControlByGroupId(G);if(b.getBindingContext().getObject().links&&b.getBindingContext().getObject().links.length){this._changeGroupLinksScope(b.getBindingContext().getObject(),this.oModel.getProperty("/tileActionModeActive")?sap.m.GenericTileScope.Actions:sap.m.GenericTileScope.Display);}if(b){b.rerender();}},this,G,o)));r.fail(this._handleAfterSortable(t._resetGroupsOnFailureHelper("fail_to_reset_group_msg")));r.always($.proxy(this._checkRequestQueue,this));},this));},_moveGroup:function(c,e,d){var f=d.fromIndex,t=d.toIndex,G=this.oModel.getProperty("/groups"),m=this.oModel,a=this.oModel.getProperty("/tileActionModeActive"),r,o,s,b=this,i,h;if(!a){f=this._adjustFromGroupIndex(f,G);}o=G[f];s=o.groupId;if(!a){t=this._adjustToGroupIndex(t,G,s);}h=G[t].object;this._moveInArray(G,f,t);this._updateGroupIndices(G);m.setProperty("/groupList-skipScrollToGroup",true);for(i=0;i<G.length-1;i++){G[i].isLastGroup=false;}G[G.length-1].isLastGroup=true;m.setProperty("/groups",G);window.setTimeout(function(){m.setProperty("/groupList-skipScrollToGroup",false);},1000);this._addRequest($.proxy(function(){var o=this.oModel.getProperty(this._getPathOfGroup(s));try{this._getOriginalGroupIndex(h).done(function(n){r=this.oPageBuilderService.moveGroup(o.object,n);r.done(function(){sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(b.analyticsConstants.PERSONALIZATION,b.analyticsConstants.MOVE_GROUP,[o.title,f,t,s]);});r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_move_group_msg")));r.always($.proxy(this._checkRequestQueue,this));}.bind(this));}catch(j){this._resetGroupsOnFailure("fail_to_move_group_msg");return;}},this));},_adjustToGroupIndex:function(t,a,b){var v=0,I=false,i=0;for(i=0;i<a.length&&v<t;i++){if(a[i].isGroupVisible){if(a[i].groupId===b){I=true;}else{v++;}}}if(I){return i-1;}return i;},_adjustFromGroupIndex:function(a,b){var v=0,i;for(i=0;i<b.length;i++){if(b[i].isGroupVisible){v++;}if(v===a+1){return i;}}return a;},_getOriginalGroupIndexByIndex:function(n){var G=this.oModel.getProperty("/groups"),s=G[n].object;return this._getOriginalGroupIndex(s);},_getOriginalGroupIndex:function(s){var a=this.oPageBuilderService,t=this,G=this.oPageBuilderService.getGroups(),d=new jQuery.Deferred();G.done(function(b){var n=null;jQuery.each(b,function(c,o){if(a.getGroupId(o)===a.getGroupId(s)){n=c;return false;}});d.resolve(n);});G.fail(function(){t._showLocalizedErrorHelper("fail_to_load_groups_msg")();d.reject();});return d;},_changeGroupTitle:function(c,e,d){var n=d.newTitle,G=this.oModel.getProperty("/groups"),s=d.groupId,a=d.groupId,b=this._getIndexOfGroup(s),o=this.oModel.getProperty("/groups/"+b),O=o.title,r,t=this;this.oModel.setProperty("/groups/"+b+"/title",n);if(!o.object){this._addRequest($.proxy(function(){try{if(b===G.length-1){r=this.oPageBuilderService.addGroup(n,b);r.done(this._handleAfterSortable($.proxy(function(s,N){var b=this._getIndexOfGroup(s);this._loadGroup(b,N);sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(t.analyticsConstants.PERSONALIZATION,t.analyticsConstants.RENAME_GROUP,[O,n,s]);},this,s)));r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_create_group_msg")));r.always($.proxy(this._checkRequestQueue,this));}else{this._getOriginalGroupIndexByIndex(b+1).done(function(h){r=this.oPageBuilderService.addGroupAt(n,h);r.done(this._handleAfterSortable($.proxy(function(s,N){var b=this._getIndexOfGroup(s);this._loadGroup(b,N);sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(t.analyticsConstants.PERSONALIZATION,t.analyticsConstants.RENAME_GROUP,[O,n,s]);},this,s)));r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_create_group_msg")));r.always($.proxy(this._checkRequestQueue,this));}.bind(this));}}catch(f){this._resetGroupsOnFailure("fail_to_create_group_msg");return;}},this));}else{this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.setGroupTitle(o.object,n);}catch(f){this._resetGroupsOnFailure("fail_to_rename_group_msg");return;}r.done(function(){a=sap.ushell.Container.getService("LaunchPage").getGroupId(o.object);sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(t.analyticsConstants.PERSONALIZATION,t.analyticsConstants.RENAME_GROUP,[O,n,a]);});r.fail(this._handleAfterSortable($.proxy(function(s,O){var h=this._getPathOfGroup(s);this._showLocalizedError("fail_to__msg");this.oModel.setProperty(h+"/title",O);this._requestFailed();},this,s)));r.always($.proxy(this._checkRequestQueue,this));},this));}},createTile:function(d){var c=d.catalogTileContext,C=d.groupContext,G=this.oModel.getProperty(C.getPath()),s=G.groupId,r,a=jQuery.Deferred(),R={},b;b=sap.ui.getCore().getEventBus();$.proxy(b.publish,b,"launchpad","addTile",{catalogTileContext:c,groupContext:C});if(!c){jQuery.sap.log.warning("DashboardManager: Did not receive catalog tile object. Abort.",this);return;}this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.addTile(c.getProperty("src"),C.getProperty("object"));}catch(e){this._resetGroupsOnFailure("fail_to_add_tile_msg");return;}var t=this;r.done(function(o){var f=t._getPathOfGroup(s),h=sap.ushell.Container.getService("LaunchPage").getTileTitle(o);t._addTileToGroup(f,o);R={group:G,status:1,action:'add'};sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(t.analyticsConstants.PERSONALIZATION,t.analyticsConstants.ADD_TILE,[G.title,h]);a.resolve(R);}).fail(function(){R={group:G,status:0,action:'add'};a.resolve(R);}).always(function(){t._checkRequestQueue();});},this));return a.promise();},createGroup:function(t){var d=jQuery.Deferred();if(!sap.ushell.utils.validHash(t)){return d.reject({status:0,action:'createNewGroup'});}var G=this._getGroupModel(null,false,true);var a=this.oModel.getProperty("/groups");var s=G.groupId;var i=a.length;if(i>0){a[i-1].isLastGroup=false;}G.title=t;G.index=i;G.editMode=false;a.push(G);this.oModel.setProperty("/groups/",a);this._addRequest(function(t){try{var r=this.oPageBuilderService.addGroup(t);}catch(e){this._resetGroupsOnFailure("fail_to_create_group_msg");return;}r.done(this._handleAfterSortable(function(s,n){var b=this._getIndexOfGroup(s);this._loadGroup(b,n);var c=new sap.ui.model.Context(this.oModel,"/groups/"+b);d.resolve(c);}.bind(this,s)));r.fail(function(b){this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_create_group_msg"));var R={group:b.group,status:0,action:'createNewGroup'};d.resolve(R);}.bind(this));r.always($.proxy(this._checkRequestQueue,this));}.bind(this,t));return d.promise();},createGroupAndSaveTile:function(d){var c=d.catalogTileContext,n=d.newGroupName,a=jQuery.Deferred(),r={};if(sap.ushell.utils.validHash(n)&&c){this.createGroup(n).then(function(C){var p=this.createTile({catalogTileContext:c,groupContext:C});p.done(function(b){r={group:b.group,status:1,action:'addTileToNewGroup'};a.resolve(r);}).fail(function(b){r={group:b.group,status:0,action:'addTileToNewGroup'};a.resolve(r);});}.bind(this));}return a.promise();},_deleteTile:function(c,e,d){var t=this,s=d.tileId||d.originalTileId,G=this.oModel.getProperty("/groups"),i=d.items||'tiles';jQuery.each(G,function(n,o){var f=false;jQuery.each(o[i],function(a,b){if(b.uuid===s||b.originalTileId===s){t._destroyTileModel("/groups/"+n+"/"+i+"/"+a);var h=o[i].splice(a,1)[0],r,j=sap.ushell.Container.getService("LaunchPage").getTileTitle(h.object),C=sap.ushell.Container.getService("LaunchPage").getCatalogTileId(h.object),k=sap.ushell.Container.getService("LaunchPage").getCatalogTileTitle(h.object),l=sap.ushell.Container.getService("LaunchPage").getTileId(h.object),p=t.oModel.getProperty("/personalization");o.visibilityModes=sap.ushell.utils.calcVisibilityModes(o,p);t.oModel.setProperty("/groups/"+n,o);t._addRequest(function(){try{r=t.oPageBuilderService.removeTile(o.object,h.object);}catch(m){this._resetGroupsOnFailure("fail_to_remove_tile_msg");return;}r.done(t._handleAfterSortable(function(){t._showLocalizedMessage("tile_deleted_msg",[j,o.title]);sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(t.analyticsConstants.PERSONALIZATION,t.analyticsConstants.DELETE_TILE,[j||l,C,k,o.title]);}));r.fail(t._handleAfterSortable(t._resetGroupsOnFailureHelper("fail_to_remove_tile_msg")));r.always($.proxy(t._checkRequestQueue,t));});sap.ushell.utils.handleTilesVisibility();f=true;return false;}});if(f){return false;}});},_sendDeleteTileRequest:function(G,t){var r,a=sap.ushell.Container.getService('LaunchPage');try{r=a.removeTile(G,t.object);}catch(e){jQuery.sap.log.error("deleteCatalogTileFromGroup ; removeTile ; Exception occurred: "+e);}return r;},deleteCatalogTileFromGroup:function(d){var t=this,s=decodeURIComponent(d.tileId),G=d.groupIndex,o=this.oModel.getProperty("/groups/"+G),a=sap.ushell.Container.getService("LaunchPage"),b=jQuery.Deferred(),c=[],f,p,e;f=o.tiles.filter(function(h){var i=a.getCatalogTileId(h.object);if(i!==s){return true;}else{p=jQuery.Deferred();e=t._sendDeleteTileRequest(o.object,h);e.done((function(b){return function(){b.resolve({status:true});};})(p));e.fail((function(b){return function(){b.resolve({status:false});};})(p));c.push(p);return false;}});o.tiles=f;o.visibilityModes=sap.ushell.utils.calcVisibilityModes(o,true);jQuery.when.apply(jQuery,c).done(function(r){var S=true,i=0,h=c.length;for(i;i<h;i++){if(!r.status){S=false;break;}}if(S){t.oModel.setProperty("/groups/"+G,o);}b.resolve({group:o,status:S,action:'remove'});});return b.promise();},_convertTile:function(c,e,s){var G=s.getParent().getBindingContext().getObject(),S=G.object,t=s.getBindingContext().sPath.split("/"),o=s.getBindingContext().getObject(),a=t[t.length-2],b=o.uuid,n=parseInt(t[t.length-1],10),d=G.index,r;var i=this._adjustIndexForConvert(a,n,G);this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.moveTile(o.object,i.tileIndex,i.newTileIndex,S,S,a==="links"?"tile":"link");}catch(f){this._resetGroupsOnFailure("fail_to_move_tile_msg");return;}o.tileIsBeingMoved=true;r.done(this._handleAfterSortable($.proxy(function(b,h){var j=this._getPathOfTile(b);if(j){this._checkRequestQueue();this.oPageBuilderService.getTileView(h).done(function(v){this._attachLinkPressHandlers(v);this._changeLinkScope(v,a==='links'?'Display':'Actions');this.replaceTileViewAfterConvert(o,n,h,G,d,v,a);this.updateTilesAssociation();sap.ushell.utils.handleTilesVisibility();}.bind(this));}},this,b)));r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_move_tile_msg")));},this));},replaceTileViewAfterConvert:function(t,n,o,G,a,v,s){var b=t.content;t.tileIsBeingMoved=false;t.content=[v];t.object=o;t.originalTileId=this.oPageBuilderService.getTileId(o);G[s].splice(n,1);G[s==="tiles"?"links":"tiles"].push(t);this.oModel.setProperty("/groups/"+a,G);if(s==="links"){this._handleTileAppearanceAnimation(t.content[0].getParent());}else{this._handleTileAppearanceAnimation(t.content[0]);}if(b&&b[0]){b[0].destroy();}},_adjustIndexForConvert:function(t,n,G){var a;if(t==="tiles"){a=G[t].length+G["links"].length;}else{a=G[t].length;n=G["tiles"].length+n;}return{"tileIndex":n,"newTileIndex":a};},_moveLink:function(c,e,d){this._moveTile(c,e,d);},_getTileInfo:function(G,t,i){var o;jQuery.each(G,function(n,a){var f=false;jQuery.each(a[i],function(b,c){if(c.uuid===t){o={"oTile":c,"tileIndex":b,"oGroup":a,"groupIndex":n};f=true;return false;}});if(f){return false;}});return o;},_getNewGroupInfo:function(G,n){var N;jQuery.each(G,function(a,t){if(t.groupId===n){N={"oNewGroup":t,"newGroupIndex":a}}});return N;},_moveTile:function(c,e,d,t,i){var n=d.toIndex,N=d.toGroupId,s=d.sTileId,S=d.source,t=d.sTileType,i=t==='link'?'links':'tiles',a=sap.ushell.Container.getService("LaunchPage"),G=this.oModel.getProperty("/groups"),o,b,r,p,f,h;f=this._getTileInfo(G,s,i);h=this._getNewGroupInfo(G,N);if(f.oGroup.groupId==h.oNewGroup.groupId&&(S==="movetileDialog"||n===null||S==="movelinkDialog")){return;}if(t==="tile"){if(n&&n>h.oNewGroup[i].length){n=h.oNewGroup[i].length;}}if(f.oGroup.groupId===N){if(n===null||n===undefined){f.oGroup[i].splice(f.tileIndex,1);n=f.oGroup[i].length;f.oGroup[i].push(f.oTile);}else{n=this._adjustTileIndex(n,f.oTile,f.oGroup,i);this._moveInArray(f.oGroup[i],f.tileIndex,n);}this.oModel.setProperty("/groups/"+f.groupIndex+"/"+i,f.oGroup[i]);}else{p=this.oModel.getProperty("/personalization");f.oGroup[i].splice(f.tileIndex,1);f.oGroup.visibilityModes=sap.ushell.utils.calcVisibilityModes(f.oGroup,p);this.oModel.setProperty("/groups/"+f.groupIndex+"/"+i,f.oGroup[i]);if(n===null||n===undefined){n=h.oNewGroup[i].length;h.oNewGroup[i].push(f.oTile);}else{n=this._adjustTileIndex(n,f.oTile,h.oNewGroup,i);h.oNewGroup[i].splice(n,0,f.oTile);}h.oNewGroup.visibilityModes=sap.ushell.utils.calcVisibilityModes(h.oNewGroup,p);this.oModel.setProperty("/groups/"+h.newGroupIndex+"/"+i,h.oNewGroup[i]);}this.updateTilesAssociation();sap.ushell.utils.handleTilesVisibility();o=this.oModel.getProperty("/groups/"+f.groupIndex).object;b=this.oModel.getProperty("/groups/"+h.newGroupIndex).object;this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.moveTile(f.oTile.object,f.tileIndex,n,o,b);}catch(j){this._resetGroupsOnFailure("fail_to_move_tile_msg");return;}f.oTile.tileIsBeingMoved=true;r.done(this._handleAfterSortable($.proxy(function(s,k){var l,u=[a.getTileTitle(f.oTile.object),a.getGroupTitle(o),a.getGroupTitle(b),s];sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(this.analyticsConstants.PERSONALIZATION,this.analyticsConstants.MOVE_TILE,u);l=this._getPathOfTile(s);if(l){this.oModel.setProperty(l+"/object",k);this.oModel.setProperty(l+"/originalTileId",this.oPageBuilderService.getTileId(k));this._checkRequestQueue();this.oPageBuilderService.getTileView(k).done(function(v){var m=this.oModel.getProperty(l+"/content");if(i==='links'){this._changeLinkScope(v,sap.m.GenericTileScope.Actions);this._attachLinkPressHandlers(v);f.oTile.content=[v];this.oModel.setProperty(l,jQuery.extend({},f.oTile));this.oModel.setProperty("/groups/"+h.newGroupIndex+"/"+i,this.oModel.getProperty("/groups/"+h.newGroupIndex+"/"+i));}else{this.oModel.setProperty(l+"/content",[v]);}if(m&&m[0]){m[0].destroy();}this.oModel.setProperty(l+"/tileIsBeingMoved",false);}.bind(this));}},this,s)));r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_move_tile_msg")));},this));},_adjustTileIndex:function(n,t,a,I){var v=0,b=false,i=0;for(i=0;i<a[I].length&&v<n;i++){if(a[I][i].isTileIntentSupported){if(a[I][i]===t){b=true;}else{v++;}}}if(b){return i-1;}return i;},getModel:function(){return this.oModel;},getDashboardView:function(){return this.oDashboardView;},updateTilesAssociation:function(){this.mapCatalogTilesToGroups();this.updateCatalogTilesToGroupsMap();},loadAllCatalogs:function(c,e,d){var G=new jQuery.Deferred(),t=this,s;G.resolve();s=function(){G.done(function(){var a=t.getModel().getProperty("/groups");if(a&&a.length!==0){t.updateTilesAssociation();}});};if(!this.oModel.getProperty("/catalogs")){if(!this.oModel.getProperty("/groups")||this.oModel.getProperty("/groups").length===0){G=this.loadPersonalizedGroups();}this._destroyAllGroupModels("/catalogs");this._destroyAllTileModels("/catalogTiles");this.oModel.setProperty("/catalogs",[]);this.oModel.setProperty("/catalogSearchEntity",{appBoxes:[],customTiles:[]});this.aPromises=[];jQuery.sap.measure.start("FLP:DashboardManager.GetCatalogsRequest","GetCatalogsRequest","FLP");jQuery.sap.measure.start("FLP:DashboardManager.getCatalogTiles","getCatalogTiles","FLP");jQuery.sap.measure.pause("FLP:DashboardManager.getCatalogTiles");jQuery.sap.measure.start("FLP:DashboardManager.BuildCatalogModelWithRendering","BuildCatalogModelWithRendering","FLP");jQuery.sap.measure.pause("FLP:DashboardManager.BuildCatalogModelWithRendering");sap.ushell.Container.getService("LaunchPage").getCatalogs().done(function(a){jQuery.sap.measure.end("FLP:DashboardManager.GetCatalogsRequest");jQuery.sap.measure.end("FLP:DashboardManager.getCatalogTiles");jQuery.when.apply(jQuery,this.aPromises).then(this.onDoneLoadingCatalogs(a));s();}.bind(this)).fail(t._showLocalizedErrorHelper("fail_to_load_catalog_msg")).progress(this.addCatalogToModel.bind(this));}else{s();}},updateCatalogTilesToGroupsMap:function(){var c=this.getModel().getProperty("/catalogs"),i,t,a,G,C,b,d,e,A,o,s=sap.ushell.Container.getService("LaunchPage");if(c){for(i=0;i<c.length;i++){b=c[i].appBoxes;if(b){for(e=0;e<b.length;e++){A=b[e];t=encodeURIComponent(s.getCatalogTileId(A.src));G=this.oTileCatalogToGroupsMap[t];a=G?G:[];A.associatedGroups=a;}}C=c[i].customTiles;if(C){for(d=0;d<C.length;d++){o=C[d];t=encodeURIComponent(s.getCatalogTileId(o.src));G=this.oTileCatalogToGroupsMap[t];a=G?G:[];o.associatedGroups=a;}}}}this.getModel().setProperty("/catalogs",c);},_getIsIntentSupported:function(c){var s=sap.ushell.Container.getService("LaunchPage"),i=!!(s.isTileIntentSupported(c));return i;},_getIsAppBox:function(c){var s=sap.ushell.Container.getService("LaunchPage"),i=!!(s.getCatalogTileTargetURL(c)&&(s.getCatalogTilePreviewTitle(c)||s.getCatalogTilePreviewSubtitle(c)));return i;},createCatalogAppBoxes:function(c){var s=sap.ushell.Container.getService("LaunchPage"),a=encodeURIComponent(s.getCatalogTileId(c)),b=this.oTileCatalogToGroupsMap[a]||[],t=s.getCatalogTileTags(c)||[];if(t.length>0){this.tagsPool=this.tagsPool.concat(t);}return{id:a,associatedGroups:b,src:c,title:s.getCatalogTilePreviewTitle(c),subtitle:s.getCatalogTilePreviewSubtitle(c),icon:s.getCatalogTilePreviewIcon(c),tags:t,url:s.getCatalogTileTargetURL(c)};},addCatalogToModel:function(c){var C=this.oModel.getProperty('/catalogs'),s=sap.ushell.Container.getService("LaunchPage"),a=s.getCatalogId(c),o={title:s.getCatalogTitle(c),id:s.getCatalogId(c),numberTilesSupportedOnCurrectDevice:0,static:false,customTiles:[],appBoxes:[]},p;jQuery.sap.measure.resume("FLP:DashboardManager.getCatalogTiles");p=s.getCatalogTiles(c);this.aPromises.push(p);p.done(function(b){jQuery.sap.measure.pause("FLP:DashboardManager.getCatalogTiles");if(!b.length){return;}this.aPendingCatalogQueue.push({oCatalogEntry:b,oCatalogModel:o});clearTimeout(this.oprocessCatalogsTimer);this.oprocessCatalogsTimer=setTimeout(function(){this.processPendingCatalogs();}.bind(this),20);}.bind(this)).fail(this._showLocalizedErrorHelper("fail_to_load_catalog_tiles_msg"));},processPendingCatalogs:function(){var c=this.oModel.getProperty('/catalogs'),p,C,o,e,i,a,b,d,A,f=this.oModel.getProperty('/masterCatalogs')||[{title:g("all")}];jQuery.sap.measure.resume("FLP:DashboardManager.BuildCatalogModelWithRendering");while(this.aPendingCatalogQueue.length>0){p=this.aPendingCatalogQueue.pop(),C=p.oCatalogEntry,o=p.oCatalogModel,e=this.searchModelCatalogByTitle(o.title),a=this.oModel.getProperty('/catalogSearchEntity');if(e.result){b=this.oModel.getProperty('/catalogs')[e.indexOfPreviousInstanceInModel];i=false;}else{i=true;b=o;}C.forEach(function(C,h){if(this._getIsIntentSupported(C)){if(this._getIsAppBox(C)){A=this.createCatalogAppBoxes(C);b.appBoxes.push(A);a.appBoxes.push(A);}else{d=this.createCatalogTiles(C);b.customTiles.push(d);a.customTiles.push(d);}}}.bind(this));if(b.appBoxes.length>0||b.customTiles.length>0){if(i){c.push(o);f.push({title:o.title});}}}this.oModel.setProperty('/masterCatalogs',f);this.oModel.setProperty('/catalogs',c);jQuery.sap.measure.pause("FLP:DashboardManager.BuildCatalogModelWithRendering");},searchModelCatalogByTitle:function(c){var a=this.oModel.getProperty('/catalogs'),b=false,i,n=0,G=false;$.each(a,function(d,t){if(t.title===sap.ushell.resources.i18n.getText('catalogsLoading')){G=true;}else if(c==t.title){i=d;n=t.numberOfTiles;b=true;return false;}});return{result:b,indexOfPreviousInstanceInModel:i,indexOfPreviousInstanceInPage:G?i-1:i,numOfTilesInCatalog:n};},getTagList:function(m){var i={},c=0,t=[],d,o,s;for(c=0;c<this.tagsPool.length;c++){o=this.tagsPool[c];if(i[o]){i[o]++;}else{i[o]=1;}}for(d in i){t.push({tag:d,occ:i[d]});}s=t.sort(function(a,b){return b.occ-a.occ;});if(s.length===0){this.oModel.setProperty("/tagFiltering",false);}if(m){this.oModel.setProperty("/tagList",s.slice(0,m));}else{this.oModel.setProperty("/tagList",s);}},onDoneLoadingCatalogs:function(c){if(!c.length){this.oModel.setProperty("/catalogsNoDataText",sap.ushell.resources.i18n.getText('noCatalogs'));}var e=sap.ui.getCore().getEventBus();e.publish("launchpad","catalogContentLoaded");var s=sap.ushell.Container.getService("LaunchPage"),l=c.filter(function(C){return!s.getCatalogError(C);});if(l.length!==c.length){this._showLocalizedError("partialCatalogFail");}if(this.oModel.getProperty("/tagFiltering")===true){this.getTagList();}sap.ushell.utils.handleTilesVisibility();},createCatalogTiles:function(c){var s=sap.ushell.Container.getService("LaunchPage"),t,a=encodeURIComponent(s.getCatalogTileId(c)),b=this.oTileCatalogToGroupsMap[a]||[],d=s.getCatalogTileTags(c)||[];if(d.length>0){this.tagsPool=this.tagsPool.concat(d);}t=new T({state:"Loading"});return{associatedGroups:b,src:c,catalog:c.title,catalogId:c.id,title:s.getCatalogTileTitle(c),tags:d,keywords:(s.getCatalogTileKeywords(c)||[]).join(','),id:a,size:s.getCatalogTileSize(c),content:[t],isTileIntentSupported:s.isTileIntentSupported(c),tileType:c.tileType};},calculateCatalogTileIndex:function(c,n,t){var r=parseInt(c*100000,10);r+=(n!==undefined?n:0)+t;return r;},mapCatalogTilesToGroups:function(){this.oTileCatalogToGroupsMap={};var G=this.oModel.getProperty("/groups"),s=sap.ushell.Container.getService("LaunchPage"),i=0,o,t,a,b,c,d;for(i=0;i<G.length;i++){o=G[i];a=o.tiles;if(a){for(t=0;t<a.length;++t){b=encodeURIComponent(s.getCatalogTileId(a[t].object));c=this.oTileCatalogToGroupsMap[b]||[];d=s.getGroupId(o.object);if(c.indexOf(d)===-1&&(typeof(o.isGroupVisible)==='undefined'||o.isGroupVisible)&&!o.isGroupLocked){c.push(d);}this.oTileCatalogToGroupsMap[b]=c;}}}},_showLocalizedMessage:function(m,p,t){sap.ushell.Container.getService("Message").show(t||M.Type.INFO,g(m,p),p);},_showLocalizedError:function(m,p){this._showLocalizedMessage(m,p,M.Type.ERROR);},_showLocalizedErrorHelper:function(m,p){var t=this;return function(){t._showLocalizedError(m,p);};},_resetGroupsOnFailureHelper:function(m){var t=this;return function(G){t._showLocalizedError(m);t._requestFailed();setTimeout(function(){t.loadGroupsFromArray(G);});};},_resetGroupsOnFailure:function(m,p){this._requestFailed();this._showLocalizedError(m,p);this.loadPersonalizedGroups();this.oModel.updateBindings(true);},resetGroupsOnFailure:function(){this._resetGroupsOnFailure.apply(this,arguments);},_bindSegment:function(G,s){var a,o,S,b;for(a=0;a<s.length;a++){S=s[a];b=S.index;o=G[b];o.isRendered=true;o.tiles=o.tiles.concat(S.tiles);o.links=o.links.concat(S.links);}return G;},createGroupsModelFrame:function(G,p){var a,c=[],o,C;C=function(b){var d=jQuery.extend({},b);d.tiles=[];d.links=[];return d;};for(a=0;a<G.length;a++){o=G[a];c[a]=C(o);c[a].isRendered=false;c[a].visibilityModes=sap.ushell.utils.calcVisibilityModes(o,p);}return c;},_splitGroups:function(s,G,f){var a,t,b=s,p=f,c=[],d,e,h,i=["tiles","links"],o=1,C,j;C=function(k){var l=jQuery.extend({},k);l.tiles=[];l.links=[];return l;};for(a=0;a<G.length;a++){j=G[a];d=C(j);c.push(d);for(e=0;e<i.length;e++){h=i[e];o=this.PagingManager.getSizeofSupportedElementInUnits(h==='links'?'link':'tile');for(t=0;t<j[h].length;t++){if(p<=0){p=b;if(c){this.segmentsStore.push(c);}d=C(j);c=[];c.push(d);}d[h].push(j[h][t]);p-=o;}}}if(c){this.segmentsStore.push(c);}},_processSegment:function(m){var e=sap.ui.getCore().getEventBus(),a,b,t;if(this.segmentsStore.length>0){a=this.segmentsStore.shift();b=a[0].index;t=m[b].tiles.length+m[b].links.length;m=this._bindSegment(m,a);this.oModel.setProperty('/groups',m);this._updateModelWithTileView(b,t);this._handleSegment();}else{this._updateModelWithTileView(0,0);sap.ushell.utils.handleTilesVisibility();e.publish("launchpad","dashboardModelContentLoaded");}},_handleBookmarkModelUpdate:function(){this.bIsGroupsModelDirty=false;this.bGroupsModelLoadingInProcess=true;this.loadPersonalizedGroups();},_modelLoaded:function(){this.bGroupsModelLoadingInProcess=false;if(this.bIsGroupsModelDirty){this._handleBookmarkModelUpdate();}},_handleSegment:function(){clearTimeout(this.oSegmentTimer);this.oSegmentTimer=setTimeout(function(){this._processSegment(this.oModel.getProperty('/groups'));}.bind(this),100);},loadGroupsFromArray:function(G){var t=this;jQuery.sap.measure.start("FLP:DashboardManager.loadGroupsFromArray","loadGroupsFromArray","FLP");this.oPageBuilderService.getDefaultGroup().done(function(d){if(G.length==0&&d==undefined){return;}var i=0,l=[],b,a=G.indexOf(d),n,N,c=[],o,e,f,m,s,h,j,k={desktop:5,tablet:10,phone:15},p=0,q=0,r,u=0,v,w;G.splice(a,1);while(i<G.length){o=G[i];e=t.oPageBuilderService.isGroupLocked(o);if(e){l.push(o);G.splice(i,1);}else{i++;}}n=l.length;if(!t.oModel.getProperty('/disableSortedLockedGroups')){l.sort(function(x,y){var z=t.oPageBuilderService.getGroupTitle(x).toLowerCase(),A=t.oPageBuilderService.getGroupTitle(y).toLowerCase();return z<A?-1:1;});}b=l;b.push(d);b.push.apply(b,G);G=b;f=G.length;m=t.oModel.getProperty("/groups/length");t.oModel.setProperty("/groups/indexOfDefaultGroup",n);for(i=f;i<m;++i){t._destroyGroupModel("/groups/"+i);}if(!t.PagingManager){t.PagingManager=new P('dashboardPaging',{supportedElements:{tile:{className:'sapUshellTile'},link:{className:'sapUshellLinkTile'}},containerHeight:window.innerHeight,containerWidth:window.innerWidth});}if(t.PagingManager.currentPageIndex===0){t.PagingManager.moveToNextPage();p=t.PagingManager._calcElementsPerPage();}h=t.PagingManager.getSizeofSupportedElementInUnits('link');j=t.PagingManager.getSizeofSupportedElementInUnits('tile');jQuery.sap.measure.start("FLP:DashboardManager._getGroupModel","_getGroupModel","FLP");for(i=0;i<f;++i){N=t._getGroupModel(G[i],i===n,i===f-1);if(i==0){N.isGroupSelected=true;}N.index=i;u+=N.tiles.length*j+N.links.length*h;c.push(N);}jQuery.sap.measure.end("FLP:DashboardManager._getGroupModel");if(sap.ui.Device.system.desktop){q=k.desktop;}else if(sap.ui.Device.system.tablet){q=k.tablet;}else{q=k.phone;}s=(u-p)/q;if(s<14){s=14;}r=t.createGroupsModelFrame(c,t.oModel.getProperty("/personalization"));t._splitGroups(s,c,p);jQuery.sap.measure.start("FLP:DashboardManager._processSegment","_processSegment","FLP");t._processSegment(r);for(var i=0;i<r.length;i++){if(r[i].isGroupVisible&&r[i].visibilityModes[0]){t.oModel.setProperty("/groups/"+i+"/isGroupSelected",true);break;}}if(t.oModel.getProperty("/homePageGroupDisplay")&&t.oModel.getProperty("/homePageGroupDisplay")==='tabs'){v=t.getDashboardView();w=v.oDashboardGroupsBox;w.getBinding('groups').filter([v.oFilterSelectedGroup]);}jQuery.sap.measure.end("FLP:DashboardManager._processSegment");t.oModel.setProperty("/groups/length",r.length);if(t.oModel.getProperty('/currentState/stateName')==="catalog"){}jQuery.sap.measure.end("FLP:DashboardManager.loadGroupsFromArray");}).fail(t._resetGroupsOnFailureHelper("fail_to_get_default_group_msg"));},_loadGroup:function(n,G,h){var t=this,s="/groups/"+n,d=t.oModel.getProperty("/groups/indexOfDefaultGroup"),i=t.oModel.getProperty(s).isLastGroup,o,N;this._destroyGroupModel(s);o=this.oModel.getProperty(s+"/groupId");N=this._getGroupModel(G,n===d,i,undefined,h);if(o){N.groupId=o;}N.index=n;N.isRendered=true;this.oModel.setProperty(s,N);},_getGroupModel:function(G,d,l,o,h){var s=this.oPageBuilderService,a=(G&&s.getGroupTiles(G))||[],m=[],b=[],i,c,e=this.getModel();c=e.getProperty("/personalization");var f=G&&s.isGroupLocked(G)?true:false;for(i=0;i<a.length;++i){var t=a[i],j=s.getTileType(t).toLowerCase();if(j==="tile"){m.push(this._getTileModel(a[i],f,j,h));}else if(j==="link"){b.push(this._getTileModel(a[i],f,j,h));}else{jQuery.sap.log.error("Unknown tile type: '"+j+"'",undefined,"sap.ushell.components.flp.launchpad.DashboardManager");}}var H=this._hasPendingLinks(b);return{title:(d&&g("my_group"))||(G&&s.getGroupTitle(G))||(o&&o.title)||"",object:G,groupId:jQuery.sap.uid(),links:H?[]:b,pendingLinks:H?b:undefined,tiles:m,isDefaultGroup:d||false,editMode:!G,isGroupLocked:f,visibilityModes:[true,true],removable:!G||s.isGroupRemovable(G),sortable:c,isGroupVisible:!G||s.isGroupVisible(G),isEnabled:!d,isLastGroup:l||false,isRendered:o?!!o.isRendered:false,isGroupSelected:false};},_hasPendingLinks:function(m){for(var i=0;i<m.length;i++){if(m[i].content[0]===undefined){return true;}}return false;},_addTileToGroup:function(G,t){var s=G+"/tiles",o=this.oModel.getProperty(G),n=this.oModel.getProperty(s).length,a=this.oPageBuilderService,b=a.getTileType(t);var i=this.oModel.getProperty(G+"/isGroupLocked"),p=this.oModel.getProperty("/personalization");o.tiles[n]=this._getTileModel(t,i,b,this._addModelToTileViewUpdateQueue);o.visibilityModes=sap.ushell.utils.calcVisibilityModes(o,p);this._updateModelWithTileView(o.index,n);this.oModel.setProperty(G,o);},_addAndUpdateModelWithTileView:function(t,o){this._addModelToTileViewUpdateQueue(t,o);this._updateModelWithTileView(0,0);},_addModelToTileViewUpdateQueue:function(t,o){this.tileViewUpdateQueue.push({uuid:t,view:o});},_updateModelWithTileView:function(s,a){var t=this;if(this.tileViewUpdateTimeoutID){clearTimeout(this.tileViewUpdateTimeoutID);}this.tileViewUpdateTimeoutID=setTimeout(function(){t.tileViewUpdateTimeoutID=undefined;t.oSortableDeferred.done(function(){t._updateModelWithTilesViews(s,a);});},50);},_updateGroupModelWithTilesViews:function(t,s,h,i){var o,u,S,l,a=s||0;for(var j=a;j<t.length;j=j+1){o=t[j];for(var q=0;q<this.tileViewUpdateQueue.length;q++){u=this.tileViewUpdateQueue[q];if(o.uuid==u.uuid){h.push(q);if(u.view){if(i){o.content=[u.view];}else{o.content[0].destroy();o.content=[u.view];}S=this.oPageBuilderService.getTileSize(o.object);l=((S!==null)&&(S==="1x2"))||false;if(o['long']!==l){o['long']=l;}}else{o.content[0].setState("Failed");}break;}}}},_updateModelWithTilesViews:function(s,a){var G=this.oModel.getProperty("/groups"),b=s||0,h=[];if(!G||this.tileViewUpdateQueue.length===0){return;}for(var i=b;i<G.length;i=i+1){this._updateGroupModelWithTilesViews(G[i].tiles,a,h);if(G[i].pendingLinks){this._updateGroupModelWithTilesViews(G[i].pendingLinks,a,h,true);if(!this._hasPendingLinks(G[i].pendingLinks)){G[i].links=G[i].pendingLinks;G[i].pendingLinks=undefined;}}}var t=[],c;for(c=0;c<this.tileViewUpdateQueue.length;c++){if(h.indexOf(c)===-1){t.push(this.tileViewUpdateQueue[c]);}}this.tileViewUpdateQueue=t;this.oModel.setProperty("/groups",G);},getModelTileById:function(i,I){var G=this.oModel.getProperty('/groups'),m,f=false;G.every(function(o,a){o[I].every(function(t,a){if(t.uuid===i||t.originalTileId===i){m=t;f=true;}return!f;});return!f;});return m;},_attachLinkPressHandlers:function(v){var e=sap.ui.getCore().getEventBus(),t=v.attachPress?v:v.getContent()[0];t.attachPress(function(o){var b=v.getBindingContext().getObject().tileIsBeingMoved;if(!b&&this.getScope&&this.getScope()==="Actions"){switch(o.getParameters().action){case"Press":sap.ushell.components.flp.ActionMode._openActionsMenu(o,v);break;case"Remove":var a=v.getBindingContext().getObject().uuid;e.publish("launchpad","deleteTile",{tileId:a,items:'links'});break;}}else{sap.ui.getCore().getEventBus().publish("launchpad","dashboardTileLinkClick");}});},_getTileModel:function(t,i,s,u){var a=this.oPageBuilderService,b=jQuery.sap.uid(),o,c=this,d,e,U;this.sTileType=s;a.setTileVisible(t,false);d=a.getTileView(t);d.done(function(v){o=v;if(c.bLinkPersonalizationSupported&&c.sTileType==="link"){c._attachLinkPressHandlers(o);}if(U){U.apply(c,[b,o]);c._handleSegment();}});d.fail(function(){if(U){U.apply(c,[b]);c._handleSegment();}else{if(c.sTileType==="link"){if(window.location.search.indexOf("new_links_container=true")===-1){o=new sap.m.Link({text:sap.ushell.resources.i18n.getText('cannotLoadTile')});}else{var L=sap.ushell.Container.getService("LaunchPage");var f=L.getCatalogTilePreviewSubtitle(t);f=(!f||!f.length)?undefined:f;var h=L.getCatalogTilePreviewTitle(t);h=((!h||!h.length)&&!f)?sap.ushell.resources.i18n.getText('cannotLoadLinkInformation'):h;o=new sap.m.GenericTile({mode:sap.m.GenericTileMode.LineMode,state:sap.m.LoadState.Failed,header:h,subheader:f});}}else{o=new T({state:"Failed"});}}});if(!o){U=u?u:this._addModelToTileViewUpdateQueue;if(this.sTileType!=="link"){o=new T({state:"Loading"});}}var S=a.getTileSize(t);e={"object":t,"originalTileId":a.getTileId(t),"uuid":b,"tileCatalogId":encodeURIComponent(a.getCatalogTileId(t)),"content":[o],"long":((S!==null)&&(S==="1x2"))||false,"target":a.getTileTarget(t)||"","debugInfo":a.getTileDebugInfo(t),"isTileIntentSupported":a.isTileIntentSupported(t),"rgba":"","isLocked":i,"showActionsIcon":this.oModel.getProperty("/tileActionsIconEnabled")||false};return e;},_destroyAllGroupModels:function(t){var G=(typeof t==="string")?this.oModel.getProperty(t):t,i;if(G){for(i=0;i<G.length;i=i+1){this._destroyGroupModel(G[i]);}}},_destroyGroupModel:function(t){var G=(typeof t==="string")?this.oModel.getProperty(t):t;if(G){this._destroyAllTileModels(G.tiles);}},_destroyAllTileModels:function(t){var a=(typeof t==="string")?this.oModel.getProperty(t):t,i;if(a){for(i=0;i<a.length;i=i+1){this._destroyTileModel(a[i]);}}},_destroyTileModel:function(t){var o=(typeof t==="string")?this.oModel.getProperty(t):t,i;if(o&&o.content){for(i=0;i<o.content.length;i=i+1){o.content[i].destroy();}}},loadPersonalizedGroups:function(){var t=this,G=this.oPageBuilderService.getGroups(),d=new jQuery.Deferred();G.done(function(a){t.loadGroupsFromArray(a);d.resolve();});G.fail(function(){t._showLocalizedErrorHelper("fail_to_load_groups_msg")();d.reject();});return d;}});return D;});
