// @copyright@
sap.ui.define(["sap/ui/base/Object"],function(b){"use strict";var D=b.extend("sap.ushell.components.flp.launchpad.dashboard.DashboardUIActions",{metadata:{publicMethods:["initializeUIActions"]},constructor:function(i,s){if(sap.ushell.components.flp.launchpad.dashboard.getDashboardUIActions&&sap.ushell.components.flp.launchpad.dashboard.getDashboardUIActions()){return sap.ushell.components.flp.launchpad.dashboard.getDashboardUIActions();}sap.ushell.components.flp.launchpad.dashboard.getDashboardUIActions=jQuery.sap.getter(this.getInterface());this.oTileUIActions=undefined;this.oGroupUIActions=undefined;this.oController=undefined;this.UIActionsInitialized=false;sap.ui.getCore().getEventBus().subscribe('launchpad','actionModeActive',this._enableGroupUIActions,this);sap.ui.getCore().getEventBus().subscribe('launchpad','actionModeInactive',this._disableGroupUIActions,this);},destroy:function(){sap.ui.getCore().getEventBus().unsubscribe('launchpad','actionModeActive',this._enableGroupUIActions,this);sap.ui.getCore().getEventBus().unsubscribe('launchpad','actionModeInactive',this._disableGroupUIActions,this);sap.ushell.components.flp.launchpad.dashboard.getDashboardUIActions=undefined;this.oGroupUIActions=null;this.oTileUIActions=null;},initializeUIActions:function(c){this.oController=c;var d=c.getView().sDashboardGroupsWrapperId,a,r=sap.ui.getCore().getConfiguration().getRTL(),C={containerSelector:'#dashboardGroups',wrapperSelector:d?"#"+d:undefined,rootSelector:"#dashboardGroups"},o=jQuery.extend(true,{},C,{switchModeDelay:1000,isTouch:c.getView().isTouch,isCombi:c.getView().isCombi,debug:false}),t={draggableSelector:".sapUshellTile",draggableSelectorExclude:".sapUshellPlusTile",placeHolderClass:"sapUshellTile-placeholder",cloneClass:"sapUshellTile-clone",deltaTop:-44,scrollContainerSelector:undefined,startCallback:this._handleTileUIStart.bind(this),endCallback:this._handleTileDrop.bind(this),dragCallback:this._handleStartDragTile.bind(this),dragAndScrollCallback:this._handleTileDragMove.bind(this),moveTolerance:c.getView().isTouch||c.getView().isCombi?10:3,isLayoutEngine:true,disabledDraggableSelector:'sapUshellLockedTile',onDragStartUIHandler:this._markDisableGroups.bind(this),onDragEndUIHandler:this._endUIHandler.bind(this),offsetLeft:r?jQuery(".sapUshellViewPortLeft").width():-jQuery(".sapUshellViewPortLeft").width()},g={draggableSelector:".sapUshellDashboardGroupsContainerItem:not(.sapUshellDisableDragAndDrop)",draggableSelectorBlocker:".sapUshellTilesContainer-sortable, .sapUshellTileContainerBeforeContent, .sapUshellTileContainerAfterContent",draggableSelectorExclude:".sapUshellHeaderActionButton",placeHolderClass:"sapUshellDashboardGroupsContainerItem-placeholder",cloneClass:"sapUshellDashboardGroupsContainerItem-clone",startCallback:this._handleGroupsUIStart.bind(this),endCallback:this._handleGroupDrop.bind(this),dragCallback:this._handleGroupStartDrag.bind(this),moveTolerance:c.getView().isTouch||c.getView().isCombi?10:0.1,isLayoutEngine:false,isVerticalDragOnly:true,draggableElement:".sapUshellTileContainerHeader"},w={draggableSelector:".sapUshellTile",placeHolderClass:"sapUshellTile-placeholder",startCallback:this._handleTileUIStart.bind(this),endCallback:this._handleTileDrop.bind(this),dragCallback:this._handleStartDragTile.bind(this),dragAndScrollCallback:this._handleTileDragMove.bind(this),onDragStartUIHandler:this._markDisableGroups.bind(this),onDragEndUIHandler:this._endUIHandler.bind(this),offsetLeft:r?jQuery(".sapUshellViewPortLeft").width():-jQuery(".sapUshellViewPortLeft").width()},W={forGroups:true,draggableSelector:".sapUshellTileContainerHeader",placeHolderClass:"sapUshellDashboardGroupsContainerItem-placeholder",_publishAsync:c._publishAsync};if(c.getView().oDashboardGroupsBox.getGroups().length){if(c.getView().getModel().getProperty("/personalization")){if(!c.getView().ieHtml5DnD){sap.ui.require(['sap/ushell/UIActions'],function(U){this._disableTileUIActions();this._disableGroupUIActions();this.oTileUIActions=new U(jQuery.extend(true,{},o,t)).enable();this.oGroupUIActions=new U(jQuery.extend(true,{},o,g));a=c.getView().getModel().getProperty("/tileActionModeActive");if(a){this.oGroupUIActions.enable();}}.bind(this));}else{sap.ui.require(['sap/ushell/UIActionsWin8'],function(U){this._disableTileUIActions();this._disableGroupUIActions();this.oTileUIActions=U.getInstance(jQuery.extend(true,{},C,w)).enable();this.oGroupUIActions=U.getInstance(jQuery.extend(true,{},C,W)).enable();}.bind(this));}}}},_enableGroupUIActions:function(){if(this.oGroupUIActions){this.oGroupUIActions.enable();}},_disableTileUIActions:function(){if(this.oTileUIActions){this.oTileUIActions.disable();}},_disableGroupUIActions:function(){if(this.oGroupUIActions){this.oGroupUIActions.disable();}},_handleTileDragMove:function(c){if(!c.isScrolling){sap.ushell.Layout.getLayoutEngine().moveDraggable(c.moveX,c.moveY);}},_handleTileUIStart:function(e,u){if((sap.ui.Device.browser.msie)&&((navigator.msMaxTouchPoints>0)||(navigator.maxTouchPoints>0))){this.titleElement=u.querySelector("[title]");if(this.titleElement){this.titleElement.setAttribute("data-title",this.titleElement.getAttribute("title"));this.titleElement.removeAttribute("title");}}},_changeTileDragAndDropAnimate:function(e,u){var d=this.dragNDropData.jqDashboard.scrollTop(),j,t,c,a,f,T,i,C;for(i=0;i<this.dragNDropData.jqDraggableElements.length;i++){j=this.dragNDropData.jqDraggableElements.eq(i);t=j[0];c=j.position();a=j.offset();if((a.left===t.offset.left)&&(a.top===t.offset.top)){continue;}t.position=c;t.offset=a;C=j.data("clone");if(!C){continue;}f=t.position.left+this.dragNDropData.containerLeftMargin;T=this._getTileTopOffset(j,t.position,d);C.stop(true,false).animate({left:f,top:T},{duration:250},{easing:"swing"});}},_handleStartDragTile:function(a,t){if(window.getSelection){var s=window.getSelection();try{s.removeAllRanges();}catch(e){}}sap.ushell.Layout.getLayoutEngine().layoutStartCallback(t);if(sap.ushell.Layout.isAnimationsEnabled()){sap.ushell.Layout.initDragMode();}jQuery(t).find("a").removeAttr('href');this.placeHolderElement=jQuery(".sapUshellTile-placeholder");sap.ui.getCore().getEventBus().publish("launchpad","sortableStart");this.oController._handleDrag.call(this.oController,a,t);},_handleTileDrop:function(e,t,a){var h=function(e,t){if(sap.ushell.Layout.isAnimationsEnabled()){sap.ushell.Layout.endDragMode();}jQuery('#dashboardGroups .sapUshellHidePlusTile').removeClass('sapUshellHidePlusTile');if((sap.ui.Device.browser.msie)&&((navigator.msMaxTouchPoints>0)||(navigator.maxTouchPoints>0))&&this.titleElement){this.titleElement.setAttribute("title",this.titleElement.getAttribute("data-title"));}this.oController._handleDrop.call(this.oController,e,t);if(sap.ui.Device.desktop){jQuery('body').removeClass("sapUshellDisableUserSelect");}};if(sap.ushell.Layout.isAnimationsEnabled()&&a&&a.clone){var d=jQuery.Deferred();var j=jQuery(a.clone);var c=a.clone.getBoundingClientRect();var p=t.getBoundingClientRect();var s=j.css("transform").split(",");var f=p.top-c.top;var g=p.left-c.left;var i=parseInt(s[4],10)+g;var k=parseInt(s[5],10)+f;j.css({"transform":"translate3d("+i+"px, "+k+"px, 0px)","transition":"transform 0.3s cubic-bezier(0.46, 0, 0.44, 1)"});setTimeout(function(){d.resolve();h.call(this,e,t);}.bind(this),300);return d.promise();}else{h.apply(this,arguments);}},_getTileTopOffset:function(t,p,d){var i=0,T=i+d;T+=t.closest(".sapUshellDashboardGroupsContainerItem").position().top;T+=p.top;return T;},_markDisableGroups:function(){if(this.oController.getView().getModel()){this.oController.getView().getModel().setProperty('/isInDrag',true);}},_endUIHandler:function(){if(sap.ushell.Layout.isAnimationsEnabled()){sap.ushell.Layout.endDragMode();}if(this.oController.getView().getModel()){this.oController.getView().getModel().setProperty('/isInDrag',false);}},_handleGroupStartDrag:function(e,u){this.oTileUIActions.disable();var g=jQuery(".sapUshellDashboardGroupsContainerItem-clone"),a=g.find(".sapUshellContainerTitle"),t=a.height(),c=a.width(),d,f,h,s,r=sap.ui.getCore().getConfiguration().getRTL();if(!sap.ui.Device.system.phone){g.find(".sapUshellTileContainerEditMode").offset({top:this.oGroupUIActions.getMove().y-t,left:r?jQuery(".sapUshellViewPortCenter").width()+this.oGroupUIActions.getMove().x+c:this.oGroupUIActions.getMove().x-(c/2)});jQuery(".sapUshellTileContainerBeforeContent").addClass("sapUshellTileContainerHidden");}else{jQuery(".sapUshellTilesContainer-sortable").addClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellLineModeContainer, .sapUshellLinksContainer").addClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellTileContainerBeforeContent").addClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellContainerHeaderActions").addClass("sapUshellTileContainerHidden");}jQuery(".sapUshellTileContainerAfterContent").addClass("sapUshellTileContainerRemoveContent");jQuery(u).find(".sapUshellContainerHeaderActions").addClass("sapUshellTileContainerHidden");this.oController.getView().getModel().setProperty('/isInDrag',true);jQuery(u).attr('startPos',jQuery(u).index());jQuery.sap.log.info('startPos - '+jQuery(u).index());setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","sortableStart");},0);d=jQuery("#dashboardGroups").offset().top;f=jQuery(".sapUshellDashboardGroupsContainerItem-placeholder").offset().top;h=jQuery(".sapUshellDashboardGroupsContainerItem-clone").offset().top;s=f-d-h;jQuery('.sapUshellDashboardView section').animate({scrollTop:s},0);},_handleGroupsUIStart:function(e,u){jQuery(u).find(".sapUshellTileContainerContent").css("outline-color","transparent");},_handleGroupDrop:function(e,u){var B=sap.ui.getCore().getEventBus(),q=jQuery(u),f=jQuery(q.children()[0]).attr("id"),g=sap.ui.getCore().byId(f),d=sap.ui.getCore().byId("dashboardGroups"),o={group:g,groupChanged:false,focus:false},n=q.index();q.startPos=window.parseInt(q.attr('startPos'),10);d.removeAggregation('groups',g,true);d.insertAggregation('groups',g,n,true);this._handleGroupMoved(e,{item:q});q.removeAttr('startPos');sap.ui.getCore().getEventBus().publish("launchpad","sortableStop");setTimeout(function(){jQuery(".sapUshellContainerHeaderActions").removeClass("sapUshellTileContainerHidden");jQuery(".sapUshellTileContainerBeforeContent").removeClass("sapUshellTileContainerHidden");jQuery(".sapUshellTileContainerBeforeContent").removeClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellTileContainerAfterContent").removeClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellTilesContainer-sortable").removeClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellLineModeContainer, .sapUshellLinksContainer").removeClass("sapUshellTileContainerRemoveContent");},0);window.setTimeout(jQuery.proxy(B.publish,B,"launchpad","scrollToGroup",o),1);this.oTileUIActions.enable();},_handleGroupMoved:function(e,u){var f=u.item.startPos,t=u.item.index(),m=this.oController.getView().getModel();if(t!==-1){this.oController._publishAsync("launchpad","moveGroup",{fromIndex:f,toIndex:t});setTimeout(function(){m.setProperty('/isInDrag',false);},100);}},_setController:function(c){this.oController=c;}});return D;});
