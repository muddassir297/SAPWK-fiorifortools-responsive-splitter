// @copyright@
sap.ui.define(["sap/ushell/services/AppConfiguration","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ushell/services/_ClientSideTargetResolution/InboundProvider","sap/ushell/services/_ClientSideTargetResolution/VirtualInbounds"],function(b,S,I,v){"use strict";function C(a,c,p,s){this._init.apply(this,arguments);};C.prototype._init=function(a,c,p,s){if(!this._implementsServiceInterface(a)){jQuery.sap.log.error("Cannot get Inbounds","ClientSideTargetResolutionAdapter should implement getInbounds method","sap.ushell.services.ClientSideTargetResolution");return;}this._oInboundProvider=new I(a.getInbounds.bind(a));this._oHaveEasyAccessSystemsDeferreds={userMenu:null,sapMenu:null};this._aTechnologyPriority=[undefined,"GUI","WDA","UI5"];this._oServiceConfiguration=s;this._oAdapter=a;};C.prototype._implementsServiceInterface=function(a){if(typeof a.getInbounds==="function"){return true;}return false;};C.prototype._getURLParsing=function(){if(!this._oURLParsing){this._oURLParsing=sap.ushell.Container.getService("URLParsing");}return this._oURLParsing;};C.prototype._addDefaultParameterValues=function(o,s,k,m,d){var a={},D={};Object.keys(o).forEach(function(p){if(p!=="sap-ushell-defaultedParameterNames"){a[p]=o[p];}});if(!s){return a;}Object.keys(s).forEach(function(p){var t=s[p],T,V=false;if(!a[p]&&t.hasOwnProperty("defaultValue")){if(t.defaultValue.format&&t.defaultValue.format==="reference"){T=t.defaultValue.value;if(k.hasOwnProperty(T)){if(typeof k[T]==="string"){a[p]=[k[T]];V=true;}else if(typeof k[T]==="object"){a[p]=k[T];V=true;}}else{a[p]=[t.defaultValue];m.push(t.defaultValue.value);}}else{a[p]=[t.defaultValue.value];V=true;}if(V){D[p]=true;}}});Object.keys(D).sort().forEach(function(p){d.push(p);});return a;};C.prototype._matchesFilter=function(V,f,k,m){var F;if(!f){return true;}if(!V&&V!==""){return false;}F=f.value;if(f.format==="reference"){if(/UserDefault\.extended\./.test(F)){jQuery.sap.log.error("Illegal inbound: extended user default '"+F+"' used as filter");return false;}if(k.hasOwnProperty(F)){return V===k[F];}m[F]=true;return true;}if(f.format==="value"||f.format==="plain"||f.format===undefined){return V===f.value;}else if(f.format==="regexp"){return!!V.match("^"+f.value+"$");}else{jQuery.sap.log.error("Illegal oFilter format");return false;}};function g(m){return m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.ui"]&&m.inbound.resolutionResult["sap.ui"].technology;}C.prototype._calculateTechnologyMatch=function(m){var t=m.intentParamsPlusAllDefaults["sap-ui-tech-hint"]&&m.intentParamsPlusAllDefaults["sap-ui-tech-hint"][0];var a=m.defaultedParamNames&&(m.defaultedParamNames.indexOf("sap-ui-tech-hint")>=0);if(t&&g(m)===t){return a?1:2;}return 0;};C.prototype._getTechnologyPriority=function(m){var t=g(m);var p=this._aTechnologyPriority.indexOf(t);return Math.max(0,p);};C.prototype._addSortString=function(m){function a(n){var s="000"+n;return s.substr(s.length-3);}m.priorityString=[m.genericSO?"g":"x","TECM="+this._calculateTechnologyMatch(m),"MTCH="+a(m.countMatchingParams),"MREQ="+a(m.countMatchingRequiredParams),"NFIL="+a(m.countMatchingFilterParams),"NDEF="+a(m.countDefaultedParams),"POT="+a(m.countPotentiallyMatchingParams),"RFRE="+a(999-m.countFreeInboundParams),"TECP="+this._getTechnologyPriority(m)].join(" ");};C.prototype._checkAdditionalParameters=function(o,a){var A=false;if(o.signature.additionalParameters==="allowed"||o.signature.additionalParameters==="ignored"){return true;}if(o.signature.additionalParameters==="notallowed"||o.signature.additionalParameters===undefined){A=Object.keys(a).every(function(p){return(!o.signature.parameters[p]&&p.indexOf("sap-")!==0)?false:true;});}else{jQuery.sap.log.error("Unexpected value of inbound for signature.additionalParameters");}return A;};C.prototype._addFoundParametersToRefs=function(r,m){r.forEach(function(R){m[R]=true;});};C.prototype._extractSapPriority=function(o,m){var s;if(o&&o["sap-priority"]&&o["sap-priority"][0]){s=parseInt(o["sap-priority"][0],10);if(!isNaN(s)){m["sap-priority"]=s;}}return;};C.prototype._constructParameterDominatorMap=function(p){var d={},r={};Object.keys(p).forEach(function(k){var R=p[k].renameTo||k;r[R]=r[R]||{"renameTo":R,"dominatedBy":[]};r[R].dominatedBy.push(k);r[R].dominatedBy=r[R].dominatedBy.sort();d[k]=r[R];});return d;};C.prototype._removeSpuriousDefaultedValues=function(o,d,p){var O=d.slice(0);O.forEach(function(P,a){var s;var n=p[P].dominatedBy.some(function(k){if(o[k]&&(k!==P)&&d.indexOf(k)===-1){s=k;return true;}return false;});if(n&&(s!==P)){d.splice(a,1);delete o[P];}});return{intentParamsPlusAllDefaults:o,defaultedParamNames:d};};C.prototype._matchToInbound=function(o,a,k,m){var t=this,M={inbound:a};function n(R,u,D){R.matches=false;R.noMatchReason=u;R.noMatchDebug=D;return R;}function f(R){R.matches=true;R.matchesVirtualInbound=v.isVirtualInbound(a);return R;}M.genericSO=(a.semanticObject==="*");if(!(o.semanticObject===undefined||o.semanticObject===a.semanticObject||a.semanticObject==='*')){return n(M,"Semantic object \""+o.semanticObject+"\" did not match");}if(!(o.action===undefined||o.action===a.action)){return n(M,"Action \""+o.action+"\" did not match");}if(a.deviceTypes&&!(o.formFactor===undefined||a.deviceTypes[o.formFactor])){return n(M,"Form factor \""+o.formFactor+"\" did not match","Inbound: ["+Object.keys(a.deviceTypes).filter(function(K){return!!a.deviceTypes[K];}).join(", ")+"]");}var T=o.params&&o.params["sap-ui-tech-hint"]&&o.params["sap-ui-tech-hint"][0];if(o.treatTechHintAsFilter&&T){var s=g({inbound:a});if(s!==T){return n(M,"Tech Hint as filter \""+T+"\" did not match","Inbound: ["+s+"]");}}var r=[],d=[],c=o.params;var e=this._addDefaultParameterValues(c,a.signature&&a.signature.parameters,k,r,d);M.intentParamsPlusAllDefaults=e;M.defaultedParamNames=d;this._extractSapPriority(e,M);var h=0,j=0,l=0,p=0;var q=Object.keys(a.signature.parameters).every(function(P){var V=e[P],u=V&&V[0],w=a.signature.parameters[P],x=c.hasOwnProperty(P);if(w.required&&(u===null||u===undefined)){return false;}if(w.filter){if(!t._matchesFilter(u,w.filter,k,m)){return false;}if(x){++l;}}if(x&&w.required){++j;}if(x){++h;}if(!x&&(u===null||u===undefined)){++p;}var y=t._constructParameterDominatorMap(a.signature.parameters);var R=t._removeSpuriousDefaultedValues(M.intentParamsPlusAllDefaults,M.defaultedParamNames,y);M.intentParmsPlusAllDefaults=R.intentParmsPlusAllDefaults;M.defaultedParamNames=R.defaultedParamNames;return true;});M.countMatchingParams=h;M.countMatchingRequiredParams=j;M.countMatchingFilterParams=l;M.countDefaultedParams=d.length;M.countPotentiallyMatchingParams=Object.keys(o.params).length;M.countFreeInboundParams=p;if(!q){return n(M,"Inbound parameter signature did not match",this._compactSignatureNotation(a.signature));}if(!this._checkAdditionalParameters(a,e)){return n(M,"Additional parameters not allowed",this._compactSignatureNotation(a.signature));}if(a.signature.additionalParameters==="ignored"){this._filterObjectKeys(e,function(K){if(K.indexOf("sap-")===0){return true;}if(a.signature.parameters.hasOwnProperty(K)){return true;}return false;},true);M.countPotentiallyMatchingParams=Object.keys(o.params).filter(function(u){return a.signature.parameters.hasOwnProperty(u);}).length;}this._constructEarlyResolutionResult(M,a);this._addSortString(M);this._addFoundParametersToRefs(r,m);return f(M);};C.prototype._filterObjectKeys=function(o,f,a){var O=a?o:jQuery.extend(true,{},o);Object.keys(O).forEach(function(k){if(f(k)===false){delete O[k];}});return O;};C.prototype._isFullLocalWDAResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWdaLocalResolution"]===false){return false;}return!(!o||!r||!(r["sap.wda"])||!(r.applicationType==="WDA"));};C.prototype._isLocalWDAResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWdaLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="WDA"));};C.prototype._isFullLocalWebguiResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r["sap.gui"])||!(r.applicationType==="TR"));};C.prototype._isLocalWebguiNowrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/~canvas;")>=0)||!(r.url.indexOf("app/transaction/APB_LPD_CALL_")===-1));};C.prototype._isLocalWebguiWrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/~canvas;")>=0)||!(r.url.indexOf("app/transaction/APB_LPD_CALL_")>=0));};C.prototype._isLocalNativeWebguiWrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableNativeWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/its/webgui")>=0)||!(r.url.indexOf("APB_LPD_CALL_")!==-1));};C.prototype._isLocalNativeWebguiNowrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableNativeWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/its/webgui")>=0)||!(r.url.indexOf("APB_LPD_CALL_")===-1));};C.prototype._constructEarlyResolutionResult=function(m,o){m.resolutionResult={};if(o&&o.resolutionResult&&o.resolutionResult.hasOwnProperty("sap.platform.runtime")){m.resolutionResult["sap.platform.runtime"]=o.resolutionResult["sap.platform.runtime"];}Object.keys(m.intentParamsPlusAllDefaults).slice(0).forEach(function(n){if(!jQuery.isArray(m.intentParamsPlusAllDefaults[n])){if(!m.resolutionResult.oNewAppStateMembers){m.resolutionResult.oNewAppStateMembers={};}m.resolutionResult.oNewAppStateMembers[n]=m.intentParamsPlusAllDefaults[n];}});};C.prototype._hasRenameTo=function(m){return m.inbound&&m.inbound.signature&&m.inbound.signature.parameters&&Object.keys(m.inbound.signature.parameters).some(function(k){return!!(m.inbound.signature.parameters[k].renameTo);});};C.prototype._removeUnusedComplexParameterValuesFromDefaultList=function(m){m.defaultedParamNames=m.defaultedParamNames.filter(function(n){if(m.intentParamsPlusAllDefaults[n]&&!jQuery.isArray(m.intentParamsPlusAllDefaults[n])){if(!(m.resolutionResult.oNewAppStateMembers&&m.resolutionResult.oNewAppStateMembers[n])){return false;}}return true;});};C.prototype._computeNavigationMode=function(m){var a,s,e,E,l,c,n,A=["inplace","explace"],o=m.inbound;e=(m.intentParamsPlusAllDefaults["sap-ushell-next-navmode"]||[])[0];if(A.indexOf(e)>=0){m.resolutionResult["sap-ushell-next-navmode"]=e;}E=(m.intentParamsPlusAllDefaults["sap-ushell-navmode"]||[])[0];if(A.indexOf(E)>=0){a=(o.resolutionResult||{}).applicationType;s=this._getInternalNavigationMode(E,a);m.resolutionResult.navigationMode=s;m.resolutionResult.explicitNavMode=true;jQuery.sap.log.debug("Navigation mode was forced to "+s,"because sap-ushell-navmode parameter was set to "+E+" for target with applicationType: "+a,"sap.ushell.services.ClientSideTargetResolution");return;}c=b.getCurrentApplication()||{};n=jQuery.sap.getObject("inbound.resolutionResult",undefined,m)||{};l=this._isLegacyApplicationType(c.applicationType)&&this._isLegacyApplicationType(n.applicationType);if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config.enableInPlaceForClassicUIs===true&&!l){m.resolutionResult.navigationMode="embedded";}};C.prototype._getInternalNavigationMode=function(e,a){var o={SAPUI5:{inplace:"embedded",explace:"newWindowThenEmbedded"},WDA:{inplace:"embedded",explace:"newWindowThenEmbedded"},TR:{inplace:"embedded",explace:"newWindowThenEmbedded"},URL:{inplace:"replace",explace:"newWindow"}};if(!o.hasOwnProperty(a)){jQuery.sap.log.error(a+" is not a valid application type","expected one of "+Object.keys(o).join(", "),"sap.ushell.services.ClientSideTargetResolution");return null;}if(e!=="inplace"&&e!=="explace"){jQuery.sap.log.error(e+" is not a valid external navigation mode","expected one of 'internal', 'external'","sap.ushell.services.ClientSideTargetResolution");return null;}return o[a][e];};C.prototype._mapDefaultParameterNames=function(m){var p=jQuery.sap.getObject("inbound.signature.parameters",undefined,m)||{},M={};m.defaultedParamNames.forEach(function(n){var N=(p[n]&&p[n].renameTo)||n;if(M[N]){jQuery.sap.log.error("renaming of defaultedParamNames creates duplicates"+n+"->"+N);}else{M[N]=true;}});m.mappedDefaultedParamNames=Object.keys(M).sort();};C.prototype._mixAppStateIntoResolutionResultAndRename=function(m,a){var d=new jQuery.Deferred(),t=this,n,s,o;function c(T){t._removeUnusedComplexParameterValuesFromDefaultList(T);t._mapDefaultParameterNames(T);t._computeNavigationMode(T);delete T.resolutionResult.oNewAppStateMembers;d.resolve(T);}function h(m){return(m.resolutionResult.oNewAppStateMembers&&!jQuery.isEmptyObject(m.resolutionResult.oNewAppStateMembers));}function e(l,p){return jQuery.isArray(l)&&l.some(function(k){return(p.indexOf(k)!==-1);});}function f(A,p){var k,P,l;if(A&&A.selectionVariant){k=new S(JSON.stringify(A.selectionVariant));l=k.getSelectOptionsPropertyNames()||[];P=k.getParameterNames()||[];if(e(l,p)||e(P,p)){return true;}}return false;}function r(k,l,p){var q=new S(),u=k.getParameterNames()||[],w=k.getSelectOptionsPropertyNames()||[],P,x;u.forEach(function(y){P=k.getParameter(y);if(p[y]&&p[y].renameTo){if((q.getParameter(p[y].renameTo)===undefined)&&(q.getSelectOption(p[y].renameTo)===undefined)){q.addParameter(p[y].renameTo,P);l.changed=true;}else{jQuery.sap.log.error("renaming of appstate creates duplicates "+y+"->"+p[y].renameTo);}}else{if((q.getParameter(y)===undefined)&&(q.getSelectOption(y)===undefined)){q.addParameter(y,P);}}});w.forEach(function(y){x=k.getSelectOption(y);if(p[y]&&p[y].renameTo){if((q.getSelectOption(p[y].renameTo)===undefined)&&(q.getParameter(p[y].renameTo)===undefined)){q.massAddSelectOption(p[y].renameTo,x);l.changed=true;}else{jQuery.sap.log.error("renaming of appstate creates duplicates "+y+"->"+p[y].renameTo);}}else{if((q.getSelectOption(y)===undefined)&&(q.getParameter(y)===undefined)){q.massAddSelectOption(y,x);}}});u.forEach(function(y){k.removeParameter(y);});w.forEach(function(y){k.removeSelectOption(y);});q.getParameterNames().forEach(function(y){k.addParameter(y,q.getParameter(y));});q.getSelectOptionsPropertyNames().forEach(function(y){k.massAddSelectOption(y,q.getSelectOption(y));});return k;}function R(k,l,p){return r(k,l,p);}function j(D){if(D===undefined||jQuery.isPlainObject(D)){return false;}return true;}function M(N){var k=N.getData()||{},l,p={};if(k.selectionVariant){l=new S(JSON.stringify(k.selectionVariant));}else{l=new S();}if(h(m)){Object.keys(m.resolutionResult.oNewAppStateMembers).forEach(function(q){l.massAddSelectOption(q,m.resolutionResult.oNewAppStateMembers[q].Ranges);});}l=R(l,p,m.inbound.signature.parameters);if(l.getParameterNames().length!==0||l.getSelectOptionsPropertyNames().length!==0){k.selectionVariant=l.toJSONObject();}if(!p.changed&&!h(m)){c(m);return;}N.setData(k);N.save().done(function(){m.intentParamsPlusAllDefaults["sap-xapp-state"]=[N.getKey()];m.mappedIntentParamsPlusSimpleDefaults["sap-xapp-state"]=[N.getKey()];c(m);});}if(!h(m)&&!t._hasRenameTo(m)){c(m);}else{s=m.intentParamsPlusAllDefaults["sap-xapp-state"]&&m.intentParamsPlusAllDefaults["sap-xapp-state"][0];if(s){a.getAppState(s).done(function(k){var p=t._constructParameterDominatorMap(m.inbound.signature.parameters);o=k.getData();if(j(o)){delete m.resolutionResult.oNewAppStateMembers;c(m);}if(m.resolutionResult.oNewAppStateMembers){Object.keys(m.resolutionResult.oNewAppStateMembers).forEach(function(P){var D=p[P].dominatedBy;if(f(o,D)){delete m.resolutionResult.oNewAppStateMembers[P];}});}if(!h(m)&&!t._hasRenameTo(m)){c(m);}else{n=a.createEmptyAppState(undefined,true);if(n){n.setData(k.getData());M(n);}}});}else if(h(m)){M(a.createEmptyAppState(undefined,true));}else{c(m);}}return d.promise();};C.prototype._extractInboundFilter=function(o){if(!this._oAdapter.hasSegmentedAccess){return undefined;}if(typeof o!=="string"){return undefined;}var f=o.indexOf("#")===0?o:"#"+o;var s=this._getURLParsing().parseShellHash(f);if(!s||!s.semanticObject||!s.action){return undefined;}return[{semanticObject:s.semanticObject,action:s.action}];};C.prototype.resolveHashFragment=function(h){var t=this,d=new jQuery.Deferred(),B=this._oAdapter.resolveHashFragmentFallback&&this._oAdapter.resolveHashFragmentFallback.bind(this._oAdapter),s=this._extractInboundFilter(h);this._oInboundProvider.getInbounds(s).then(function(a){t._resolveHashFragment(h,B,a).done(d.resolve.bind(d)).fail(d.reject.bind(d));},function(){d.reject.apply(d,arguments);});return d.promise();};C.prototype.resolveTileIntent=function(h){var t=this,d=new jQuery.Deferred(),s=this._extractInboundFilter(h);this._oInboundProvider.getInbounds(s).then(function(a){t._resolveTileIntent(h,undefined,a).done(d.resolve.bind(d)).fail(d.reject.bind(d));},function(){d.reject.apply(d,arguments);});return d.promise();};C.prototype._resolveHashFragment=function(h,B,a){var u=this._getURLParsing(),t=this,d=new jQuery.Deferred(),f=h.indexOf("#")===0?h:"#"+h,s=u.parseShellHash(f);if(s===undefined){jQuery.sap.log.error("Could not parse shell hash '"+h+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return d.reject().promise();}s.formFactor=sap.ushell.utils.getFormFactor();this._getMatchingInbounds(s,a,true).fail(function(e){jQuery.sap.log.error("Could not resolve "+h,"_getMatchingInbounds promise rejected with: "+e,"sap.ushell.services.ClientSideTargetResolution");d.reject(e);}).done(function(m){var M;if(m.length===0){jQuery.sap.log.warning("Could not resolve "+h,"rejecting promise","sap.ushell.services.ClientSideTargetResolution");d.reject("Could not resolve navigation target");return;}M=m[0];t._resolveSingleMatchingTarget(M,B,f).done(d.resolve.bind(d)).fail(d.reject.bind(d));});return d.promise();};C.prototype._resolveEasyAccessMenuIntent=function(o,m){var e="Intent must be either #Shell-startGUI or #Shell-startWDA";if(o.action==="startGUI"){return this._resolveEasyAccessMenuIntentWebgui(o,m);}if(o.action==="startWDA"){return this._resolveEasyAccessMenuIntentWDA(o,m);}return new jQuery.Deferred().reject("The easy access menu intent "+o.semanticObject+"-"+o.action+" could not be resolved: "+e).promise();};C.prototype._resolveEasyAccessMenuIntentWDA=function(o,m){var d=new jQuery.Deferred(),u,U,t=this,a={};u="/ui2/nwbc/~canvas;window=app/wda/"+o.params["sap-ui2-wd-app-id"][0]+"/";jQuery.each(o.params,function(c,e){if(c==="sap-ui2-wd-app-id"||c==="sap-system"){return;}if(c==="sap-ui2-wd-conf-id"){a["sap-wd-configId"]=e;return;}a[c]=e;});if(a){u=u+"?"+t._getURLParsing().paramsToString(a);}U=new URI(u);this._spliceSapSystemIntoURI(U,"",o.params["sap-system"][0],"WDA").done(function(U){var r={url:U.toString(),applicationType:"NWBC",text:o.params["sap-ui2-wd-app-id"][0],additionalInformation:"","sap-system":o.params["sap-system"][0]};if(m&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){r["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}d.resolve(r);}).fail(d.reject.bind(d));return d.promise();};C.prototype._resolveEasyAccessMenuIntentWebgui=function(o,m){var d=new jQuery.Deferred(),u,U;u="/sap/bc/gui/sap/its/webgui?%7etransaction="+o.params["sap-ui2-tcode"][0]+"&%7enosplash=1";U=new URI(u);this._spliceSapSystemIntoURI(U,"",o.params["sap-system"][0],"NATIVEWEBGUI").done(function(U){var r={url:U.toString(),applicationType:"TR",text:o.params["sap-ui2-tcode"][0],additionalInformation:"","sap-system":o.params["sap-system"][0]};if(m&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){r["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}d.resolve(r);}).fail(d.reject.bind(d));return d.promise();};C.prototype._resolveSingleMatchingTarget=function(m,B,f){var t=this,d=new jQuery.Deferred(),u=this._getURLParsing(),o=u.parseShellHash(f);if(o.semanticObject==="Shell"&&(o.action==="startWDA"||o.action==="startGUI")){return this._resolveEasyAccessMenuIntent(o,m);}this._mapParameterNamesAndRemoveObjects(m);this._mixAppStateIntoResolutionResultAndRename(m,sap.ushell.Container.getService("AppState")).done(function(m){var a=t._determineResultProcessor(m);a(m,B,f).done(function(m){d.resolve(m.resolutionResult);jQuery.sap.log.debug("Intent was resolved to the following target",JSON.stringify(m.resolutionResult,null,3),"sap.ushell.services.ClientSideTargetResolution");}).fail(function(M){if(M.indexOf("fallback:")>=0){t._constructFallbackResolutionResult.call(this,m,B,f).fail(d.reject.bind(d)).done(function(m){d.resolve(m.resolutionResult);});}else{d.reject(M);}});});return d.promise();};C.prototype._resolveTileIntent=function(h,B,a){var u=this._getURLParsing(),t=this,d=new jQuery.Deferred(),f=h.indexOf("#")===0?h:"#"+h,s=u.parseShellHash(f);if(s===undefined){jQuery.sap.log.error("Could not parse shell hash '"+h+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return d.reject("Cannot parse shell hash").promise();}s.formFactor=sap.ushell.utils.getFormFactor();this._getMatchingInbounds(s,a,false).fail(function(e){jQuery.sap.log.error("Could not resolve "+h,"_getMatchingInbounds promise rejected with: "+e,"sap.ushell.services.ClientSideTargetResolution");d.reject(e);}).done(function(m){var M;if(m.length===0){jQuery.sap.log.warning("Could not resolve "+h,"no matching targets were found","sap.ushell.services.ClientSideTargetResolution");d.reject("No matching targets found");return;}M=m[0];t._resolveSingleMatchingTileIntent(M,B,f).done(d.resolve.bind(d)).fail(d.reject.bind(d));});return d.promise();};C.prototype._resolveSingleMatchingTileIntent=function(m,B,f){var d=new jQuery.Deferred();d.resolve(m.inbound.tileResolutionResult);return d.promise();};C.prototype._determineResultProcessor=function(m){var o=m.inbound,r=o&&o.resolutionResult;function l(p,R){jQuery.sap.log.debug("Resolution result will be constructed via "+p+" processor",R,"sap.ushell.services.ClientSideTargetResolution");}if(!o||!r){l("FALLBACK","the inbound or the inbound resolutionResult member was not available");return this._constructFallbackResolutionResult.bind(this);}if(r.applicationType==="SAPUI5"){l("SAPUI5","inbound resolutionResult had SAPUI5 applicationType");return this._constructSAPUI5ResolutionResult.bind(this);}var a=this._isFullLocalWDAResolution(m);if(a){l("WDA full url construction");return this._constructFullWDAResolutionResult.bind(this);}var c=this._isLocalWDAResolution(m);if(c){l("WDA");return this._constructWDAResolutionResult.bind(this);}var d=this._isFullLocalWebguiResolution(m);if(d){l("NON-WRAPPED WEBGUI full url construction");return this._constructFullWebguiResolutionResult.bind(this);}var e=this._isLocalWebguiNowrapResolution(m);if(e){l("NON-WRAPPED WEBGUI");return this._constructWebguiNowrapResult.bind(this);}var f=this._isLocalWebguiWrapResolution(m);if(f){l("WRAPPED WEBGUI");return this._constructWebguiWrapResult.bind(this);}var h=this._isLocalNativeWebguiNowrapResolution(m);if(h){l("NATIVE NON-WRAPPED WEBGUI");return this._constructNativeWebguiNowrapResult.bind(this);}var j=this._isLocalNativeWebguiWrapResolution(m);if(j){l("NATIVE WRAPPED WEBGUI");return this._constructNativeWebguiWrapResult.bind(this);}if(r.applicationType==="URL"){l("URL","inbound resolutionResult had URL applicationType");return this._constructURLResolutionResult.bind(this);}l("FALLBACK","could not apply any result processor to inbound resolutionResult: "+JSON.stringify(r,null,"   "));return this._constructFallbackResolutionResult.bind(this);};C.prototype._stripURI=function(u,s,U){var d=new jQuery.Deferred(),t=this;if(typeof s==="undefined"){this._stripURIWithSystemAlias(u,s,U,undefined).fail(function(e){d.reject(e);}).done(function(n){d.resolve(n);});return d.promise();}this._oAdapter.resolveSystemAlias(s).fail(function(e){d.reject(e);}).done(function(r){t._stripURIWithSystemAlias(u,s,U,r).fail(function(e){d.reject(e);}).done(function(n){d.resolve(n);});});return d.promise();};C.prototype._stripURIWithSystemAlias=function(u,s,U,r){var t=this,o,a,T,c,d=new jQuery.Deferred(),p=new jQuery.Deferred();u.protocol("");u.hostname("");u.port("");t._removeParametersFromURI(u,["sap-client","sap-language"]);if(!jQuery.isPlainObject(r)||typeof s!=="string"){return d.resolve(u).promise();}a=t._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol());o=r[a];c=(typeof o.pathPrefix==="string")&&o.pathPrefix;if(c!==""){p.resolve(c);}else{this._oAdapter.resolveSystemAlias("").fail(function(e){d.reject(e);}).done(function(R){var e=R[a];p.resolve(e.pathPrefix);});}p.fail(function(e){d.reject(e);}).done(function(c){if(c&&c.length>0){T=u.path();T=T.replace(c,"");if(T.indexOf("/")!==0){T="/"+T;}u.path(T);}if(U==="NATIVEWEBGUI"&&r.hasOwnProperty("rfc")){T=u.path();T=T.split(";").filter(function(P){return P.indexOf("~sysid=")!==0&&P.indexOf("~service=")!==0&&P.indexOf("~loginGroup=")!==0&&P.indexOf("~messageServer=")!==0&&P.indexOf("~sncNameR3=")!==0&&P.indexOf("~sncQoPR3=")!==0;}).join(";");u.path(T);}d.resolve(u);});return d.promise();};C.prototype._removeParametersFromURI=function(u,p){var B={},t;p.forEach(function(P){B[P]=true;});t=u.query();t=t.split("&").filter(function(P){var s=(P.split("=")[0]||"").toLowerCase();return!B.hasOwnProperty(s);}).join("&");u.query(t);};C.prototype._spliceSapSystemIntoUrlURI=function(u,s,a){var t=this,d=new jQuery.Deferred();if(typeof a==="undefined"||s===a){return d.resolve(u).promise();}if(s===""||typeof s==="undefined"){if(this._isAbsoluteURI(u)){return d.resolve(u);}t._applyAliasToURI(a,u,"URL").fail(function(e){d.reject(e);}).done(function(U){d.resolve(U);});return d.promise();}if(typeof this._oAdapter.resolveSystemAlias!=="function"){return d.reject("fallback: the adapter does not implement resolveSystemAlias").promise();}this._oAdapter.resolveSystemAlias(s).fail(function(e){d.reject(e);}).done(function(r){var c=t._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),o=r[c],D;if((u.protocol()||"").toLowerCase()===c&&(u.hostname()||"")===o.host&&(u.path().indexOf(o.pathPrefix)===0)){u.protocol("");u.hostname("");D=u.path().replace(o.pathPrefix,"");u.path(D);t._removeParametersFromURI(u,["sap-language","sap-client"]);t._applyAliasToURI(a,u,"URL").fail(function(e){d.reject(e);}).done(function(U){d.resolve(U);});}else{d.resolve(u);}});return d.promise();};C.prototype._spliceSapSystemIntoURI=function(u,s,a,U){var d=new jQuery.Deferred(),t=this;if(U==="URL"){return this._spliceSapSystemIntoUrlURI(u,s,a);}if(typeof a==="undefined"||s===a){return d.resolve(u).promise();}if(typeof this._oAdapter.resolveSystemAlias!=="function"){return d.reject("fallback: the adapter does not implement resolveSystemAlias").promise();}this._stripURI(u,s,U).fail(function(e){d.reject(e);}).done(function(o){t._applyAliasToURI(a,o,U).fail(function(e){d.reject(e);}).done(function(c){d.resolve(c);});});return d.promise();};C.prototype._applyAliasToURI=function(s,u,U){var t=this,n=u,d=new jQuery.Deferred();this._oAdapter.resolveSystemAlias(s).fail(function(e){d.reject(e);}).done(function(r){var a=t._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),o=r[a],q,l,c;n.protocol(a);n.hostname(o.host);n.port(o.port);t._interpolatePathPrefixIntoURI(n,U,o.pathPrefix).fail(function(e){d.reject(e);}).done(function(n){q=n.query();if(typeof r.client==="string"&&r.client!==""){q=q+(q.length>0?"&":"")+"sap-client="+r.client;}if(typeof r.language==="string"&&r.language!==""){l=r.language;}else{c=sap.ushell.Container.getUser();if(!c){jQuery.sap.log.error("Cannot retieve the User object via sap.ushell.Container while determining sap-language","will default to 'en' language","sap.ushell.services.ClientSideTargetResolution");l="en";}else{l=c.getLanguage();}}q=q+(q.length>0?"&":"")+"sap-language="+l;n.query(q);n=t._interpolateNativeWebguiDataIntoURI(r,n,U);d.resolve(n);});});return d.promise();};C.prototype._interpolateNativeWebguiDataIntoURI=function(s,u,U){var a,t,c,p;if(s.hasOwnProperty("rfc")&&U==="NATIVEWEBGUI"){c=s.rfc;a=!!c.systemId;if(a){t=[c.systemId&&("~sysid="+c.systemId),c.loginGroup&&("~loginGroup="+c.loginGroup),c.sncNameR3&&("~messageServer="+encodeURIComponent(c.sncNameR3)),c.sncNameR3&&("~sncNameR3="+encodeURIComponent(c.sncNameR3)),c.sncQoPR3&&("~sncQoPR3="+c.sncQoPR3)].filter(function(o){return(typeof o==="string")&&(o!=="");});}else{t=[c.service&&("~service="+c.service),c.sncNameR3&&("~sncNameR3="+encodeURIComponent(c.sncNameR3)),c.sncQoPR3&&("~sncQoPR3="+c.sncQoPR3)].filter(function(o){return(typeof o==="string")&&(o!=="");});}p=u.path()+";"+t.join(";").replace(/(%[A-F0-9]{2})/g,function(e){return e.toLowerCase();});u.path(p);u._parts.path=p;}return u;};C.prototype._interpolatePathPrefixIntoURI=function(u,U,p){var t=this,d=new jQuery.Deferred(),T;if(U==="URL"&&p.length===0){return d.resolve(u).promise();}function a(P){var r=P+u.path();u.path(r.replace(/\/+/g,"/"));d.resolve(u);}if(p.length>0){if((U==="WDA"||U==="WEBGUI")&&u.path().indexOf("~canvas")>=0){T=u.path();T="/~canvas"+T.split("~canvas")[1];u.path(T);}a(p);}else{this._oAdapter.resolveSystemAlias("").fail(function(e){d.reject(e);}).done(function(r){var s=t._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),P=r[s].pathPrefix;a(P);});}return d.promise();};C.prototype._selectSystemAliasDataName=function(s,B){if(s.hasOwnProperty("https")){return"https";}if(s.hasOwnProperty("http")){return"http";}jQuery.sap.log.error("Cannot select which system alias to pick between http/https","make sure they are provided in the given system alias collection","sap.ushell.services.ClientSideTargetResolution");return undefined;};C.prototype._getRenameParameterName=function(p,s,P){if(!P||!jQuery.isArray(P)){return p;}if(s&&s.parameters&&s.parameters[p]&&s.parameters[p].renameTo){return s.parameters[p].renameTo;}return p;};C.prototype._mapParameterNamesAndRemoveObjects=function(m){var t=this,n={},o=m.intentParamsPlusAllDefaults;Object.keys(o).sort().forEach(function(p){var r=t._getRenameParameterName(p,m.inbound.signature,o[p]);if(jQuery.isArray(m.intentParamsPlusAllDefaults[p])){if(n[r]){jQuery.sap.log.error("collision of values during parameter mapping : \""+p+"\" -> \""+r+"\"");}else{n[r]=m.intentParamsPlusAllDefaults[p];}}});m.mappedIntentParamsPlusSimpleDefaults=n;};C.prototype._constructFullWDAResolutionResult=function(m,B,f){var t=this,o=m.inbound,r=o&&o.resolutionResult,d=new jQuery.Deferred();var c={target:{"semanticObject":"Shell","action":"startWDA"},"params":{"sap-ui2-wd-app-id":[o.resolutionResult["sap.wda"].applicationId],"sap-system":[r.systemAlias]}};if(o.resolutionResult["sap.wda"].configId){c.params["sap-ui2-wd-conf-id"]=[o.resolutionResult["sap.wda"].configId];}this._resolveEasyAccessMenuIntentWDA(c,m).done(function(e){r.url=e.url;return t._constructWDAResolutionResult(m,B,f).done(function(a){d.resolve(a);}).fail(function(M){d.reject(M);});});return d.promise();};C.prototype._constructFullWebguiResolutionResult=function(m,B,f){var t=this,o=m.inbound,r=o&&o.resolutionResult,d=new jQuery.Deferred();var c={target:{"semanticObject":"Shell","action":"startGUI"},"params":{"sap-ui2-tcode":[o.resolutionResult["sap.gui"].transaction],"sap-system":[r.systemAlias]}};this._resolveEasyAccessMenuIntentWebgui(c,m).done(function(e){r.url=e.url;return t._constructWebguiNowrapResult(m,B,f).done(function(a){d.resolve(a);}).fail(function(M){d.reject(M);});});return d.promise();};C.prototype._constructWDAResolutionResult=function(m,B,f){var t=this,o=m.inbound,r=o&&o.resolutionResult,d=new jQuery.Deferred();var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);if(m.mappedDefaultedParamNames.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(m.mappedDefaultedParamNames)];}var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];t._spliceSapSystemIntoURI(w,r.systemAlias,s,"WDA").fail(d.reject.bind(d)).done(function(w){sap.ushell.Container.getService("ShellNavigation").compactParams(e,["sap-xapp-state","sap-ushell-defaultedParameterNames","sap-intent-params"],undefined,true).fail(d.reject.bind(d)).done(function(E){var a=t._getURLParsing().paramsToString(E);var p=w.search();if(a){p=p+((p.indexOf("?")<0)?"?":"&")+a;}w.search(p);["additionalInformation","applicationDependencies"].forEach(function(P){if(o.resolutionResult.hasOwnProperty(P)){m.resolutionResult[P]=o.resolutionResult[P];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=o.title;m.resolutionResult.applicationType="NWBC";d.resolve(m);});});return d.promise();};C.prototype._constructWebguiNowrapResult=function(m,B,f){var t=this,o=m.inbound,r=o&&o.resolutionResult,d=new jQuery.Deferred();var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];t._adjustDYNP_OKCODE(e,m);t._spliceSapSystemIntoURI(w,r.systemAlias,s,"WEBGUI").fail(d.reject.bind(d)).done(function(w){var E=t._getURLParsing().paramsToString(e);var p=w.search();if(E){p=p+((p.indexOf("?")<0)?"?":"&")+E;}w.search(p);["additionalInformation","applicationDependencies"].forEach(function(P){if(o.resolutionResult.hasOwnProperty(P)){m.resolutionResult[P]=o.resolutionResult[P];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=o.title;m.resolutionResult.applicationType="NWBC";d.resolve(m);});return d.promise();};C.prototype._constructWebguiWrapResult=function(m,B,f){var t=this,o=m.inbound,r=o&&o.resolutionResult,d=new jQuery.Deferred();var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];t._spliceSapSystemIntoURI(w,r.systemAlias,s,"WEBGUI").fail(d.reject.bind(d)).done(function(w){var p=w.search();p=t._injectEffectiveParametersIntoWebguiPobjectParam(p,e,"&","=");w.search(p);["additionalInformation","applicationDependencies"].forEach(function(P){if(o.resolutionResult.hasOwnProperty(P)){m.resolutionResult[P]=o.resolutionResult[P];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=o.title;m.resolutionResult.applicationType="NWBC";d.resolve(m);});return d.promise();};C.prototype._injectEffectiveParametersIntoWebguiPobjectParam=function(q,p,Q,s){var a,P="P_OBJECT"+s,m=132;var c=this._getURLParsing().privparamsToString(p,"%25","%21");if(!c){return q;}var d="";this._amendGuiParam("P_OBJECT",q,Q,s,function(e){var f=e.replace(P,"");d=decodeURIComponent(f);if(d.length>0){d=d+"%25";}return P;});c=d+c;var o={pObjX:"",pObject:""};c.match(new RegExp(".{1,"+m+"}","g")).map(function(e){return encodeURIComponent(e);}).forEach(function(e,G){var f="P_OBJECT";var h="pObject";if(G>0){f="P_OBJ"+G;h="pObjX";}var j=o[h].length===0?"":Q;o[h]=o[h]+j+f+s+e;});a=[o.pObjX,o.pObject].filter(function(e){return e.length>0;}).join(Q);var A=this._amendGuiParam("P_OBJECT",q,Q,s,function(f){return a;});if(A.found){return A.query;}return q+(q.length===0?"":Q)+a;};C.prototype._amendGuiParam=function(t,q,Q,s,a){var f=false,p=t+s;var A=q.split(Q).map(function(P){if(P.indexOf(p)!==0){return P;}f=true;return a(P);}).filter(function(P){return typeof P!=="undefined";}).join(Q);return{found:f,query:A};};C.prototype._parseWebguiTransactionQueryParam=function(t){var T="^(.+?)(%20|(%20)(.+))?$",r=new RegExp(T,"i"),s,p={hasParameters:null,transactionParamName:"",transactionCode:"",parameters:[]};var P=t.split("=");if(P.length>2){return{"error":"Found more than one assignment ('=') in the transaction query parameter","details":"Only one '=' sign is expected in "+t};}if(P.length<2||typeof P[1]==="undefined"||P[1].length===0){return{"error":"The transaction query parameter must specify at least the transaction name","details":"Got "+t+" instead."};}p.transactionParamName=P[0];s=P[1];var m=s.match(r);if(!m){return{"error":"Cannot parse ~transaction query parameter value.","details":s+" should match /"+T+"/"};}p.transactionCode=m[1];if(m[2]&&m[2]!=="%20"){var a=m[4]||"";a.split("%3b").forEach(function(n){var N=n.split("%3d"),c=N[0];if(c&&typeof c==="string"&&c.length>0){p.parameters.push({name:c,value:N[1]});}});}p.hasParameters=false;if(p.parameters.length>0){p.hasParameters=true;p.transactionCode=p.transactionCode.replace(/^[*]/,"");}return p;};C.prototype._injectEffectiveParametersIntoWebguiQueryParam=function(t,p){var P=this._parseWebguiTransactionQueryParam(t);if(P.error){jQuery.sap.log.error(P.error,P.details,"sap.ushell.services.ClientSideTargetResolution");return t;}var a=P.parameters.map(function(c){return c.name.toUpperCase()+"%3d"+c.value;});var o={};Object.keys(p).forEach(function(k){o[k.toUpperCase()]=p[k];});var s=this._getURLParsing().privparamsToString(o,"%3b","%3d");if(s){a.push(s);}var h=a.length>0;return P.transactionParamName+"="+(h?"*":"")+P.transactionCode+(h?"%20":"")+a.join("%3b");};C.prototype._constructNativeWebguiWrapResult=function(m,B,f){var t=this,o=m.inbound,r=o&&o.resolutionResult,d=new jQuery.Deferred();var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];t._spliceSapSystemIntoURI(w,r.systemAlias,s,"NATIVEWEBGUI").fail(d.reject.bind(d)).done(function(w){var p=w.search();var P=p.split("&").map(function(q){var a;if(q.indexOf("?%7etransaction")===0||q.indexOf("%7etransaction")===0){a=t._injectEffectiveParametersIntoWebguiPobjectParam(q,e,"%3b","%3d");return a;}return q;}).join("&");w.search(P);["additionalInformation","applicationDependencies"].forEach(function(a){if(o.resolutionResult.hasOwnProperty(a)){m.resolutionResult[a]=o.resolutionResult[a];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=o.title;m.resolutionResult.applicationType="TR";d.resolve(m);});return d.promise();};C.prototype._isWebguiBusinessParameter=function(n,V){var N;if(arguments.length===1){N=n.split(/[=](.+)?/);if(N.length>1){return this._isWebguiBusinessParameter.apply(this,N);}}return!(n.indexOf("sap-")===0||n.charAt(0)==="~");};C.prototype._extractWebguiNonBusinessParameters=function(p){var t=this,n={};Object.keys(p).forEach(function(P){var s=p[P];if(!t._isWebguiBusinessParameter(P,s)){n[P]=s;delete p[P];}});return n;};function i(o){return o&&o.signature&&o.signature&&o.signature.parameters&&o.signature.parameters.DYNP_OKCODE&&o.signature.parameters.DYNP_OKCODE.required===true;}C.prototype._adjustDYNP_OKCODE=function(e,m){var t=this;var a=i(m&&m.inbound);if(a){return e;}var n=Object.keys(e).reduce(function(p,P){if(!t._isWebguiBusinessParameter(P)){return p;}if(P.toUpperCase()==="DYNP_OKCODE"){return p;}return p+1;},0);if(n===0){Object.keys(e).forEach(function(p){if(p.toUpperCase()==="DYNP_OKCODE"){delete e[p];}});}return e;};C.prototype._constructNativeWebguiNowrapResult=function(m,B,f){var t=this,o=m.inbound,r=o&&o.resolutionResult,d=new jQuery.Deferred(),F={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true};var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;Object.keys(e).forEach(function(p){if(F[p.toLowerCase()]){delete e[p];}});t._adjustDYNP_OKCODE(e,m);var E=this._extractWebguiNonBusinessParameters(e);t._spliceSapSystemIntoURI(w,r.systemAlias,s,"NATIVEWEBGUI").fail(d.reject.bind(d)).done(function(w){var p=w.search();var P=p.split("&").map(function(q){var n;if(!t._isWebguiBusinessParameter(q)){if(q.indexOf("=")>=0){n=q.split("=");if(!E.hasOwnProperty(n[0])){E[n[0]]=n[1];}}else{jQuery.sap.log.error("Found no '=' separator of Webgui non-business parameter. Parameter will be skipped.","'"+q+"'","sap.ushell.services.ClientSideTargetResolution");}return undefined;}var c;if(q.indexOf("?%7etransaction")===0||q.indexOf("%7etransaction")===0){c=t._injectEffectiveParametersIntoWebguiQueryParam(q,e,"%3b","%3d");return c;}return q;}).filter(function(c){return typeof c!=="undefined";}).join("&");var a=t._getURLParsing().paramsToString(E);P=[P,a.replace("~","%7e")].join("&");w.search(P);["additionalInformation","applicationDependencies","sap.platform.runtime"].forEach(function(c){if(o.resolutionResult.hasOwnProperty(c)){m.resolutionResult[c]=o.resolutionResult[c];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=o.title;m.resolutionResult.applicationType="TR";d.resolve(m);});return d.promise();};C.prototype._constructSAPUI5ResolutionResult=function(m,B,f){var o=m.inbound,d=new jQuery.Deferred(),u,s,e;["applicationType","additionalInformation","url","applicationDependencies"].forEach(function(p){if(o.resolutionResult.hasOwnProperty(p)){m.resolutionResult[p]=o.resolutionResult[p];}});if(m.resolutionResult.applicationDependencies&&typeof m.resolutionResult.applicationDependencies.manifestUrl==="string"&&typeof m.resolutionResult.url==="undefined"){m.resolutionResult.url="";}if(typeof m.resolutionResult.url==="undefined"){return d.reject("Cannot resolve intent: url was not specified in matched inbound").promise();}e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);if(m.mappedDefaultedParamNames.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(m.mappedDefaultedParamNames)];}s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;u=this._getURLParsing().paramsToString(e);if(u){m.resolutionResult.url=o.resolutionResult.url+((o.resolutionResult.url.indexOf("?")<0)?"?":"&")+u;}if(typeof o.resolutionResult.ui5ComponentName!=="undefined"){m.resolutionResult.ui5ComponentName=o.resolutionResult.ui5ComponentName;}m.resolutionResult.text=o.title;d.resolve(m);return d.promise();};C.prototype._isAbsoluteURI=function(u){return(u.protocol()||"").length>0;};C.prototype._constructURLResolutionResult=function(m,B,f){var t=this,o=m.inbound,r=o&&o.resolutionResult,d=new jQuery.Deferred();var u=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);if(m.inbound&&m.inbound.action==="launchURL"&&m.inbound.semanticObject==="Shell"){delete e["sap-external-url"];}var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];t._spliceSapSystemIntoURI(u,r.systemAlias,s,"URL").fail(d.reject.bind(d)).done(function(a){var c=a.toString(),h,F,A;A=t._getURLParsing().paramsToString(e);if(A){if(a.fragment()){F="#"+a.fragment();h=c.replace(/#.*/,"");}else{h=c;F="";}c=h+((c.indexOf("?")<0)?"?":"&")+A+F;}["additionalInformation","applicationDependencies"].forEach(function(p){if(o.resolutionResult.hasOwnProperty(p)){m.resolutionResult[p]=o.resolutionResult[p];}});m.resolutionResult.url=c;m.resolutionResult.text=o.title;m.resolutionResult.applicationType="URL";d.resolve(m);});return d.promise();};C.prototype._constructFallbackResolutionResult=function(m,B,f){var d=new jQuery.Deferred(),e={},D;Object.keys(m.intentParamsPlusAllDefaults).forEach(function(p){if(jQuery.isArray(m.intentParamsPlusAllDefaults[p])){e[p]=m.intentParamsPlusAllDefaults[p];}});D=m.mappedDefaultedParamNames||m.defaultedParamNames;if(D.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(D)];}if(typeof B!=="function"){jQuery.sap.log.error("Cannot resolve hash fragment",f+" has matched an inbound that cannot be resolved client side"+" and no resolveHashFragmentFallback method was implemented in ClientSideTargetResolutionAdapter","sap.ushell.services.ClientSideTargetResolution");d.reject("Cannot resolve hash fragment: no fallback provided.");return d.promise();}jQuery.sap.log.warning("Cannot resolve hash fragment client side",f+" has matched an inbound that cannot be resolved client side. Using fallback logic","sap.ushell.services.ClientSideTargetResolution");B(f,jQuery.extend(true,{},m.inbound),e).done(function(r){["applicationType","additionalInformation","url","applicationDependencies","text"].forEach(function(p){if(r.hasOwnProperty(p)){m.resolutionResult[p]=r[p];}});d.resolve(m);}).fail(d.reject.bind(d));return d.promise();};C.prototype.getDistinctSemanticObjects=function(){var d=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(a){var s={};a.forEach(function(o){if(typeof o.semanticObject==="string"&&o.semanticObject!=="*"&&!o.hideIntentLink&&o.semanticObject.length>0){s[o.semanticObject]=true;}});d.resolve(Object.keys(s).sort());},function(){d.reject.apply(d,arguments);});return d.promise();};C.prototype.getLinks=function(a){var t=this,s,p,c,d=new jQuery.Deferred(),o;if(arguments.length===1&&jQuery.isPlainObject(arguments[0])){var a=arguments[0];o=jQuery.extend(true,{},a);["action","semanticObject"].forEach(function(A){if(a.hasOwnProperty(A)){o[A]=a[A];}});if(o.appStateKey){o.params=o.params||{};o.params["sap-xapp-state"]=[o.appStateKey];delete o.appStateKey;}}else if(arguments.length<=3){jQuery.sap.log.warning("Passing positional arguments to getLinks is deprecated","Please use nominal arguments instead","sap.ushell.services.ClientSideTargetResolution");s=arguments[0];p=arguments[1];c=arguments[2];o={semanticObject:s,params:p,ignoreFormFactor:c};}else{return d.reject("invalid arguments for getLinks").promise();}this._oInboundProvider.getInbounds().then(function(e){t._getLinks(o,e).done(d.resolve.bind(d)).fail(d.reject.bind(d));},function(){d.reject.apply(d,arguments);});return d.promise();};C.prototype._validateGetSemanticObjectLinksArgs=function(a){var s=a.semanticObject,A=a.action,c=!a.hasOwnProperty("action");if(typeof s!=="undefined"||c){if(typeof s!=="string"){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must be a string, got "+Object.prototype.toString.call(s)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}if(c&&s.match(/^\s+$/)){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must be a non-empty string, got '"+s+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}if(!c&&s.length===0){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must not be an empty string, got '"+s+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}}if(typeof A!=="undefined"){if(typeof A!=="string"){jQuery.sap.log.error("invalid input for _getLinks","the action must be a string, got "+Object.prototype.toString.call(A)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action";}if(A.length===0){jQuery.sap.log.error("invalid input for _getLinks","the action must not be an empty string, got '"+A+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action";}}return undefined;};C.prototype._getLinks=function(a,c){var s=a.semanticObject,A=a.action,p=a.params,w=!!a.withAtLeastOneUsedParam,t=!!a.treatTechHintAsFilter,d=a.ignoreFormFactor,e=a.sortResultOnTexts?"text":"intent";var E=this._validateGetSemanticObjectLinksArgs(a);if(E){return new jQuery.Deferred().reject(E).promise();}if(s==="*"){return new jQuery.Deferred().resolve([]).promise();}function f(u,p){var B=u.paramsToString(p);return B?"?"+B:"";}var h=this,u=this._getURLParsing(),D=new jQuery.Deferred(),F=sap.ushell.utils.getFormFactor(),o=u.parseParameters(f(u,p)),j={semanticObject:(s===""?undefined:s),action:A,formFactor:(d?undefined:F),params:o};if(t){j.treatTechHintAsFilter=true;}this._getMatchingInbounds(j,c,true).done(function(m){var U={},r=m.map(function(M){var k=s||M.inbound.semanticObject,l="#"+k+"-"+M.inbound.action,n;if(k==="*"){return undefined;}if(M.inbound.action==="*"){return undefined;}if(M.inbound&&M.inbound.hasOwnProperty("hideIntentLink")&&M.inbound.hideIntentLink===true){return undefined;}if(!U.hasOwnProperty(l)){U[l]=1;if(M.inbound.signature.additionalParameters==="ignored"){n=h._filterObjectKeys(o,function(x){return(x.indexOf("sap-")===0)||M.inbound.signature.parameters.hasOwnProperty(x);},false);}else{n=o;}if(w){var q=Object.keys(n).some(function(N){return N.indexOf("sap-")!==0;});if(!q){return undefined;}}return{"intent":l+f(u,n),"text":M.inbound.title};}else{U[l]++;}return undefined;}).filter(function(k){return typeof k==="object";}).sort(function(G,k){return G[e]<k[e]?-1:1;});if(r.length===0){jQuery.sap.log.debug("_getLinks returned no results");}else if(jQuery.sap.log.getLevel()>=jQuery.sap.log.Level.DEBUG){if(jQuery.sap.log.getLevel()>=jQuery.sap.log.Level.TRACE){var R=[];r.forEach(function(k){var l=k.intent.split("?")[0],L="- "+l+" ("+U[l]+") "+"text: "+k.text+" "+"intent: "+k.intent;R.push(L);});jQuery.sap.log.debug("_getLinks filtered to the following unique intents:",R.join("\n"),"sap.ushell.services.ClientSideTargetResolution");}else{jQuery.sap.log.debug("_getLinks filtered to unique intents.","Reporting histogram: "+Object.keys(U).join(", "),"sap.ushell.services.ClientSideTargetResolution");}}D.resolve(r);}).fail(D.reject.bind(D));return D.promise();};C.prototype._serializeMatchingResult=function(m,a){var r=m.inbound.resolutionResult;return["applicationType","ui5ComponentName","url","additionalInformation","text"].map(function(k){if(a){return r.hasOwnProperty(k)?k+":"+r[k]:"";}return r.hasOwnProperty(k)?r[k]:"";}).join("");};C.prototype._getMatchingInbounds=function(s,a,e){var t=this,d=new jQuery.Deferred(),r=new jQuery.Deferred(),R=new jQuery.Deferred();function w(c){var h=jQuery.sap.log.getLevel();if(h>=jQuery.sap.log.Level.DEBUG){var j=h>=jQuery.sap.log.Level.TRACE;c(j);}}function u(k,V){return this[k]===undefined?"<undefined>":V;}var f=function(){var m=[],M={},p=[],P=[],n={};w(function(){jQuery.sap.log.debug("Intent to navigate to is: \"#"+((s||{}).semanticObject||"")+"-"+((s||{}).action||"")+"\" with parameters"+"\n"+JSON.stringify(s.params,u,"   "),null,"sap.ushell.services.ClientSideTargetResolution");});P=a;if(e){P=a.filter(function(o){return!o.tileResolutionResult||!o.tileResolutionResult.isCustomTile;});}P.forEach(function(o){var c=t._matchToInbound(s,o,{},M);if(c.matches){m.push(c);p.push(o);}else{w(function(){if(!n[c.noMatchReason]){n[c.noMatchReason]=[];}n[c.noMatchReason].push("#"+(c.inbound||{}).semanticObject+"-"+(c.inbound||{}).action+(c.noMatchDebug?"|"+c.noMatchDebug:""));});}});w(function(c){if(c){Object.keys(n).forEach(function(h){jQuery.sap.log.debug(h+": "+n[h].join("; "),null,"sap.ushell.services.ClientSideTargetResolution");});}});if(jQuery.isEmptyObject(M)){r.resolve(m);}else{w(function(c){jQuery.sap.log.debug(c?"A rematch is required because the following user defaults need to be determined:"+"\n"+Object.keys(M).join("\n"):"A rematch is required because one or more user defaults need to be determined.",null,"sap.ushell.services.ClientSideTargetResolution");});w(function(){jQuery.sap.log.debug("Waiting for ReferenceResolver service to resolve all missing UserDefault references","Promises are being resolved...","sap.ushell.services.ClientSideTargetResolution");});sap.ushell.Container.getService("ReferenceResolver").resolveReferences(Object.keys(M)).done(function(o){R.resolve(o,p);w(function(){jQuery.sap.log.debug("ReferenceResolver service has resolved all UserDefault references","All Promises are resolved","sap.ushell.services.ClientSideTargetResolution");});}).fail(function(E){jQuery.sap.log.error("Failed to resolve all references",E,"sap.ushell.services.ClientSideTargetResolution");r.resolve([]);});}};if(sap.ushell.utils.getParameterValueBoolean("sap-ushell-cstr-timeout")){setTimeout(f,0);}else{f();}R.done(function(k,p){w(function(c){jQuery.sap.log.debug(c?"Rematching with the following resolved user defaults:"+JSON.stringify(k,u,"   "):"Rematching with resolved user defaults.",null,"sap.ushell.services.ClientSideTargetResolution");});var P=[],m={};p.forEach(function(o){var M=t._matchToInbound(s,o,k,m);if(M.matches){P.push(M);}});if(jQuery.isEmptyObject(m)){r.resolve(P);}else{jQuery.sap.log.error("Still obtained unknown references during rematch",JSON.stringify(m,u,"   "),"sap.ushell.services.ClientSideTargetResolution");d.reject("Rematching returned unknown references!");}});r.done(function(p){t._sortMatchingResultsDeterministic(p);w(function(c){if(p.length===0){w(function(){jQuery.sap.log.debug("The intent did not match any inbounds",null,"sap.ushell.services.ClientSideTargetResolution");});return;}var T=0,h=function(l,m){return(l==="_original")?undefined:u.call(this,l,m);},j=p.map(function(m){var l="";T++;if(c){l=" "+(m["sap-priority"]||"")+" Priority: "+(m["sap-priority"]?"sap-priority : "+m["sap-priority"]:"")+m.priorityString+" Signature: "+t._compactSignatureNotation((m.inbound||{}).signature)+" Deterministic blob: "+t._serializeMatchingResult(m,true);}return T+". #"+(m.inbound||{}).semanticObject+"-"+(m.inbound||{}).action+(m.matchesVirtualInbound?" (virtual)":"")+l;}).join("\n"),k=c?JSON.stringify(p[0],u,"   "):JSON.stringify(p[0].resolutionResult||p[0],h,"   ");jQuery.sap.log.debug("Intent has matched the following inbounds (in priority): \n"+j,"\nTop matched inbound resolves to:"+k,"sap.ushell.services.ClientSideTargetResolution");});d.resolve(p);});return d.promise();};C.prototype._sortMatchingResultsDeterministic=function(m){var t=this;m.sort(function(M,o){if((M["sap-priority"]||0)-(o["sap-priority"]||0)!==0){return-((M["sap-priority"]||0)-(o["sap-priority"]||0));}if(M.priorityString<o.priorityString){return 1;}if(M.priorityString>o.priorityString){return-1;}return(t._serializeMatchingResult(M)<t._serializeMatchingResult(o))?1:-1;});};C.prototype._isIntentSupportedOne=function(s,a){var d=new jQuery.Deferred(),o=this._getURLParsing().parseShellHash(s);if(s==="#"){d.resolve(true);return d.promise();}if(o===undefined){jQuery.sap.log.error("Could not parse shell hash '"+s+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return d.reject().promise();}o.formFactor=sap.ushell.utils.getFormFactor();this._getMatchingInbounds(o,a,true).done(function(t){d.resolve(t.length>0);}).fail(function(){d.reject();});return d.promise();};C.prototype.isIntentSupported=function(a){var t=this,d=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(c){t._isIntentSupported(a,c).done(d.resolve.bind(d)).fail(d.reject.bind(d));},function(){d.reject.apply(d,arguments);});return d.promise();};C.prototype._isIntentSupported=function(a,c){var t=this,d=new jQuery.Deferred(),s={};d.resolve();function e(f,h){s[f]={supported:h};}a.forEach(function(f){var n=t._isIntentSupportedOne(f,c);n.fail(function(E){e(f,false);});n.done(function(R){e(f,R);});d=jQuery.when(d,n);});var r=new jQuery.Deferred();d.done(function(){r.resolve(s);}).fail(function(){r.reject.bind(d);});return r.promise();};C.prototype.getUserDefaultParameterNames=function(){var t=this,d=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(a){var r;try{r=t._getUserDefaultParameterNames(a);d.resolve(r);}catch(e){d.reject("Cannot get user default parameters from inbounds: "+e);}},function(){d.reject.apply(d,arguments);});return d.promise();};C.prototype._getUserDefaultParameterNames=function(a){var r={simple:{},extended:{}};a.forEach(function(t){var s=t.signature&&t.signature.parameters||[];Object.keys(s).forEach(function(p){var P=s[p],R,e,c,o;if(P){if(P.filter&&P.filter.format==="reference"){c=P.filter.value;}else if(P.defaultValue&&P.defaultValue.format==="reference"){c=P.defaultValue.value;}if(typeof c==="string"){o=sap.ushell.Container.getService("ReferenceResolver");R=o.extractUserDefaultReferenceName(c);if(typeof R==="string"){r.simple[R]={};}e=o.extractExtendedUserDefaultReferenceName(c);if(typeof e==="string"){r.extended[e]={};}}}});});return r;};C.prototype._compactSignatureNotation=function(s){var f=s||{};var p=f.parameters||{},t={optional:"[FORMAT]",required:"FORMAT"},F={regexp:"/VALUE/",reference:"@VALUE",value:"VALUE",plain:"VALUE",_unknown:"?VALUE"},a={allowed:"<+>",notallowed:"<->",ignored:"<o>",_unknown:"<?>"};if(jQuery.isEmptyObject(p)){return"<no params>"+(a[f.additionalParameters||"_unknown"]);}var r=[];Object.keys(p).forEach(function(P){var o=p[P],c=o.required?"required":"optional",d=o.filter&&o.filter.value,e=o.defaultValue&&o.defaultValue.value,h=(o.filter&&o.filter.format)||"plain",j=(o.defaultValue&&o.defaultValue.format)||"plain";var V=[],k=F[h]||F._unknown,l=F[j]||F._unknown;if(d){V.push(t["required"].replace("FORMAT",k.replace("VALUE",d)));}if(e){V.push(t["optional"].replace("FORMAT",l.replace("VALUE",e)));}r.push(t[c].replace("FORMAT",P+":"+V.join("")));});return r.join(";")+(a[f.additionalParameters||"_unknown"]);};C.prototype._isLegacyApplicationType=function(a){switch(a){case"WDA":case"TR":case"NWBC":return true;default:return false;}};C.prototype.getEasyAccessSystems=function(m){var t=this,r={},a,V,d;m=m||"sapMenu";if(this._oHaveEasyAccessSystemsDeferreds[m]){return this._oHaveEasyAccessSystemsDeferreds[m].promise();}this._oHaveEasyAccessSystemsDeferreds[m]=new jQuery.Deferred();d=this._oHaveEasyAccessSystemsDeferreds[m];function c(o,s,V){return o&&o.semanticObject&&o.semanticObject==="Shell"&&o.action&&V[m][o.action]&&o.deviceTypes&&s!==undefined&&o.deviceTypes[s];}function e(o){return["#"+o.semanticObject,"-",o.action,", signature: "+t._compactSignatureNotation((o||{}).signature)].join("");}a={startGUI:{priority:3,appType:"TR"},startWDA:{priority:2,appType:"WDA"},startURL:{priority:1,appType:"URL"}};V={userMenu:{startGUI:true,startWDA:true,startURL:true},sapMenu:{startGUI:true,startWDA:true,startURL:false}};this._oInboundProvider.getInbounds().then(function(f){var l={};f.filter(function(o){return c(o,sap.ushell.utils.getFormFactor(),V);}).forEach(function(E){var s;if(jQuery.isPlainObject(E.signature.parameters["sap-system"])&&E.signature.parameters["sap-system"].hasOwnProperty("filter")){s=jQuery.sap.getObject("signature.parameters.sap-system.filter.value",undefined,E);}if(typeof s==="string"){var h=a[E.action].priority;var j=a[E.action].appType;if(!r[s]){l[s]=-1;r[s]={appType:{}};}if(l[s]<h){r[s].text=E.title;l[s]=h;}r[s].appType[j]=true;}else{jQuery.sap.log.warning("Cannot extract sap-system from easy access menu inbound: "+e(E),"This parameter is supposed to be a string. Got '"+s+"' instead.","sap.ushell.services.ClientSideTargetResolution");}});d.resolve(r);},function(){d.reject.apply(d,arguments);});return d.promise();};C.hasNoAdapter=false;return C;},true);
