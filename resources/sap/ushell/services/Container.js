// @copyright@
sap.ui.define(['sap/ushell/utils','sap/ushell/System'],function(u,S){"use strict";var a="sap.ushell.services.Container",b="sap.ushell.Container.dirtyState.",c,p,f;function d(){close();}function r(){document.location="about:blank";}function g(P){if(p&&p[P]){return p[P];}return"sap.ushell.adapters."+P;}function h(s){return(c.services&&c.services[s])||{};}function j(n,s,P){var A=h(n).adapter||{},e=A.module||g(s.getPlatform())+"."+n+"Adapter";jQuery.sap.require(e);return new(jQuery.sap.getObject(e))(s,P,{config:A.config||{}});}function C(A){var E=new sap.ui.base.EventProvider(),k=false,R=[],o={},s="sap.ushell.Container."+A.getSystem().getPlatform()+".remoteSystem.",m={},G,l,L=u.getLocalStorage(),n=new u.Map(),q="sap.ushell.Container."+A.getSystem().getPlatform()+".sessionTermination",t=this;this.cancelLogon=function(){if(this.oFrameLogonManager){this.oFrameLogonManager.cancelXHRLogon();}};this.createRenderer=function(e){var i,x,y,z,B;e=e||c.defaultRenderer;if(!e){throw new Error("Missing renderer name");}B=(c.renderers&&c.renderers[e])||{};x=B.module||(e.indexOf(".")<0?"sap.ushell.renderers."+e+".Renderer":e);jQuery.sap.require(x);if(B.componentData&&B.componentData.config){i={config:B.componentData.config};}y=new(jQuery.sap.getObject(x))({componentData:i});if(y instanceof sap.ui.core.UIComponent){z=new sap.ui.core.ComponentContainer({component:y,height:"100%",width:"100%"});}else{z=y;}if(!(z instanceof sap.ui.core.Control)){throw new Error("Unsupported renderer type for name "+e);}o[e]=z;E.fireEvent("rendererCreated",{renderer:y});return z;};this.getRenderer=function(e){var i,x;e=e||c.defaultRenderer;if(e){i=o[e];}else{x=Object.keys(o);if(x.length===1){i=o[x[0]];}else{jQuery.sap.log.warning("getRenderer() - cannot determine renderer, because no default renderer is configured and multiple instances exist.",undefined,a);}}if(i instanceof sap.ui.core.ComponentContainer){return i.getComponentInstance();}return i;};this.DirtyState={CLEAN:"CLEAN",DIRTY:"DIRTY",MAYBE_DIRTY:"MAYBE_DIRTY",PENDING:"PENDING",INITIAL:"INITIAL"};this.getGlobalDirty=function(){var i,D=new jQuery.Deferred(),U=jQuery.sap.uid(),x,P=0,y=this.DirtyState.CLEAN;function z(){if(P===0||y===t.DirtyState.DIRTY){D.resolve(y);jQuery.sap.log.debug("getGlobalDirty() Resolving: "+y,null,"sap.ushell.Container");}}function B(F){if(F.key.indexOf(b)===0&&F.newValue!==t.DirtyState.INITIAL&&F.newValue!==t.DirtyState.PENDING){jQuery.sap.log.debug("getGlobalDirty() Receiving event key: "+F.key+" value: "+F.newValue,null,"sap.ushell.Container");if(F.newValue===t.DirtyState.DIRTY||F.newValue===t.DirtyState.MAYBE_DIRTY){y=F.newValue;}P-=1;z();}}try{L.setItem(U,"CHECK");L.removeItem(U);}catch(e){jQuery.sap.log.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.Container");return D.resolve(this.DirtyState.MAYBE_DIRTY).promise();}if(G){throw new Error("getGlobalDirty already called!");}G=D;window.addEventListener('storage',B);D.always(function(){window.removeEventListener('storage',B);G=undefined;});for(i=L.length-1;i>=0;i-=1){x=L.key(i);if(x.indexOf(b)===0){if(L.getItem(x)==='PENDING'){L.removeItem(x);jQuery.sap.log.debug("getGlobalDirty() Cleanup of unresolved 'PENDINGS':"+x,null,"sap.ushell.Container");}else{P+=1;u.localStorageSetItem(x,this.DirtyState.PENDING,true);jQuery.sap.log.debug("getGlobalDirty() Requesting status for: "+x,null,"sap.ushell.Container");}}}z();setTimeout(function(){if(D.state()!=="resolved"){D.resolve('MAYBE_DIRTY');jQuery.sap.log.debug("getGlobalDirty() Timeout reached, - resolved 'MAYBE_DIRTY'",null,"sap.ushell.Container");}},P*2000);return D.promise();};this.getLogonSystem=function(){return A.getSystem();};this.getUser=function(){return A.getUser();};this.getDirtyFlag=function(){for(var i=0;i<R.length;i++){k=k||R[i].call();}return k;};this.setDirtyFlag=function(i){k=i;};this.registerDirtyStateProvider=function(D){if(typeof D!=="function"){throw new Error("fnDirty must be a function");}R.push(D);};this.getService=function(e,P){var i={},M,K,x,y,z,B,D,F;function H(I){var J=new jQuery.Deferred();if(!I){throw new Error("Missing system");}J.resolve(j(e,I,P));sap.ushell.Container.addRemoteSystem(I);return J.promise();}if(!e){throw new Error("Missing service name");}if(e.indexOf(".")>=0){throw new Error("Unsupported service name");}D=h(e);M=D.module||"sap.ushell.services."+e;K=M+"/"+(P||"");F={config:D.config||{}};if(!n.containsKey(K)){x=sap.ui.requireSync(M.replace(/[.]/g,"/"));if(x.hasNoAdapter){y=new x(i,P,F);}else{B=j(e,A.getSystem(),P);i.createAdapter=H;y=new x(B,i,P,F);}n.put(K,y);return y;}return n.get(K);};function v(){var x,y,i,K;for(i=L.length-1;i>=0;i-=1){K=L.key(i);if(K.indexOf(s)===0){try{x=K.substring(s.length);y=JSON.parse(L.getItem(K));m[x]=new S(y);}catch(e){L.removeItem(K);}}}return m;}function w(){function e(i,x,F){jQuery.sap.log.warning(i,null,"sap.ushell.Container");if(F){setTimeout(F.bind(null,i),5000);}return{abort:function(){return;}};}OData.read=function(i,x,F){return e("OData.read('"+(i&&i.Uri?i.requestUri:i)+"') disabled during logout processing",x,F);};OData.request=function(i,x,F){return e("OData.request('"+(i?i.requestUri:"")+"') disabled during logout processing",x,F);};}this.addRemoteSystem=function(e){var i=e.getAlias(),O=m[i];if(O){if(O.toString()===e.toString()){return;}jQuery.sap.log.warning("Replacing "+O+" by "+e,null,"sap.ushell.Container");}else{jQuery.sap.log.debug("Added "+e,null,"sap.ushell.Container");}m[i]=e;u.localStorageSetItem(s+i,e);};this.addRemoteSystemForServiceUrl=function(e){var M,i={baseUrl:";o="};if(!e||e.charAt(0)!=='/'||e.indexOf('//')===0){return;}M=/^[^?]*;o=([^\/;?]*)/.exec(e);if(M&&M.length>=2){i.alias=M[1];}e=e.replace(/;[^\/?]*/g,"");if(/^\/sap\/(bi|hana|hba)\//.test(e)){i.platform="hana";i.alias=i.alias||"hana";}else if(/^\/sap\/opu\//.test(e)){i.platform="abap";}if(i.alias&&i.platform){this.addRemoteSystem(new S(i));}};this.attachLogoutEvent=function(F){E.attachEvent("Logout",F);};this.detachLogoutEvent=function(F){E.detachEvent("Logout",F);};this.attachRendererCreatedEvent=function(F){E.attachEvent("rendererCreated",F);};this.detachRendererCreatedEvent=function(F){E.detachEvent("rendererCreated",F);};this.logout=function(){var D=new jQuery.Deferred();function i(){A.logout(true).always(function(){L.removeItem(q);D.resolve();});}function x(){if(E.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}function y(){var m,z=[];if(l){window.removeEventListener('storage',l);}u.localStorageSetItem(q,"pending");t._suppressOData();m=t._getRemoteSystems();Object.keys(m).forEach(function(B){try{z.push(j("Container",m[B]).logout(false));}catch(e){jQuery.sap.log.warning("Could not create adapter for "+B,e.toString(),"sap.ushell.Container");}L.removeItem(s+B);});jQuery.when.apply(jQuery,z).done(x);}if(typeof A.addFurtherRemoteSystems==='function'){A.addFurtherRemoteSystems().always(y);}else{y();}return D.promise();};this.setLogonFrameProvider=function(e){if(this.oFrameLogonManager){this.oFrameLogonManager.setLogonFrameProvider(e);}};this._closeWindow=d;this._redirectWindow=r;this._getRemoteSystems=v;this._suppressOData=w;sap.ui.getCore().getEventBus().subscribe("sap.ushell.Container","addRemoteSystemForServiceUrl",function(e,i,D){t.addRemoteSystemForServiceUrl(D);});if(typeof A.logoutRedirect==='function'){l=function(e){function i(){t._closeWindow();t._redirectWindow();}if(sap.ushell.Container!==t){return;}if(e.key.indexOf(s)===0&&e.newValue&&e.newValue!==L.getItem(e.key)){u.localStorageSetItem(e.key,e.newValue);}if(e.key===q){if(e.newValue==="pending"){t._suppressOData();if(E.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}}};window.addEventListener('storage',l);}}sap.ushell.bootstrap=function(P,A){var o,e;if(sap.ushell.Container!==undefined){e=new Error("Unified shell container is already initialized - cannot initialize twice.\nStacktrace of first initialization:"+f);jQuery.sap.log.error(e,e.stack,a);throw e;}sap.ushell.Container=null;f=(new Error()).stack;c=jQuery.extend({},true,window["sap-ushell-config"]||{});p=A;if(typeof window["sap.ushell.bootstrap.callback"]==="function"){setTimeout(window["sap.ushell.bootstrap.callback"]);}if(c.modulePaths){Object.keys(c.modulePaths).forEach(function(m){jQuery.sap.registerModulePath(m,c.modulePaths[m]);});}o=j("Container",new S({alias:"",platform:c.platform||P}));return o.load().done(function(){sap.ushell.Container=new C(o);sap.ushell.Container.getService("PluginManager").registerPlugins(c.bootstrapPlugins);});};});
