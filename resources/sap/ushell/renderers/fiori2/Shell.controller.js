// @copyright@
sap.ui.define(['sap/ushell/ui5service/ShellUIService','sap/ui/core/IconPool','sap/ushell/CanvasShapesManager','./AccessKeysHandler','./History','./Lifecycle','./ShellModel','sap/ushell/services/AppConfiguration','sap/ushell/services/AppType','sap/ushell/services/Message','sap/ushell/services/Notifications','sap/ushell/services/ShellNavigation','sap/ushell/ui/launchpad/Fiori2LoadingDialog','sap/ushell/utils','sap/ushell/components/container/ApplicationContainer'],function(S,I,C,A,H,L,a,b,c,M,N,d,F,u,f){"use strict";var g=true,h=true,B=false,s,m,n={embedded:"embedded",newWindowThenEmbedded:"newWindowThenEmbedded",newWindow:"newWindow",replace:"replace"},o={},j,k=['minimal','app','standalone','embedded','headerless','merged','home','blank'],l,p=false;sap.ui.controller("sap.ushell.renderers.fiori2.Shell",{onInit:function(){h=true;B=false;g=true;var o=(this.getView().getViewData()?this.getView().getViewData().config:{})||{};this.initPromises();this.bMeAreaSelected=false;this.oEndUserFeedbackConfiguration={showAnonymous:true,anonymousByDefault:true,showLegalAgreement:true,showCustomUIContent:true,feedbackDialogTitle:true,textAreaPlaceholder:true,customUIContent:undefined};this.bUserImageAlreadyLoaded=undefined;this.bMeAreaLoaded=false;this.bNotificationsSelected=false;o["enableBackGroundShapes"]=o.enableBackGroundShapes===undefined?true:o.enableBackGroundShapes;j=this._historyBackNavigation;this.initShellModel(o);this.getView().setModel(m);this.getView().setModel(sap.ushell.resources.i18nModel,"i18n");sap.ui.getCore().getEventBus().subscribe("externalSearch",this.externalSearchTriggered,this);this._setConfigurationToModel();sap.ui.getCore().getEventBus().subscribe("launchpad","contentRendered",this._loadCoreExt,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this.loadUserImage,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this.setBackGroundShapes,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell","coreResourcesFullyLoaded",this._postCoreExtActivities,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this.delayedCloseLoadingScreen,this);sap.ui.getCore().getEventBus().subscribe("launchpad","toggleContentDensity",this.toggleContentDensity,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this._loadCoreExtNWBC,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);sap.ui.getCore().getEventBus().subscribe("launchpad","appClosed",this.logApplicationUsage,this);sap.ui.getCore().getEventBus().subscribe("launchpad","launchpadCustomRouterRouteMatched",this._centerViewPort,this);sap.ushell.Container.getService("AppLifeCycle");if(sap.ushell.Container.getService("Notifications").isEnabled()===true){m.setProperty("/enableNotifications",true);sap.ushell.Container.getService("Notifications").init();if(o.enableNotificationsUI===true){m.setProperty("/enableNotificationsUI",true);sap.ushell.Container.getService("Notifications").registerDependencyNotificationsUpdateCallback(this.notificationsCountUpdateCallback.bind(this),true);}}this.history=new H();this.oViewPortContainer=sap.ui.getCore().byId("viewPortContainer");this.oNotificationsCountButton=sap.ui.getCore().byId("NotificationsCountButton");this.oFiori2LoadingDialog=sap.ui.getCore().byId("Fiori2LoadingDialog");this.oShellNavigation=sap.ushell.Container.getService("ShellNavigation");this.oShellNavigation.registerNavigationFilter(jQuery.proxy(this._handleEmptyHash,this));this.oShellNavigation.init(jQuery.proxy(this.doHashChange,this));this.oShellNavigation.registerNavigationFilter(jQuery.proxy(this.handleDataLoss,this));sap.ushell.Container.getService("Message").init(jQuery.proxy(this.doShowMessage,this));sap.ushell.Container.setLogonFrameProvider(this._getLogonFrameProvider());this.bContactSupportEnabled=sap.ushell.Container.getService("SupportTicket").isEnabled();A.init(m);window.onbeforeunload=function(){if(sap.ushell.Container&&sap.ushell.Container.getDirtyFlag()){if(!sap.ushell.resources.browserI18n){sap.ushell.resources.browserI18n=sap.ushell.resources.getTranslationModel(window.navigator.language).getResourceBundle();}return sap.ushell.resources.browserI18n.getText("dataLossExternalMessage");}};if(m.getProperty("/contentDensity")){this._applyContentDensityClass();}if(m.getProperty("/enableNotificationsUI")===true){s.addHeaderEndItem(["NotificationsCountButton"],false,["home","app","minimal"],true);}sap.ui.Device.media.attachHandler(this.onScreenSizeChange.bind(this),null,sap.ui.Device.media.RANGESETS.SAP_STANDARD);this.onScreenSizeChange(sap.ui.Device.media.getCurrentRange(sap.ui.Device.media.RANGESETS.SAP_STANDARD));this.initShellUIService();if(this.getView().oShellNavigationMenu){this.getView().oShellNavigationMenu.setModel(m);}sap.ui.getCore().attachThemeChanged(this.redrawBackGroundShapes);},initPromises:function(){l=jQuery.Deferred();},initShellModel:function(o){s=a;s.init(o);m=s.getModel();},redrawBackGroundShapes:function(){if(o.enableBackGroundShapes){C.drawShapes();}},setBackGroundShapes:function(){var v=this.getView(),m=v.getModel(),e=m.getProperty('/animationMode')!=='minimal';;if(!B&&o.enableBackGroundShapes){B=true;C.drawShapes();C.enableAnimationDrawing(e);}},initShellUIService:function(){this.oShellUIService=new S({scopeObject:this.getOwnerComponent(),scopeType:"component"});this.oShellUIService._attachHierarchyChanged(this.onHierarchyChange.bind(this));this.oShellUIService._attachTitleChanged(this.onTitleChange.bind(this));this.oShellUIService._attachRelatedAppsChanged(this.onRelatedAppsChange.bind(this));this.oShellUIService._attachBackNavigationChanged(this.onBackNavigationChange.bind(this));if(o.enableOnlineStatus){sap.ui.require(["sap/ushell/ui5service/UserStatus"],function(U){this.oUserStatus=new U({scopeObject:this.getOwnerComponent(),scopeType:"component"});this.oUserStatus.attachEnabledStatusChanged(function(e){this.getModel().setProperty("/userStatusEnabled",e.mParameters.data);}.bind(this));this.oUserStatus.attachStatusChanged(function(e){this.getModel().setProperty("/userStatus",e.mParameters.data);if(e.mParameters.data==null){this.getModel().setProperty("/userStatusUserEnabled",false);}else{this.getModel().setProperty("/userStatusUserEnabled",true);}}.bind(this));}.bind(this));}},onHierarchyChange:function(e){this.isHierarchyChanged=true;var i=e.getParameters().data,q,E,r;if(!i){i=[];}q=this.getHierarchyDefaultValue();E=i.concat(q);r=m.getProperty("/currentState");if(r&&r.stateName==="home"){s.updateStateProperty("application/hierarchy",E,false,["home"]);}s.updateStateProperty("application/hierarchy",E,true);},onTitleChange:function(e){this.isTitleChanged=true;var t=e.getParameters().data,i;if(!t){t=this.getTitleDefaultValue();}i=m.getProperty("/currentState");if(i&&i.stateName==="home"){s.updateStateProperty("application/title",t,false,["home"]);}s.updateStateProperty("application/title",t,true);window.document.title=t;},onBackNavigationChange:function(e){this.isBackNavigationChanged=true;var i=e.getParameters().data,m=this.getModel(),q=m.getProperty('/currentState/');if(i){j=i;if(q.stateName==='minimal'||q.stateName==='standalone'||q.stateName==='embedded'){sap.ushell.Container.getRenderer('fiori2').showHeaderItem('backBtn',true);}}else{j=this._historyBackNavigation;}},onRelatedAppsChange:function(e){this.isRelatedAppsChanged=true;var r=e.getParameters().data,i;if(!r){r=[];}i=m.getProperty("/currentState");if(i&&i.stateName==="home"){s.updateStateProperty("application/relatedApps",r,false,["home"]);}s.updateStateProperty("application/relatedApps",r,true);},getHierarchyDefaultValue:function(){var e=[],i=m.getProperty("/currentState");if(i&&(i.stateName==="app"||i.stateName==="embedded")){e=[{icon:"sap-icon://home",title:sap.ushell.resources.i18n.getText("actionHomePage"),intent:o.rootIntent?"#"+o.rootIntent:"#"}];}return e;},getTitleDefaultValue:function(){var t="",e=b.getMetadata();if(e&&e.title){t=e.title;}return t;},getAppIcon:function(){var i="sap-icon://folder",e=b.getMetadata();if(e&&e.icon){i=e.icon;}return i;},_handleAlerts:function(e,E,i){var q;if(this.oViewPortContainer.getCurrentState()!=='RightCenter'){for(q=0;q<i.length;q++){this.handleNotification(i[q]);}}},handleNotification:function(e){var i=sap.ushell.Container.getRenderer("fiori2").addRightFloatingContainerItem({press:function(E){var v=sap.ui.getCore().byId('viewPortContainer');if(hasher.getHash()===e.NavigationTargetObject+"-"+e.NavigationTargetAction){v.switchState("Center");}else{u.toExternalWithParameters(e.NavigationTargetObject,e.NavigationTargetAction,e.NavigationTargetParams);}sap.ushell.Container.getService("Notifications").markRead(e.Id);},datetime:sap.ushell.resources.i18n.getText("notification_arrival_time_now"),title:e.SensitiveText?e.SensitiveText:e.Text,description:e.SubTitle,unread:e.IsRead,priority:"High",hideShowMoreButton:true},true,true);setTimeout(function(){sap.ushell.Container.getRenderer("fiori2").removeRightFloatingContainerItem(i.getId(),true);},3500);},_createActionButtons:function(){var e,E,i,U=sap.ui.getCore().byId("userSettingsBtn"),q=sap.ui.getCore().byId("aboutBtn")||new sap.ushell.ui.footerbar.AboutButton("aboutBtn");if(!U){U=new sap.ushell.ui.launchpad.ActionItem("userSettingsBtn",{id:"userSettingsBtn",text:sap.ushell.resources.i18n.getText("userSettings"),icon:'sap-icon://action-settings'});}jQuery.sap.require('sap.ushell.ui.footerbar.ContactSupportButton');e=sap.ui.getCore().byId("ContactSupportBtn")||new sap.ushell.ui.footerbar.ContactSupportButton("ContactSupportBtn",{visible:this.bContactSupportEnabled});i=m.getProperty('/showEndUserFeedback');if(i){jQuery.sap.require('sap.ushell.ui.footerbar.EndUserFeedback');E=sap.ui.getCore().byId("EndUserFeedbackBtn")||new sap.ushell.ui.footerbar.EndUserFeedback("EndUserFeedbackBtn",{showAnonymous:this.oEndUserFeedbackConfiguration.showAnonymous,anonymousByDefault:this.oEndUserFeedbackConfiguration.anonymousByDefault,showLegalAgreement:this.oEndUserFeedbackConfiguration.showLegalAgreement,showCustomUIContent:this.oEndUserFeedbackConfiguration.showCustomUIContent,feedbackDialogTitle:this.oEndUserFeedbackConfiguration.feedbackDialogTitle,textAreaPlaceholder:this.oEndUserFeedbackConfiguration.textAreaPlaceholder,customUIContent:this.oEndUserFeedbackConfiguration.customUIContent});}if(m.getProperty("/enableHelp")){U.addStyleClass('help-id-loginDetails');q.addStyleClass('help-id-aboutBtn');if(i){E.addStyleClass('help-id-EndUserFeedbackBtn');}e.addStyleClass('help-id-contactSupportBtn');}this.getView().aDanglingControls.push(e,U,q);if(i){this.getView().aDanglingControls.push(E);}},_isCompactContentDensity:function(){var i,U,q;if(!sap.ui.Device.support.touch){i=true;}else if(!sap.ui.Device.system.combi){i=false;}else{try{q=sap.ushell.Container.getService("UserInfo");U=q.getUser();}catch(e){jQuery.sap.log.error("Getting UserInfo service failed.");U=sap.ushell.Container.getUser();}i=(U.getContentDensity()==='compact')?true:false;}return i;},_applyContentDensity:function(i){if(i===undefined){i=this._isCompactContentDensity();}var e=b.getMetadata(),q;q=e.compactContentDensity===undefined?true:e.compactContentDensity;if(i&&!q){i=false;}else if(q&&!e.cozyContentDensity){i=true;}this._applyContentDensityClass(i);},_applyContentDensityClass:function(i){if(i===undefined){i=this._isCompactContentDensity();}if(i){jQuery('body').removeClass('sapUiSizeCozy');jQuery('body').addClass('sapUiSizeCompact');}else{jQuery('body').removeClass('sapUiSizeCompact');jQuery('body').addClass('sapUiSizeCozy');}},toggleContentDensity:function(e,E,D){var i=D.contentDensity==="compact";this._applyContentDensity(i);},loadMeAreaView:function(){if(!sap.ui.getCore().byId('meArea')&&!this.bMeAreaLoaded){this.bMeAreaLoaded=true;var e=sap.ui.view("meArea",{viewName:"sap.ushell.renderers.fiori2.meArea.MeArea",type:'JS',viewData:this.getView().getViewData()});this._createActionButtons();this._setUserPrefModel();this.oViewPortContainer.addLeftViewPort(e);this.oViewPortContainer.navTo('leftViewPort',e.getId());}},notificationsCountUpdateCallback:function(D){var t=this,v=this.oViewPortContainer.getCurrentState(),i=v==="RightCenter"?true:false;if((D===undefined)||(!i)){this._updateBadge();}else{D.done(function(){t._updateBadge();});}},_updateBadge:function(){var e;sap.ushell.Container.getService("Notifications").getUnseenNotificationsCount().done(function(i){e=parseInt(i,10);m.setProperty('/notificationsCount',e);}).fail(function(i){jQuery.sap.log.error("Shell.controller - call to notificationsService.getCount failed: ",i,"sap.ushell.renderers.lean.Shell");});},_handleEmptyHash:function(e){e=(typeof e==="string")?e:"";e=e.split("?")[0];if(e.length===0){var v=this.getView()?this.getView().getViewData():{};o=v.config||{};if(o.migrationConfig){return this.oShellNavigation.NavigationFilterStatus.Continue;}if(o.rootIntent){setTimeout(function(){hasher.setHash(o.rootIntent);},0);return this.oShellNavigation.NavigationFilterStatus.Abandon;}}return this.oShellNavigation.NavigationFilterStatus.Continue;},_setConfigurationToModel:function(){var v=this.getView().getViewData(),e,i;if(v){o=v.config||{};}if(o){if(o.states){i=m.getProperty('/states');for(e in o.states){if(o.states.hasOwnProperty(e)){i[e]=o.states[e];}}m.setProperty('/states',i);}if(o.appState==="headerless"||o.appState==="merged"||o.appState==="blank"){m.setProperty("/personalization",false);o.enablePersonalization=false;}else if(o.enablePersonalization!==undefined){m.setProperty("/personalization",o.enablePersonalization);}if(o.changeEndUserFeedbackTitle!==undefined){this.oEndUserFeedbackConfiguration.feedbackDialogTitle=o.changeEndUserFeedbackTitle;}if(o.changeEndUserFeedbackPlaceholder!==undefined){this.oEndUserFeedbackConfiguration.textAreaPlaceholder=o.changeEndUserFeedbackPlaceholder;}if(o.showEndUserFeedbackAnonymousCheckbox!==undefined){this.oEndUserFeedbackConfiguration.showAnonymous=o.showEndUserFeedbackAnonymousCheckbox;}if(o.makeEndUserFeedbackAnonymousByDefault!==undefined){this.oEndUserFeedbackConfiguration.anonymousByDefault=o.makeEndUserFeedbackAnonymousByDefault;}if(o.showEndUserFeedbackLegalAgreement!==undefined){this.oEndUserFeedbackConfiguration.showLegalAgreement=o.showEndUserFeedbackLegalAgreement;}if(o.enableSetTheme!==undefined){m.setProperty("/setTheme",o.enableSetTheme);}m.setProperty("/contentDensity",o.enableContentDensity===undefined?true:o.enableContentDensity);if(o.title){m.setProperty("/title",o.title);}if(o.migrationConfig!==undefined){m.setProperty("/migrationConfig",o.migrationConfig);}if(o.enableUserDefaultParameters!==undefined){m.setProperty("/userDefaultParameters",o.enableUserDefaultParameters);}if(o.disableHomeAppCache!==undefined){m.setProperty("/disableHomeAppCache",o.disableHomeAppCache);}m.setProperty("/enableHelp",!!o.enableHelp);m.setProperty("/searchAvailable",(o.enableSearch!==false));m.bindProperty('/animationMode').attachChange(this.handleAnimationModeChange.bind(this));m.setProperty("/animationMode",o.animationMode);this._getPersonalizer().getPersData().then(function(U){m.setProperty("/animationMode",U?U:o.animationMode);o.animationMode=U?U:o.animationMode;}.bind(this));s.updateStateProperty("headerHiding",false,false,["home","app"]);}},getModelConfiguration:function(){var v=this.getView().getViewData(),e,i;if(v){e=v.config||{};i=jQuery.extend({},e);}delete i.applications;return i;},_getLogonFrameProvider:function(){var v=this.getView();return{create:function(){return v.createIFrameDialog();},show:function(){v.showIFrameDialog();},destroy:function(){v.destroyIFrameDialog();}};},onExit:function(){sap.ui.getCore().getEventBus().unsubscribe("launchpad","contentRendered",this._loadCoreExt,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this.loadUserImage,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this.setBackGroundShapes,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this.delayedCloseLoadingScreen,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","toggleContentDensity",this.toggleContentDensity,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",this._loadCoreExtNWBC,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","appClosed",this.logApplicationUsage,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell","coreResourcesFullyLoaded",this._postCoreExtActivities,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","launchpadCustomRouterRouteMatched",this._centerViewPort,this);sap.ui.getCore().getEventBus().unsubscribe("externalSearch",this.externalSearchTriggered,this);sap.ui.Device.media.detachHandler(this.onScreenSizeChange.bind(this),null,sap.ui.Device.media.RANGESETS.SAP_STANDARD);this.oShellNavigation.hashChanger.destroy();this.getView().aDanglingControls.forEach(function(e){if(e.destroyContent){e.destroyContent();}e.destroy();});sap.ushell.UserActivityLog.deactivate();if(sap.ushell.Container){if(sap.ushell.Container.getService("Notifications").isEnabled()===true){sap.ushell.Container.getService("Notifications").destroy();}}s.destroy();s=undefined;},handleAnimationModeChange:function(){var v=this.getView(),m=v.getModel(),e=m.getProperty('/animationMode'),E=e!=='minimal';C.enableAnimationDrawing(E);sap.ui.getCore().getEventBus().publish("launchpad","animationModeChange",e);},getAnimationType:function(){return"show";},onCurtainClose:function(e){jQuery.sap.log.warning("Closing Curtain",e);},handleDataLoss:function(e,i){if(!h){h=true;this.closeLoadingScreen();return this.oShellNavigation.NavigationFilterStatus.Custom;}if(sap.ushell.Container.getDirtyFlag()){if(!sap.ushell.resources.browserI18n){sap.ushell.resources.browserI18n=sap.ushell.resources.getTranslationModel(window.navigator.language).getResourceBundle();}if(confirm(sap.ushell.resources.browserI18n.getText("dataLossInternalMessage"))){sap.ushell.Container.setDirtyFlag(false);return this.oShellNavigation.NavigationFilterStatus.Continue;}h=false;hasher.setHash(i);return this.oShellNavigation.NavigationFilterStatus.Custom;}return this.oShellNavigation.NavigationFilterStatus.Continue;},doShowMessage:function(t,i,P){sap.ui.require(["sap/m/MessageToast","sap/m/MessageBox"],function(q,r){if(t===M.Type.ERROR){if(sap.ushell.Container.getService("SupportTicket").isEnabled()&&i!==sap.ushell.resources.i18n.getText("supportTicketCreationFailed")){sap.ui.require(["sap/ushell/ui/launchpad/EmbeddedSupportErrorMessage"],function(E){try{var v=new E("EmbeddedSupportErrorMessage",{title:P.title||sap.ushell.resources.i18n.getText("error"),content:new sap.m.Text({text:i})});v.open();}catch(e){r.show(i,r.Icon.ERROR,P.title||sap.ushell.resources.i18n.getText("error"));}});}else{r.show(i,r.Icon.ERROR,P.title||sap.ushell.resources.i18n.getText("error"));}}else if(t===M.Type.CONFIRM){if(P.actions){r.show(i,r.Icon.QUESTION,P.title,P.actions,P.callback);}else{r.confirm(i,P.callback,P.title);}}else{q.show(i,{duration:P.duration||3000});}});},_isColdStart:function(){if(this.history.getHistoryLength()<=1){return true;}this._isColdStart=function(){return false;};return false;},_setEnableHashChange:function(v){h=v;},_logRecentActivity:function(r){if(o&&o.enableRecentActivity){setTimeout(function(){if(sap.ushell.Container){b.addActivity(r);}},700);}},_logOpenAppAction:function(e){if(o&&o.enableTilesOpacity&&o.enableRecentActivity){setTimeout(function(){if(sap.ushell.Container){var U=sap.ushell.Container.getService("UserRecents");U.addAppUsage(e);}},700);}},doHashChange:function(e,i,O,q,P){jQuery.sap.measure.start("FLP:ShellController.doHashChange","doHashChange","FLP");var t=this,r,v;u.addTime("ShellControllerHashChange");this.lastApplicationFullHash=q?O+q:O;if(!h){h=true;this.closeLoadingScreen();return;}if(P){this.hashChangeFailure(this.history.getHistoryLength(),P.message,null,"sap.ushell.renderers.fiori2.Shell.controller",false);return;}if(sap.m.InstanceManager&&g){sap.m.InstanceManager.closeAllDialogs();sap.m.InstanceManager.closeAllPopovers();}g=true;this.openLoadingScreen();if(u.getParameterValueBoolean("sap-ushell-no-ls")){this.closeLoadingScreen();}r=this.history.getHistoryLength();v=this.fixShellHash(e);this.history.hashChange(v,O);this.currentAppBeforeNav=b.getCurrentAppliction();this._resolveHashFragment(v).done(function(R,w){var x=w?w.semanticObject+"-"+w.action:"",o=t._getConfig(),E,T=R&&R.ui5ComponentName,y=!!T,z=R&&R.componentHandle;R=t._calculateNavigationMode(w,v,R);if(R&&(R.navigationMode===n.newWindow||u.isNativeWebGuiNavigation(R))){t._openAppInNewWindowAndRestore(R);return;}if(t.getModel().getProperty("/migrationConfig")){o.migrationConfig=false;t.getModel().setProperty("/migrationConfig",false);if(R&&v==='#'){o.rootIntent="";}else if(v==='#'){setTimeout(function(){hasher.setHash(o.rootIntent);},0);return;}}if(z){t._initiateApplication(R,v,w,r);return;}if(!y){t._initiateApplication(R,v,w,r);return;}if(o&&o.applications&&o.applications[x]){R.applicationConfiguration=o.applications[x];}E=t._getExistingAppAndDestroyIfNotRoot(x);if(E){t._initiateApplication(R,v,w,r);return;}else{sap.ui.getCore().getEventBus().publish("ApplicationContainer","_prior.newUI5ComponentInstantion",{name:T});jQuery.sap.measure.start("FLP:ShellController.UI5createComponent","UI5 createComponent","FLP");sap.ushell.Container.getService("Ui5ComponentLoader").createComponent(R,w,t._createWaitForRendererCreatedPromise()).done(function(D){jQuery.sap.measure.end("FLP:ShellController.UI5createComponent");t._initiateApplication(R,v,w,r);}).fail(function(D){t.hashChangeFailure(r,"Failed to load U5 component for navigation intent "+v,D,"sap.ushell.renderers.fiori2.Shell.controller",false);});}}).fail(function(w){t.hashChangeFailure(r,"Failed to resolve navigation target: \""+v+"\"",w,"sap.ushell.renderers.fiori2.Shell.controller",false);});jQuery.sap.measure.end("FLP:ShellController.doHashChange");},_initiateApplication:function(r,e,P,O){jQuery.sap.measure.start("FLP:ShellController._initiateApplication","_initiateApplication","FLP");var i=b.getMetadata(r);window.document.title=i.title;if(this.bContactSupportEnabled){sap.ushell.UserActivityLog.activate();}this._logOpenAppAction(e);try{this.navigate(P,e,i,r);}catch(E){if(E.stack){jQuery.sap.log.error("Application initialization (Intent: \n"+e+"\n failed due to an Exception:\n"+E.stack);}this.hashChangeFailure(O,E.name,E.message,i?i.title:"",false);}finally{if(r&&r.coreResourcesFullyLoaded&&!this._pluginLoadingTriggered){this._loadRendererExtensionPlugins();}}jQuery.sap.measure.end("FLP:ShellController._initiateApplication");},_resolveHashFragment:function(e){jQuery.sap.measure.start("FLP:ShellController._resolveHashFragment","_resolveHashFragment","FLP");var r,P,i=sap.ushell.Container.getService("URLParsing").parseShellHash(e),D=new jQuery.Deferred(),o=this._getConfig();P=i&&i.params||{};if(i&&i.contextRaw&&i.contextRaw==="navResCtx"&&P&&P.additionalInformation&&(P.additionalInformation[0]||P.additionalInformation[0]==="")&&P.applicationType&&P.applicationType[0]&&P.url&&P.url[0]&&P.navigationMode&&(P.navigationMode[0]||P.additionalInformation[0]==="")){P=i.params||{};r={additionalInformation:P.additionalInformation[0],applicationType:P.applicationType[0],url:P.url[0],navigationMode:P.navigationMode[0]};if(P.title){r.text=P.title[0];}D.resolve(r,i);}else{if(window["sap-ushell-async-libs-promise-directstart"]){window["sap-ushell-async-libs-promise-directstart"].then(function(q){D.resolve(q.resolvedHashFragment,i);delete window["sap-ushell-async-libs-promise-directstart"];},function(q){D.reject(q);delete window["sap-ushell-async-libs-promise-directstart"];});return D.promise();}sap.ushell.Container.getService("NavTargetResolution").resolveHashFragment(e).done(function(r){if(i&&(i.semanticObject+"-"+i.action)===o.rootIntent){r.navigationMode="embedded";}jQuery.sap.measure.end("FLP:ShellController._resolveHashFragment");D.resolve(r,i);}).fail(function(q){D.reject(q);});}return D.promise();},_calculateNavigationMode:function(P,e,r){if(!r){return undefined;}var i=r.navigationMode;if(i===n.newWindowThenEmbedded){if(this._isColdStart()||(P.contextRaw&&P.contextRaw==="navResCtx")||this.history.backwards){r.navigationMode=n.embedded;}else{r.navigationMode=n.newWindow;if(!u.isNativeWebGuiNavigation(r)){r.url=encodeURI(e);}}return r;}if(i===n.newWindow&&this._isColdStart()){r.navigationMode=n.replace;return r;}return r;},_handleConditionalNavigation:function(P,e,i,r){var q=r.navigationMode;if(q===n.newWindowThenEmbedded){if(this._isColdStart()||(P.contextRaw&&P.contextRaw==="navResCtx")||this.history.backwards){r.navigationMode=n.embedded;this.navigate(P,e,i,r);}else{r.navigationMode=n.newWindow;r.url=encodeURI(e);this.navigate(P,e,i,r);}return true;}if(q===n.newWindow&&this._isColdStart()){r.navigationMode=n.replace;this.navigate(P,e,i,r);return true;}return false;},_usesNavigationRedirect:function(e){if(!e){return new jQuery.Deferred().reject().promise();}var t=this,i=e.getInstance({});if(i&&typeof i.navigationRedirect==="function"){var D=new jQuery.Deferred();var q=i.navigationRedirect();if(q&&typeof q.then==="function"){q.then(function(r){jQuery.sap.log.warning("Performing navigation redirect to hash "+r);i.destroy();t.history.pop();sap.ushell.Container.getService("ShellNavigation").toExternal({target:{shellHash:r}},undefined,false);D.resolve(true);},function(){D.reject();});return D.promise();}}return new jQuery.Deferred().reject().promise();},navigate:function(P,e,i,r){jQuery.sap.measure.start("FLP:ShellController.navigate","navigate","FLP");var q=(jQuery.isPlainObject(r)?r.navigationMode:null),t=this;if(q===null){if(this._isColdStart()){hasher.setHash("");return;}h=false;this.history.pop();this._windowHistoryBack(1);return;}r=this._calculateNavigationMode(P,e,r);q=(jQuery.isPlainObject(r)?r.navigationMode:null);if(q===n.embedded){var D=this._usesNavigationRedirect(r.componentHandle);D.fail(function(){t._handleEmbeddedNavMode(e,P,i,r);if(P&&P.contextRaw==="navResCtx"){jQuery.sap.log.error(" This path will no longer be supported in 1.40");h=false;if(P&&P.params&&P.params.original_intent&&P.params.original_intent[0]){hasher.replaceHash(P.params.original_intent[0]);t.history._history[0]=P.params.original_intent[0];}}});jQuery.sap.measure.end("FLP:ShellController.navigate");return;}if(q===n.replace){h=false;this._changeWindowLocation(r.url);return;}if(q===n.newWindow){this._openAppInNewWindowAndRestore(r);return;}this.hashChangeFailure(this.history.getHistoryLength(),"Navigation mode is not recognized",null,"sap.ushell.renderers.fiori2.Shell.controller",false);},_openAppInNewWindowAndRestore:function(r){h=false;if(u.isNativeWebGuiNavigation(r)){try{var U=u.appendUserIdToUrl("sap-user",r.url);var E=u.getPrivateEpcm();E.doNavigate(U);}catch(e){if(e.stack){jQuery.sap.log.error("Application initialization failed due to an Exception:\n"+e.stack);}this.hashChangeFailure(this.history.getHistoryLength(),e.name,e.message,r.text,false);}}else{this._openAppNewWindow(r.url);}this.history.pop();var v=r.componentHandle&&r.componentHandle.getInstance&&r.componentHandle.getInstance({});if(v){v.destroy();}this._windowHistoryBack(1);b.setCurrentApplication(this.currentAppBeforeNav);return;},_handleEmbeddedNavMode:function(e,P,i,r){jQuery.sap.measure.start("FLP:ShellController._handleEmbeddedNavMode","_handleEmbeddedNavMode","FLP");var q,t,v,w,x;this.resetShellUIServiceHandlers();this.setAppIcons(i);q='-'+P.semanticObject+'-'+P.action;v=(r.applicationType==="NWBC"||r.applicationType==="TR");w=e==="#"||(o.rootIntent&&o.rootIntent===P.semanticObject+"-"+P.action);if(w&&!this.oHomeApp&&!o.disableHomeAppCache){this._saveHomePageComponent();}x=P?P.semanticObject+"-"+P.action:"";if(v&&!r.explicitNavMode){if(r.applicationType==="NWBC"&&o.appState&&o.appState==="headerless"){this.switchViewState("headerless");}else{this.switchViewState("minimal");}}else if(w){this.switchViewState("home");this.oShellUIService.setBackNavigation();}else{this.switchViewState("app");}t=this.getWrappedApplication(x,i,r,q,r.fullWidth||i.fullWidth||v);if(w&&!o.disableHomeAppCache){if(!this.oViewPortContainer.getInitialCenterViewPort()){this.oViewPortContainer.setInitialCenterViewPort(t);}}this.oViewPortContainer.navTo('centerViewPort',t.getId(),'show');this._centerViewPort();jQuery.sap.measure.end("FLP:ShellController._handleEmbeddedNavMode");},_centerViewPort:function(){this.oViewPortContainer.switchState("Center");},_getExistingAppAndDestroyIfNotRoot:function(i){var e;e=this.oViewPortContainer&&(this.oViewPortContainer.getViewPortControl('centerViewPort',"application"+'-'+i)||this.oViewPortContainer.getViewPortControl('centerViewPort',"applicationShellPage"+'-'+i));if(e&&i!==o.rootIntent){this.oViewPortContainer.removeCenterViewPort(e.getId(),true);e.destroy();return null;}else if(e){return e;}},getWrappedApplication:function(i,e,r,q,t){jQuery.sap.measure.start("FLP:ShellController.getWrappedApplication","getWrappedApplication","FLP");var E,v,w=this;E=this._getExistingAppAndDestroyIfNotRoot(i,q);if(E){this.closeLoadingScreen();return E;}setTimeout(function(){setTimeout(function(){var x;if(m.getProperty("/currentState/stateName")==="app"){x="shellAppTitle";}A.sendFocusBackToShell(x);setTimeout(function(){w.readNavigationEnd();},500);},100);sap.ui.getCore().getEventBus().publish("launchpad","appOpening",r);jQuery.sap.log.info('app is being opened');},0);if(o.applications){r.applicationConfiguration=o.applications[i];}v=this._getAppContainer(q,r);r.sShellHash=i;this.publishNavigationStateEvents(v,r);v.addStyleClass('sapUshellApplicationPage');if(!t){v.addStyleClass("sapUShellApplicationContainerLimitedWidth");}if(!e.hideLightBackground){v.addStyleClass('sapUshellDefaultBackground');}this._applyContentDensity();v.onfocusin=function(){A.bFocusOnShell=false;A.bFocusPassedToExternalHandlerFirstTime=false;};v.onfocusout=function(){A.bFocusOnShell=true;A.bFocusPassedToExternalHandlerFirstTime=true;};this.oViewPortContainer.addCenterViewPort(v);setTimeout(function(){w.closeLoadingScreen();},0);jQuery.sap.measure.end("FLP:ShellController.getWrappedApplication");return v;},resetShellUIServiceHandlers:function(){this.isHierarchyChanged=false;this.isTitleChanged=false;this.isRelatedAppsChanged=false;this.isBackNavigationChanged=false;},_publicEventDataFromResolutionResult:function(e){var P={};if(!e){return e;}["applicationType","ui5ComponentName","url","additionalInformation","text"].forEach(function(i){P[i]=e[i];});Object.freeze(P);return P;},onAppAfterRendering:function(e){setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","appOpened",e);jQuery.sap.log.info('app was opened');},0);var i=this._publicEventDataFromResolutionResult(e);sap.ushell.renderers.fiori2.utils.publishExternalEvent("appOpened",i);if(this.oShellUIService){if(!this.isHierarchyChanged){this.oShellUIService.setHierarchy();}if(!this.isTitleChanged){this.oShellUIService.setTitle();}if(!this.isRelatedAppsChanged){this.oShellUIService.setRelatedApps();}if(!this.isBackNavigationChanged){this.oShellUIService.setBackNavigation();}}s.updateStateProperty("application/icon",this.getAppIcon(),true);s.updateStateProperty("application/showNavMenuTitle",this.bNavMenuTitleVisible,true);},_getAppContainer:function(e,r){if(!this.oShellUIService){this.initShellUIService();}r.shellUIService=this.oShellUIService.getInterface();var i=new f("application"+e,r);return i;},_saveHomePageComponent:function(){if(this.oHomeApp){return;}var t=this,e="sap.ushell.components.container.ApplicationContainer",i=function(E,q,D){t.oHomeApp=D.component;sap.ui.getCore().getEventBus().unsubscribe(e,'componentCreated',i);};sap.ui.getCore().getEventBus().subscribe(e,'componentCreated',i);},hashChangeFailure:function(i,e,D,q,E){this.reportError(e,D,q);this.closeLoadingScreen();this.delayedMessageError(sap.ushell.resources.i18n.getText("fail_to_start_app_try_later"));g=false;if(i===0){hasher.setHash("");}else{if(jQuery.sap.getUriParameters().get("bFallbackToShellHome")){hasher.setHash("");}else{h=E;this._windowHistoryBack(1);}}},reportError:function(e,D,i){jQuery.sap.log.error(e,D,i);},delayedMessageError:function(e){setTimeout(function(){if(sap.ushell.Container!==undefined){sap.ushell.Container.getService("Message").error(e);}},0);},fixShellHash:function(e){if(!e){e='#';}else if(e.charAt(0)!=='#'){e='#'+e;}return e;},publishNavigationStateEvents:function(e,i){var q,r=e.getId?e.getId():"",t=this;var v=b.getMetadata(),w=v.icon,T=v.title;e.addEventDelegate({onAfterRendering:this.onAppAfterRendering.bind(this,i)});q=e.exit;e.exit=function(){if(q){q.apply(this,arguments);}t._applyContentDensity();setTimeout(function(){var E=jQuery.extend(true,{},i);delete E.componentHandle;E["appId"]=r;E["usageIcon"]=w;E["usageTitle"]=T;sap.ui.getCore().getEventBus().publish("launchpad","appClosed",E);jQuery.sap.log.info('app was closed');},0);var P=t._publicEventDataFromResolutionResult(i);sap.ushell.renderers.fiori2.utils.publishExternalEvent("appClosed",P);};},_openAppNewWindow:function(U){var e=window.open(U);if(!e){var i=sap.ushell.resources.i18n.getText("fail_to_start_app_popup_blocker");this.delayedMessageError(i);}},_windowHistoryBack:function(i){window.history.back(i);},_changeWindowLocation:function(U){window.location.href=U;},setAppIcons:function(e){sap.ui.require(["sap/ui/core/theming/Parameters"],function(P){jQuery.sap.measure.start("FLP:ShellController.setAppIcons","setAppIcons","FLP");var i=jQuery.sap.getModulePath("sap.ushell"),q=(e&&e.homeScreenIconPhone)||(i+'/themes/base/img/launchicons/57_iPhone_Desktop_Launch.png'),r=(e&&e["homeScreenIconPhone@2"])||(i+'/themes/base/img/launchicons/114_iPhone-Retina_Web_Clip.png'),t=(e&&e.homeScreenIconTablet)||(i+'/themes/base/img/launchicons/72_iPad_Desktop_Launch.png'),v=(e&&e["homeScreenIconTablet@2"])||(i+'/themes/base/img/launchicons/144_iPad_Retina_Web_Clip.png'),w=(e&&e.favIcon)||(this._getDefaultFavIcon(P)),x=this.getFavIconHref();if(sap.ui.Device.os.ios){jQuery.sap.setIcons({'phone':q,'phone@2':r,'tablet':t,'tablet@2':v,'favicon':w,'precomposed':true});}else if(x!==w){jQuery.sap.setIcons({'phone':'','phone@2':'','tablet':'','tablet@2':'','favicon':w,'precomposed':true});}jQuery.sap.measure.end("FLP:ShellController.setAppIcons");}.bind(this));},_getDefaultFavIcon:function(P){var e=P.get('@sapFavicon');if(e){var i=/url[\s]*\('?"?([^\'")]*)'?"?\)/.exec(e);if(i){e=i[1];}else if(e==="''"||e==="none"){e=null;}}if(!e){var q=jQuery.sap.getModulePath("sap.ushell");return q+'/themes/base/img/launchpad_favicon.ico';}return e;},handleEndItemsOverflow:function(P){var e=this.getModel().getProperty("/currentState/headEndItems");if(P.name==='Phone'){if(e.indexOf("endItemsOverflowBtn")===-1){s.addHeaderEndItem(["endItemsOverflowBtn"],false,["home","app"]);}}else{if(e.indexOf("endItemsOverflowBtn")>-1){s.removeHeaderEndItem(["endItemsOverflowBtn"],false,["home","app"]);}var i=sap.ui.getCore().byId('headEndItemsOverflow');if(i){i.destroy();}}},isHeadEndItemOverflow:function(){var e=this.getModel().getProperty("/currentState/headEndItems");if(e.indexOf("endItemsOverflowBtn")===-1){return false;}else{return e.length>3;}},isHeadEndItemInOverflow:function(e){return e!=="ENDITEMSOVERFLOWBTN"&&!this.isHeadEndItemNotInOverflow(e);},isHeadEndItemNotInOverflow:function(e){if(this.isHeadEndItemOverflow()){if(e==="NOTIFICATIONSCOUNTBUTTON"||e==="ENDITEMSOVERFLOWBTN"){return true;}else{return false;}}else{if(e==="ENDITEMSOVERFLOWBTN"){return false;}else{return true;}}},pressEndItemsOverflow:function(e){if(!sap.ui.Device.system.desktop){var i=m.getProperty("/currentState").headerHiding;if(i){m.setProperty("/currentState/headerHiding",false);}}var P=sap.ui.getCore().byId('headEndItemsOverflow');function q(){P.close();}var r;if(P){r=P.getContent()[0];}else{var t=new sap.ui.model.Filter('','EQ','a');t.fnTest=this.isHeadEndItemInOverflow.bind(this);r=new sap.ui.layout.VerticalLayout({content:{path:"/currentState/headEndItems",filters:[t],factory:function(v,w){var x=sap.ui.getCore().byId(w.getObject());x.detachPress(q);x.attachPress(q);return x;}}});P=new sap.m.Popover("headEndItemsOverflow",{placement:sap.m.PlacementType.Bottom,showHeader:false,showArrow:false,content:r}).addStyleClass("sapUshellPopupContainer");r.updateAggregation=this.getView().updateShellAggregation;P.setModel(m);this.getView().aDanglingControls.push(P);P.attachAfterClose(P,function(){if(!sap.ui.Device.system.desktop){if(i){m.setProperty("/currentState/headerHiding",i);}}});}if(P.isOpen()){P.close();}else{r.updateAggregation("content");P.openBy(e.getSource());}},getFavIconHref:function(){return jQuery('link').filter('[rel="shortcut icon"]').attr('href')||'';},externalSearchTriggered:function(e,E,D){m.setProperty("/searchTerm",D.searchTerm);D.query=D.searchTerm;},onAfterNavigate:function(e){this.closeLoadingScreen();var i=this.oViewPortContainer.getInitialCenterViewPort(),q=e.getParameter("fromId"),r=e.getParameter("from");if(q&&q!==i){this.oViewPortContainer.removeCenterViewPort(q,true);r.destroy();}u.addTime("ShellController.onAfterNavigate");if(e.mParameters&&e.mParameters.toId===i){sap.ui.getCore().byId("configBtn").focus();if(this.oHomeApp&&this.oHomeApp.setInitialConfiguration){this.oHomeApp.setInitialConfiguration();}}},logApplicationUsage:function(e,i,q){if(o&&o.enableRecentActivity){var r=q.appId,t=r,R={};R.title=q.usageTitle;R.appType=c.APP;R.url='#'+this.lastApplicationFullHash;if(r.indexOf('-')>0){t=r.substr(r.indexOf('-')+1);}R.appId='#'+t;if(t==="Action-search"){R.appType=c.SEARCH;}this._logRecentActivity(R);}},openLoadingScreen:function(){jQuery.sap.measure.start("FLP:ShellController.openLoadingScreen","openLoadingScreen","FLP");if(this.oFiori2LoadingDialog){var e=m.getProperty('/animationMode');var e=e||'full';this.oFiori2LoadingDialog.openLoadingScreen(e);}jQuery.sap.measure.end("FLP:ShellController.openLoadingScreen");},closeLoadingScreen:function(){if(this.oFiori2LoadingDialog){this.oFiori2LoadingDialog.closeLoadingScreen();}},readNavigationEnd:function(){var e=document.getElementById("sapUshellLoadingAccessibilityHelper-loadingComplete");if(e){e.setAttribute("aria-live","polite");e.innerHTML=sap.ushell.resources.i18n.getText("loadingComplete");setTimeout(function(){e.setAttribute("aria-live","off");e.innerHTML="";},0);}},delayedCloseLoadingScreen:function(){setTimeout(function(){this.closeLoadingScreen();}.bind(this),600);},togglePane:function(e){var i=e.getSource(),q=i.getSelected();sap.ui.getCore().getEventBus().publish("launchpad","togglePane",{currentContent:i.getModel().getProperty("/currentState/paneContent")});if(e.getParameter("id")==="categoriesBtn"){i.getModel().setProperty("/currentState/showCurtainPane",!q);}else{i.getModel().setProperty("/currentState/showPane",!q);}},_switchToNotificationView:function(e){this.oViewPortContainer.navTo('rightViewPort',"notificationsView",'show');this._switchViewPortStateByControl(e,"RightCenter");sap.ui.getCore().getEventBus().publish("launchpad","notificationViewOpened");},_switchToNotificationViewWithPreview:function(e,i,q){if(i==='minimal'){this._switchToNotificationView(q);}else{var r=e.getFloatingContainerItems().length;setTimeout(function(){this._switchToNotificationView(q);}.bind(this),300+(r*100));}},toggleNotificationsView:function(e,i){if(e){i=e.getSource();}if(!p){l.done(function(){this.toggleNotificationsView(undefined,i);}.bind(this));return;}var q,r=sap.ushell.Container.getService("Notifications"),t=sap.ui.getCore().byId("notifications-preview-container"),v=this.getView().getModel().getProperty('/animationMode')||'full';this.bMeAreaSelected=false;var w=sap.ui.getCore().byId("meAreaHeaderButton");if(w){w.setSelected(false);jQuery(w.getDomRef()).attr("aria-pressed","false");}if(!sap.ui.getCore().byId('notificationsView')){q=sap.ui.view("notificationsView",{viewName:"sap.ushell.renderers.fiori2.notifications.Notifications",type:'JS',viewData:{}});this.oViewPortContainer.addRightViewPort(q);}this.bNotificationsSelected=i.getSelected();if(this.bNotificationsSelected){this._switchViewPortStateByControl(i,"Center");}else{this.getView().getModel().setProperty("/notificationsCount",0);if(t){t.setFloatingContainerItemsVisiblity(false);this._switchToNotificationViewWithPreview(t,v,i);}else{this._switchToNotificationView(i);}}this.bNotificationsSelected=!this.bNotificationsSelected;i.setSelected(this.bNotificationsSelected);r.notificationsSeen();this.getView().getModel().setProperty("/notificationsCount",0);jQuery(i.getDomRef()).attr("aria-pressed",this.bNotificationsSelected);jQuery(i.getDomRef()).attr("aria-label",sap.ushell.resources.i18n.getText("NotificationToggleButtonCollapsedNoNotifications"));},toggleMeAreaView:function(e,i){if(e){i=e.getSource();}if(!p){l.done(function(){this.toggleMeAreaView(undefined,i);}.bind(this));return;}var q=i.getSelected(),m=this.getModel(),r=m.getProperty('/currentState/stateName');this.bMeAreaSelected=!q;if(r==='embedded'||r==='embedded-home'||r==='standalone'||r==='blank-home'||r==='blank'){if(!q){this.loadMeAreaView();}this._showActionsInPopOver(i);}else{this._switchToMeAreaView(i);}var t=sap.ui.getCore().byId("NotificationsCountButton");if(t&&this.bNotificationsSelected){this.bNotificationsSelected=false;t.setSelected(false);jQuery(t.getDomRef()).attr("aria-pressed","false");}jQuery(i.getDomRef()).attr("aria-pressed",this.bMeAreaSelected);},_showActionsInPopOver:function(O){var m=this.getModel(),e=m.getProperty('/currentState/actions');if(!this.oActionsPopover){this.oActionsLayout=new sap.ui.layout.VerticalLayout();this.oActionsPopover=new sap.m.Popover("sapUshellActionsPopover",{showHeader:false,placement:sap.m.PlacementType.Bottom,content:this.oActionsLayout}).addStyleClass("sapUshellPopupContainer");}this.oActionsLayout.removeAllContent();this._createActionButtons();e.forEach(function(i,q){var r=sap.ui.getCore().byId(i);if(r&&r.setActionType){this.oActionsLayout.addContent(r);r.setActionType('standard');r.addStyleClass('sapUshellStandardActionItem');}}.bind(this));this.oActionsPopover.openBy(O);this.oActionsPopover.setModel(m);},_switchToMeAreaView:function(O){var e=O.getSelected();if(e){this._switchViewPortStateByControl(O,"Center");}else{this._switchViewPortStateByControl(O,"LeftCenter");this.loadMeAreaView();}},_switchViewPortStateByControl:function(O,e){var i=false,v=this.oViewPortContainer;if(O&&O.setEnabled&&typeof O.setEnabled==="function"){i=true;}if(i){O.addStyleClass("sapUshellShellHeadItemOverrideDisableStyle");O.setEnabled(false);}function q(){O.setEnabled(true);O.removeStyleClass("sapUshellShellHeadItemOverrideDisableStyle");v.detachAfterSwitchStateAnimationFinished(q);}if(i){v.attachAfterSwitchStateAnimationFinished(q);}v.switchState(e);},onScreenSizeChange:function(P){this.validateShowLogo(P);this.handleNavMenuTitleVisibility(P);this._handleHomeAndBackButtonsVisibility(P);this.handleEndItemsOverflow(P);},_handleHomeAndBackButtonsVisibility:function(P){var m=a.getModel(),i=m.getProperty('/currentViewPortState')==='Center',e=sap.ui.Device.media.getCurrentRange(sap.ui.Device.media.RANGESETS.SAP_STANDARD).name,q=sap.ui.getCore().byId("homeBtn"),r=sap.ui.getCore().byId("backBtn"),t=e==="Desktop",v=e!=="Phone"||i;if(q){q.setVisible(t);}if(r){r.setVisible(v);}},validateShowLogo:function(P){var e;var i=this.getModel().getProperty('/currentState/stateName');var q=i==='merged'||i==='headerless';if(P){e=P.name;}else{e=sap.ui.Device.media.getCurrentRange(sap.ui.Device.media.RANGESETS.SAP_STANDARD).name;}var r=true;if(e==="Phone"&&!this.bMeAreaSelected||q){r=false;}s.updateStateProperty("showLogo",r,false,["home","app","blank","blank-home"],true);},handleNavMenuTitleVisibility:function(P){this.bNavMenuTitleVisible=false;if(P.name!=="Desktop"){this.bNavMenuTitleVisible=true;}s.updateStateProperty("application/showNavMenuTitle",this.bNavMenuTitleVisible,true);},navigateFromShellApplicationNavigationMenu:function(i){this.oViewPortContainer.switchState("Center");hasher.setHash(i);var e=sap.ui.getCore().byId("shellAppTitle");if(e){e.close();}},loadUserImage:function(){if(!this.bUserImageAlreadyLoaded){this.getView().loadUserImage();this.bUserImageAlreadyLoaded=true;}},_loadCoreExtNWBC:function(e,E,i){if(i&&i.applicationType=="NWBC"){setTimeout(this._loadCoreExt.bind(this),2000);}},_postCoreExtActivities:function(){sap.ushell.Container.getService("UsageAnalytics").init(sap.ushell.resources.i18n.getText("usageAnalytics"),sap.ushell.resources.i18n.getText("i_agree"),sap.ushell.resources.i18n.getText("i_disagree"),sap.ushell.resources.i18n.getText("remind_me_later"));var i=jQuery.Deferred();try{sap.ushell.Container.getService("EndUserFeedback").isEnabled().done(function(){m.setProperty('/showEndUserFeedback',true);i.resolve();}).fail(function(){m.setProperty('/showEndUserFeedback',false);i.resolve();});}catch(e){jQuery.sap.log.error("EndUserFeedback adapter is not found",e.message||e);m.setProperty('/showEndUserFeedback',false);i.resolve();}this.getView().createPostCoreExtControls();i.done(function(){this.loadMeAreaView();p=true;l.resolve();}.bind(this));},_loadRendererExtensionPlugins:function(){if(!this._pluginLoadingTriggered){this._pluginLoadingTriggered=true;jQuery.sap.log.info("Triggering load of 'RendererExtension' plug-ins after loading core-ext module (after home page content rendered)",null,"sap.ushell.renderers.fiori2.Shell");sap.ushell.Container.getService("PluginManager").loadPlugins("RendererExtensions");this._publishCoreExtLoadedEvent();}},_loadCoreExt:function(){var e=jQuery.sap.isDeclared('sap.fiori.core',true)||jQuery.sap.isDeclared('sap.fiori.core-ext-light',true),i=window['sap-ui-debug']===true?'sap/fiori/core-ext-light-dbg.js':'sap/fiori/core-ext-light.js',t=this;if(e){this._loadRendererExtensionPlugins();return;}jQuery.sap._loadJSResourceAsync(i).then(function(){t._loadRendererExtensionPlugins();}).catch(function(){t._loadRendererExtensionPlugins();jQuery.sap.log.warning('failed to load sap.fiori.core-ext-light');});},_publishCoreExtLoadedEvent:function(){setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","coreExtLoaded");},0);},getCurrentViewportState:function(){var v=m.getProperty('/currentViewPortState');return v;},makeEndUserFeedbackAnonymousByDefault:function(e){this.oEndUserFeedbackConfiguration.anonymousByDefault=e;},showEndUserFeedbackLegalAgreement:function(e){this.oEndUserFeedbackConfiguration.showLegalAgreement=e;},setFloatingContainerDragSelector:function(e){jQuery(e).addClass("sapUshellShellFloatingContainerSelector");sap.ui.require(["sap/ushell/UIActions"],function(U){if(this.oFloatingUIActions){this.oFloatingUIActions.delete();}this.oFloatingUIActions=new sap.ushell.UIActions({containerSelector:".sapUiBody",wrapperSelector:'.sapUshellShellFloatingContainerWrapper',draggableSelector:'.sapUshellShellFloatingContainerWrapper',rootSelector:".sapUiBody",cloneClass:"sapUshellFloatingContainer-clone",dragCallback:this._handleFloatingContainerUIStart.bind(this),endCallback:this._handleFloatingContainerDrop.bind(this),moveTolerance:3,switchModeDelay:1000,isLayoutEngine:false,isTouch:false,elementToCapture:e,debug:jQuery.sap.debug()}).enable();}.bind(this));},_handleFloatingContainerDrop:function(e,i,D){var q=i.firstChild?sap.ui.getCore().byId(i.firstChild.id):undefined,r=jQuery.sap.storage(jQuery.sap.storage.Type.local,"com.sap.ushell.adapters.local.FloatingContainer"),w=jQuery(window).width(),W=jQuery(window).height(),P=D.deltaX/w,t=D.deltaY/W,O=i.style.visibility,v=i.style.display,x=parseFloat(i.style.left.replace("%","")),y=parseFloat(i.style.top.replace("%",""));i.style.visibility='hidden';i.style.display='block';if(typeof(x)==='number'){P=x+100*D.deltaX/w;}if(typeof(y)==='number'){t=y+100*D.deltaY/W;}i.setAttribute("style","left:"+P+"%;top:"+t+"%;position:absolute;");i.visibility=O;i.display=v;r.put("floatingContainerStyle",i.getAttribute("style"));if(q){q.handleDrop();}},_handleFloatingContainerUIStart:function(i,q){var r=q;r.style.display="none";if(window.getSelection){var t=window.getSelection();try{t.removeAllRanges();}catch(e){}}},setFloatingContainerVisibility:function(v){this.getView().getOUnifiedShell().setFloatingContainerVisible(v);},getFloatingContainerVisibility:function(){return this.getView().getOUnifiedShell().getFloatingContainerVisible();},setFloatingContainerContent:function(P,i,e,q){s.setFloatingContainerContent(P,i,e,q);},getRightFloatingContainerVisibility:function(){var r=this.getView().getOUnifiedShell().getRightFloatingContainer(),R=r&&r.getVisible();return R;},setHeaderTitle:function(t,i){if(typeof t!=="string"){throw new Error("sTitle type is invalid");}this.getView().getOUnifiedShell().getHeader().setTitleControl(t,i);},addEndUserFeedbackCustomUI:function(e,i){if(e){this.oEndUserFeedbackConfiguration.customUIContent=e;}if(i===false){this.oEndUserFeedbackConfiguration.showCustomUIContent=i;}},setFooter:function(e){if(typeof e!=="object"||!e.getId){throw new Error("oFooter value is invalid");}if(this.getView().oShellPage.getFooter()!==null){jQuery.sap.log.warning("You can only set one footer. Replacing existing footer: "+this.getView().oShellPage.getFooter().getId()+", with the new footer: "+e.getId()+".");}this.getView().oShellPage.setFooter(e);},removeFooter:function(){if(this.getView().oShellPage.getFooter()===null){jQuery.sap.log.warning("There is no footer to remove.");return;}this.getView().oShellPage.setFooter(null);},addUserPreferencesEntry:function(e){this._validateUserPrefEntryConfiguration(e);this._updateUserPrefModel(e);},addUserProfilingEntry:function(e){this._validateUserPrefEntryConfiguration(e);this._updateProfilingModel(e);},_validateUserPrefEntryConfiguration:function(e){if((!e)||(typeof e!=="object")){throw new Error("object oConfig was not provided");}if(!e.title){throw new Error("title was not provided");}if(!e.value){throw new Error("value was not provided");}if(typeof e.entryHelpID!=="undefined"){if(typeof e.entryHelpID!=="string"){throw new Error("entryHelpID type is invalid");}else{if(e.entryHelpID===""){throw new Error("entryHelpID type is invalid");}}}if(e.title&&typeof e.title!=="string"){throw new Error("title type is invalid");}if(typeof e.value!=="function"&&typeof e.value!=="string"&&typeof e.value!=="number"){throw new Error("value type is invalid");}if(e.onSave&&typeof e.onSave!=="function"){throw new Error("onSave type is invalid");}if(e.content&&typeof e.content!=="function"){throw new Error("content type is invalid");}if(e.onCancel&&typeof e.onCancel!=="function"){throw new Error("onCancel type is invalid");}},switchViewState:function(e,i){var q=e;if(e==='home'&&(o.appState==='embedded'||o.appState=='headerless'||o.appState=='merged'||o.appState=='blank')){q=o.appState+'-home';}else if(e==='app'&&k.indexOf(o.appState)>=0){q=o.appState;}var r=s.switchState(q,i);if(e==="searchResults"){m.setProperty("/lastSearchScreen",'');if(!hasher.getHash().indexOf("Action-search")===0){var t=sap.ui.getCore().getModel("searchModel");hasher.setHash("Action-search&/searchTerm="+t.getProperty("/uiFilter/searchTerms")+"&dataSource="+JSON.stringify(t.getProperty("/uiFilter/dataSource").getJson()));}}this._handleHomeAndBackButtonsVisibility();sap.ui.getCore().getEventBus().publish("launchpad","shellViewStateChanged",r);},_navBack:function(){this.bMeAreaSelected=false;j();},_historyBackNavigation:function(){window.history.back();},_updateUserPrefModel:function(e){var i=this._getModelEntryFromEntryObject(e),q=m.getProperty("/userPreferences/entries");q.push(i);q=this._reorderUserPrefEntries(q);m.setProperty("/userPreferences/entries",q);},_updateProfilingModel:function(e){var i=this._getModelEntryFromEntryObject(e),q=m.getProperty("/userPreferences/profiling")||[];q.push(i);m.setProperty("/userPreferences/profiling",q);},_getModelEntryFromEntryObject:function(e){return{"entryHelpID":e.entryHelpID,"title":e.title,"editable":e.content?true:false,"valueArgument":e.value,"valueResult":null,"onSave":e.onSave,"onCancel":e.onCancel,"contentFunc":e.content,"contentResult":null,"icon":e.icon};},pressActionBtn:function(e){if(!sap.ui.Device.system.desktop){var i=m.getProperty("/currentState").headerHiding;if(i){m.setProperty("/currentState/headerHiding",false);}}var q=sap.ui.getCore().byId('headActions');if(!q){this._createActionButtons();var r=new sap.ui.model.Filter('','EQ','a');r.fnTest=function(t){var v=m.getProperty("/currentState/actions"),w,x;for(x=0;x<v.length;x++){w=v[x];if(w.toUpperCase()==t){return!!sap.ui.getCore().byId(w);}}};q=new sap.m.ActionSheet("headActions",{placement:sap.m.PlacementType.Bottom,buttons:{path:"/currentState/actions",filters:[r],factory:function(t,v){var w=sap.ui.getCore().byId(v.getObject());if(w&&w.setActionType){w.setActionType("standart");}return w;}}});q.updateAggregation=this.getView().updateShellAggregation;q.setModel(m);this.getView().aDanglingControls.push(q);q.attachAfterClose(q,function(){if(!sap.ui.Device.system.desktop){if(i){m.setProperty("/currentState/headerHiding",i);}}});}q.updateAggregation("buttons");q.openBy(e.getSource());},_setUserPrefModel:function(){var e=m.getProperty("/userPreferences/entries");var D=this._getUserPrefDefaultModel();D.entries=D.entries.concat(e);D.entries=this._reorderUserPrefEntries(D.entries);m.setProperty("/userPreferences",D);},_reorderUserPrefEntries:function(e){var q,t;for(var i=0;i<e.length;i++){if(e[i].entryHelpID==="flpSettingsEntry"){q=i;}else if(e[i].entryHelpID==="themes"){t=i;}if(q!=undefined&&t!=undefined){var r=e.splice(q,1);e.splice(t+1,0,r[0]);break;}}return e;},_getUserPrefDefaultModel:function(){var t=this;var U=sap.ushell.Container.getUser();sap.ui.require(['sap/ushell/renderers/fiori2/search/userpref/SearchPrefs'],function(E){var J=E;var K=J.getEntry();K.isSearchPrefsActive().done(function(O){if(!O){return;}t.addUserProfilingEntry(K);});});function G(E,J,K,O,P,Q,R,T,V,W,m,X,Y){this.view=null;this.getView=function(){if(!this.view||!sap.ui.getCore().byId(E)){if(K==="xml"){this.view=sap.ui.xmlview(E,J);}else{this.view=sap.ui.jsview(E,J);}}if(m){this.view.setModel(m);}return this.view;};return{entryHelpID:O,title:P,valueResult:null,onSave:Q?Q.bind(this):function(){if(this.getView().getController().onSave){return this.getView().getController().onSave();}return;}.bind(this),onCancel:R?R.bind(this):function(){if(this.getView().getController().onCancel){return this.getView().getController().onCancel();}return;}.bind(this),contentFunc:T?T.bind(this):function(){if(this.getView().getController().getContent){return this.getView().getController().getContent();}return;}.bind(this),valueArgument:V?V.bind(this):function(){var Z=jQuery.Deferred(),t=this;setTimeout(function(){if(t.getView().getController().getValue){t.getView().getController().getValue().done(function($){Z.resolve($);});}},0);return Z.promise();}.bind(this),editable:typeof W==="function"?W():W,contentResult:null,icon:X,defaultVisibility:Y};}var e=new G("userPrefThemeSelector","sap.ushell.renderers.fiori2.theme_selector.ThemeSelector","xml","themes",sap.ushell.resources.i18n.getText("Appearance"),function(){var E=this.getView().getController().onSave();E.done(function(){if(m.getProperty("/tilesOpacity")===true){u.handleTilesOpacity();}});return E;},undefined,undefined,undefined,function(){if(m.getProperty("/setTheme")!==undefined){return m.getProperty("/setTheme")&&U.isSetThemePermitted();}else{return U.isSetThemePermitted();}},this.getView().getModel(),"sap-icon://palette");var i=new G("userPrefUsageAnalyticsSelector","sap.ushell.renderers.fiori2.usageAnalytics_selector.UsageAnalyticsSelector","js","usageAnalytics",sap.ushell.resources.i18n.getText("usageAnalytics"),undefined,undefined,undefined,undefined,sap.ushell.Container.getService("UsageAnalytics").isSetUsageAnalyticsPermitted());var q=new G("defaultParametersSelector","sap.ushell.renderers.fiori2.defaultParameters_selector.DefaultParameters","js",undefined,sap.ushell.resources.i18n.getText("defaultsValuesEntry"),undefined,undefined,undefined,undefined,true,undefined,undefined,false);var r=new G("userProfilingView","sap.ushell.renderers.fiori2.profiling.UserProfiling","js","userProfiling",sap.ushell.resources.i18n.getText("userProfiling"),undefined,undefined,undefined,undefined,false,this.getView().getModel(),"sap-icon://user-settings",false);function v(){this.view=null;this.getView=function getView(){if(!this.languageRegionSelector){this.languageRegionSelector=sap.ui.jsview("languageRegionSelector","sap.ushell.renderers.fiori2.userPreferences.LanguageRegionSelector");}return this.languageRegionSelector;};var E=function(){var P=this.getView().getController().onSave();return P;}.bind(this);var J=function(){return this.getView().getController().onCancel();}.bind(this);var K=function(){return this.getView().getController().getContent();}.bind(this);var O=function(){return this.getView().getController().getValue();}.bind(this);return{entryHelpID:"language",title:sap.ushell.resources.i18n.getText("languageRegionTit"),editable:true,valueArgument:O,valueResult:null,onSave:E,onCancel:J,contentFunc:K,contentResult:null,icon:"sap-icon://globe"};}function w(){this.view=null;this.getView=function getView(){if(!this.userAccountSelector){if(o.enableOnlineStatus&&sap.ushell.ui5service.UserStatus.prototype.isEnabled){this.userAccountSelector=sap.ui.xmlview("UserAccountSelector","sap.ushell.renderers.fiori2.userAccount.UserAccountSelector");}else{this.userAccountSelector=sap.ui.xmlview("UserAccountSetting","sap.ushell.renderers.fiori2.userAccount.UserAccountSetting");}}return this.userAccountSelector;};var E=function(){var P=this.getView().getController().onSave();return P;}.bind(this);var J=function(){return this.getView().getController().onCancel();}.bind(this);var K=function(){return this.getView().getController().getContent();}.bind(this);var O=function(){return this.getView().getController().getValue();}.bind(this);return{entryHelpID:"userAccountEntry",title:sap.ushell.resources.i18n.getText("UserAccountFld"),editable:true,valueArgument:O,valueResult:null,onSave:E,onCancel:J,contentFunc:K,contentResult:null,icon:"sap-icon://account"};}var x=[new w(),e,new v()],y=[];y.push(i);x.push(r);if(m.getProperty("/enableNotifications")===true){var z=sap.ushell.Container.getService("Notifications")._getNotificationSettingsAvalability(),D;D=new G("notificationSettings","sap.ushell.renderers.fiori2.notifications.Settings","js",undefined,sap.ushell.resources.i18n.getText("notificationSettingsEntry_title"),undefined,undefined,undefined,undefined,true,undefined,"sap-icon://ui-notifications",false);x.push(D);z.done(function(E){if(E.settingsAvailable){D.visible=true;m.getProperty("/userPreferences/entries").every(function(J,K){if(J.title===sap.ushell.resources.i18n.getText("notificationSettingsEntry_title")){m.setProperty("/userPreferences/entries/"+K+"/visible",true);return false;}return true;});}});}if(m.getProperty("/userDefaultParameters")){x.push(q);}return{dialogTitle:sap.ushell.resources.i18n.getText("userSettings"),isDetailedEntryMode:false,activeEntryPath:null,entries:x,profiling:y};},onAfterViewPortSwitchState:function(e){var t=e.getParameter("to");var i=sap.ui.getCore().byId("shellAppTitle");m.setProperty("/currentViewPortState",t);if(this.applicationKeyHandler){A.registerAppKeysHandler(this.applicationKeyHandler);this.applicationKeyHandler=undefined;}sap.ui.getCore().getEventBus().publish("launchpad","afterSwitchState",e);if(t==="Center"){i.setVisible(true);this.bMeAreaSelected=false;}else{i.setVisible(false);if(t==="Right"){this.bMeAreaSelected=false;}else if(t=="RightCenter"){this.applicationKeyHandler=A.getAppKeysHandler();A.bFocusOnShell=false;A.registerAppKeysHandler(sap.ui.getCore().byId("notificationsView").getController().keydownHandler.bind(sap.ui.getCore().byId("notificationsView")));}}this.validateShowLogo();this._handleHomeAndBackButtonsVisibility();},getModel:function(){return m;},_getConfig:function(){return o?o:{};},_createWaitForRendererCreatedPromise:function(){var P,r;r=sap.ushell.Container.getRenderer();if(r){jQuery.sap.log.debug("Shell controller._createWaitForRendererCreatedPromise: shell renderer already created, return empty array.");return[];}else{P=new Promise(function(e,i){var O;O=function(){jQuery.sap.log.info("Shell controller: resolving component waitFor promise after shell renderer created event fired.");e();sap.ushell.Container.detachRendererCreatedEvent(O);};r=sap.ushell.Container.getRenderer();if(r){jQuery.sap.log.debug("Shell controller: resolving component waitFor promise immediately (shell renderer already created");e();}else{sap.ushell.Container.attachRendererCreatedEvent(O);}});return[P];}},_getPersonalizer:function(){if(this.oPersonalizer){return this.oPersonalizer;}var P=sap.ushell.Container.getService("Personalization");var e=sap.ui.core.Component.getOwnerComponentFor(this);var i={keyCategory:P.constants.keyCategory.FIXED_KEY,writeFrequency:P.constants.writeFrequency.LOW,clientStorageAllowed:true};var q={container:"flp.launchpad.animation.mode",item:"animationMode"};this.oPersonalizer=P.getPersonalizer(q,i,e);return this.oPersonalizer;}});},false);
