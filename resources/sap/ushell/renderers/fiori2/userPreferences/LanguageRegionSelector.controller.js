// @copyright@
sap.ui.define(function(){"use strict";sap.ui.controller("sap.ushell.renderers.fiori2.userPreferences.LanguageRegionSelector",{onInit:function(){try{this.userInfoService=sap.ushell.Container.getService("UserInfo");this.oUser=this.userInfoService.getUser();}catch(e){jQuery.sap.log.error("Getting UserInfo service failed.");this.oUser=sap.ushell.Container.getUser();}this.sLanguage=this._getFormatedLanguage(this.oUser.getLanguage());this.aLanguageList=null;var v=this.getView();var m=new sap.ui.model.json.JSONModel();var a={languageList:[{text:this.sLanguage,key:this.sLanguage}],selectedLanguage:this.sLanguage};var l=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var L=sap.ui.core.LocaleData.getInstance(l);var d=L.getDatePattern("medium"),t=L.getTimePattern("medium"),T=(t.indexOf("H")===-1)?"12h":"24h";a.datePatternList=[{text:d,key:d}];a.timeFormat=T;a.selectedDatePattern=d;var h=this.oView.hourFormatSegmentedButton.getButtons();var s=(T==="12h")?h[0]:h[1];this.oView.hourFormatSegmentedButton.setSelectedButton(s);m.setData(a);this.oView.setModel(m);},getContent:function(){var d=jQuery.Deferred();var t=this;var i=sap.ushell.Container.getRenderer('fiori2').getModelConfiguration().enableSetLanguage;if(i){jQuery.sap.measure.start("FLP:LanguageRegionSelector.getContent","getContent","FLP");var a=this._getLanguagesList();a.done(function(l){if(l){if(l.length>1){t.getView().getModel().setProperty("/languageList",l);t.oView.inputLanguage.setVisible(false);t.oView.selectLanguage.setVisible(true);t.oView.helpingText.setVisible(true);t.oView.helpingTextLabel.setVisible(true);}}jQuery.sap.measure.end("FLP:LanguageRegionSelector.getContent");d.resolve(t.getView());});a.fail(function(e){jQuery.sap.log.error(e);d.resolve(t.getView());});}else{d.resolve(t.getView());}return d.promise();},getValue:function(){var d=jQuery.Deferred();d.resolve(this._getFormatedLanguage(this.getView().getModel().getProperty("/selectedLanguage"))+" | "+sap.ushell.resources.i18n.getText("timeFormatFld")+": "+this.getView().getModel().getProperty("/timeFormat"));return d.promise();},onCancel:function(){var d=jQuery.Deferred();var s=this.getView().getModel().getProperty("/selectedLanguage");if(this.oUser.getLanguage()!=s){this._handleSelectChange(this.oUser.getLanguage(),"Cancel");d.resolve();}else{d.resolve();}return d.promise();},onSave:function(){var d=jQuery.Deferred();var s=this.getView().getModel().getProperty("/selectedLanguage");if(this.oUser.getLanguage()!=s){if(s){this.oUser.setLanguage(s);this.userInfoService.updateUserPreferences(this.oUser).done(function(){d.resolve();window.location.reload();}.bind(this));}}else{d.resolve();}return d.promise();},_getFormatedLanguage:function(l){if(l&&l.indexOf('-')>-1){l=l.replace('-',' (').concat(')').toUpperCase();}else if(l){l=l.toUpperCase();}return l;},_handleSelectChange:function(l,m){var L=new sap.ui.core.Locale(l);var o=sap.ui.core.LocaleData.getInstance(L);var d=o.getDatePattern("medium"),t=o.getTimePattern("medium"),T=(t.indexOf("H")===-1)?"12h":"24h";if(m=="Cancel"){this.getView().selectLanguage.setSelectedKey(l);}this.getView().comboDate.setValue(d);var h=this.getView().hourFormatSegmentedButton.getButtons();var s=(T==="12h")?h[0]:h[1];this.getView().hourFormatSegmentedButton.setSelectedButton(s);},_getLanguagesList:function(){var t=this;var r=jQuery.Deferred();if(this.aLanguageList==null){jQuery.sap.measure.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");var g=this.userInfoService.getLanguageList();g.done(function(d){d.forEach(function(o){if(o.text.length>0){o.text=t._getFormatedLanguage(o.text)}});jQuery.sap.measure.end("FLP:LanguageRegionSelector._getLanguagesList");r.resolve(d);});g.fail(function(){r.reject("Failed to load language list.");});}else{r.resolve(this.aLanguageList);}return r.promise();},});},true);
