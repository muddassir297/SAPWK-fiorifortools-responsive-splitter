sap.ui.define(["sap/ui/core/Control","sap/ui/core/Item","sap/ui/core/ValueState","sap/m/Select","sap/m/Input","sap/m/Button","sap/m/SelectDialog","sap/m/StandardListItem","sap/m/Text","sap/m/DatePicker","sap/ui/model/type/Float","sap/ui/model/type/Date","sap/ui/model/type/Time","sap/ui/model/type/DateTime","sap/ui/core/HTML","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","./Utils","sap/m/DateTimePicker","sap/m/TimePicker"],function(C,a,V,S,I,B,b,c,T,D,d,f,g,h,H,J,F,j,U,k,l){"use strict";return C.extend("sap.rules.ui.InstructionRenderer",{metadata:{properties:{instructions:{type:"any"}},aggregations:{_content:{type:"sap.ui.core.Control",multiple:true,visibility:"hidden"}},events:{"change":{}},publicMethods:["getTokensAndTexts","getExpression"]},init:function(){this.INTERNAL_MODEL="internal";this.TOKEN="token";this.TEXT="text";this.MODEL_INSTRUCTIONS="/instructions";this.LINE_GAP_CLASS="sapUiSmallMarginTop";this.TOKENS_GAP_CLASS="sapUiTinyMarginEnd";var e="'";var O="'";this.VALIDATION_REGEX="^["+O+"][^"+e+"]*["+O+"]$"+"|"+"^[^"+e+"]*$";this.lineBreakIndexes={start:{},end:{}};this._internalModel=new J({instructions:[]});this._internalModel.setSizeLimit(300);this.setModel(this._internalModel,this.INTERNAL_MODEL);},setInstructions:function(i){this.setProperty("instructions",i);this.destroyAggregation("_content");if(!i||!i.length){i=[];}this.getModel(this.INTERNAL_MODEL).setProperty(this.MODEL_INSTRUCTIONS,i);},setUseIndent:function(u){this.setProperty("useIndent",u,true);this.destroyAggregation("_content");},onBeforeRendering:function(){var e=this.getAggregation("_content");if(!e){var m=this._internalModel.getProperty(this.MODEL_INSTRUCTIONS);if(!m){return;}try{var n=this._createControls(m);for(var i=0,o=n.length;i<o;++i){this.addAggregation("_content",n[i],true);}}catch(p){this._showErrorMessage(p);}}},renderer:function(r,o){r.write("<div class='sapUiSizeCompact' ");r.writeControlData(o);r.write(">");var e=o.getAggregation("_content");if(e){if(o._getIndent()){r.write(o._getTableStart());}for(var i=0,m=e.length;i<m;++i){var n=o.lineBreakIndexes.start[i];var p=o.lineBreakIndexes.end[i];if(n&&o._getIndent()){r.write(o._getLogicalOperatorStart());}r.renderControl(e[i]);if(p&&o._getIndent()){r.write(o._getLogicalOperatorEnd());}}if(o._getIndent()){r.write(o._getTableEnd());}}r.write("</div>");},getTokensAndTexts:function(){var t=[];var e=this._internalModel.getProperty(this.MODEL_INSTRUCTIONS);for(var i=0,m=e.length;i<m;++i){var n=e[i];var o={text:n[this.TEXT],token:n[this.TOKEN]};t.push(o);}return t;},getExpression:function(){var e=[];var m=this._internalModel.getProperty(this.MODEL_INSTRUCTIONS);for(var i=0,n=m.length;i<n;++i){var o=m[i];var t=o[this.TOKEN];e.push(t);}if(!m[m.length-1].token){e.pop(m.length-1);}return e.join(" ");},_onChange:function(o){var i=o.getSource().data("instructionNum");this.fireEvent("change",{instructionNum:i});},_createControls:function(e){this.lineBreakIndexes={start:{},end:{}};var m=[];var n=[];var i,o;var p;var q;var r;for(i=0,o=e.length;i<o;++i){p=e[i];q=this._getCreateFunction(p);if(q===null){var s=" ";this._showErrorMessage(s);n=[];break;}n.push(q);}for(i=0,o=n.length;i<o;++i){p=e[i];q=n[i];r=n[i+1];var t=this.MODEL_INSTRUCTIONS+"/"+i+"/";var u=this.INTERNAL_MODEL+">"+t;var v=q.apply(this,[p,r,t,u]);var w=v.controls;v.controls.forEach(function(x){x.data({instructionNum:i});if(x.attachChange){x.attachChange(this._onChange.bind(this));}}.bind(this));if(v.needLineBreak){this.lineBreakIndexes.start[m.length]=true;this.lineBreakIndexes.end[m.length+w.length-1]=true;}m.push.apply(m,w);}return m;},_getCreateFunction:function(i){var e=null;if(i.visible===false){e=this._createHiddenControl;}else if(i.type&&i.type==="action"){e=this._createAddRepetitiveControl;}else if(i.tokenType=="ConjunctionOperator"&&!i.editable){e=this._createNonEditableLogicalOperator;}else if(i.tokenType=="ConjunctionOperator"&&i.editable){e=this._createEditableLogicalOperator;}else if(i.editable===false){e=this._createTextControl;}else if(i.businessDataType==="Number"){e=this._createNumberControl;}else if(i.businessDataType==="Date"){e=this._createDateControl;}else if(i.businessDataType==="Time"){e=this._createTimeControl;}else if(i.businessDataType==="Timestamp"){e=this._createDateTimeControl;}else if(i.businessDataType==="TimeSpan"){e=this._createNumberControl;}else if(i.businessDataType==="String"){e=this._createGeneralInputControl;}else if(i.businessDataType==="Boolean"){e=this._createBooleanSelectionControl;}else if(i.valueOptions&&i.valueOptions.type==="Set"){e=this._createSelectionControl;}return e;},_createHiddenControl:function(i,n,e,m){return[];},_createSelectionControl:function(i,n,e,m){var p=this.getParent();var o=new S({items:{path:m+"valueOptions/values",template:new a({key:"{"+this.INTERNAL_MODEL+">"+this.TOKEN+"}",text:"{"+this.INTERNAL_MODEL+">"+this.TEXT+"}"})},forceSelection:false,selectedKey:"{"+m+this.TOKEN+"}",width:"auto",change:function(q){},enabled:(p.bReadOnly&&p instanceof sap.rules.ui.DecisionTableCellExpressionBasic)?false:true});o.addStyleClass(this.TOKENS_GAP_CLASS);return{controls:[o],needLineBreak:false};},_createAddRepetitiveControl:function(i,n,e,m){var o=[];var p=new B({text:"",press:i.callback});p.setIcon("sap-icon://add");o.push(p);return{controls:o,needLineBreak:false};},_createTextControl:function(i,n,e,m){var o=[];var p=new T({text:"{"+m+this.TEXT+"}",width:"auto"}).addStyleClass("sapUiTinyMarginTop").addStyleClass("sapRULExpressionBasic");o.push(p);return{controls:o,needLineBreak:false};},_createNumberControl:function(i,n,e,m){var v=this._createValueRange(i);var o=new I({width:"auto",type:"Text",value:{path:m+this.TOKEN,type:new d({minIntegerDigits:0,minFractionDigits:0},v)},valueStateText:this._getValueStateText(v),change:function(p){}});o.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(o);return{controls:[o],needLineBreak:false};},_createDateControl:function(i,n,e,m){var v=this._createValueRange(i);this._removeTextSingleQuote(e);var o=new D({width:"auto",type:"Date",value:{path:m+this.TEXT},valueStateText:this._getValueStateText(v),change:function(p){var P=p.getSource().getParent();P._syncToken(e);}});o.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(o);return{controls:[o],needLineBreak:false};},_createTimeControl:function(i,n,e,m){var v=this._createValueRange(i);this._removeTextSingleQuote(e);var o=new l({width:"auto",type:"Time",value:{path:m+this.TEXT},valueStateText:this._getValueStateText(v),change:function(p){var P=p.getSource().getParent();P._syncToken(e);}});o.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(o);return{controls:[o],needLineBreak:false};},_createDateTimeControl:function(i,n,e,m){var v=this._createValueRange(i);this._removeTextSingleQuote(e);var o=new k({width:"auto",value:{path:m+this.TEXT},valueStateText:this._getValueStateText(v),change:function(p){var P=p.getSource().getParent();P._syncToken(e);}});o.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(o);return{controls:[o],needLineBreak:false};},_createGeneralInputControl:function(i,n,e,m){var o=new I({value:{path:m+this.TEXT,type:new sap.ui.model.type.String(null,{search:this.VALIDATION_REGEX})},width:"auto",change:function(p){var P=p.getSource().getParent();P._syncToken(e);}});o.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(o);return{controls:[o],needLineBreak:false};},_createBooleanSelectionControl:function(i,n,e,m){var o=new sap.m.Select({selectedKey:"{"+m+this.TOKEN+"}",width:"auto",items:[{text:"true",key:"true"},{text:"false",key:"false"}]});o.addStyleClass(this.TOKENS_GAP_CLASS);return{controls:[o],needLineBreak:false};},_createNonEditableLogicalOperator:function(i,n,e,m){var o=this._createLineBreak();var p=[];var q=new H({content:"<B class='sapMText sapUiTinyMarginTop sapUiTinyMarginEnd'>"+i[this.TEXT]+"</B>"});if(!this._getIndent()){p.push(o);}p.push(q);return{controls:p,needLineBreak:true};},_createEditableLogicalOperator:function(i,n,e,m){var o=this._createLineBreak();var p=[];var q=new S({items:{path:m+"valueOptions/values",template:new a({key:"{"+this.INTERNAL_MODEL+">"+this.TOKEN+"}",text:"{"+this.INTERNAL_MODEL+">"+this.TEXT+"}"})},selectedKey:"{"+m+this.TOKEN+"}",width:"auto",change:function(r){}});q.addStyleClass(this.TOKENS_GAP_CLASS);if(!this._getIndent()){p.push(o);}p.push(q);return{controls:p,needLineBreak:true};},_createSpace:function(){var e=new H({content:'<span>&nbsp;</span>'});return e;},_createLineBreak:function(){var e=new H({content:'<DIV class="'+this.LINE_GAP_CLASS+'"></DIV>'});return e;},_getTableStart:function(){return'<table><td></td><td style="vertical-align:top;">';},_getTableEnd:function(){return'</td></tr></table>';},_getLogicalOperatorStart:function(){return'<div class="'+this.LINE_GAP_CLASS+'"></td></tr><tr><td style="vertical-align:top;">';},_getLogicalOperatorEnd:function(){return'</td><td style="vertical-align:top;">';},_getIndent:function(){var i;try{i=this.getProperty("useIndent");}catch(e){i=false;}return i;},_createValueRange:function(i){var r=null;if(i.valueOptions&&i.valueOptions.type==="Range"){r={};var e=i.valueOptions;if(e.from){r.minimum=e.from;}if(e.to){r.maximum=e.to;}}return r;},_getValueStateText:function(v){var t;if(!v){return t;}if(v.minimum!==undefined&&v.maximum!==undefined){t="";}else if(v.minimum!==undefined){t="";}else if(v.maximum!==undefined){t="";}else{t="";}return t;},_attachValidationHandlers:function(i){i.attachParseError(function(e){e.getParameter("element").setValueState("Error");e.getParameter("element").setValueStateText(e.getParameter("message"));});i.attachValidationSuccess(function(e){e.getParameter("element").setValueState("None");});},_showErrorMessage:function(m){jQuery.sap.require("sap.m.MessageBox");sap.m.MessageBox.alert(m,{icon:sap.m.MessageBox.Icon.ERROR});},_removeTextSingleQuote:function(e){var m=this._internalModel;var v=m.getProperty(e+this.TEXT);m.setProperty(e+this.TEXT,v.replace(/\'/g,""));},_syncToken:function(e){var m=this._internalModel,i=false,n=false;var o=m.getProperty(e+this.TEXT).toString();if(o==="'"){i=true;}if(o.substr(0,"'")!=="'"){i=true;}if(o.substr(o.length-1,"'")!=="'"){n=true;}if(i){o="'"+o;}if(n){o=o+"'";}m.setProperty(e+this.TOKEN,o);}});});
