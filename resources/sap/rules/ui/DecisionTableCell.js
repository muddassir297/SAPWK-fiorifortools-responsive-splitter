/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","./library","sap/rules/ui/DecisionTableCellExpressionAdvanced","sap/rules/ui/type/DecisionTableCell","sap/rules/ui/DecisionTableCellExpressionBasic","sap/m/Popover"],function(q,l,D,a,b,P){"use strict";var c=sap.ui.core.Control.extend("sap.rules.ui.DecisionTableCell",{metadata:{library:"sap.rules.ui",properties:{valuePath:{type:"string",defaultValue:"",bindable:"bindable"},valueOnlyPath:{type:"string",defaultValue:"",bindable:"bindable"},headerValuePath:{type:"string",defaultValue:"",bindable:"bindable"},fixedOperatorPath:{type:"string",defaultValue:"",bindable:"bindable"},typePath:{typePath:"string",bindable:"bindable"},valueStateTextPath:{type:"string",defaultValue:"null",bindable:"bindable"},valueModelName:{type:"string",defaultValue:"",bindable:"bindable"},displayModelName:{type:"string",defaultValue:"",bindable:"bindable"},editable:{type:"boolean",defaultValue:true},inFocus:{type:"boolean",defaultValue:false}},aggregations:{_displayedControl:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{expressionLanguage:{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,validateOnLoad:true,singularName:"expressionLanguage"}}}});c.prototype.onFocusIn=function(){var A=function(e){var d=e.getSource().getAggregation('content')[1];d.setVisible(true);}.bind(this);var f=function(e){if(this._oPopover){var d=this._oPopover.getAggregation('content')[1];if(d instanceof sap.rules.ui.ExpressionAdvanced){if(d.codeMirror){var E=d.codeMirror.getValue();d.setValue(E);}}this._oPopover.destroy();this._oPopover=null;}}.bind(this);if(!this._oPopover){var v=this.getModel().getProperty(this.getValueOnlyPath());if(v){this._oPopover=sap.ui.xmlfragment("sap.rules.ui.fragments.DecisionTableCellExpressionBasic",this);}else{this._oPopover=sap.ui.xmlfragment("sap.rules.ui.fragments.DecisionTableCellExpressionAdvanced",this);}this._oPopover.attachAfterOpen(A);this._oPopover.attachAfterClose(f);this.addDependent(this._oPopover);var n=q.sap.byId(this.getId()).closest('td').width()*0.93;var w=n+"px";var s=this._oPopover.getAggregation('content')[0];s.setWidth(w);var d=this._oPopover.getAggregation('content')[1];d.setExpressionLanguage(this.getExpressionLanguage());this._bindPopOverFragment(d);var i=this.getAggregation("_displayedControl");this._oPopover.openBy(i);}};c.prototype.onBeforeRendering=function(){this._setDisplayedControl();};c.prototype.onAfterRendering=function(){this._createStaticControl();};c.prototype.init=function(){this._decisionTableCellFormatter=new a();};c.prototype._setDisplayedControl=function(){var d=this.getAggregation("_displayedControl");var r=this.getParent().getParent().getParent();if(this.getInFocus()&&r.getEditable()){}else{d=this._createStaticControl();}this.setAggregation("_displayedControl",d,true);};c.prototype._createStaticControl=function(){var r=this.getParent().getParent().getParent();var e=r.getEditable();var d=this.getAggregation("_displayedControl");if(!(d instanceof sap.m.Input)){if(d){d.destroy();}d=new sap.m.Input({editable:false});d.addStyleClass("sapRULDecisionTableSCellTextOverflow");d.addDelegate({onclick:function(E){if(e){this.onFocusIn();}}.bind(this)});d.addDelegate({onkeypress:function(E){if(E.keyCode===13&&e){this.onFocusIn();}else{return;}}.bind(this)});}var v=this.getDisplayModelName()+">"+this.getValuePath();if(v&&v!=="null"){d.bindValue(v);d.bindProperty("tooltip",{path:v,formatter:function(V){return V;}});}var f=this.getValueStateTextPath();if(f&&f!=="null"){d.bindProperty("valueState",{path:f,formatter:function(V){if(V){d.addStyleClass("sapMInputBaseErrorInner");return sap.ui.core.ValueState.Error;}d.removeStyleClass("sapMInputBaseErrorInner");return sap.ui.core.ValueState.None;}});}return d;};c.prototype._bindPopOverFragment=function(e){var d=this.getDisplayModelName()+">"+this.getValuePath();var v=this.getValueModelName()?this.getValueModelName()+">"+this.getValuePath():this.getValuePath();var f=this.getDisplayModelName()?this.getDisplayModelName()+">"+this.getHeaderValuePath():this.getHeaderValuePath();if(v&&v!=="null"){if(!this.getTypePath()){e.bindValue({parts:[{path:f},{path:this.getFixedOperatorPath()},{path:v},{path:d}],type:this._decisionTableCellFormatter});}else{e.bindValue({parts:[{path:v},{path:this.getTypePath()},{path:d}],type:this._decisionTableCellFormatter});}}if(this.getTypePath()){e.bindType(this.getTypePath());}if(f){e.bindHeaderValue(f);if(this.getFixedOperatorPath()){e.bindFixedOperator(this.getFixedOperatorPath());}}var g=this.getValueStateTextPath();if(g&&g!=="null"){e.bindValueStateText(g);}};c.prototype.setExpressionLanguage=function(e){this._decisionTableCellFormatter.setExpressionLanguage(e);return this.setAssociation("expressionLanguage",e,true);};return c;},true);
