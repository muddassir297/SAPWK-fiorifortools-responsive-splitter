jQuery.sap.declare("sap.rules.ui.parser.ruleBody.lib.decisionTableCell");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.parsingBackendMediator");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.ASTConvertor");jQuery.sap.require("sap.rules.ui.parser.infrastructure.errorHandling.hrfException");jQuery.sap.require("sap.rules.ui.parser.infrastructure.messageHandling.lib.responseCollector");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.constants");jQuery.sap.require("sap.rules.ui.parser.ruleBody.lib.constants");jQuery.sap.require("sap.rules.ui.parser.AST.lib.bundleAst");sap.rules.ui.parser.ruleBody.lib.decisionTableCell=sap.rules.ui.parser.ruleBody.lib.decisionTableCell||{};sap.rules.ui.parser.ruleBody.lib.decisionTableCell.lib=(function(){var p=new sap.rules.ui.parser.businessLanguage.lib.parsingBackendMediator.lib.parsingBackendMediatorLib();var A=sap.rules.ui.parser.businessLanguage.lib.ASTConvertor.lib;var h=sap.rules.ui.parser.infrastructure.errorHandling.hrfException.lib;var r=sap.rules.ui.parser.infrastructure.messageHandling.lib.responseCollector.lib.ResponseCollector;var a=sap.rules.ui.parser.businessLanguage.lib.constants.lib;var b=sap.rules.ui.parser.ruleBody.lib.constants.lib;var c=RulesAPI_Ast;var d=c.astOperations;function D(i,k,l,m,v,o){this.cellExpression=l;this.headerExpression=i;this.operator=k;this.businessDataType=m;this.vocabulary=v;this.vocaDataProvider=o;this.status=a.statusEnum.SUCCESS;this.convertedHeader={};this.convertedHeader.text=null;this.convertedHeader.AST=null;this.convertedCell={};this.convertedCell.text=null;this.convertedCell.AST=null;this.convertedCondition={};this.convertedCondition.text=null;this.convertedCondition.AST=null;this.convertedOperator={};this.convertedOperator.text=this.operator;this.convertedOperator.AST=null;this.valueHelp=null;this.tokensRequested=false;this.tokens=[];this.headerTokens=[];this.operatorTokens=[];this.cellTokens=[];this.currCursorInfo={};this.needASTResult=false;}var s=function s(o){if(o&&o.hasOwnProperty(b.expressionProperties.AST)&&o.hasOwnProperty(b.expressionProperties.text)){if(o[b.expressionProperties.AST]){o[b.expressionProperties.AST]=o[b.expressionProperties.AST].serialize();}return JSON.stringify(o);}return null;};var e=function e(t){t=t.replace(/(\r\n|\n|\r|\t|\f)/gm," ");return JSON.parse(t);};var f=function f(i,k,o){var l='';if(i){l+=i;}if(o){l+=" "+o;}if(k){l+=" "+k;}return l;};var g=function g(i,k,o){var l,m=0,q=k.length;if(i){m=i.length+1;q=k.length-i.length-1;if(o){m+=o.length+1;q-=(o.length+1);}}l=k.substr(m,q);return l;};var n=function n(i,k){var l=false;var v;var m;if(k){v=parseInt(k.replace(/\./g,''),10);m=parseInt(a.supportedVersions.NEW_AST.replace(/\./g,''),10);if(((i[a.propertiesEnum.locale]&&i[a.propertiesEnum.locale][a.propertiesEnum.convert]&&i[a.propertiesEnum.locale][a.propertiesEnum.convert][a.propertiesEnum.source]===a.CODE_TEXT)||(i.hasOwnProperty(a.propertiesEnum.termMode)&&i[a.propertiesEnum.termMode].hasOwnProperty(a.propertiesEnum.convert)&&i[a.propertiesEnum.termMode][a.propertiesEnum.convert]&&i[a.propertiesEnum.termMode][a.propertiesEnum.convert][a.propertiesEnum.source]===a.CODE_TEXT))&&v>=m){l=true;}}return l;};var j=function j(i,k){var l=false;var v;var m;if(k){v=parseInt(k.replace(/\./g,''),10);m=parseInt(a.supportedVersions.NEW_AST.replace(/\./g,''),10);if(((i[a.propertiesEnum.locale]&&i[a.propertiesEnum.locale][a.propertiesEnum.convert]&&i[a.propertiesEnum.locale][a.propertiesEnum.convert][a.propertiesEnum.target]===a.CODE_TEXT)||(i.hasOwnProperty(a.propertiesEnum.termMode)&&i[a.propertiesEnum.termMode].hasOwnProperty(a.propertiesEnum.convert)&&i[a.propertiesEnum.termMode][a.propertiesEnum.convert]&&i[a.propertiesEnum.termMode][a.propertiesEnum.convert][a.propertiesEnum.target]===a.CODE_TEXT))&&v>=m){l=true;}}return l;};D.prototype.deserializeExpressionParts=function deserializeExpressionParts(){this.headerExpression=this.headerExpression?e(this.headerExpression).text:null;this.cellExpression=this.cellExpression?e(this.cellExpression).text:null;this.operator=this.operator?e(this.operator).text:null;};D.prototype.getParserAST=function getParserAST(i,k,v,l,m){function o(i){if(i===null||i===undefined||i===""){return true;}return false;}var q=p.parseInputRT(i,k,this.vocaDataProvider,v,l,this.vocabulary,m);if(q===undefined||(q===null&&o(i)===false)){r.getInstance().addMessage("error_in_parsing_expression",[i]);throw new h.HrfException("error_in_parsing_expression: "+i,false);}if(k===p.PARSE_MODE){if(q!==null&&q.status===a.statusEnum.ERROR){throw new h.HrfException('',false);}}return q;};D.prototype.getParserConvertedExpression=function getParserConvertedExpression(i){return i[b.parserResultEnum.convertedExpression];};D.prototype.hasParserConvertedExpression=function hasParserConvertedExpression(i){if(i.status===a.statusEnum.SUCCESS){if(!i.hasOwnProperty(a.propertiesEnum.convertedExpression)){this.status=a.statusEnum.ERROR;}else{return true;}}return false;};D.prototype.validateAndConvert=function validateAndConvert(k,l){var m;var o;var q;if(k.hasOwnProperty(a.propertiesEnum.tokens)&&(k[a.propertiesEnum.tokens]===true)){this.tokensRequested=true;}function u(i){var B={};if(this.convertedHeader.text&&i>this.convertedHeader.text.length){B.position=i-this.convertedHeader.text.length-this.convertedOperator.text.length-2;B.expressionPart=b.expressionParts.cell;}else{B.position=i;B.expressionPart=b.expressionParts.header;}return B;}function t(i){var B={};if(i){if(i.hasOwnProperty('cursorPosition')&&i.cursorPosition!==undefined&&i.cursorPosition!==null){B.cursorInfo=u.call(this,i.cursorPosition);}r.getInstance().addMessage(i.errorID,undefined,null,B,i.errorDetails);}}function v(){var q={};q.status=this.status;if(this.status===a.statusEnum.SUCCESS){if(this.convertedCell.text||this.convertedHeader.text){q.converted={};if(this.needASTResult){q.converted.header=s(this.convertedHeader);q.converted.fixedOperator=s(this.convertedOperator);q.converted.cell=s(this.convertedCell);}else{q.converted.header=this.convertedHeader.text;q.converted.fixedOperator=this.convertedOperator.text;q.converted.cell=this.convertedCell.text;}}q.actualReturnType=this.actualReturnType;if(this.valueHelp){q.valueHelp=this.valueHelp;}}if(this.tokensRequested){q.tokens={};q.tokens.header=this.headerTokens;q.tokens.fixedOperator=this.operatorTokens;q.tokens.cell=this.cellTokens;}return q;}function w(){if(this.operator){this.operatorTokens=this.getParserAST(this.operator,a.TOKEN_TYPES,null,null,k);}else{this.operatorTokens=[];}var B=0;var C=0;var E=0;if(this.headerExpression){B=this.headerExpression.length;}if(this.operator){C=this.operator.length+1;}if(this.cellExpression){E=1;}var F=B+C+E;var G=0;var H=this.tokens;var I=false;var i=0;for(i=0;i<H.length;++i){if(H[i].start===F){G=i;I=true;break;}if((H[i].start<F)&&(F<=H[i].end)){G=i;H[i].start=F;I=true;break;}if(H[i].end<F){continue;}}if(I){for(i=G;i<H.length;++i){H[i].start-=F;H[i].end-=F;this.cellTokens.push(H[i]);}}}function x(i,o,k){var B;var C=null;var E={};var F=null;var G={};E.text=null;E.AST=null;B=this.getParserAST(i,a.VALIDATE_MODE,null,o,k);if(this.tokensRequested){if(B.tokens){C=B.tokens;}else{C=[];}}if(B.status===a.statusEnum.SUCCESS){this.actualReturnType=B.actualReturnType;if(B.valueHelp){this.valueHelp=B.valueHelp;}if(B.hasOwnProperty(a.propertiesEnum.convertedExpression)){E.text=this.getParserConvertedExpression(B);if(this.needASTResult){F=new A.ASTConvertor(B.model);E.AST=F.getAST();}}}else{t.call(this,B);this.status=a.statusEnum.ERROR;}G.converted=E;G.tokens=C;return G;}this.needASTResult=j(k,l);if(n(k,l)){this.deserializeExpressionParts();}var y={};if(this.headerExpression){y=x.call(this,this.headerExpression,a.TYPE_SINGLE_EXPRESSION,k);this.convertedHeader=y.converted;this.headerTokens=y.tokens;}if(this.status===a.statusEnum.SUCCESS&&this.cellExpression){m=f(this.headerExpression,this.cellExpression,this.convertedOperator.text);o=this.businessDataType||a.TYPE_BOOLEAN_ENHANCED;y=x.call(this,m,o,k);this.convertedCondition=y.converted;this.tokens=y.tokens;if(this.status===a.statusEnum.SUCCESS&&this.convertedCondition&&this.convertedCondition.text){this.convertedCell.text=g(this.convertedHeader.text,this.convertedCondition.text,this.convertedOperator.text);if(this.needASTResult){var z=d.split(this.convertedHeader.AST,this.convertedCondition.AST,A.ASTConvertor.operatorsMap[this.convertedOperator.text]);this.convertedOperator.AST=z.operator;this.convertedCell.AST=z.rest;}}}if(this.tokensRequested){w.call(this);}q=v.call(this);return q;};return{DecisionTableCell:D,concatToDecisionTableCondition:f,splitDecisionTableCondition:g};}());
