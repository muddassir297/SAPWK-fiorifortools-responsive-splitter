VBI.InputModeDefault=0;VBI.InputModeTrackObject=1;VBI.InputModeTrackMap=2;VBI.InputModeTrackDesign=3;VBI.InputModeRectSelect=4;VBI.InputModeLassoSelect=5;VBI.InputModeRectZoom=6;
VBI.SceneManager=function(){"use strict";var s={};s.vbiclass="SceneManager";s.m_SceneArray=[];s.find=function(n){for(var a=0;a<s.m_SceneArray.length;++a){if(s.m_SceneArray[a].m_ID==n){return s.m_SceneArray[a];}}return null;};s.clear=function(){for(var n=0;n<s.m_SceneArray.length;++n){s.m_SceneArray[n].clear();}s.m_SceneArray=[];};s.load=function(d,c){if(d.Set){s.loadScenes(d.Set,false,d,c);}if(d.Merge){s.loadScenes(d.Merge,true,d,c);}};s.loadScenes=function(a,i,d,c){if(jQuery.type(a)=='array'){for(var n=0;n<a.length;++n){s.loadScene(a[n],i,d,c);}}else{s.loadScene(a,i,d,c);}};s.loadScene=function(m,i,d,c){var a;var r=false;if(m.name){a=s.find(m.name);if(a){if(!i){a.clear();}if(m.SceneGeo){r=a.load(m.SceneGeo,c,i);}else if(m.Scene3D){r=a.load(m.Scene3D,c,i);}else{r=a.load(m.Scene,c,i);}if(r){a.ReAwake();}return;}}else if(!i){s.clear();}if(m.SceneGeo){s.loadNewScene(m.SceneGeo,'geo',c);}else if(m.Scene3D){s.loadNewScene(m.Scene3D,'3d',c);}else if(m.Scene){s.loadNewScene(m.Scene,'default',c);}};s.loadNewScene=function(a,b,c){var d=null;if(jQuery.type(a)=='object'){if(b=='geo'){d=new VBI.GeoScene(null,null,null);}else if(b=='3d'){d=new VBI.Scene3D(null);}else{d=new VBI.Scene(null,null,null);}d.load(a,c);s.Add(d);}else if(jQuery.type(a)=='array'){for(var n=0;n<a.length;++n){d=null;if(b=='geo'){d=new VBI.GeoScene(null,null,null);}else if(b=='3d'){d=new VBI.Scene3D(null);}else{d=new VBI.Scene(null,null,null);}d.load(a[n],c);s.Add(d);}}};s.Add=function(a){s.m_SceneArray.push(a);};s.GetScene=function(t){for(var i=0;i<s.m_SceneArray.length;++i){if(s.m_SceneArray[i].m_TargetName==t){return s.m_SceneArray[i];}}return null;};s.GetSceneByName=function(n){for(var i=0;i<s.m_SceneArray.length;++i){if(s.m_SceneArray[i].m_ID==n){return s.m_SceneArray[i];}}return null;};return s;};
VBI.Scene=function(t){"use strict";var s={};s.vbiclass="Scene";s.m_TargetName=t;s.m_EvtCont=new VBI.Events();s.m_ID="";s.m_Ctx=null;s.m_Div=null;s.m_Parent=null;s.m_CaptureVO=null;s.m_DesignVO=null;s.m_VOS=[];s.m_Events=null;s.m_Proj=null;s.m_LastDefinedCenterPos=s.m_LastZoomArea=undefined;s.m_HotItem={m_VO:null,m_Index:null,m_Design:null,m_HitObj:null};s.m_DragInfo=null;s.m_Target=t;s.LoadSingleVO=function(e,v,c,I){if(jQuery.type(e)=='object'){var a=null;if(s.vbiclass=="3DScene"){a=v.Factory3D.CreateInstance(e.type);}else{a=v.Factory.CreateInstance(e.type);}a.m_Scene=s;a.load(e,c);if(I){var n=a.m_ID;for(var i=s.m_VOS.length;i--;){if(s.m_VOS[i].m_ID==n){s.m_VOS[i]=a;return;}}}s.m_VOS.push(a);}};s.BaseLoad=function(d,c,i){if(!i){VBI.RegisterKeyboardHook();s.m_Ctx=c;if(d.id){s.m_ID=d.id;}}if(d.VO){var v=new VBI.VisualObjects();if(jQuery.type(d.VO)=='array'){for(var n=0;n<d.VO.length;++n){s.LoadSingleVO(d.VO[n],v,c,i);}}else{s.LoadSingleVO(d.VO,v,c,i);}}};s.BaseClear=function(){for(var n=0,a=s.m_VOS.length;n<a;++n){s.m_VOS[n].clear();}s.m_VOS=[];s.m_Ctx=null;s.m_CaptureVO=null;s.m_DesignVO=null;if(s.m_Parent){s.m_Parent.m_refSceneInstance=null;}s.m_HotItem=null;if(s.m_Events){s.m_Events.clear();s.m_Events=null;}VBI.UnRegisterKeyboardHook();};s.BaseGetVO=function(i){for(var n=0,a=s.m_VOS.length;n<a;++n){if(s.m_VOS[n].m_ID==i){return s.m_VOS[n];}}return null;};s.load=function(d,c,i){s.BaseLoad(d,c,i);return false;};s.clear=function(){s.BaseClear();s.m_Div=null;};s.VerifyHotItem=function(v,B){var h=s.m_HotItem;if((B!=h.m_Index)&&(v==h.m_VO)){var r=v.m_BBRefs[B];if((h.cI==r.cI)&&(h.nI==r.i)){h.m_Index=B;}}s.m_LastHotItem=undefined;};s.CheckHotItem=function(){if(this.m_LastHotItem){var r=this.m_LastHotItem;var I=(r.cI!=undefined)?s.m_PreassembledData.clust[r.cI]:s.m_PreassembledData.base[s.m_LastHotItem.m_VO];if(I.m_nRecalcs!=r.recalcs){s.InternalSetHotItem(null,null,true);this.m_LastHotItem=undefined;}}};s.SetLastHotItem=function(h){if(h.m_VO&&h.m_VO.m_BBRefs!=undefined){var r=h.m_VO.m_BBRefs[h.m_Index];var I=(r.cI!=undefined)?s.m_PreassembledData.clust[r.cI]:s.m_PreassembledData.base[h.m_VO.m_nPreDataIndex];s.m_LastHotItem={cI:r.cI,i:r.i,m_VO:h.m_VO.m_nPreDataIndex,recalcs:I.m_nRecalcs};}};s.InvalidateInvisibleHots=function(){if(this.m_LastHotItem!=undefined){var r=this.m_LastHotItem;var I=(r.cI!=undefined)?s.m_PreassembledData.clust[r.cI]:s.m_PreassembledData.base[s.m_LastHotItem.m_VO];if(I[r.i]!=undefined){I[r.i].h=false;s.InternalSetHotItem(null,null,true);}this.m_LastHotItem=undefined;}};s.InternalSetHotItem=function(v,h,u){var a=s.m_HotItem;var m=false;var o=a.m_Index;var b=a.m_VO;if(h){if(a.m_Index!=h.m_Index){a.m_Index=h.m_Index;m=true;}if(a.m_Design!=h.m_Design){a.m_Design=h.m_Design;m=true;}if(a.m_Entity!=h.m_Entity){a.m_Entity=h.m_Entity;m=true;}}else if(a.m_Entity||a.m_Detail){m=true;a.m_Entity=null;a.m_Detail=null;}if(a.m_VO!=v){a.m_VO=v;m=true;}if(!m){var c;if(h&&(c=a.m_HitObj)){if(!jQuery.sap.equal(c,h,2)){m=true;}}else if(h!=null||a.m_HitObj!=null){m=true;}}a.m_HitObj=h;if(m){if(b&&!u){b.InternalChangeHotItem(o,false,a);}if(v){v.InternalChangeHotItem(a.m_Index,true,a);}s.RenderAsync(false);}return m;};s.InternalRenderVisualObjects=function(c,a){var b=Date.now();var v=s.m_VOS;VBI.Utilities.BackupFont(a);for(var n=0;n<s.m_VOS.length;++n){v[n].Render(c,a);}VBI.Utilities.RestoreFont(a);s.m_nLastRenderingTime=Date.now()-b;};s.Render=function(){};s.Awake=function(t){s.InternalRenderVisualObjects(null,s.m_Ctx);};s.NotifyDataChange=function(){for(var n=0;n<s.m_VOS.length;++n){s.m_VOS[n].NotifyDataChange(s.m_Ctx);}s.m_nDataVersion++;};s.GetPointArrayFromPosArray=function(p,a){return p;};s.GetPosFromPoint=function(p){return p;};s.GetPointFromPos=function(p,a,i){return s.GetPointArrayFromPosArray(p,a,i);};s.GetInternalDivClientRect=function(){var r=s.m_Div.getBoundingClientRect();if(this.m_Ctx.moThumbnail&&this.m_Ctx.moThumbnail.nOrgWidth&&this.m_Ctx.moThumbnail.nOrgHeight){return{left:r.left,top:r.top,width:s.m_Ctx.moThumbnail.nOrgWidth,height:s.m_Ctx.moThumbnail.nOrgHeight,right:r.left+s.m_Ctx.moThumbnail.nOrgWidth,bottom:r.top+s.m_Ctx.moThumbnail.nOrgHeight};}return r;};s.GetEventVPCoords=function(e){if(!e){return[0,0];}var r=s.GetInternalDivClientRect();if(VBI.m_bIsRtl){return[r.right-e.clientX,e.clientY-r.top];}else{return[e.clientX-r.left,e.clientY-r.top];}};s.GetEventVPCoordsObj=function(e){var p=s.GetEventVPCoords(e);return{x:p[0].toString(),y:p[1].toString()};};s.GetEventVPCoordsObjWithScene=function(e){var p=s.GetEventVPCoords(e);return{x:p[0].toString(),y:p[1].toString(),scene:s.m_ID};};s.GetEventDropObjWithScene=function(e){return{strSource:s.m_DragInfo.strScene+"|"+s.m_DragInfo.strID+"|"+s.m_DragInfo.strInstance,scene:s.m_ID};};s.DispatchEvent=function(e,a){if(VBI.m_bTrace){VBI.Trace("DispatchEvent "+e.type+" as "+a+" mode:"+s.m_nInputMode+(s.m_Gesture?" gesture active":""));}if(s.m_nInputMode==VBI.InputModeTrackMap){return false;}var f,b=e.type;if(a){e.m_evName=b=a;}e.m_Scene=s;if(e.offsetX==undefined||e.offsetY==undefined){var r;if(e.clientX!==undefined&&e.clientY!==undefined){r=e.target.getBoundingClientRect();e.offsetX=e.clientX-r.left;e.offsetY=e.clientY-r.top;}else if(e.changedTouches!==undefined&&(e.changedTouches.length>0)){r=e.target.getBoundingClientRect();e.clientX=e.changedTouches[0].clientX;e.clientY=e.changedTouches[0].clientY;e.offsetX=e.clientX-r.left;e.offsetY=e.clientY-r.top;}}if(e.shiftKey==undefined){e.shiftKey=VBI.m_shiftKey;}if(e.ctrlKey==undefined){e.ctrlKey=VBI.m_ctrlKey;}if(s.m_DesignVO){if(VBI.m_bTrace){VBI.Trace("DispatchEvent to Design VO");}if((f=s.m_DesignVO["on"+b])&&typeof(f)=='function'){if((f.bind(s.m_DesignVO))(e)==true){return true;}}}if(s.m_CaptureVO){if((f=s.m_CaptureVO["on"+b])&&typeof(f)=='function'){if((f.bind(s.m_CaptureVO))(e)==true){return true;}}}var i;for(var n=0,l=s.m_VOS.length;n<l;++n){i=l-n-1;if((f=s.m_VOS[i]["on"+b])&&typeof(f)=='function'){if((f.bind(s.m_VOS[i]))(e)==true){return true;}}}return false;};return s;};
VBI.Scene3D=function(t){"use strict";var s=new VBI.Scene(t);s.vbiclass="3DScene";s.m_DivCopyright=null;s.m_bMainSceneInitialized=false;s.m_Events=null;s.m_Canvas=[];s.m_nMaxCanvasDimension=(VBI.m_bIsMobile?6144:8192);s.clear=function(){s.BaseClear();s.clearCanvases();s.m_TargetName=null;s.m_Proj=null;s.m_DivCopyright=null;s.m_Target=null;};s.clearCanvas=function(n){s.m_Canvas[n].m_Scene=null;s.m_Canvas[n]=null;};s.clearCanvases=function(){for(var n=0,a=s.m_Canvas.length;n<a;++n){s.clearCanvas(n);}s.m_Canvas=[];};s.Init=function(){};s.InitializeCanvas=function(c){c.m_Scene=s;c.m_nCurrentX=undefined;c.m_nCurrentY=undefined;c.m_bInvalid=false;if(!c.m_bNotInDOM){s.m_Div.appendChild(c);}};s.CreateCanvases=function(){s.m_Canvas.push(VBI.Utilities.Create3DSceneCanvas("layer1",s.m_nWidthCanvas,s.m_nHeightCanvas,2));for(var n=0;n<s.m_Canvas.length;++n){s.InitializeCanvas(s.m_Canvas[n]);}};s.Awake=function(t){if(!(s.m_Target=VBI.Utilities.GetDOMElement(t))){s.m_Target=VBI.Utilities.CreateDOMElement(t,"1px","1px");}if(s.m_Div){if(s.m_Div.parentNode==s.m_Target){return;}s.m_Target.appendChild(s.m_Div);return;}s.m_TargetName=t;s.m_Div=VBI.Utilities.Create3DSceneDiv(t+"-3Dscene");s.m_Target.appendChild(s.m_Div);s.DoAwake(t);};s.DoAwake=function(t){s.CalculateCanvasDimensions();s.CreateCanvases();s.Init();
// // append copyright
// scene.AddCopyright();
var c=s.m_Canvas[0];s.m_Events=new VBI.SceneEvent(this,c);};s.CalculateCanvasDimensions=function(){var n=s.m_Target.offsetWidth;var r=s.m_Div.getBoundingClientRect();var d=r.width?r.width:s.m_Div.clientWidth;var a=r.height?r.height:s.m_Div.clientHeight;if((d==s.m_nDivWidth)&&(a==s.m_nDivHeight)){return;}if(VBI.m_bTrace){VBI.Trace("Calculating Canvas Dimensions to "+d+","+a+", Dummy:"+n);}s.m_nDivWidth=d;s.m_nDivHeight=a;s.m_nWidthCanvas=d;s.m_nHeightCanvas=a;};s.Render=function(){var v=null;var c=0;for(var i=s.m_VOS.length;i--;){v=s.m_VOS[i];c+=v.Render(s.m_Canvas[0]);}};if(t){s.Awake(t);}return s;};
VBI.GeoScene=function(t,m,c){"use strict";var s=new VBI.Scene(t);s.vbiclass="GeoScene";s.m_RefMapLayerStack="";s.m_DivCopyright=null;s.m_Canvas=[];s.m_ZoomFactors=[1.0,1.0];s.m_StretchFactors=[1.0,1.0];s.m_MapManager=m;s.m_MapLayerStack=c;s.m_nMaxCanvasDimension=(VBI.m_bIsMobile?6144:8192);s.Click=null;s.m_nOverlayIndex=2;s.m_nLabelIndex=3;s.m_nNonDomIndex=4;s.m_nTapCount=0;s.GetHomeLocation=null;s.m_Touches=[];s.m_currentMouseX=0;s.m_currentMouseY=0;s.m_oldMouseX=0;s.m_oldMouseY=0;s.m_currentMouseDownX=0;s.m_currentTouchCount=0;s.m_currentMouseDownY=0;s.m_midPointX=0;s.m_midPointY=0;s.m_currentTouchDistance=0;s.m_nInputMode=VBI.InputModeDefault;s.m_AnimZoomTimer=null;s.m_startPointLonLat=[0.0,0.0];s.m_startLOD=0;s.m_bNavControlVisible=true;s.m_NavControl=null;s.m_RenderRequestID=0;s.m_SuppressedNavigation={zoom:false,move:false};s.m_bScaleVisible=true;s.m_Scale=null;s.m_nInitialTrackingMode=VBI.InputModeDefault;s.m_nCanvasXOversize=2.2;s.m_nCanvasYOversize=2.2;s.m_nCanvasStdXPos=s.m_nCanvasXOversize/4;s.m_nCanvasStdYPos=s.m_nCanvasYOversize/4;s.m_nTicksInALod=VBI.m_bIsMobile?6:12;s.m_nLodFactorZoomIn=Math.pow(2,1/s.m_nTicksInALod);s.m_nLodFactorZoomOut=1/s.m_nLodFactorZoomIn;s.m_nLodFactorZoomInHalf=Math.pow(2,1/(2*s.m_nTicksInALod));s.m_nLodFactorZoomOutHalf=1/s.m_nLodFactorZoomInHalf;s.m_nMaxAnimLodDiff=3;s.m_nZoomMode=1;s.m_nLastRenderingTime=0;s.m_nRenderTimeTarget=250;s.m_nNumOfScalingVOInst=0;s.m_nLastClusteringTime=0;s.m_nDataVersion=0;s.m_bObjCanvasMode=1;s.m_nlstWidth=s.m_nlstHeight=0;s.m_nGetImageDataIncidents=0;s.onTileLoaded=null;s.clear=function(){s.BaseClear();s.m_Touches=[];if(s.m_NavControl){s.m_NavControl.clear();s.m_NavControl=null;}if(s.m_Scale){s.m_Scale.clear();s.m_Scale=null;}s.clearTimers();s.clearCanvases();s.SetInputMode(VBI.InputModeDefault);s.Remove();s.m_RefMapLayerStack="";s.m_MapManager=null;s.m_MapLayerStack=null;s.m_TargetName=null;s.m_Proj=null;s.m_DivCopyright=null;s.m_Target=null;};s.loadSingleRemoveOnScene=function(r,a){if(jQuery.type(r)=='object'){switch(r.type){case"VO":var i=r.id;for(var j=s.m_VOS.length;j--;){if(s.m_VOS[j].m_ID==i){s.m_VOS[j].clear();s.m_VOS.splice(j,1);return;}}break;default:break;}}};s.loadRemoveOnScene=function(r,a){if(jQuery.type(r)=='array'){for(var j=0;j<r.length;++j){s.loadSingleRemoveOnScene(r[j],a);}}else{s.loadSingleRemoveOnScene(r,a);}};s.load=function(d,a,i){var r=false;if(i&&d.Remove){s.loadRemoveOnScene(d.Remove,a);}s.BaseLoad(d,a,i);if(d.refMapLayerStack){var n=a.m_MapLayerStackManager.GetMapLayerStack(d.refMapLayerStack);if(s.m_RefMapLayerStack!=n){s.m_RefMapLayerStack=n;r=true;}}else if(VBI.m_bTrace){VBI.Trace("no map layer specified in geo scene");}if(i){return r;}var b=-1000,e=1000;var f=-90,g=90;s.m_nMinLodVisualBorder=0;s.m_nMaxLodVisualBorder=99;s.m_nOffsetMinLod=0;s.m_bYBorderExists=false;if(d.VisualFrame){if(d.VisualFrame.minLon!=undefined){b=d.VisualFrame.minLon;}else{b=(d.VisualFrame.minX!=undefined?d.VisualFrame.minX:b);}if(d.VisualFrame.maxLon!=undefined){e=d.VisualFrame.maxLon;}else{e=(d.VisualFrame.maxX!=undefined?d.VisualFrame.maxX:e);}if(d.VisualFrame.minLat!=undefined){f=d.VisualFrame.minLat;}else{f=(d.VisualFrame.minY!=undefined?d.VisualFrame.minY:f);}if(d.VisualFrame.maxLat!=undefined){g=d.VisualFrame.maxLat;}else{g=(d.VisualFrame.maxY!=undefined?d.VisualFrame.maxY:g);}if(d.VisualFrame.minLOD!=undefined){s.m_nMinLodVisualBorder=d.VisualFrame.minLOD;}if(d.VisualFrame.maxLOD!=undefined){s.m_nMaxLodVisualBorder=d.VisualFrame.maxLOD;}if(d.VisualFrame.maxFraction!=undefined){s.m_fMaxMinLODFraction=d.VisualFrame.maxFraction;}if(d.VisualFrame.offsetMinLOD!=undefined){s.m_nOffsetMinLod=d.VisualFrame.offsetMinLOD;}}s.m_bXBorderExists=(b!=-1000)||(e!=1000);s.m_nBorderMinPoint=VBI.MathLib.DegToRad([b,g]);s.m_nBorderMaxPoint=VBI.MathLib.DegToRad([e,f]);s.m_Proj=s.setProjection();var u=[1.0,1.0],h=[1.0,1.0];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,u);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,h);s.m_nXSizeVisualBorder=Math.max(0.0,Math.min(1.0,h[0]-u[0]));s.m_nYSizeVisualBorder=Math.max(0.0,Math.min(1.0,h[1]-u[1]));if(d.initialStartPosition){var j=d.initialStartPosition.split(';');s.m_startPointLonLat=VBI.MathLib.DegToRad([parseFloat(j[0]),parseFloat(j[1])]);}if(d.initialZoom){s.m_startLOD=parseInt(d.initialZoom,10);}var S={zoom:false,move:false,fade:false};if(d.NavigationDisablement){if(d.NavigationDisablement.zoom){s.m_SuppressedNavigation.zoom=VBI.Types.string2bool(d.NavigationDisablement.zoom);}if(d.NavigationDisablement.move){s.m_SuppressedNavigation.move=VBI.Types.string2bool(d.NavigationDisablement.move);}}if(d.navControlVisible){s.m_bNavControlVisible=VBI.Types.string2bool(d.navControlVisible);}S.zoom=s.m_SuppressedNavigation.zoom;S.move=s.m_SuppressedNavigation.move;if(s.m_SuppressedNavigation.zoom&&s.m_SuppressedNavigation.move){s.m_bNavControlVisible=false;}else if(s.m_bNavControlVisible){if(d.SuppressedNavControlVisibility){if(!S.zoom&&d.SuppressedNavControlVisibility.zoom){S.zoom=VBI.Types.string2bool(d.SuppressedNavControlVisibility.zoom);}if(!S.move&&d.SuppressedNavControlVisibility.move){S.move=VBI.Types.string2bool(d.SuppressedNavControlVisibility.move);}if(d.SuppressedNavControlVisibility.fade){S.fade=VBI.Types.string2bool(d.SuppressedNavControlVisibility.fade);}}if(S.move&&S.zoom){s.m_bNavControlVisible=false;}}if(d.scaleVisible){s.m_bScaleVisible=VBI.Types.string2bool(d.scaleVisible);}if(s.m_Ctx.moThumbnail){s.m_SuppressedNavControlVisibility=S;}else if(s.m_bNavControlVisible){s.m_NavControl=new VBI.NavigationControl(S);}if(s.m_bScaleVisible&&!s.m_Ctx.moThumbnail){s.m_Scale=new VBI.Scale(s);}if(d.rectZoom&&VBI.Types.string2bool(d.rectZoom)){s.m_nInitialTrackingMode=VBI.InputModeRectZoom;}else if(d.rectSelect&&VBI.Types.string2bool(d.rectSelect)){s.m_nInitialTrackingMode=VBI.InputModeRectSelect;}else if(d.lassoSelect&&VBI.Types.string2bool(d.lassoSelect)){s.m_nInitialTrackingMode=VBI.InputModeRectSelect;}else{s.m_nInitialTrackingMode=VBI.InputModeDefault;}return false;};s.SetInputMode=function(v){if(VBI.m_bTrace){VBI.Trace("SetInputMode: "+this.m_nInputMode);}if(this.m_nInputMode==v){return;}switch(this.m_nInputMode){case VBI.InputModeTrackMap:s.SetInputModeTrackMap(false);break;default:break;}switch(v){case VBI.InputModeTrackMap:s.SetInputModeTrackMap(true);break;default:break;}this.m_nInputMode=v;};s.SetToolTip=function(a,v,b,d){var C=s.m_Canvas[s.m_nLabelIndex];if(a instanceof sap.ui.core.TooltipBase){if(v==true&&!a._getPopup().isOpen()){var o=(b)+" "+(d+20);a.setMyPosition(sap.ui.core.Popup.Dock.BeginTop);a.setAtPosition(sap.ui.core.Popup.Dock.BeginTop);a.setOffset(o);a.setCollision("fit fit");a.openPopup(a.getParent());C.title="";}else if(v==false&&a._getPopup().isOpen()){a.closePopup();}}else if(C.title!=a){C.title=a;}};s.SetCursor=function(a){var C=s.m_Canvas[s.m_nLabelIndex];if(C.style.cursor!=a){C.style.cursor=a;}};s.RenderAsync=function(f){if(f!=false){s.bForceRecluster=true;}if(!s.m_RenderRequestID){s.m_RenderRequestID=window.requestAnimationFrame(s.DoRender);}};s.DoRender=function(){s.Render(!s.bForceRecluster);};s.Render=function(a){s.m_RenderRequestID=0;s.bForceRecluster=false;if(s.m_Canvas.length){s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,true,a!=true,s.m_Canvas[0].m_nExactLOD);}};s.GoToInitialStart=function(){if(s.m_nMaxLodVisualBorder<Math.ceil(s.GetMinLOD())){s.m_nMaxLodVisualBorder=Math.ceil(s.GetMinLOD());}if(!s.ZoomToGeoPosition(s.m_startPointLonLat,s.m_startLOD,true,false,true)){var a=VBI.MathLib.RadToDeg(s.m_nBorderMinPoint);var b=VBI.MathLib.RadToDeg(s.m_nBorderMaxPoint);var l=[a[0],b[0]];var d=[a[1],b[1]];s.ZoomToMultiplePositions(l,d,1.1,true);}s.RenderAsync(true);};s.GetDistance=function(p,a){var G=s.GetPosFromVPPoint(p);var b=s.GetPosFromVPPoint(a);return VBI.MathLib.Distance(VBI.MathLib.DegToRad(G),VBI.MathLib.DegToRad(b));};s.GetTargetPointForDistance=function(d,p){var a=VBI.MathLib.DegToRad(s.GetPosFromVPPoint(p));var b=90*Math.PI/180;var l=Math.asin(Math.sin(a[1])*Math.cos(d/VBI.MathLib.earthradius)+Math.cos(a[1])*Math.sin(d/VBI.MathLib.earthradius)*Math.cos(b));var e=a[0]+Math.atan2(Math.sin(b)*Math.sin(d/VBI.MathLib.earthradius)*Math.cos(a[1]),Math.cos(d/VBI.MathLib.earthradius)-Math.sin(a[1])*Math.sin(l));return(s.GetPointFromGeo([e,l],false));};s.ZoomToMultiplePositions=function(l,d,e,S){var f=[];var g=[];if(l.length!=d.length){return;}var n;for(n=0;n<l.length;n++){var L=(parseFloat(l[n]));if(L<0){L+=360;}f.push(L);g.push(parseFloat(d[n]));}if(f.length!=g.length||!f.length){return;}f.sort(function(a,b){return a-b;});g.sort(function(a,b){return a-b;});var h=0,i=0,j,k;j=g[0];k=g[g.length-1];var o,p,q,r;p=f[f.length-1];for(n=0;n<f.length;n++){q=f[n];r=(q<p?(q+360-p):(q-p));if(o==undefined||r>o){o=r;h=(q<p?q+360:q);i=p;}p=q;}s.ZoomToArea(h,i,j,k,e?e:1.0,true,S);};s.ZoomToAreas=function(a,b){var x=Math.log(s.m_nDivWidth/(s.m_MapManager.m_tileWidth*s.m_nXSizeVisualBorder))*Math.LOG2E;var d=VBI.MathLib.GetSurroundingBox(a,0,x,s.CalculateYMinLod,s.m_bObjCanvasMode==1?0.5:0);s.ZoomToArea(d[0],d[1],d[2],d[3],b,true);var e=new Date().getTime();s.m_LastZoomArea=[e,"Areas",a,b];return true;};s.CalculateYMinLod=function(a,b){if(a==b){return 1000;}var u=[256,256];var d=[256,256];s.m_Proj.LonLatToUCS(VBI.MathLib.DegToRad([0,a]),u);s.m_Proj.LonLatToUCS(VBI.MathLib.DegToRad([0,b]),d);var l=s.m_nDivHeight/Math.abs(d[1]-u[1]);l=Math.log(l)*Math.LOG2E;return l;};s.ZoomToArea=function(a,b,d,e,f,r,S){var n=256,g=256;if(s.m_MapManager){n=s.m_MapManager.m_tileWidth;g=s.m_MapManager.m_tileHeight;}var h=s.m_nDivHeight?s.m_nDivHeight:g;var i=s.m_nDivWidth?s.m_nDivWidth:n;var I;var p;if(jQuery.type(f)=='array'){if(f.length>=4){var x=f[0]+f[2];var y=f[1]+f[3];if((x<i)&&(y<h)){if((f[0]!=f[2])||(f[1]!=f[3])){p=[(f[2]-f[0])/2,(f[3]-f[1])/2];}i-=x;h-=y;I=((x<0)||(y<0));}}}else{h*=f;i*=f;I=(f>1.0);}if(b<a){b+=360;}while(a>180){a-=360;}while(b>180){b-=360;}var j=[a,d];var k=[b,e];j=VBI.MathLib.DegToRad(j);k=VBI.MathLib.DegToRad(k);var u=[n,g];var l=[n,g];s.m_Proj.LonLatToUCS(j,u);s.m_Proj.LonLatToUCS(k,l);var o=u[0]+l[0]+(l[0]<=u[0])*n;var q=u[1]+l[1];var v=[o/n-1,q/g-1];var z=[1,1];s.m_Proj.UCSToLonLat(v,z);var w=14,A=14;if(e!=d){w=h/Math.abs(l[1]-u[1]);w=Math.log(w)*Math.LOG2E;}if(b!=a){A=i/Math.abs((l[0]-u[0])+(l[0]<=u[0])*n);A=Math.log(A)*Math.LOG2E;}var B=(I)?Math.max(A,w):Math.min(A,w);if(r){B=Math.floor(B);}s.ZoomToGeoPosition(z,B,false,false,S,p);if(B!=Math.floor(B)){setTimeout(function(){s.AnimateZoomToGeo(z,Math.floor(B),5);},20);}var C=new Date().getTime();s.m_LastZoomArea=[C,"Area",a,b,d,e,f];};s.getInfoForCluster=function(i,a){var p=JSON.parse(i);var b=s.m_Ctx.m_Clustering;return b.getInfoForCluster(p,a,s);};s.AdaptOtherCanvas=function(u,l,a,n){var b=a?1:0;var o=s.m_Canvas[1-b];if((a<=1)&&(a>=-2)){var d=l-o.m_nCurrentLOD;var e=Math.pow(2,-d);var p=Math.max(1,e);var f=o.getPixelLeft(),g=o.getPixelTop();var h=o.getPixelWidth(),i=o.getPixelHeight();var j=h/s.m_nWidthCanvas;var k=[(this.m_MapManager.m_tileWidth*o.m_nCurrentX+(s.m_nDivWidth/2-f)/j),(this.m_MapManager.m_tileHeight*o.m_nCurrentY+(s.m_nDivHeight/2-g)/j)];var q=[k[0]-e*u[0],k[1]-e*u[1]];if((Math.abs(q[0])<p*s.m_nWidthCanvas)&&(Math.abs(q[1])<p*s.m_nHeightCanvas)){var r=Math.pow(2,n);var v=r*(f-s.m_nDivWidth/2+j*q[0])+s.m_nDivWidth/2;var w=r*(g-s.m_nDivHeight/2+j*q[1])+s.m_nDivHeight/2;this.MoveCanvas(o,v,w,h*r,i*r);return b;}}return 0;};s.ZoomToGeoPosition=function(l,a,d,S,b,p){if((l.pixelShift!=undefined)&&(p==undefined)){p=l.pixelShift;}if(s.m_Canvas[s.m_nNonDomIndex].m_bCanvasValid){s.SwitchTmpCanvasToActive();}var x=0,y=0;var e=s.m_Canvas[0];var o=e.m_nExactLOD;var n=s.m_MapManager.m_tileWidth;var f=s.m_MapManager.m_tileHeight;var g=Math.min(Math.max(a,s.GetMinLOD()),s.GetMaxLOD());a=Math.floor(g);var h=Math.pow(2,g-a);var i=(1<<a);if(p!=undefined){x=p[0]/h;y=p[1]/h;}var u=[i*n,i*f];s.m_Proj.LonLatToUCS(l,u);var j=[u[0]-s.m_nDivWidth/2+x,u[1]-s.m_nDivHeight/2+y];var k=s.m_Proj.m_nUCSMin*i;var q=s.AdaptOtherCanvas(u,a,a-e.m_nCurrentLOD,g-e.m_nExactLOD);var r=Math.round(j[0]/n-s.m_nCanvasStdXPos-k);var v=Math.round(j[1]/f-s.m_nCanvasStdYPos);var w=-Math.floor(j[0]-(r+k)*n);var z=-Math.floor(j[1]-v*f);var A=Math.round(w+((h-1)*(w-s.m_nDivWidth/2)));var B=Math.round(z+((h-1)*(z-s.m_nDivHeight/2)));var C=Math.round(s.m_nWidthCanvas*h);var D=Math.round(s.m_nHeightCanvas*h);var E=[i,i];var F=[i,i];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,E);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,F);var G=D/s.m_nHeightCanvas;var H=f*(v-E[1])*G-B;var I=f*(v-F[1])*G+s.m_nDivHeight-B;var J;var T=true;if(H<-s.m_nMaxPixelBeyondPoles){B=f*(v-E[1])*G+s.m_nMaxPixelBeyondPoles;}else if(I>s.m_nMaxPixelBeyondPoles){B=f*(v-F[1])*G+s.m_nDivHeight-s.m_nMaxPixelBeyondPoles;}else{T=false;}if(T){if(d){return false;}var K=(B+(h-1)*s.m_nDivHeight/2)/h;J=-Math.round(s.m_nCanvasStdYPos+K/f);v+=J;B+=h*J*f;}if(s.m_bXBorderExists){var L=n*(r-E[0])*G-A;var M=n*(r-F[0])*G+s.m_nDivWidth-A;var N=true;if(L<-s.m_nMaxPixelBeyondPoles){A=n*(r-E[0])*G+s.m_nMaxPixelBeyondPoles;}else if(M>s.m_nMaxPixelBeyondPoles){A=n*(r-F[0])*G+s.m_nDivWidth-s.m_nMaxPixelBeyondPoles;}else{N=false;}if(N){if(d){return false;}var O=(A+(h-1)*s.m_nDivWidth/2)/h;J=-Math.round(s.m_nCanvasStdXPos+O/f);r+=J;A+=h*J*n;}}var P=((e.m_nCurrentX==r)&&(e.m_nCurrentY==v)&&(e.m_nCurrentLOD==a));if(P){s.MoveCanvas(e,A,B,C,D);e.m_nExactLOD=g;}else{s.InvalidateCanvas(s.m_Canvas[1]);if(q==0){var Q=e.getContext("2d");Q.clearRect(0,0,e.width,e.height);}var R=s.m_Canvas[q];s.MoveCanvas(R,A,B,C,D);s.m_MapManager.RequestTiles(R,s.m_MapLayerStack,r,v,s.m_nTilesX,s.m_nTilesY,0,0,0,0,a,false);R.m_nExactLOD=g;if(q==1){s.ToggleCanvas(s);}}if(b!=true){s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,!P,!P,g);}s.m_LastDefinedCenterPos=p?undefined:l;s.InternalOnMoveLayer(e,S);if(g!=o){s.InternalOnZoomLayer(s.m_Canvas[s.m_nOverlayIndex],S);}if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.AdjustScrollPoint(g);}return true;};s.SetMapLayerStack=function(n){var i=VBI.GetMapLayerStack(n);if(i==null){return;}if(s.m_Canvas[s.m_nNonDomIndex].m_bCanvasValid){s.SwitchTmpCanvasToActive();}s.m_MapLayerStack=i;var a=s.m_Canvas[0];s.m_MapManager.RequestTiles(a,s.m_MapLayerStack,a.m_nCurrentX,a.m_nCurrentY,s.m_nTilesX,s.m_nTilesY,0,0,0,0,a.m_nCurrentLOD,false);s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,true,true,a.m_nCurrentLOD);};s.ZoomToZoomlevel=function(l,n,S){var r=s.GetInternalDivClientRect();if((r.width!=s.m_nDivWidth)||(r.height!=s.m_nDivHeight)){s.resizeCanvas(0);}s.ZoomToGeoPosition(l,n,false,S);};s.GetMapLayerStack=function(){return s.m_MapLayerStack;};s.GetMinLOD=function(){var n=Math.max(s.m_nDivWidth/(s.m_MapManager.m_tileWidth*s.m_nXSizeVisualBorder),s.m_nDivHeight/(s.m_MapManager.m_tileHeight*s.m_nYSizeVisualBorder));var a=Math.log(n)*Math.LOG2E;var b=s.m_MapLayerStack;var d=Math.max(s.m_nMinLodVisualBorder-s.m_nOffsetMinLod,b?b.GetMinLOD():0);var e=Math.max(a,d);if(s.m_fMaxMinLODFraction!=undefined&&(e-Math.floor(e)>s.m_fMaxMinLODFraction)){return Math.ceil(e);}return e;};s.GetMinLODForWidth=function(w){var n=w/s.m_MapManager.m_tileWidth;var a=Math.log(n)*Math.LOG2E;var b=s.m_MapLayerStack;var d=Math.max(s.m_nMinLodVisualBorder,b?b.GetMinLOD():0)-s.m_nOffsetMinLod;return Math.max(a,d);};s.GetMaxLOD=function(){var a=s.m_MapLayerStack;return Math.min(a?a.GetMaxLOD():20,s.m_nMaxLodVisualBorder);};s.GetCurrentZoomlevel=function(){return s.m_Canvas[0].m_nExactLOD;};s.GetCenterPos=function(){if(s.m_LastDefinedCenterPos!=undefined){return s.m_LastDefinedCenterPos;}var a=s.getCanvas();var p=[s.m_nDivWidth/2-a.getPixelLeft(),s.m_nDivHeight/2-a.getPixelTop()];return(s.GetGeoFromPoint(p));};s.InternalRenderVisualObjects=function(a,d,b){var e=Date.now();var v=s.m_VOS;var V=v.length;var f;s.m_nNumOfScalingVOInst=0;VBI.Utilities.BackupFont(d);var g,h;if(b){if(s.m_nShadowIndex!=undefined){g=s.m_Canvas[s.m_nShadowIndex];h=g.getContext('2d');h.clearRect(0,0,g.width,g.height);}}s.BuildCacheDataObj();for(var n=0;n<V;++n){v[n].Init4Render();}for(var i=0;i<V;++i){var j=v[i];if(j.m_Label&&j.m_Label.length){for(var k=0;k<j.m_Label.length;++k){j.m_Label[k].clear();}}j.m_Label=[];if(b){var p=b.base[i];j.m_nPreDataIndex=i;f=j.Render(a,d,p);for(var l=p.clusterings.length;l--;){f+=j.Render(a,d,b.clust[p.clusterings[l].i],g,h,true);}}else{f=j.Render(a,d);}if(f!=undefined){s.m_nNumOfScalingVOInst+=f;}}this.InvalidateInvisibleHots();if(s.m_DesignVO){s.m_DesignVO.Render(a,d);}var o=s.m_Canvas[s.m_nLabelIndex];var q=o.getContext('2d');VBI.Utilities.BackupFont(q);q.clearRect(0,0,o.width,o.height);s.InternalRenderLabels(o,q);VBI.Utilities.RestoreFont(q);VBI.Utilities.RestoreFont(d);s.DestroyCacheDataObj();s.m_nLastRenderingTime=Date.now()-e;if(s.m_Ctx.moThumbnail){s.Copy2Thumbnail();}};s.TriggerReRenderTimer=function(n){window.clearInterval(s.m_ReRenderTimer);s.m_ReRenderTimer=window.setInterval(function(){window.clearInterval(s.m_ReRenderTimer);s.m_ReRenderTimer=null;if(!s.m_bNonIntPosStable){s.m_bNonIntPosStable=Date.now();}s.RenderAsync(true);if(s.m_bLineAnimationRunning){s.TriggerReRenderTimer(15);}},n);};s.AddThumbnailText=function(a,b){var x,y,d,e;var f=a.getContext('2d');switch(b.nFontPos){case 2:case 3:case 4:x=a.width;d="right";break;case 0:case 1:case 5:x=a.width/2;d="center";break;default:x=0;d="left";break;}switch(b.nFontPos){case 4:case 5:case 6:y=a.height;e="bottom";break;case 7:case 0:case 3:y=a.height/2;e="middle";break;default:y=0;e="top";break;}var C=VBI.Types.string2rgba(b.strCol);f.font=b.strFont;f.fillStyle=f.strokeStyle=VBI.Utilities.RgbToHex(C[0],C[1],C[2]);f.textAlign=d;f.textBaseline=e;f.fillText(b.strText,x,y);};s.GetOverlayPicture=function(M){var C;var r;var o=s.GetStretchFactor4Mode();var a=VBI.Utilities.CreateGeoSceneCanvas("temporarynondomlayer",s.m_nDivWidth,s.m_nDivHeight,0,2);var b=a.getContext("2d");if(M&2){C=s.m_Canvas[0];var d=s.GetCurrentZoomFactors();b.drawImage(C,-C.m_pixelLeft/d[0],-C.m_pixelTop/d[1],s.m_nDivWidth/d[0],s.m_nDivHeight/d[1],0,0,s.m_nDivWidth,s.m_nDivHeight);}C=s.m_Canvas[s.m_nOverlayIndex];b.drawImage(C,-C.m_pixelLeft/o[0],-C.m_pixelTop/o[1],s.m_nDivWidth/o[0],s.m_nDivHeight/o[1],0,0,s.m_nDivWidth,s.m_nDivHeight);if(M&1){C=s.m_Canvas[s.m_nLabelIndex];b.drawImage(C,-C.m_pixelLeft/o[0],-C.m_pixelTop/o[1],s.m_nDivWidth/o[0],s.m_nDivHeight/o[1],0,0,s.m_nDivWidth,s.m_nDivHeight);}try{r=a.toDataURL("png");}catch(e){VBI.Trace(e.message);return"";}return r;};s.Copy2Thumbnail=function(){var a=s.m_Canvas[s.m_nThumbnailIndex];var C=s.m_Canvas[0];var b=a.getContext("2d");var d=s.GetCurrentZoomFactors();var o=s.GetStretchFactor4Mode();b.clearRect(0,0,a.width,a.height);b.drawImage(C,-C.m_pixelLeft/d[0],-C.m_pixelTop/d[1],s.m_Ctx.moThumbnail.nOrgWidth/d[0],s.m_Ctx.moThumbnail.nOrgHeight/d[1],0,0,a.clientWidth,a.clientHeight);C=s.m_Canvas[s.m_nOverlayIndex];b.drawImage(C,-C.m_pixelLeft/o[0],-C.m_pixelTop/o[1],s.m_Ctx.moThumbnail.nOrgWidth/o[0],s.m_Ctx.moThumbnail.nOrgHeight/o[1],0,0,a.clientWidth,a.clientHeight);var e=s.m_Ctx.moThumbnail;if(e.strFont&&e.nFontPos!=undefined&&e.strText){s.AddThumbnailText(a,e);}};s.CopyCanvasAway=function(a,t){var l=t.getContext('2d');l.clearRect(0,0,t.width,t.height);l.drawImage(a,0,0,a.width,a.height);};s.UpdatePreData4Selected=function(V,I){var a=s.m_Ctx.m_Clustering;if((V!=undefined)&&a){a.VerifyCurrentSelection(s.m_VOS,s.m_PreassembledData,s.m_Ctx);a.AddSingle2Selected(V,s.m_VOS,I,s.m_PreassembledData,s.m_Ctx);}};s.UpdatePreData4SelArray=function(a){var b=s.m_Ctx.m_Clustering;if(b){b.VerifyCurrentSelection(s.m_VOS,s.m_PreassembledData,s.m_Ctx);b.AddMultiple2Selected(a,s.m_VOS,s.m_PreassembledData,s.m_Ctx);}};VBI.addSceneLabelFunctions(s);s.InvalidatePreassembledData=function(a,l){var h=s.m_HotItem.m_VO;var b;if(h!=undefined&&h.IsClusterable()){b=h.SwitchHotItemToStandard();}s.m_PreassembledData=undefined;if(s.m_nShadowIndex!=undefined){s.DisableShadowLayer();}return b;};s.DisableShadowLayer=function(){var a=s.m_Canvas[s.m_nShadowIndex];var d=a.getContext('2d');d.clearRect(0,0,a.width,a.height);s.clearCanvas(s.m_nShadowIndex);s.m_Canvas.splice(s.m_nShadowIndex,1);s.m_nShadowIndex=undefined;};s.SwitchCanvasSize=function(a,n,b){var d=[n,b];var e=d[0]*d[1]/1024;if(s.m_nCanvasMaxPixel<e){var f=Math.sqrt(e/s.m_nCanvasMaxPixel);d[0]=Math.floor(d[0]/f);d[1]=Math.floor(d[1]/f);s.m_bObjCanvasMode=2;}else{s.m_bObjCanvasMode=1;}a.width=s.m_Canvas[s.m_nLabelIndex].width=d[0];a.height=s.m_Canvas[s.m_nLabelIndex].height=d[1];if(s.m_nShadowIndex){s.m_Canvas[s.m_nShadowIndex].width=d[0];s.m_Canvas[s.m_nShadowIndex].height=d[1];}a.setPixelWidth(a.width);a.setPixelHeight(a.height);return d;};s.InternalRenderLayer=function(a,C,f,F,n,b){var d=s.m_Canvas[0];var l;var e=s.m_Ctx.m_Clustering;var g=((e!=undefined)&&e.m_Clusters.length);if((s.m_PreassembledData!=undefined)&&!g){l=s.InvalidatePreassembledData(e,d.m_nCurrentLOD);}if((f==false)&&(n!=undefined)){var h=Math.floor(n);if(n==s.m_nLastRenderLOD){return;}if((h==Math.floor(s.m_nLastRenderLOD))&&(n!=h&&(n>(s.GetMinLOD()+0.001)))){var i=Math.abs(n-s.m_nLastRenderLOD);if(i<s.m_nLastRenderingTime/s.m_nRenderTimeTarget){return;}}}s.m_OverlayImage=null;s.m_nLastRenderLOD=(n==undefined)?-1:n;var j,o=a.getPixelWidth();var k,p=a.getPixelHeight();if(s.m_bObjCanvasMode){var q=s.SwitchCanvasSize(a,o,p);s.m_StretchFactors=[o/q[0],p/q[1]];s.m_ZoomFactors=[q[0]/s.m_nWidthCanvas,q[1]/s.m_nHeightCanvas];j=o;k=p;}else{j=s.m_nWidthCanvas;k=s.m_nHeightCanvas;a.setPixelWidth(j);a.setPixelHeight(k);s.m_ZoomFactors=[1,1];s.m_StretchFactors=[o/s.m_nWidthCanvas,p/s.m_nHeightCanvas];}var r=a.getContext('2d');if(C){r.clearRect(0,0,a.width,a.height);a.setPixelWidth(o);a.setPixelHeight(p);return;}var S=false;if(g){this.SetLastHotItem(s.m_HotItem);var u=Date.now();s.m_PreassembledData=e.DoClustering(this,d.m_nCurrentLOD,d.m_nCurrentX,d.m_nCurrentY,s.m_nTilesX,s.m_nTilesY,s.m_VOS,s.m_Ctx,l,f,F,s.m_nDataVersion);this.CheckHotItem();if(s.m_PreassembledData.config.bNeedsShadowLayer&&(s.m_nShadowIndex==undefined)){s.m_nShadowIndex=s.m_Canvas.length;s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(s.m_TargetName+"-"+s.m_ID+"-shadow",j,k));s.InitializeCanvas(s.m_Canvas[s.m_nShadowIndex],s.m_Canvas[s.m_nOverlayIndex]);S=true;}if(!s.m_PreassembledData.config.bNeedsShadowLayer&&(s.m_nShadowIndex!=undefined)){s.DisableShadowLayer();}s.m_nLastClusteringTime=Date.now()-u;}r.clearRect(0,0,a.width,a.height);s.InternalRenderVisualObjects(a,r,s.m_PreassembledData);if(s.m_bObjCanvasMode!=1){a.setPixelWidth(o);a.setPixelHeight(p);}if(S){s.MoveCanvas2ObjectCanvas(s.m_Canvas[s.m_nShadowIndex]);}s.InternalOnRenderLayer(a);if(s.m_Scale){s.m_Scale.Update();}if(s.m_bSwitch2OldCanvasMode&&d.m_nExactLOD==Math.round(d.m_nExactLOD)){s.m_bSwitch2OldCanvasMode=undefined;s.m_bObjCanvasMode=0;VBI.Trace("Switching back to old object canvas rendering style due to performance issues ");}};s.InternalOnMoveLayer=function(a,S){s.m_Ctx.m_Windows.NotifySceneMove(this);var b;if((b=s.m_Ctx.m_Actions)&&(S!=true)){var d=b.findAction("CenterChanged",s,"Map");if(d){var e=s.m_Canvas[s.m_nOverlayIndex];var n=e.getPixelWidth();var f=e.getPixelHeight();var l=s.GetPosFromPoint([0,0]);var r=s.GetPosFromPoint([n,f]);if(!s.m_Proj.m_bIsIsogonal){var g=s.GetPosFromPoint([n,0]);var h=s.GetPosFromPoint([0,f]);l=[Math.min(l[0],h[0]),Math.min(l[1],g[1])];r=[Math.max(g[0],r[0]),Math.max(h[1],r[1])];}var i=s.GetInternalDivClientRect();var v=-e.getPixelLeft();var j=-e.getPixelTop();var k=s.GetPosFromPoint([v,j]);var o=s.GetPosFromPoint([v+i.width,j+i.height]);var p={level:s.GetCurrentZoomlevel().toString(),min:l[0].toString()+";"+l[1].toString()+";0",max:r[0].toString()+";"+r[1].toString()+";0",vpmin:k[0].toString()+";"+k[1].toString()+";0",vpmax:o[0].toString()+";"+o[1].toString()+";0"};s.m_Ctx.FireAction(d,s,this,null,p);}}this.m_EvtCont.fire("onMove",{canvas:a});s.m_Ctx.onMoveLayer(a);};s.InternalOnZoomLayer=function(a,b){s.m_Ctx.m_Windows.NotifySceneZoom(this);if(b!=true){var d=s.m_Ctx.m_Actions;if(d){var e=d.findAction("ZoomChanged",s,"Map");if(e){var f=s.m_Canvas[s.m_nOverlayIndex];var n=f.getPixelWidth();var g=f.getPixelHeight();var l=s.GetPosFromPoint([0,0]);var r=s.GetPosFromPoint([n,0]);var h=s.GetPosFromPoint([0,g]);var i=s.GetPosFromPoint([n,g]);var j=s.GetInternalDivClientRect();var v=-f.getPixelLeft();var k=-f.getPixelTop();var o=s.GetPosFromPoint([v,k]);var p=s.GetPosFromPoint([v+j.width,k+j.height]);var q={level:s.GetCurrentZoomlevel().toString(),min:Math.min(l[0],h[0]).toString()+";"+Math.min(l[1],r[1]).toString()+";0",max:Math.max(i[0],r[0]).toString()+";"+Math.max(h[1],i[1]).toString()+";0",vpmin:o[0].toString()+";"+o[1].toString()+";0",vpmax:p[0].toString()+";"+p[1].toString()+";0"};if(b!=undefined&&b!=false){q.x=b.x.toString()-j.left;q.y=b.y.toString()-j.top;}s.m_Ctx.FireAction(e,s,this,null,q);}}}this.m_EvtCont.fire("onZoom",{canvas:a});s.m_Ctx.onZoomLayer(a);};s.InternalOnRenderLayer=function(a){s.m_Ctx.onRenderLayer(a);if(s.GetHomeLocation){var o=a.getPixelWidth();var b=a.getPixelHeight();var l=[0,0];var h=s.GetHomeLocation();l[0]=h[0];l[1]=h[1];var x=s.GetPointFromGeo(l);a.setPixelWidth(s.m_nWidthCanvas);a.setPixelHeight(s.m_nHeightCanvas);var d=a.getContext('2d');d.clearRect(0,0,a.width,a.height);d.fillStyle='yellow';d.beginPath();d.arc(x[0],x[1],5,0,Math.PI*2,true);d.closePath();d.fill();var i=null;if(s.m_Ctx){i=s.m_Ctx.GetImage("dummy",s.RenderAsync.bind());}if(i){d.drawImage(i,x[0]-i.naturalWidth/2,x[1]-i.naturalHeight);}a.setPixelWidth(o);a.setPixelHeight(b);}};s.MoveObject=function(o,x,y,w,h){o.m_pixelLeft=Math.round(x);o.m_pixelTop=Math.round(y);o.style.left=o.m_pixelLeft.toString()+"px";o.style.top=o.m_pixelTop.toString()+"px";if(w!==undefined){o.m_pixelWidth=Math.round(w);o.style.width=o.m_pixelWidth.toString()+"px";}if(h!==undefined){o.m_pixelHeight=Math.round(h);o.style.height=o.m_pixelHeight.toString()+"px";}};s.InvalidateCanvas=function(a){var b=a.getContext("2d");b.fillStyle='white';b.clearRect(0,0,a.width,a.height);a.m_bInvalid=true;};s.MoveCanvas=function(a,x,y,w,h){s.MoveObject(s.m_Canvas[s.m_nOverlayIndex],x,y,w,h);s.MoveObject(s.m_Canvas[s.m_nLabelIndex],x,y,w,h);if(s.m_nShadowIndex!=undefined){s.MoveObject(s.m_Canvas[s.m_nShadowIndex],x,y,w,h);}s.MoveObject(a,x,y,w,h);};s.MoveOnlyThisCanvas=function(a,x,y,w,h){s.MoveObject(a,x,y,w,h);};s.MoveCanvas2ObjectCanvas=function(a){var b=s.m_Canvas[s.m_nOverlayIndex];s.MoveObject(a,b.m_pixelLeft,b.m_pixelTop,b.m_pixelWidth,b.m_pixelHeight);};s.MoveMap=function(d,a){if(VBI.m_bTrace){VBI.Trace("MoveMap"+" DX:"+d+" DY:"+a);}var b=s.m_Canvas[s.m_nNonDomIndex];var e=s.m_Canvas[0];var f=(b.m_bCanvasValid?b:e);var g=s.m_MapManager;var n=f.getPixelWidth();var h=f.getPixelHeight();var i=f.getPixelLeft()+d;var j=f.getPixelTop()+a;var k=g.m_tileWidth,l=g.m_tileHeight;var o=n/s.m_nTilesX;var p=h/s.m_nTilesY;var q=h/s.m_nHeightCanvas;var r=(1<<e.m_nCurrentLOD);var u=[r,r];var v=[r,r];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,u);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,v);if((a>0&&((l*q*(f.m_nCurrentY-u[1])-j)<-s.m_nMaxPixelBeyondPoles))||(a<0&&((l*q*(f.m_nCurrentY-v[1])+s.m_nDivHeight-j)>s.m_nMaxPixelBeyondPoles))){if(d==0){return;}a=0;j=f.getPixelTop();}if(s.m_bXBorderExists&&((d>0&&((k*q*(f.m_nCurrentX-u[0])-i)<-s.m_nMaxPixelBeyondPoles))||(d<0&&((k*q*(f.m_nCurrentX-v[0])+s.m_nDivWidth-i)>s.m_nMaxPixelBeyondPoles)))){if(a==0){return;}d=0;i=f.getPixelLeft();}var w=0;var x=0;var y;if((d>0)&&(y=i+s.m_nMapMoveXPreLoad)>0){w=Math.ceil(y/o);}else if((d<0)&&((y=s.m_nMapMoveXPreLoad+s.m_nDivWidth-(i+n))>0)){w=-Math.ceil(y/o);}var z=f.m_nCurrentX-w;if((a>0)&&(y=j+s.m_nMapMoveYPreLoad)>0){x=Math.ceil(y/p);}else if((a<0)&&(y=(s.m_nMapMoveYPreLoad+s.m_nDivHeight-(j+h)))>0){x=-Math.ceil(y/p);}var A=f.m_nCurrentY-x;var B=s.m_MapLayerStack;var S=B?B.m_bSingleBMP:false;if(w||x){var C=0,D=0;if(!s.m_Canvas[1].m_bInvalid){s.InvalidateCanvas(s.m_Canvas[1]);}s.MoveCanvas(e,e.getPixelLeft()+d,e.getPixelTop()+a);if(b.m_bCanvasValid){if(b.m_nTilesBefSwitch<b.m_nForceSwitchLimit){s.SwitchTmpCanvasToActive();}else{C=b.m_nOffsetX;D=b.m_nOffsetY;}}b.m_nTilesBefSwitch=(S||Math.abs(w)>=s.m_nTilesX||Math.abs(x)>=s.m_nTilesY)?1:(s.m_nTilesX-Math.abs(w))*(s.m_nTilesY-Math.abs(x));b.m_nForceSwitchLimit=Math.ceil(b.m_nTilesBefSwitch/2);b.m_nOffsetX=w+C;b.m_nOffsetY=x+D;s.MoveOnlyThisCanvas(b,i-w*o,j-x*p,n,h);var E=b.getContext("2d");E.clearRect(0,0,e.getPixelWidth(),e.getPixelHeight());if(g.RequestTiles(b,s.m_MapLayerStack,z,A,s.m_nTilesX,s.m_nTilesY,0,0,0,0,e.m_nCurrentLOD,false)){b.m_bCanvasValid=true;}else{s.SwitchTmpCanvasToActive();}}else{s.MoveCanvas(e,e.getPixelLeft()+d,e.getPixelTop()+a);s.MoveObject(s.m_Canvas[1],s.m_Canvas[1].getPixelLeft()+d,s.m_Canvas[1].getPixelTop()+a);if(b.m_bCanvasValid){s.MoveOnlyThisCanvas(b,i,j);}}var V=s.m_VOS;var R=false;for(var F=0,G=V.length;F<G;++F){if(V[F].m_Label.length>0&&V[F].CalculateLabelPos){R=true;break;}}if(R){var H=s.m_Canvas[s.m_nLabelIndex].getContext("2d");H.clearRect(0,0,s.m_Canvas[s.m_nLabelIndex].width,s.m_Canvas[s.m_nLabelIndex].height);VBI.Utilities.BackupFont(H);s.InternalRenderLabels(s.m_Canvas[s.m_nLabelIndex],H);VBI.Utilities.RestoreFont(H);}s.InternalOnMoveLayer(s.m_Canvas[s.m_nOverlayIndex]);s.m_LastDefinedCenterPos=undefined;};s.AdaptZoomFactor=function(a,f,x,y,b){var r={};r.bZoomNotPossible=true;var n=(1<<a.m_nCurrentLOD);if((a.m_nCurrentY<0)&&(y<-a.m_nCurrentY*(a.getPixelHeight()/s.m_nTilesY))){return r;}if(((a.m_nCurrentY+s.m_nTilesY)>n)&&(y>(n-a.m_nCurrentY)*(a.getPixelHeight()/s.m_nTilesY))){return r;}if(f<1){var d=Math.max((s.m_nDivWidth/(a.getPixelWidth()*s.m_nXSizeVisualBorder))*(s.m_nTilesX/n),(s.m_nDivHeight/(a.getPixelHeight()*s.m_nYSizeVisualBorder))*(s.m_nTilesY/n));if(f<d){if((d>=1)&&(f!=0)){return r;}f=d;}}var A=b&&(s.m_nZoomMode||(f==s.m_nLodFactorZoomIn)||(f==s.m_nLodFactorZoomOut));var e=a.m_nExactLOD+Math.log(f)*Math.LOG2E;var g=s.GetMinLOD();if((g!=Math.round(g))&&(f!=1.0)&&(a.m_nExactLOD<=Math.ceil(g))&&(Math.round(b*e)==Math.round(b*g))){A=false;}if(A&&Math.round(b*e)!=b*e){e=Math.round(b*e)/b;f=Math.pow(2,e-a.m_nExactLOD);}else if(e<g){e=g;f=Math.pow(2,e-a.m_nExactLOD);}r.factor=f;r.nNewLod=Math.floor(e);r.lodFallsOnInteger=(Math.round(e)==e);r.bZoomNotPossible=((e>s.GetMaxLOD())||(e<g));return r;};s.ZoomMap=function(f,x,y,a,S){s.m_bNonIntPosStable=false;if(s.m_Canvas[s.m_nNonDomIndex].m_bCanvasValid){s.SwitchTmpCanvasToActive();}var b=s.m_Canvas[0];var o=s.m_Canvas[1];var d=s.m_MapManager;var e=d.m_tileWidth,g=d.m_tileHeight;var n,h,i=0,j=0;var k=b.getPixelLeft(),l=b.getPixelTop();var p=b.getPixelWidth(),q=b.getPixelHeight();var r=o.getPixelWidth();var z=s.AdaptZoomFactor(b,f,x,y,a);if(z.bZoomNotPossible){return;}f=z.factor;var u=z.nNewLod;if(VBI.m_bTrace){VBI.Trace("Zoom by "+f+" to "+x+"/"+y);}var v=Math.round(p*f);var w=Math.round(v*b.height/b.width);var A=Math.round(k-((f-1)*x));var B=Math.round(l-((f-1)*y));if(f<1){var C=(1<<b.m_nCurrentLOD);var D=[C,C];var E=[C,C];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,D);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,E);var F=w/s.m_nHeightCanvas;var G=(b.m_nCurrentY-D[1])*g*F-B;if(G<-s.m_nMaxPixelBeyondPoles){B=Math.round(g*(b.m_nCurrentY-D[1])*F+s.m_nMaxPixelBeyondPoles);y=(l-B)/(f-1);}else{var H=g*(b.m_nCurrentY-E[1])*F+s.m_nDivHeight-B;if(H>s.m_nMaxPixelBeyondPoles){B=Math.round(g*(b.m_nCurrentY-E[1])*F+s.m_nDivHeight-s.m_nMaxPixelBeyondPoles);y=(l-B)/(f-1);}}if(s.m_bXBorderExists){var I=(b.m_nCurrentX-D[0])*e*F-A;if(I<-s.m_nMaxPixelBeyondPoles){A=Math.round(e*(b.m_nCurrentX-D[0])*F+s.m_nMaxPixelBeyondPoles);x=(k-A)/(f-1);}var J=(b.m_nCurrentX-E[0])*e*F+s.m_nDivWidth-A;if(J>s.m_nMaxPixelBeyondPoles){A=Math.round(e*(b.m_nCurrentX-E[0])*F+s.m_nDivWidth-s.m_nMaxPixelBeyondPoles);x=(k-A)/(f-1);}}}s.MoveCanvas(b,A,B,v,w);var K=v/s.m_nTilesX;var L=w/s.m_nTilesY;var R=false;if(u==b.m_nCurrentLOD){if(!o.m_bInvalid){var M=Math.round(r*f);var N=Math.round(o.getPixelHeight()*f);if((M<=s.m_nMaxCanvasDimension)&&(N<=s.m_nMaxCanvasDimension)){var O=o.getPixelLeft();var P=o.getPixelTop();var Q=Math.round(O-((f-1)*(x+k-O)));var T=Math.round(P-((f-1)*(y+l-P)));s.MoveObject(o,Q,T,Math.round(r*f),Math.round(o.getPixelHeight()*f));}else{s.InvalidateCanvas(s.m_Canvas[1]);}}b.m_nExactLOD=b.m_nCurrentLOD+Math.log(K/e)*Math.LOG2E;if(A>0||B>0||(A+v<s.m_nDivWidth)||(B+w<s.m_nDivHeight)){R=true;n=-Math.ceil(A/K);h=-Math.ceil(B/L);i=A+n*K;j=B+h*L;A=b.m_nCurrentX+n;B=b.m_nCurrentY+h;if(VBI.m_bTrace){VBI.Trace("run out viewport newTop="+B+" nTilesY="+h+" nPosY="+j+" yOffset="+y+"\n");}}}else{R=true;var U=Math.pow(2,b.m_nCurrentLOD-u);var V=q/s.m_nHeightCanvas;var W=x/V+(U*(s.m_nDivWidth/2-k-x));var X=y/V+(U*(s.m_nDivHeight/2-l-y));if(u>b.m_nCurrentLOD){n=Math.round(W/U/e-s.m_nTilesX/2);h=Math.round(X/U/g-s.m_nTilesY/2);i=Math.ceil(A+n*K*U);j=Math.ceil(B+h*L*U);}else{var Y=((b.m_nCurrentX%U)+U)%U;var Z=((b.m_nCurrentY%U)+U)%U;n=Math.round((W/e+Y)/U-s.m_nTilesX/2);h=Math.round((X/g+Z)/U-s.m_nTilesY/2);i=A+K*(n*U-Y);j=B+L*(h*U-Z);}A=Math.floor(b.m_nCurrentX/U+n);B=Math.floor(b.m_nCurrentY/U+h);v=z.lodFallsOnInteger?(e*s.m_nTilesX):Math.ceil(v*U);w=z.lodFallsOnInteger?(g*s.m_nTilesY):Math.ceil(w*U);}var $=u+Math.log(v/s.m_nWidthCanvas)*Math.LOG2E;if(R){o.m_nExactLOD=$;s.MoveCanvas(o,i,j,v,w);s.m_MapManager.RequestTiles(s.m_Canvas[1],s.m_MapLayerStack,A,B,s.m_nTilesX,s.m_nTilesY,0,0,0,0,u,true);b.m_Scene.ToggleCanvas(b.m_Scene);}s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,R,R,$);if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.AdjustScrollPoint($);}s.InternalOnMoveLayer(b,S);s.InternalOnZoomLayer(s.m_Canvas[s.m_nOverlayIndex],S);s.m_LastDefinedCenterPos=s.m_LastZoomArea=undefined;};s.ZoomOtherCanvas=function(o,a,f,x,y){var n=Math.round(o.getPixelLeft()-((f-1)*x));var b=Math.round(o.getPixelTop()-((f-1)*y));var d=Math.round(o.getPixelWidth()*f);var e=Math.round(o.getPixelHeight()*f);s.MoveObject(o,n,b,d,e);};s.AnimationStep=function(){var a=s.m_Canvas[0].m_nExactLOD;var r=s.m_Canvas[0].getBoundingClientRect();if(a!=s.AnimZoomTarget){var b=Math.min((Date.now()-s.AnimZoomTimestamp)/s.AnimZoomDuration,1);var f=Math.min(b*(2-b),1);var z=Math.pow(2,s.AnimZoomOrigin+(s.AnimZoomTarget-s.AnimZoomOrigin)*f)/Math.pow(2,a);s.ZoomMap(z,s.AnimZoomClientX-r.left,s.AnimZoomClientY-r.top,b<1?0:1,true);if(b<1){s.m_AnimZoomRequestID=window.requestAnimationFrame(s.AnimationStep);return;}}s.ZoomMap(1,s.AnimZoomClientX-r.left,s.AnimZoomClientY-r.top,1,true);s.InternalOnMoveLayer(s.m_Canvas[s.m_nOverlayIndex],s.AnimZoomClickCoords);s.InternalOnZoomLayer(s.m_Canvas[s.m_nOverlayIndex],s.AnimZoomClickCoords);s.m_AnimZoomRequestID=0;s.AnimZoomClientX=s.AnimZoomClientY=s.AnimZoomClickCoords=undefined;s.AnimZoomTimestamp=s.AnimZoomDuration=s.AnimZoomOrigin=s.AnimZoomTarget=undefined;};s.AnimateZoom=function(z,a,b,i,e){var d=((e!=undefined&&e.clientX!=undefined)?{x:e.clientX,y:e.clientY}:undefined);s.AnimZoomClientX=a;s.AnimZoomClientY=b;s.AnimZoomClickCoords=d;s.AnimZoomOrigin=s.m_Canvas[0].m_nExactLOD;s.AnimZoomTarget=Math.round(s.AnimZoomTarget?s.AnimZoomTarget:s.AnimZoomOrigin)+(z?1:-1);s.AnimZoomTimestamp=Date.now();s.AnimZoomDuration=Math.pow(Math.abs(s.AnimZoomTarget-s.AnimZoomOrigin),0.8)*300;if(s.m_AnimZoomRequestID){window.cancelAnimationFrame(s.m_AnimZoomRequestID);}s.m_AnimZoomRequestID=window.requestAnimationFrame(s.AnimationStep);};s.AnimationToGeoStep=function(a,l,n,b,d){if(--s.m_nAnimOpenTicks){s.ZoomToZoomlevel(l,n-(s.m_nAnimOpenTicks-1)*(n-b)/(s.m_nAnimTicks-1),true);var e=Date.now(),f=a;if(s.m_AnimTimestamp){var g=Math.max(0,e-s.m_AnimTimestamp);f=Math.max(10,2*a-g);}s.m_AnimTimestamp=e;s.m_AnimZoomTimer=window.setTimeout(function(){s.AnimationToGeoStep(a,l,n,b,d);},f);return;}s.InternalOnZoomLayer(s.m_Canvas[s.m_nOverlayIndex]);if(s.m_AnimZoomTimer){s.m_nAnimOpenTicks=s.m_nAnimationTicks=undefined;window.clearInterval(s.m_AnimZoomTimer);s.m_AnimZoomTimer=null;s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,false,false,s.m_Canvas[0].m_nExactLOD);}};s.AnimateZoomToGeo=function(l,G,i){var n=s.m_Canvas[0].m_nExactLOD;if(n==G){return;}s.m_bNonIntPosStable=false;var a=2*s.m_nTicksInALod;if(s.m_AnimZoomTimer){window.clearInterval(s.m_AnimZoomTimer);}s.m_nAnimTicks=2+Math.abs(Math.round((n-G)*a));s.m_nAnimOpenTicks=s.m_nAnimTicks;var b=n;var d=G;var e=i*a/s.m_nAnimTicks;s.m_AnimZoomTimer=window.setTimeout(function(){s.AnimationToGeoStep(e,l,d,b,a);},e);};s.PerFormMultiSelect=function(e,T){if(s.m_nInputMode!=VBI.InputModeLassoSelect&&s.m_nInputMode!=VBI.InputModeRectSelect){return;}var S,C;if((e.type.indexOf("touch")>=0)||(e.type.indexOf("pointer")>=0)){S=C=false;}else{C=e.ctrlKey;S=e.shiftKey;}var l=s.m_VOS.length;var a=false;var h=[],o=[];var n,b,d,f,g,v;var F=false;for(var i=0;i<l;++i){o[i]=[];h=[];if(s.m_nInputMode==VBI.InputModeLassoSelect&&!s.m_VOS[i].LassoSelect){continue;}if(s.m_nInputMode==VBI.InputModeLassoSelect){F=s.m_VOS[i].LassoSelect(T.m_PosMoves,h,o[i]);}else{F=s.m_VOS[i].RectSelect(T.selectionRect,h,o[i]);}if(F){v=s.m_VOS[i];if(!(g=v.m_DataSource)){continue;}if(!S&&!C&&g){if((d=g.GetCurrentNode(s.m_Ctx))){for(b=0;b<=1;b++){for(n=0;n<d.m_dataelements.length;++n){g.Select(n);if((f=g.GetIndexedElement(s.m_Ctx,n))){if(v.IsSelected(s.m_Ctx)){if(VBI.IndexOf(h,n)==-1){v.Select(f,s.m_Ctx,false);a=true;}}else if(VBI.IndexOf(h,n)!=-1){v.Select(f,s.m_Ctx,true);a=true;}}}}}}else if(S){for(n=0;n<h.length;n++){g.Select(h[n]);if((f=g.GetIndexedElement(s.m_Ctx,h[n]))){if(!v.IsSelected(s.m_Ctx)){v.Select(f,s.m_Ctx,true);a=true;}}}}else if(C){var j=[];for(n=0;n<h.length;n++){g.Select(h[n]);var k={};if(v.IsSelected(s.m_Ctx)){k.toSelect=false;}else{k.toSelect=true;}k.idx=n;j.push(k);}for(b=0;b<=1;b++){for(n=0;n<j.length;n++){g.Select(h[j[n]]);if((f=v.m_DataSource.GetIndexedElement(s.m_Ctx,h[j[n].idx]))){if(b==0&&j[n].toSelect){v.Select(f,s.m_Ctx,true);a=true;}if(b==1&&!j[n].toSelect){v.Select(f,s.m_Ctx,false);a=true;}}}}}}}if(s.m_PreassembledData&&o.length){s.UpdatePreData4SelArray(o);}var p;if(a&&(p=s.m_Ctx.m_Actions)){var q;if((q=p.findAction("Select",s,"General"))){s.m_Ctx.FireAction(q,s,"General",null,null);}}};s.endTrackingMode=function(){if(s.m_nInputMode==VBI.InputModeRectSelect||s.m_nInputMode==VBI.InputModeLassoSelect||s.m_nInputMode==VBI.InputModeRectZoom){s.m_DesignVO.ExitMode();}};s.GetViewport=function(){var z=s.GetStretchFactor4Mode();var r=s.GetInternalDivClientRect();var a=r.width/z[0];var b=r.height/z[1];var P=s.m_Canvas[0].getPixelLeft()/z[0];var d=s.m_Canvas[0].getPixelTop()/z[1];return[-P,-d,-P+a,-d+b];};s.IsTransparent=function(a,b){var C=s.m_Canvas[s.m_nOverlayIndex];if(!C){return false;}var d=C.getContext("2d");var r=C.getBoundingClientRect();var e=Date.now();var p=d.getImageData(Math.round(a-r.left),Math.round(b-r.top),1,1);if(s.m_bObjCanvasMode&&VBI.m_bIsMyChromeTest&&(C.width!=s.m_nlstWidth||C.height!=s.m_nlstHeight)){var f=Date.now()-e;s.m_nlstWidth=C.width;s.m_nlstHeight=C.height;if(f>40){s.m_nGetImageDataIncidents++;if(s.m_nGetImageDataIncidents>2||f>200){s.m_bSwitch2OldCanvasMode=true;}}}var g=p.data[3];return g?false:true;};s.GetCurrentZoomFactors=function(){return[s.m_StretchFactors[0]*s.m_ZoomFactors[0],s.m_StretchFactors[1]*s.m_ZoomFactors[1]];};s.GetStretchFactor4Mode=function(){return s.m_StretchFactors;};s.GetZoomFactor4Mode=function(){return s.m_ZoomFactors;};s.ToggleCanvas=function(s){var a=s.m_Canvas[0];s.m_Canvas[0]=s.m_Canvas[1];s.m_Canvas[1]=a;s.m_Canvas[0].className="vbi-geoscenecanvas vbi-map-inactive";s.m_MapsLayerDiv.insertBefore(s.m_Canvas[1],s.m_Canvas[0]);jQuery.sap.delayedCall(0,this,function(b){s.m_Canvas[0].className="vbi-geoscenecanvas vbi-map-active";});};VBI.addScenePositioningFunctions(s);s.getCanvas=function(){return s.m_Canvas[0];};s.SetEdgeTransition=function(a,e,b,o,d,n,f){a[e+9*o]=1;a[e+9*b]=f;a[e+9*d]=f;a[b+9*e]=f;a[d+9*e]=f;a[e+9*n]=f;a[n+9*e]=f;};s.SetCornerTransition=function(a,b,t,e){a[b+9*t]=e;a[t+9*b]=e;};s.BuildQuarterTransistionTable=function(){var r=[];var i;for(i=0;i<81;++i){r.push(0);}for(i=0;i<9;++i){r[i]=1;r[9*i]=1;}s.SetEdgeTransition(r,3,7,6,8,2,16);s.SetEdgeTransition(r,2,4,1,7,6,8);s.SetEdgeTransition(r,6,4,3,5,1,4);s.SetEdgeTransition(r,1,5,2,8,3,2);s.SetCornerTransition(r,4,8,18);s.SetCornerTransition(r,5,7,24);return r;};s.clearTimers=function(){if(s.m_AnimZoomTimer){window.clearInterval(s.m_AnimZoomTimer);s.m_AnimZoomTimer=null;}};s.clearCanvas=function(n){s.m_Canvas[n].m_Scene=null;s.m_Canvas[n]=null;};s.clearCanvases=function(){for(var n=0,a=s.m_Canvas.length;n<a;++n){s.clearCanvas(n);}s.m_Canvas=[];};s.Remove=function(){if(s.m_Div){s.SetInputMode(VBI.InputModeDefault);while(s.m_Div.firstChild){s.m_Div.removeChild(s.m_Div.firstChild);}s.m_Div.parentElement.removeChild(s.m_Div);s.m_Div=null;s.clearTimers();s.clearCanvases();}if(s.m_Target){while(s.m_Target.firstChild){s.m_Target.removeChild(s.m_Target.firstChild);}s.m_Target=null;}};s.AddCopyright=function(){if(!s.m_MapLayerStack){return;}if(!s.m_DivCopyright){var C=VBI.Utilities.CreateGeoSceneDivCSS(s.m_Target.id+"-copyright","vbi-copyright");C.m_VBIType="C";s.m_MapDecoDiv.appendChild(C);s.m_DivCopyright=C;}var a=s.m_MapLayerStack.GetCopyright();if(a){s.m_DivCopyright.innerHTML=a;}else{s.m_DivCopyright.style.paddingRight=0;s.m_DivCopyright.style.paddingLeft=0;}};s.ReAwake=function(){s.m_MapLayerStack=s.m_RefMapLayerStack;s.AddCopyright();s.resizeCanvas(0,true);};s.Awake=function(t,m,c){s.m_Target=VBI.Utilities.GetDOMElement(t);if(!s.m_Target){s.m_Target=VBI.Utilities.CreateDOMElement(t,"1px","1px");}if(s.m_Div){if(s.m_Div.parentNode==s.m_Target){return;}s.m_Target.appendChild(s.m_Div);if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.AttachEvents();}return;}s.m_TargetName=t;s.m_MapManager=typeof m!=='undefined'?m:VBI.MapManager;s.m_MapLayerStack=typeof c!=='undefined'?c:s.m_RefMapLayerStack;s.m_Div=VBI.Utilities.CreateGeoSceneDivCSS(t+"-geoscene-viewport","vbi-viewport");s.m_Target.appendChild(s.m_Div);s.m_MoveableLayer=VBI.Utilities.CreateGeoSceneDivCSS(t+"-geoscene-moveable-layer","vbi-moveable-layer");s.m_Div.appendChild(s.m_MoveableLayer);s.m_MapsLayerDiv=VBI.Utilities.CreateGeoSceneDivCSS(t+"-geoscene-mapslayer","vbi-map-layer");s.m_MoveableLayer.appendChild(s.m_MapsLayerDiv);
// add a layer div for map deco like scale and copyright
s.m_MapDecoDiv=VBI.Utilities.CreateGeoSceneDivCSS(t+"-geoscene-decolayer","vbi-structure-layer");s.m_Div.appendChild(s.m_MapDecoDiv);s.m_LegendLayerDiv=VBI.Utilities.CreateGeoSceneDivCSS(t+"-geoscene-legendlayer","vbi-structure-layer");s.m_Div.appendChild(s.m_LegendLayerDiv);s.m_WindowLayerDiv=VBI.Utilities.CreateGeoSceneDivCSS(t+"-geoscene-winlayer","vbi-structure-layer");if(VBI.m_bIsPhone){s.m_Div.appendChild(s.m_WindowLayerDiv);}else{s.m_MoveableLayer.appendChild(s.m_WindowLayerDiv);}s.DoAwake(t);};s.setProjection=function(){if(!s.m_RefMapLayerStack||!s.m_RefMapLayerStack.m_MapLayerArray||!s.m_RefMapLayerStack.m_MapLayerArray.length){return new VBI.MercatorProjection();}var l=s.m_RefMapLayerStack.m_MapLayerArray;var n=l[0].GetMapProvider().m_nProjection;for(var i=2;i<l.length;++i){if(l[i].GetMapProvider().m_nProjection!=n){if(VBI.m_bTrace){VBI.Trace("projection of layer "+i+" is inconsistent to base layer. Choosing projection of base layer");}}}switch(n){case 1:return new VBI.MercatorProjection();case 2:return new VBI.LinearProjection();case 3:return new VBI.ElliMercatorProjection();default:return new VBI.MercatorProjection();}};s.DoAwake=function(t){s.CalculateCanvasDimensions();s.CreateCanvases();
// append copyright
if(!s.m_Ctx.moThumbnail){s.AddCopyright();}var C=s.m_Canvas[s.m_nLabelIndex];if(s.m_Events){s.m_Events.clear();}s.m_Events=new VBI.SceneEvent(this,C.parentElement);if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.Awake(s,t);}if(s.m_bScaleVisible&&s.m_Scale){s.m_Scale.Awake(s,t);}var e=s.GetMinLOD();if(s.m_startLOD<e){var f=Math.ceil(e);s.m_startLOD=(f-e)<0.6?f:e;}if(s.m_bObjCanvasMode&&VBI.m_bIsMyChromeTest&&!s.m_bObjCanvasModeChecked){s.ChromePerformanceCheck(C);}s.GoToInitialStart();if(s.m_nInitialTrackingMode==VBI.InputModeRectSelect){new s.RectSelection();}else if(s.m_nInitialTrackingMode==VBI.InputModeLassoSelect){new s.LassoSelection();}else if(s.m_nInitialTrackingMode==VBI.InputModeRectZoom){new s.RectangularZoom();}s.m_nInitialTrackingMode=VBI.InputModeDefault;};s.ChromePerformanceCheck=function(C){var T=false;var d=[855,672,1512,240,801,901,1222,1392,1023,1024];var o=C.width,a=C.height;var b;var e=C.getContext("2d");C.width=C.height=1024;b=e.getImageData(500,500,1,1);var f,g=Date.now();for(var i=0;i<10;++i){f=Date.now();C.width=C.height=d[i];b=e.getImageData(500,500,1,1);if(Date.now()-f>60){T=true;break;}}C.width=o;C.height=a;if(T||(Date.now()-g>80)){s.m_bObjCanvasMode=0;var r=T?"("+(Date.now()-f)+" ms peak)":"("+((Date.now()-g)/10)+" ms average)";VBI.Trace("Setting Object Canvas Mode to Old Style due to Performance issues "+r);if(VBI.m_bTrace){VBI.Trace("Some Pixel was "+b);}}else{VBI.Trace("Chrome Performance Test passed with "+((Date.now()-g)/10)+" ms average time.");}s.m_bObjCanvasModeChecked=true;};s.CalcCanvasWidth=function(w,a){return(Math.floor(w/a+s.m_nCanvasXOversize))*a;};s.CalcCanvasHeight=function(h,a){return(Math.floor(h/a+s.m_nCanvasYOversize))*a;};s.GetInternalDivWidth=function(){if(this.m_Ctx.moThumbnail&&this.m_Ctx.moThumbnail.nOrgWidth){return this.m_Ctx.moThumbnail.nOrgWidth;}var r=s.m_Div.parentNode.getBoundingClientRect();return r.width?r.width:s.m_Div.clientWidth;};s.GetInternalDivHeight=function(){if(this.m_Ctx.moThumbnail&&this.m_Ctx.moThumbnail.nOrgHeight){return this.m_Ctx.moThumbnail.nOrgHeight;}var r=s.m_Div.parentNode.getBoundingClientRect();return r.height?r.height:s.m_Div.clientHeight;};s.CalculateCanvasDimensions=function(){var n=s.m_Target.offsetWidth;var a=s.m_MapManager;var d=s.GetInternalDivWidth();var b=s.GetInternalDivHeight();if((d==s.m_nDivWidth)&&(b==s.m_nDivHeight)){return;}s.m_nDivWidth=d;s.m_nDivHeight=b;s.m_nWidthCanvas=s.CalcCanvasWidth(d,a.m_tileWidth);s.m_nHeightCanvas=s.CalcCanvasHeight(b,a.m_tileHeight);s.m_nTilesX=s.m_nWidthCanvas/a.m_tileWidth;s.m_nTilesY=s.m_nHeightCanvas/a.m_tileHeight;a.m_requestTileWidth=a.m_tileWidth;a.m_requestTileHeight=a.m_tileHeight;var l=s.m_MapLayerStack;if(l.m_nMaxSquare&&l.m_MapLayerArray.length){var e=0;for(var i=0;i<l.m_MapLayerArray.length;++i){if(!i||(l.m_MapLayerArray[i].m_refMapProvider.m_nResolution<e)){e=parseInt(l.m_MapLayerArray[i].m_refMapProvider.m_nResolution,10);}}var f=l.m_nMaxSquare*e;if((s.m_nTilesX*a.m_tileWidth>f)||(s.m_nTilesY*a.m_tileHeight>f)){var g=Math.floor(f/Math.max(s.m_nTilesX,s.m_nTilesY));a.m_requestTileWidth=g;a.m_requestTileHeight=g;}}if(VBI.m_bTrace){VBI.Trace("Setting Canvas Size to ("+s.m_nWidthCanvas+","+s.m_nHeightCanvas+") on div with size ("+d+","+b+"). Dummy is "+n);}s.m_nMapMoveXPreLoad=Math.min(120,a.m_tileWidth*(s.m_nTilesX-1)-d);s.m_nMapMoveYPreLoad=Math.min(120,a.m_tileHeight*(s.m_nTilesY-1)-b);s.m_nCanvasStdXPos=(s.m_nWidthCanvas-s.m_nDivWidth)/a.m_tileWidth/2;s.m_nCanvasStdYPos=(s.m_nHeightCanvas-s.m_nDivHeight)/a.m_tileHeight/2;s.m_nMaxPixelBeyondPoles=0;};s.SwitchTmpCanvasToActive=function(){var d=s.m_Canvas[0],a=s.m_Canvas[s.m_nNonDomIndex];var b=d.getContext('2d');b.clearRect(0,0,d.getPixelWidth(),d.getPixelHeight());b.drawImage(s.m_Canvas[s.m_nNonDomIndex],0,0);s.MoveCanvas(d,d.getPixelLeft()-a.m_nOffsetX*d.getPixelWidth()/s.m_nTilesX,d.getPixelTop()-a.m_nOffsetY*d.getPixelHeight()/s.m_nTilesY);d.m_nCurrentX=a.m_nCurrentX;d.m_nCurrentY=a.m_nCurrentY;a.m_bCanvasValid=false;a.m_CanvasRedirect=d;a.m_CanvasRedirRequest=a.m_nRequest;a.m_nOffsetX=a.m_nOffsetY=0;a.m_nTilesBefSwitch=undefined;s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,true,true,d.m_nExactLOD);};s.InitializeCanvas=function(a,n){a.m_Scene=s;a.m_nCurrentLOD=2;a.m_nExactLOD=2;a.m_nCurrentX=undefined;a.m_nCurrentY=undefined;a.m_nAppliedRequest=0;a.m_bInvalid=false;if(a.m_bNotInDOM!=2){if(!n){s.m_MapsLayerDiv.appendChild(a);}else{s.m_MapsLayerDiv.insertBefore(a,n);}}};s.AttachCanvasesToDOM=function(){var a=s.m_Div.firstChild,n;while(a){var b=a.m_VBIType;n=a.nextSibling;if(b=="L"||b=="N"||b=="S"||b=="C"){s.m_Div.removeChild(a);}else if(a.m_VBIHidden){a.m_VBIHidden=false;a.style.display=a.m_VBIOrgDiplay;}a=n;}for(var i=0;i<s.m_Canvas.length;++i){if(s.m_Canvas[i].m_bNotInDOM!=2){s.m_Canvas[i].m_bNotInDOM=!s.m_Canvas[i].m_bNotInDOM;}}s.m_bThumbnailedCanvases=false;if(s.m_bNavControlVisible){s.m_NavControl=new VBI.NavigationControl(s.m_SuppressedNavControlVisibility);s.m_NavControl.AttachEvents();s.m_NavControl.Awake(s,s.m_TargetName);}if(s.m_bScaleVisible){s.m_Scale=new VBI.Scale(s);s.m_Scale.Awake(s,s.m_TargetName);}s.AddCopyright();};s.DetachCanvasesFromDOM=function(){for(var i=0;i<s.m_Canvas.length;++i){if(s.m_Canvas[i].m_bNotInDOM!=2){s.m_Canvas[i].m_bNotInDOM=!s.m_Canvas[i].m_bNotInDOM;}}var a=s.m_TargetName+"-"+s.m_ID+"-";var b=s.m_Div.firstChild,n;while(b){var d=b.m_VBIType;n=b.nextSibling;if(d=="L"||d=="N"||d=="S"||d=="C"){s.m_Div.removeChild(b);}else{b.m_VBIHidden=true;b.m_VBIOrgDiplay=b.style.display;b.style.display='none';}b=n;}var e;if(s.m_nThumbnailIndex){e=s.m_Canvas[s.m_nThumbnailIndex];e.width=s.m_Div.clientWidth;e.setPixelWidth(e.width);e.height=s.m_Div.clientHeight;e.setPixelHeight(e.height);}else{e=VBI.Utilities.CreateGeoSceneCanvas(a+"thumbnail",s.m_Div.clientWidth,s.m_Div.clientHeight,0,false);s.m_ThumbnaiEvents=new VBI.ThumbnailEvent(this,e);s.m_Canvas.push(e);s.m_nThumbnailIndex=s.m_Canvas.length-1;}s.m_Div.appendChild(e);s.m_bThumbnailedCanvases=true;if(s.m_NavControl){s.m_SuppressedNavControlVisibility=s.m_NavControl.suppressedVisibility;s.m_NavControl.clear();s.m_NavControl=null;}if(s.m_Scale){s.m_Scale.clear();s.m_Scale=null;}s.m_DivCopyright=null;};s.CreateCanvases=function(){var i=s.m_TargetName+"-"+s.m_ID+"-";var T=false;if(s.m_Ctx.moThumbnail){T=true;if(!s.m_Ctx.moThumbnail.bThumbnailed){s.m_Ctx.DoMinimize(s);}}s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"layer1",s.m_nWidthCanvas,s.m_nHeightCanvas,-1,T,"vbi-map-active"));s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"layer2",s.m_nWidthCanvas,s.m_nHeightCanvas,-1,T,"vbi-map-inactive"));s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"objectlayer",s.m_nWidthCanvas,s.m_nHeightCanvas,-1,T));s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"labellayer",s.m_nWidthCanvas,s.m_nHeightCanvas,0,T));s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"nondomlayer",s.m_nWidthCanvas,s.m_nHeightCanvas,-1,2));if(T){s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"thumbnail",s.m_Div.clientWidth,s.m_Div.clientHeight,0,false));s.m_nThumbnailIndex=s.m_Canvas.length-1;s.m_ThumbnaiEvents=new VBI.ThumbnailEvent(this,s.m_Canvas[s.m_nThumbnailIndex]);s.m_bThumbnailedCanvases=true;}s.m_nShadowIndex=undefined;for(var n=0;n<s.m_Canvas.length;++n){s.InitializeCanvas(s.m_Canvas[n]);}s.ToggleCanvas(s);if(s.m_Ctx.moThumbnail){s.DetachCanvasesFromDOM();}if(s.m_nCanvasMaxPixel==undefined){var e=8192;if(VBI.m_bIsMyChromeTest){e=32767;}if(VBI.m_bIsIDevice){e=5120;}if(VBI.m_bIsAndroid){e=16384;}s.m_nCanvasMaxPixel=s.CalculateCanvasMaxPixel(s.m_Canvas[2],e,16384);}};s.CalculateCanvasMaxPixel=function(a,b,d){var o=a.width;var e=a.height;if(b>d-100){return b;}var f=a.getContext("2d");if(s.CanvasSizeTest(a,f,Math.floor(b*1.05))){while(d-b>50){var g=Math.floor((b+d)/2);if(s.CanvasSizeTest(a,f,g)){b=g;}else{d=g;}}}a.width=o;a.height=e;return b;};s.CanvasSizeTest=function(a,b,v){a.height=1024;a.width=v;b.fillStyle="#050000";b.fillRect(v-1,1023,1,1);var p=b.getImageData(v-1,1023,1,1).data;return(p[0]+256*(p[1]+256*p[2])==5);};s.DivIsAlive=function(){var r=s.m_Div.getBoundingClientRect();return(r.width!=0||r.height!=0);};s.resizeCanvas=function(e,f,S){if(!s.DivIsAlive()){return;}if(!s.m_Canvas.length){s.DoAwake();return;}if(s.m_Canvas[s.m_nNonDomIndex].m_bCanvasValid){s.SwitchTmpCanvasToActive();}var a=s.m_MapManager;var b=s.m_Canvas[0];var o=s.m_nDivWidth;var d=s.m_nDivHeight;var g=s.GetMinLODForWidth(o);var h=b.getPixelWidth()/s.m_nWidthCanvas;s.m_nLastRenderLOD=-1;s.CalculateCanvasDimensions();if(s.m_Ctx.moThumbnail){if(!s.m_bThumbnailedCanvases){s.DetachCanvasesFromDOM();}else{var j=s.m_Canvas[s.m_nThumbnailIndex];j.width=s.m_Div.clientWidth;j.height=s.m_Div.clientHeight;j.setPixelWidth(s.m_Div.clientWidth);j.setPixelHeight(s.m_Div.clientHeight);}}else if(s.m_bThumbnailedCanvases){s.AttachCanvasesToDOM();}else if((!f)&&(s.m_nDivWidth==o)&&(s.m_nDivHeight==d)){return;}if(VBI.m_bTrace){VBI.Trace("Resizing ("+(o)+","+(d)+") to ("+(s.m_nDivWidth)+","+(s.m_nDivHeight)+")");}var k=b.m_nCurrentX;var l=b.m_nCurrentY;var n=b.m_nCurrentLOD;var p=b.getPixelLeft()+(s.m_nDivWidth-o)/2;var x=Math.round((-p/a.m_tileWidth-s.m_nCanvasStdXPos)/h);p+=h*x*a.m_tileWidth;var q=b.getPixelTop()+(s.m_nDivHeight-d)/2;var y=Math.round((-q/a.m_tileHeight-s.m_nCanvasStdYPos)/h);q+=h*y*a.m_tileHeight;for(var i=0;i<s.m_Canvas.length;++i){if(i!=s.m_nThumbnailIndex){if(s.m_Canvas[i].width!=s.m_nWidthCanvas){s.m_Canvas[i].width=s.m_nWidthCanvas;}if(s.m_Canvas[i].height!=s.m_nHeightCanvas){s.m_Canvas[i].height=s.m_nHeightCanvas;}}}s.InvalidateCanvas(s.m_Canvas[1]);s.MoveCanvas(b,p,q,h*s.m_nWidthCanvas,h*s.m_nHeightCanvas);s.m_MapManager.RequestTiles(b,s.m_MapLayerStack,k+x,l+y,s.m_nTilesX,s.m_nTilesY,0,0,0,0,n,false);var r=s.m_LastZoomArea;var A=false;if(r!=undefined){var u=new Date().getTime();if((u-r[0])<3000){switch(r[1]){case"Area":s.ZoomToArea(r[2],r[3],r[4],r[5],r[6]);A=true;break;case"Areas":s.ZoomToAreas(r[2],r[3]);A=true;break;default:break;}}}if(!A){var v=s.GetMinLOD();if(b.m_nExactLOD<v){s.ZoomMap(Math.pow(2,v-b.m_nExactLOD)*1.000001,s.m_nDivWidth/2-p,s.m_nDivHeight/2-q);}else if(!S&&b.m_nExactLOD!=Math.floor(b.m_nExactLOD)){s.AnimateZoomToGeo(s.GetCenterPos(),Math.floor(b.m_nExactLOD),5);}else{s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,true,true,b.m_nExactLOD);s.InternalOnMoveLayer(s.m_Canvas[s.m_nOverlayIndex]);}var w=s.GetMaxLOD();if(b.m_nExactLOD>w){s.ZoomMap(Math.pow(2,w-b.m_nExactLOD),s.m_nDivWidth/2-p,s.m_nDivHeight/2-q);}}if((f||(s.GetMinLOD()!=g))&&s.m_NavControl){s.m_NavControl.AdaptMinMaxLOD(s);}if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.AdjustScrollPoint(s.m_Canvas[0].m_nExactLOD);}s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false,false,true,s.m_Canvas[0].m_nExactLOD);};VBI.addSceneLassoTrackingFunctions(s);VBI.addSceneRectangularTrackingFunctions(s);s.m_TransitionTable=s.BuildQuarterTransistionTable();if(t){s.Awake(t,m,c);}return s;};
