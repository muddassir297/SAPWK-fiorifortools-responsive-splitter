/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library','sap/ui/base/ManagedObject','sap/ui/comp/personalization/Util','./Util','./Factory','sap/ui/comp/personalization/Controller'],function(q,C,M,P,U,F,a){"use strict";var b=M.extend("sap.ui.comp.navpopover.FlexHandler",{constructor:function(i,s){M.apply(this,arguments);},metadata:{properties:{initialSnapshot:{type:"object",defaultValue:null},snapshotOfUserLayer:{type:"object",defaultValue:null},snapshotOfLayersWithoutUser:{type:"object",defaultValue:null}}}});b.prototype.applySettings=function(s){this.setInitialSnapshot({});this.setSnapshotOfUserLayer({});this.setSnapshotOfLayersWithoutUser({});M.prototype.applySettings.apply(this,arguments);};b.prototype.init=function(){if(JSON.parse(q.sap.getUriParameters().get("sap-ui-smartlink"))){F.getService("FlexConnector").activateApplyChangeStatistics();}};b.prototype.updateAvailableActionOfSnapshot=function(l,L){if(!l||!L){return;}switch(L){case"USER":var s=this.getSnapshotOfUserLayer();s[l.getKey()]={key:l.getKey(),visible:l.getVisible()};this.setSnapshotOfUserLayer(s);break;default:var s=this.getSnapshotOfLayersWithoutUser();s[l.getKey()]={key:l.getKey(),visible:l.getVisible()};this.setSnapshotOfLayersWithoutUser(s);}};b.prototype.discardAvailableActionsOfSnapshot=function(l){if(l!=="USER"){return;}this.setSnapshotOfUserLayer({});};b.prototype.determineSnapshotOfAvailableActions=function(){var s=b._getUnion(this.getInitialSnapshot(),this.getSnapshotOfLayersWithoutUser());var S=b._getUnion(s,this.getSnapshotOfUserLayer());return S;};b.prototype.determineSnapshotOfChangedAvailableActions=function(){var s=this.determineSnapshotOfAvailableActions();var S=b._getUnionCondensed(this.getInitialSnapshot(),s);return S;};b.prototype.openSelectionDialog=function(n){var t=this;var s=q.extend(true,{},this.getSnapshotOfLayersWithoutUser());var S=q.extend(true,{},this.getSnapshotOfUserLayer());var o=b._getUnion(this.getInitialSnapshot(),s);var c=b._getUnion(o,S);return new Promise(function(r){var d=false;var e=new a({table:P.createSelectionWrapper(U.getStorableAvailableActions(b._convertSnapshotToObjectArray(o)),false),resetToInitialTableState:true,afterP13nModelDataChange:function(E){c=b._getUnion(c,E.getParameter("changeData").selection?b.convertArrayToSnapshot("columnKey",E.getParameter("changeData").selection.selectionItems):{});},dialogConfirmedReset:function(){d=true;},dialogAfterClose:function(){var B=d?o:b._getUnion(o,S);if(d){t._discardChanges(n).then(function(D){if(!D){t._revertChanges(n,s,S);return r();}t._saveChanges(n,B,c).then(function(f){if(!f){t._revertChanges(n,s,S);}return r();});});return;}t._saveChanges(n,B,c).then(function(f){if(!f){t._revertChanges(n,s,S);}return r();});}});e.setPersonalizationData({selection:{selectionItems:b._convertSnapshotToSelectionItems(S)}});e.openDialog({contentWidth:"25rem",contentHeight:"35rem",selection:{visible:true}});});};b.prototype._revertChanges=function(n,s,S){this.setSnapshotOfLayersWithoutUser(s);this.setSnapshotOfUserLayer(S);n._syncAvailableActions();};b.prototype._discardChanges=function(n){return new Promise(function(r){F.getService("FlexConnector").discardChangesForControl(n,true).then(function(){return r(true);})['catch'](function(e){q.sap.log.error("Changes could not be discarded in LRep: "+e.status);return r(false);});});};b.prototype._saveChanges=function(n,s,S){var o=b._getUnionCondensed(s,S);var c=b._convertSnapshotToChangeFormat(o);var m=c.filter(function(e){return e.visible===true;});var d=c.filter(function(e){return e.visible===false;});return new Promise(function(r){F.getService("FlexConnector").createAndSaveChangesForControl(m,d,n).then(function(){return r(true);})['catch'](function(e){q.sap.log.error("Changes could not be saved in LRep: "+e.status);return r(false);});});};b._getUnion=function(s,S){var o=q.extend(true,{},s);if(S){for(var k in o){if(S[k]&&S[k].visible!==undefined){o[k].visible=S[k].visible;}}}return o;};b._getUnionCondensed=function(s,S){var o=b._condense(s,S);var c=b._condense(S,s);var u=b._getUnion(o,c);return u;};b._condense=function(s,S){var o={};for(var k in s){if(!P.semanticEqual(s[k],S[k])){o[k]=s[k];}}return o;};b.convertArrayToSnapshot=function(k,i){var s={};i.forEach(function(I){if(I[k]===undefined){return;}s[I[k]]=I;});return s;};b._convertSnapshotToObjectArray=function(s){return Object.keys(s).map(function(k){return s[k];});};b._convertSnapshotToSelectionItems=function(s){return b._convertSnapshotToObjectArray(s).map(function(m){return{columnKey:m.key,visible:m.visible};});};b._convertSnapshotToChangeFormat=function(s){var m=b._convertSnapshotToObjectArray(s);return m.map(function(o){return{key:o.key,visible:o.visible};});};return b;},true);
