/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','./BaseController','sap/m/library','sap/ui/comp/library','./Util'],function(q,B,M,C,U){"use strict";var S=B.extend("sap.ui.comp.personalization.SelectionController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.selection);},metadata:{events:{afterSelectionModelDataChange:{}}}});S.prototype.onAfterSubmit=function(p){if(!p||!p.selection){return;}var d=this.getModel("$sapuicomppersonalizationBaseController").getData();d.persistentData.selection.selectionItems=[];p.selection.selectionItems.forEach(function(s){d.persistentData.selection.selectionItems.push({columnKey:s.getColumnKey(),visible:s.getSelected()});});this.getModel("$sapuicomppersonalizationBaseController").refresh();B.prototype.onAfterSubmit.apply(this,arguments);};S.prototype._getTable2Json=function(){var j=this.createPersistentStructure();var t=this.getTable();if(!t){return j;}var c=this.getColumnMap(true);for(var s in c){var o=c[s];j.selection.selectionItems.push({columnKey:s,text:o.getLabel(),visible:o.getSelected()});}return j;};S.prototype._getTable2JsonRestore=function(){return this._getTable2Json();};S.prototype.syncTable2TransientModel=function(){var i=[];var t=this.getTable();if(!t){return;}var c=this.getColumnMap(true);for(var s in c){var o=c[s];i.push({columnKey:s,text:o.getLabel(),href:o.getHref(),target:o.getTarget(),press:o.getPress()});}var I=this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.selection.items;if(q(i).not(I).length!==0||q(I).not(i).length!==0){this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.selection.items=i;}};S.prototype.getPanel=function(p){sap.ui.getCore().loadLibrary("sap.m");q.sap.require("sap/m/P13nSelectionPanel");q.sap.require("sap/m/P13nItem");q.sap.require("sap/m/P13nColumnsItem");var P=new sap.m.P13nSelectionPanel({titleLarge:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_SELECTION_TITLE"),items:{path:'$sapmP13nPanel>/transientData/selection/items',template:new sap.m.P13nItem({columnKey:'{$sapmP13nPanel>columnKey}',href:'{$sapmP13nPanel>href}',target:'{$sapmP13nPanel>target}',text:'{$sapmP13nPanel>text}',press:'{$sapmP13nPanel>press}'})},selectionItems:{path:"$sapmP13nPanel>/persistentData/selection/selectionItems",template:new sap.m.P13nSelectionItem({columnKey:"{$sapmP13nPanel>columnKey}",selected:"{$sapmP13nPanel>visible}"})},beforeNavigationTo:this.setModelFunction()});return P;};S.prototype.getChangeType=function(d,D){return this.getChangeData(d,D)?sap.ui.comp.personalization.ChangeType.ModelChanged:sap.ui.comp.personalization.ChangeType.Unchanged;};S.prototype.getChangeData=function(d,D){if(!D||!D.selection||!D.selection.selectionItems){return null;}var c={selection:U.copy(d.selection)};if(this._isSemanticEqual(d,D)){return null;}var t=[];c.selection.selectionItems.forEach(function(i,I){var o=U.getArrayElementByKey("columnKey",i.columnKey,D.selection.selectionItems);if(U.semanticEqual(i,o)){t.push(i);return;}for(var p in i){if(p==="columnKey"||!o){continue;}if(i[p]===o[p]){delete i[p];}}if(Object.keys(i).length<2){t.push(i);}});t.forEach(function(i){var I=U.getIndexByKey(c.selection.selectionItems,i.columnKey);c.selection.selectionItems.splice(I,1);});return c;};S.prototype.getUnionData=function(d,D){if(!D||!D.selection||!D.selection.selectionItems){return d.selection?{selection:U.copy(d.selection)}:null;}if(!d||!d.selection||!d.selection.selectionItems){return{selection:U.copy(D.selection)};}var u=this.createPersistentStructure();d.selection.selectionItems.forEach(function(s,i){var o=U.getArrayElementByKey("columnKey",s.columnKey,D.selection.selectionItems);if(o){if(o.visible!==undefined){s.visible=o.visible;}}u.selection.selectionItems.push(s);});return u;};S.prototype._isSemanticEqual=function(d,D){var s=function(a,b){if(a.visible===true&&(b.visible===false||b.visible===undefined)){return-1;}else if((a.visible===false||a.visible===undefined)&&b.visible===true){return 1;}else if(a.visible===true&&b.visible===true){return 0;}else if((a.visible===false||a.visible===undefined)&&(b.visible===false||b.visible===undefined)){if(a.columnKey<b.columnKey){return-1;}else if(a.columnKey>b.columnKey){return 1;}else{return 0;}}};var c=U.copy(d.selection.selectionItems).sort(s);var e=U.copy(D.selection.selectionItems).sort(s);return!c.some(function(o,i){if(!U.semanticEqual(o,e[i])){return true;}});};S.prototype.exit=function(){B.prototype.exit.apply(this,arguments);};return S;},true);
