/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/ManagedObject','sap/ui/rta/ui/ToolsMenu','sap/ui/dt/ElementUtil','sap/ui/dt/DesignTime','sap/ui/dt/OverlayRegistry','sap/ui/dt/Overlay','sap/ui/rta/command/Stack','sap/ui/rta/command/CommandFactory','sap/ui/rta/command/LREPSerializer','sap/ui/rta/plugin/Rename','sap/ui/rta/plugin/DragDrop','sap/ui/rta/plugin/RTAElementMover','sap/ui/rta/plugin/CutPaste','sap/ui/rta/plugin/Remove','sap/ui/rta/plugin/CreateContainer','sap/ui/rta/plugin/additionalElements/AdditionalElementsPlugin','sap/ui/rta/plugin/additionalElements/AddElementsDialog','sap/ui/rta/plugin/additionalElements/AdditionalElementsAnalyzer','sap/ui/rta/plugin/Combine','sap/ui/rta/plugin/Split','sap/ui/rta/plugin/Selection','sap/ui/rta/plugin/MultiSelection','sap/ui/rta/plugin/Settings','sap/ui/dt/plugin/ContextMenu','sap/ui/dt/plugin/TabHandling','sap/ui/fl/FlexControllerFactory','sap/ui/rta/ui/SettingsDialog','./Utils','sap/ui/fl/transport/Transports','sap/ui/fl/transport/TransportSelection','sap/ui/fl/Utils','sap/ui/fl/registry/Settings','sap/m/MessageBox','sap/m/MessageToast'],function(q,M,T,E,D,O,a,C,b,L,R,c,d,e,f,g,A,h,i,j,S,k,l,m,n,o,F,p,U,r,s,t,u,v,w){"use strict";var x=M.extend("sap.ui.rta.RuntimeAuthoring",{metadata:{library:"sap.ui.rta",associations:{"rootControl":{type:"sap.ui.core.Control"}},properties:{"customFieldUrl":"string","showCreateCustomField":"boolean","showToolbars":{type:"boolean",defaultValue:true},"triggeredFromDialog":{type:"boolean",defaultValue:false},"showSettingsDialog":{type:"boolean",defaultValue:true},"showWindowUnloadDialog":{type:"boolean",defaultValue:true},"commandStack":{type:"sap.ui.rta.command.Stack"},"plugins":{type:"any",defaultValue:{}}},events:{"start":{},"stop":{},"failed":{},"selectionChange":{parameters:{selection:{type:"sap.ui.dt.Overlay[]"}}},"undoRedoStackModified":{}}},_sAppTitle:null});x.prototype.getDefaultPlugins=function(){if(!this._mDefaultPlugins){this._mDefaultPlugins={};var X=new k();this._mDefaultPlugins["selection"]=X;var Y=new d();Y.setCommandFactory(b);var Z=new c({elementMover:Y,commandFactory:b}).attachElementModified(this._handleElementModified,this);Z.attachDragStarted(this._handleStopCutPaste,this);this._mDefaultPlugins["dragDrop"]=Z;var $=new e({elementMover:Y,commandFactory:b}).attachElementModified(this._handleElementModified,this);this._mDefaultPlugins["cutPaste"]=$;var _=new f({commandFactory:b}).attachElementModified(this._handleElementModified,this);this._mDefaultPlugins["remove"]=_;var a1=new A({commandFactory:b,analyzer:i,dialog:new h()}).attachElementModified(this._handleElementModified,this);this._mDefaultPlugins["additionalElements"]=a1;var b1=new R({commandFactory:b}).attachElementModified(this._handleElementModified,this);b1.attachEditable(this._handleStopCutPaste,this);this._mDefaultPlugins["rename"]=b1;var c1=new l({multiSelectionTypes:["sap.ui.comp.smartform.GroupElement"]});this._mDefaultPlugins["multiSelection"]=c1;var d1=new m({commandFactory:b}).attachElementModified(this._handleElementModified,this);this._mDefaultPlugins["settings"]=d1;var e1=new g({commandFactory:b}).attachElementModified(this._handleElementModified,this);this._mDefaultPlugins["createContainer"]=e1;var f1=new j({commandFactory:b}).attachElementModified(this._handleElementModified,this);this._mDefaultPlugins["combine"]=f1;var g1=new S({commandFactory:b}).attachElementModified(this._handleElementModified,this);this._mDefaultPlugins["split"]=g1;var h1=new n();this._mDefaultPlugins["contextMenu"]=h1;var i1=new o();this._mDefaultPlugins["tabHandling"]=i1;}return q.extend({},this._mDefaultPlugins);};x.prototype._destroyDefaultPlugins=function(X){for(var Y in this._mDefaultPlugins){var Z=this._mDefaultPlugins[Y];if(Z&&!Z.bIsDestroyed){if(!X||X[Y]!==Z){Z.destroy();}}}if(!X){this._mDefaultPlugins=null;}};x.prototype.init=function(){this._onCommandStackModified=this._onStackModified.bind(this);};x.prototype.setPlugins=function(X){if(this._oDesignTime){throw new Error('Cannot replace plugins: runtime authoring already started');}this.setProperty("plugins",X);};x.prototype.start=function(){this._aPopups=[];this._oTextResources=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");this._aSupportedControls=["sap.ui.comp.smartform.Group","sap.uxap.ObjectPageSection","sap.uxap.ObjectPageLayout"];if(!this._oDesignTime){this._oRootControl=sap.ui.getCore().byId(this.getRootControl());if(!this.getPlugins()||!Object.keys(this.getPlugins()).length){this.setPlugins(this.getDefaultPlugins());}this._destroyDefaultPlugins(this.getPlugins());if(this.getPlugins()["settings"]){this.getPlugins()["settings"].setCommandStack(this.getCommandStack());}this._buildContextMenu();var X=Object.keys(this.getPlugins());var Y=X.map(function($){return this.getPlugins()[$];},this);q.sap.measure.start("rta.dt.startup","Measurement of RTA: DesignTime start up");this._oDesignTime=new D({rootElements:[this._oRootControl],plugins:Y});q(a.getOverlayContainer()).addClass("sapUiRta");this._oDesignTime.attachSelectionChange(function($){this.fireSelectionChange({selection:$.getParameter("selection")});},this);this._oDesignTime.attachEventOnce("synced",function(){this.fireStart();q.sap.measure.end("rta.dt.startup","Measurement of RTA: DesignTime start up");},this);this._oDesignTime.attachEventOnce("syncFailed",function(){this.fireFailed();},this);this.$document=q(document);this.fnKeyDown=this._onKeyDown.bind(this);this.$document.on("keydown",this.fnKeyDown);}if(this.getShowToolbars()){this._createToolsMenu();var Z={"onAfterRendering":function(){this._oToolsMenu._oToolBar.focus();this._oToolsMenu._oToolBar.removeEventDelegate(Z,this);}};this._oToolsMenu._oToolBar.addEventDelegate(Z,this);this._oToolsMenu.show();}this._oldUnloadHandler=window.onbeforeunload;window.onbeforeunload=this._onUnload.bind(this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.renderers.fiori2.Renderer","appClosed",this._onAppClosed,this);};var y=function(X){var Y=X.message||X.status||X;var Z=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");q.sap.log.error("Failed to transfer runtime adaptation changes to layered repository",Y);q.sap.require("sap.m.MessageBox");var $=Z.getText("MSG_LREP_TRANSFER_ERROR")+"\n"+Z.getText("MSG_ERROR_REASON",Y);sap.m.MessageBox.error($);};x.prototype._onAppClosed=function(){this.stop(true);};x.prototype.setCommandStack=function(X){var Y=this.getProperty("commandStack");if(Y){Y.detachModified(this._onCommandStackModified);}if(this._oInternalCommandStack){this._oInternalCommandStack.destroy();delete this._oInternalCommandStack;}var Z=this.setProperty("commandStack",X);if(X){X.attachModified(this._onCommandStackModified);}if(this.getPlugins()&&this.getPlugins()["settings"]){this.getPlugins()["settings"].setCommandStack(X);}return Z;};x.prototype.getCommandStack=function(){var X=this.getProperty("commandStack");if(!X){X=new C();this._oInternalCommandStack=X;this.setCommandStack(X);}return X;};x.prototype._onStackModified=function(){var X=this.getCommandStack();var Y=X.canUndo();var Z=X.canRedo();var $=U.getUshellContainer();if(this.getShowToolbars()){this._oToolsMenu.adaptUndoRedoEnablement(Y,Z);this._oToolsMenu.adaptTransportEnablement(this._bChangesExist||Y);this._oToolsMenu.adaptRestoreEnablement(this._bChangesExist||Y);}this.fireUndoRedoStackModified();if($){if(Y){$.setDirtyFlag(true);}else{$.setDirtyFlag(false);}}};x.prototype._closeToolBars=function(){if(this.getShowToolbars()){return this._oToolsMenu.hide();}else{return Promise.resolve();}};x.prototype.getSelection=function(){if(this._oDesignTime){return this._oDesignTime.getSelection();}else{return[];}};x.prototype.stop=function(X){return((X)?Promise.resolve():this._serializeToLrep()).then(this._closeToolBars.bind(this)).then(function(){this.exit();this.fireStop();}.bind(this))['catch'](y);};x.prototype.restore=function(){this._onRestore();};x.prototype.transport=function(){this._onTransport();};x.prototype.undo=function(){this._onUndo();};x.prototype.redo=function(){this._onRedo();};x.prototype.canUndo=function(){return this.getCommandStack().canUndo();};x.prototype.canRedo=function(){return this.getCommandStack().canRedo();};x.prototype._onKeyDown=function(X){var Y=sap.ui.Device.os.macintosh?X.metaKey:X.ctrlKey;if((X.keyCode===q.sap.KeyCodes.Z)&&(X.shiftKey===false)&&(X.altKey===false)&&(Y===true)){this._onUndo();X.stopPropagation();}else if((X.keyCode===q.sap.KeyCodes.Z)&&(X.shiftKey===true)&&(X.altKey===false)&&(Y===true)){this._onRedo();X.stopPropagation();}};x.prototype.handleEvent=function(X){if(X.type==="keydown"){this._onKeyDown(X);}};x.prototype._onUnload=function(){var X=this.getCommandStack();var Y=X.canUndo()||X.canRedo();if(Y&&this.getShowWindowUnloadDialog()){var Z=this._oTextResources.getText("MSG_UNSAVED_CHANGES");return Z;}else{window.onbeforeunload=this._oldUnloadHandler;}};x.prototype._serializeToLrep=function(){var X=new L({commandStack:this.getCommandStack(),rootControl:this.getRootControl()});return X.saveCommands();};x.prototype._onUndo=function(){this._handleStopCutPaste();this.getCommandStack().undo();};x.prototype._onRedo=function(){this._handleStopCutPaste();this.getCommandStack().redo();};x.prototype._createToolsMenu=function(){if(!this._oToolsMenu){this._oToolsMenu=new T();this._oToolsMenu.setRootControl(this._oRootControl);this._oToolsMenu.createToolbar(this.getTriggeredFromDialog());this._checkChangesExist().then(function(X){this._bChangesExist=X;this._oToolsMenu.adaptTransportEnablement(X);this._oToolsMenu.adaptRestoreEnablement(X);}.bind(this));this._oToolsMenu.attachToolbarClose(this.stop.bind(this,false),this);this._oToolsMenu.attachTransport(this._onTransport,this);this._oToolsMenu.attachRestore(this._onRestore,this);this._oToolsMenu.attachUndo(this._onUndo,this);this._oToolsMenu.attachRedo(this._onRedo,this);}};x.prototype.exit=function(){if(this._oDesignTime){q(a.getOverlayContainer()).removeClass("sapUiRta");this._oDesignTime.destroy();this._oDesignTime=null;this.$document.off("keydown",this.fnKeyDown);this._destroyDefaultPlugins();this.setPlugins(null);}if(this._oToolsMenu){this._oToolsMenu.destroy();this._oToolsMenu=null;}this.setCommandStack(null);var X=U.getUshellContainer();if(X){X.setDirtyFlag(false);}window.onbeforeunload=this._oldUnloadHandler;};x.prototype._onTransport=function(){var X=function(Y){if(Y.message!=='createAndApply failed'){t.log.error("transport error"+Y);return this._showMessage(v.Icon.ERROR,"HEADER_TRANSPORT_ERROR","MSG_TRANSPORT_ERROR",Y);}}.bind(this);this._handleStopCutPaste();return this._openSelection().then(this._checkTransportInfo).then(function(Y){if(Y){var Z=F.createForControl(this._oRootControl);return this._serializeToLrep().then(function(){return Z.getComponentChanges().then(function($){if($.length>0){return this._createAndApplyChanges($,Z).then(this._transportAllLocalChanges.bind(this,Y,Z))['catch'](X);}}.bind(this));}.bind(this))['catch'](y);}}.bind(this));};x.prototype._checkTransportInfo=function(X){if(X&&X.transport&&X.packageName!=="$TMP"){return X;}else{return false;}};x.prototype._openSelection=function(){return new s().openTransportSelection(null,this._oRootControl);};x.prototype._createAndApplyChanges=function(X,Y){return Promise.resolve().then(function(){function Z($){return $&&$.selector&&$.selector.id;}X.filter(Z).forEach(function($){var _=sap.ui.getCore().byId($.selector.id);Y.createAndApplyChange($,_);});})['catch'](function(Z){t.log.error("Create and apply error: "+Z);return Z;}).then(function(Z){return Y.saveAll().then(function(){if(Z){throw Z;}});})['catch'](function(Z){t.log.error("Create and apply and/or save error: "+Z);return this._showMessage(v.Icon.ERROR,"HEADER_TRANSPORT_APPLYSAVE_ERROR","MSG_TRANSPORT_APPLYSAVE_ERROR",Z);}.bind(this));};x.prototype._deleteChanges=function(){var X=new s();var Y=F.createForControl(this._oRootControl);Y.getComponentChanges().then(function(Z){return u.getInstance(t.getComponentClassName(this._oRootControl)).then(function($){if(!$.isProductiveSystem()&&!$.hasMergeErrorOccured()){return X.setTransports(Z,this._oRootControl);}}.bind(this)).then(function(){return Y.discardChanges(Z);}).then(function(){return window.location.reload();});}.bind(this))["catch"](function(Z){return this._showMessage(v.Icon.ERROR,"HEADER_RESTORE_FAILED","MSG_RESTORE_FAILED",Z);}.bind(this));};x.prototype._showMessage=function(X,Y,Z,$){var _=this._oTextResources.getText(Z,$?[$.message||$]:undefined);var a1=this._oTextResources.getText(Y);return new Promise(function(b1){v.show(_,{icon:X,title:a1,onClose:b1});});};x.prototype._showMessageToast=function(X){var Y=this._oTextResources.getText(X);w.show(Y);};x.needsRestart=function(){var X=!!window.localStorage.getItem("sap.ui.rta.restart");return X;};x.enableRestart=function(){window.localStorage.setItem("sap.ui.rta.restart",true);};x.disableRestart=function(){window.localStorage.removeItem("sap.ui.rta.restart");};x.prototype._onRestore=function(){var X=this._oTextResources.getText("FORM_PERS_RESET_MESSAGE");var Y=this._oTextResources.getText("FORM_PERS_RESET_TITLE");var Z=function($){if($==="OK"){this.getCommandStack().removeAllCommands();x.enableRestart();this._deleteChanges();}}.bind(this);this._handleStopCutPaste();v.confirm(X,{icon:v.Icon.WARNING,title:Y,onClose:Z});};x.prototype._transportAllLocalChanges=function(X,Y){return Y.getComponentChanges().then(function(Z){var $=new r();var _=$._convertToChangeTransportData(Z);var a1={};a1.package=X.packageName;a1.transportId=X.transport;a1.changeIds=_;return $.makeChangesTransportable(a1).then(function(){Z.forEach(function(b1){if(b1.getPackage()==='$TMP'){var c1=b1.getDefinition();c1.packageName=X.packageName;b1.setResponse(c1);}});}).then(function(){this._showMessageToast("MSG_TRANSPORT_SUCCESS");}.bind(this));}.bind(this));};x.prototype._isEqualParentInfo=function(X,Y){var Z=!!X&&!!Y;if(Z&&(X.parent&&Y.parent)){Z=X.parent.getId()===Y.parent.getId();}if(Z&&(X.index||Y.index)){Z=X.index===Y.index;}if(Z&&(X.aggregation||Y.aggregation)){Z=X.aggregation===Y.aggregation;}return Z;};x.prototype._handleElementModified=function(X){this._handleStopCutPaste();var Y=X.getParameter("command");if(Y instanceof sap.ui.rta.command.BaseCommand){this.getCommandStack().pushAndExecute(Y);}};x.prototype._handleRemoveElement=function(X){this.getPlugins()["remove"].removeElement(X);};x.prototype._openSettingsDialog=function(X){var Y=(X.mParameters)?X.getParameter("selectedOverlays"):X;var Z=Y[0].getElementInstance();this._handleStopCutPaste();if(!this._oSettingsDialog){this._oSettingsDialog=new p();}this._oSettingsDialog.setCommandStack(this.getCommandStack());this._oSettingsDialog.open(Z);};var z=function(X){return this._oDesignTime.getSelection().length<2;};var I=function(X){return X.getMovable();};var B=function(X){return this.getPlugins()["remove"].isRemoveAvailable(X);};var G=function(X){return this.getPlugins()["remove"].isRemoveEnabled(X);};var H=function(X){return this.getPlugins()["rename"].isRenameAvailable(X);};var J=function(X){return this.getPlugins()["rename"].isRenameEnabled(X);};var K=function(X){return this.getPlugins()["settings"].isSettingsAvailable(X);};var N=function(X){return this.getPlugins()["settings"].isSettingsEnabled(X);};var P=function(X){return this.getPlugins()["combine"].isCombineAvailable(X);};var Q=function(X){return this.getPlugins()["combine"].isCombineEnabled(X);};var V=function(X){return this.getPlugins()["split"].isSplitAvailable(X);};var W=function(X){return this.getPlugins()["split"].isSplitEnabled(X);};x.prototype._buildContextMenu=function(){var X=this.getPlugins()["contextMenu"];if(!X){return;}var Y=this.getPlugins()["additionalElements"];var Z=this.getPlugins()["createContainer"];if(this.getPlugins()["rename"]){X.addMenuItem({id:"CTX_RENAME_LABEL",text:this._oTextResources.getText("CTX_RENAME"),handler:this._handleRename.bind(this),available:H.bind(this),enabled:function($){return(z.call(this,$)&&J.call(this,$));}.bind(this)});}if(Y){X.addMenuItem({id:"CTX_ADD_ELEMENTS_AS_SIBLING",text:Y.getContextMenuTitle.bind(Y,true),handler:Y.showAvailableElements.bind(Y,true),available:Y.isAvailable.bind(Y,true),enabled:function($){return z.call(this,$)&&Y.isEnabled(true,$);}.bind(this)});X.addMenuItem({id:"CTX_ADD_ELEMENTS_AS_CHILD",text:Y.getContextMenuTitle.bind(Y,false),handler:Y.showAvailableElements.bind(Y,false),available:Y.isAvailable.bind(Y,false),enabled:function($){return z.call(this,$)&&Y.isEnabled(false,$);}.bind(this)});}if(Z){X.addMenuItem({id:"CTX_CREATE_CHILD_CONTAINER",text:Z.getCreateContainerText.bind(Z,false),handler:this._createContainer.bind(this,false),available:Z.isCreateAvailable.bind(Z,false),enabled:Z.isCreateEnabled.bind(Z,false)});X.addMenuItem({id:"CTX_CREATE_SIBLING_CONTAINER",text:Z.getCreateContainerText.bind(Z,true),handler:this._createContainer.bind(this,true),available:Z.isCreateAvailable.bind(Z,true),enabled:Z.isCreateEnabled.bind(Z,true)});}if(this.getPlugins()["remove"]){X.addMenuItem({id:"CTX_REMOVE",text:this._oTextResources.getText("CTX_REMOVE"),handler:this._handleRemoveElement.bind(this),available:B.bind(this),enabled:G.bind(this)});}X.addMenuItem({id:"CTX_CUT",text:this._oTextResources.getText("CTX_CUT"),handler:this._handleCutElement.bind(this),available:I,enabled:function(){return this._oDesignTime.getSelection().length===1;}.bind(this)});if(this.getPlugins()["cutPaste"]){X.addMenuItem({id:"CTX_PASTE",text:this._oTextResources.getText("CTX_PASTE"),handler:this._handlePasteElement.bind(this),available:I,enabled:function($){return this.getPlugins()["cutPaste"].isElementPasteable($);}.bind(this)});}X.addMenuItem({id:"CTX_GROUP_FIELDS",text:this._oTextResources.getText("CTX_GROUP_FIELDS"),handler:this._handleCombineElements.bind(this),available:P.bind(this),enabled:Q.bind(this)});X.addMenuItem({id:"CTX_UNGROUP_FIELDS",text:this._oTextResources.getText("CTX_UNGROUP_FIELDS"),handler:this._handleSplitElements.bind(this),available:V.bind(this),enabled:W.bind(this)});if(this.getPlugins()["settings"]){X.addMenuItem({id:"CTX_SETTINGS",text:this._oTextResources.getText("CTX_SETTINGS"),handler:this._handleSettings.bind(this),available:K.bind(this),enabled:N.bind(this)});}};x.prototype._createContainer=function(X,Y){this._handleStopCutPaste();var Z=Y[0];var $=this.getPlugins()["createContainer"].handleCreate(X,Z);if(this.getPlugins()["rename"]){var _={"onAfterRendering":function(){setTimeout(function(){this.getPlugins()["rename"].startEdit($);}.bind(this),0);$.removeEventDelegate(_);}.bind(this)};$.addEventDelegate(_);}};x.prototype._handleRename=function(X){var Y=X[0];this.getPlugins()["rename"].startEdit(Y);};x.prototype._handleCutElement=function(X){var Y=X[0];this.getPlugins()["cutPaste"].cut(Y);};x.prototype._handlePasteElement=function(X){var Y=X[0];this.getPlugins()["cutPaste"].paste(Y);};x.prototype._handleStopCutPaste=function(){this.getPlugins()["cutPaste"].stopCutAndPaste();};x.prototype._handleCombineElements=function(){this._handleStopCutPaste();var X=this.getPlugins()["contextMenu"].getContextElement();this.getPlugins()["combine"].handleCombine(X);};x.prototype._handleSplitElements=function(){this._handleStopCutPaste();var X=this.getPlugins()["contextMenu"].getContextElement();this.getPlugins()["split"].handleSplit(X);};x.prototype._handleSettings=function(X){this.getPlugins()["settings"].handleSettings(X);};x.prototype._getSmartFormForElement=function(X){while(X&&!E.isInstanceOf(X,"sap.ui.comp.smartform.SmartForm")){X=X.getParent();}return X;};x.prototype._getApplicationTitle=function(){var X="";var Y=sap.ui.core.Component.getOwnerComponentFor(this._oRootControl);if(Y){X=Y.getMetadata().getManifestEntry("sap.app").title;}return X;};x.prototype._checkChangesExist=function(){var X=F.createForControl(this._oRootControl);if(X.getComponentName().length>0){return X.getComponentChanges().then(function(Y){return Y.length>0;});}else{return Promise.resolve(false);}};return x;},true);
