/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/ui/rta/plugin/Plugin",'sap/ui/dt/ElementUtil','sap/ui/dt/OverlayRegistry','sap/ui/rta/Utils','sap/ui/core/StashedControlSupport','sap/ui/dt/ElementDesignTimeMetadata'],function(q,P,E,O,U,S,a){"use strict";function _(u,v){var w,x;if(u){w=v.getParentElementOverlay();x=v.getPublicParentElementOverlay();}else{w=v;if(v.isInHiddenTree()){x=v.getPublicParentElementOverlay();}else{x=v;}}return{publicParentOverlay:x,parentOverlay:w,publicParent:x.getElementInstance(),parent:w.getElementInstance()};}function b(u,C){return C.sParentAggregationName;}function c(u,v){var I=E.getAggregation(u,v).filter(function(u){return u.getVisible&&!u.getVisible();});var w=S.getStashedControls(u.getId());return I.concat(w);}function d(u,v){var w=_(u,v);var R={};if(v.isInHiddenTree()){R=e(R,w);}else{R=f(R,w,u,v);}return R;}function e(R,u){var D=u.publicParentOverlay.getDesignTimeMetadata();var v=D&&D.getAggregationAction("reveal",u.parent)[0];if(v&&v.changeType&&sap.ui.rta.plugin.Plugin.prototype.hasChangeHandler(v.changeType,u.publicParent)){if(!v.getAggregationName){v.getAggregationName=b;}var G=v.getInvisibleElements||c;var I=G(u.publicParent,v.aggregation);R[v.aggregation]={reveal:{elements:I,types:I.reduce(function(w,x){w[x.getMetadata().getName()]={designTimeMetadata:D,action:v};return w;},{})}};}return R;}function f(R,u,v,w){var x=[u.parentOverlay];var y=m(u.parent,u.parentOverlay.getDesignTimeMetadata());if(y!==u.parent){x=E.findAllSiblingsInContainer(u.parent,y).map(function(B){return O.getOverlay(B);});}var z;if(v){z=[w.getElementInstance().sParentAggregationName];}z=u.parentOverlay.getAggregationOverlays().filter(function(B){return!B.getDesignTimeMetadata().isIgnored();}).map(function(B){return B.getAggregationName();});R=z.reduce(g.bind(null,x),{});return R;}function g(u,v,w){var I=u.reduce(function(x,y){return x.concat(c(y.getElementInstance(),w));},[]);var T=I.reduce(function(T,x){var y=x.getMetadata().getName();if(!T[y]){if(y==="sap.ui.core._StashedControl"){T[y]=n();}else{var z=O.getOverlay(x);if(z){var D=z.getDesignTimeMetadata();var R=D&&D.getAction("reveal",x);if(R&&R.changeType&&sap.ui.rta.plugin.Plugin.prototype.hasChangeHandler(R.changeType,x)){if(!R.getAggregationName){R.getAggregationName=b;}T[y]={designTimeMetadata:D,action:R};}}}}return T;},{});if(I.length>0&&Object.keys(T).length>0){v[w]={reveal:{elements:I,types:T}};}return v;}function h(u,v){var w=_(u,v);var D=w.publicParentOverlay.getDesignTimeMetadata();var x=D.getAggregationAction("addODataProperty",w.parent);var y=x.reduce(function(z,B){if(B.changeType&&sap.ui.rta.plugin.Plugin.prototype.hasChangeHandler(B.changeType,w.parent)){z[B.aggregation]={addODataProperty:{designTimeMetadata:D,action:B}};}return z;},{});return y;}function i(u,v){var R=d(u,v);var w=h(u,v);var x=q.extend(true,R,w);var y=Object.keys(x);if(y.length===0){return{};}else if(y.length>1){q.sap.log.error("reveal or addODataProperty action defined for more than 1 aggregation, that is not yet possible");}var z=y[0];x[z].aggregation=z;return x[z];}var j=true,k=false;function l(R,u,v,w){var N=[];var C;var x;if(u.addODataProperty){var y=u.aggregation;var D=u.addODataProperty.designTimeMetadata;C=D.getAggregationDescription(y,v);if(C){x=w?C.singular:C.plural;N.push(x);}}if(u.reveal){Object.keys(u.reveal.types).forEach(function(B){var F=u.reveal.types[B];C=F.designTimeMetadata.getName(v);if(C){x=w?C.singular:C.plural;N.push(x);}});}var z=N.reduce(function(B,F){if(B.indexOf(F)===-1){B.push(F);}return B;},[]);var T=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");if(z.length===1){x=z[0];}else{x=T.getText("MULTIPLE_CONTROL_NAME");}return T.getText(R,x);}function m(u,D){if(D.getData().getRelevantContainer){return D.getData().getRelevantContainer(u);}else{return u;}}function n(){return{designTimeMetadata:new a({data:{name:{singular:function(){return sap.uxap.i18nModel.getResourceBundle().getText("SECTION_CONTROL_NAME");},plural:function(){return sap.uxap.i18nModel.getResourceBundle().getText("SECTION_CONTROL_NAME_PLURAL");}},actions:{reveal:{changeType:"unstashControl",getAggregationName:b}}}}),action:{changeType:"unstashControl",getAggregationName:b}};}var A=P.extend("sap.ui.rta.plugin.additionalElements.AdditionalElementsPlugin",{metadata:{library:"sap.ui.rta",properties:{analyzer:"object",dialog:"object",commandFactory:"object"},associations:{},events:{}},getContextMenuTitle:function(u,v){var w=_(u,v);var x=i(u,v);return l("CTX_ADD_ELEMENTS",x,w.parent,j);},isAvailable:function(u,v){return this._isEditable(v,u);},isEnabled:function(u,v){if(u){if(!U.hasParentStableId(v)){return false;}}var w=i(u,v);if(w.reveal&&w.reveal.elements.length===0&&!w.addODataProperty){return false;}return true;},showAvailableElements:function(u,v){var w=v[0];var x=_(u,w);var y=u&&w.getElementInstance();var z=[];var B=i(u,w);if(B.reveal){z.push(this.getAnalyzer().enhanceInvisibleElements(x.publicParent,B.reveal));}if(B.addODataProperty){B.addODataProperty.relevantContainer=m(x.publicParent,B.addODataProperty.designTimeMetadata);z.push(this.getAnalyzer().getUnboundODataProperties(x.publicParent,B.addODataProperty));}if(B.aggregation){this._setDialogTitle(B,x.parent);}return Promise.resolve().then(function(){if(B.addODataProperty){return U.isServiceUpToDate(x.parent);}}).then(function(){if(B.addODataProperty){return U.isCustomFieldAvailable(x.parent);}}).then(function(C){if(C){this._oCurrentFieldExtInfo=C;this.getDialog().setCustomFieldEnabled(true);this.getDialog().detachEvent('openCustomField',this._onOpenCustomField,this);this.getDialog().attachEvent('openCustomField',null,this._onOpenCustomField,this);}}.bind(this)).then(p.bind(null,z)).then(function(C){this.getDialog().setElements(C);return this.getDialog().open().then(function(){this._createCommands(u,w,x,y,B.designTimeMetadata,B);}.bind(this)).catch(function(D){if(D instanceof Error){throw D;}});}.bind(this)).catch(function(C){if(C instanceof Error){throw C;}else{q.sap.log.info("Service not up to date, skipping add dialog","sap.ui.rta");}});},_setDialogTitle:function(u,v){var D=l("HEADER_ADDITIONAL_ELEMENTS",u,v,k);this.getDialog().setTitle(D);},_onOpenCustomField:function(u){var C=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var H=(C&&C.hrefForExternal({target:{semanticObject:"CustomField",action:"develop"},params:{businessContexts:this._oCurrentFieldExtInfo.BusinessContexts,serviceName:this._oCurrentFieldExtInfo.ServiceName,serviceVersion:this._oCurrentFieldExtInfo.ServiceVersion,entityType:this._oCurrentFieldExtInfo.EntityType}}));U.openNewWindow(H);},_createCommands:function(u,v,w,x,D,y){var z=this.getDialog().getSelectedElements();if(z.length>0){var C=this.getCommandFactory().getCommandFor(w.parent,"composite");z.forEach(function(B){var F;switch(B.type){case"invisible":F=this._createRevealCommandForInvisible(B,y,w,x);C.addCommand(F);F=this._createMoveCommandForInvisible(B,y,w,x);if(F){C.addCommand(F);}else{q.sap.log.warning("No move action configured for "+w.publicParent.getMetadata().getName()+", aggregation: "+y.aggregation,"sap.ui.rta");}break;case"odata":F=this._createCommandsForOData(B,y,w,x);C.addCommand(F);break;default:}},this);this.fireElementModified({"command":C});}},_createCommandsForOData:function(u,v,w,x){var y=v.addODataProperty.designTimeMetadata;var z=y.createAggregationDesignTimeMetadata(v.aggregation);var B=U.getIndex(w.parent,x,v.aggregation,z.getData().getIndex);return this.getCommandFactory().getCommandFor(w.publicParent,"addODataProperty",{newControlId:U.createFieldLabelId(w.publicParent,u.entityType,u.bindingPath),index:B,label:u.label,bindingString:u.bindingPath},y);},_createRevealCommandForInvisible:function(u,v,w,x){var R=u.element;var T=R.getMetadata().getName();var y=v.reveal.types[T];var D=y.designTimeMetadata;if(w.publicParent!=w.parent){var z=D.createAggregationDesignTimeMetadata(v.aggregation);return this.getCommandFactory().getCommandFor(w.publicParent,"reveal",{revealedElementId:R.getId(),hiddenParent:w.parent},z);}else{return this.getCommandFactory().getCommandFor(R,"reveal",{},D);}},_createMoveCommandForInvisible:function(u,v,w,x){var R=u.element;var T=R.getMetadata().getName();var y=v.reveal.types[T];var z=y.action.getAggregationName(w.parent,R);var B=r(R,w);var C=w.parent;var D=U.getIndex(w.parent,x,z);var F=U.getIndex(B,R,z)-1;D=s(B,C,F,D);var G;if(D!==F||w.parent!==R.getParent()){var H=w.publicParentOverlay.getDesignTimeMetadata();G=this.getCommandFactory().getCommandFor(w.publicParent,"move",{movedElements:[{element:R,sourceIndex:F,targetIndex:D}],source:{publicParent:w.publicParent,publicAggregation:v.aggregation,parent:B,aggregation:z},target:{publicParent:w.publicParent,publicAggregation:v.aggregation,parent:C,aggregation:z}},H);}return G;},_isEditable:function(u,v){if(v===undefined||v===null){return o.call(this,u,true)||o.call(this,u,false);}else{return o.call(this,u,v);}}});function o(u,v){var w=false;var x=U.getPublicParentDesigntimeMetadata(u);if(!x){return false;}var y=i(v,u);if(y.addODataProperty){var z=y.addODataProperty.action;w=z&&z.aggregation===u.getPublicParentAggregationOverlay().getAggregationName();}if(!w&&y.reveal){w=true;}if(!w&&!v){w=t(u);}if(!w&&v){w=this.checkAggregations(u,u.getPublicParentAggregationOverlay(),"addODataProperty");}if(!w&&!v){w=this.checkAggregationsOnSelf(u,"addODataProperty");}if(w){return this.hasStableId(u);}else{return false;}}function p(u){return Promise.all(u).then(function(v){var w=v[0]||[];if(w&&v[1]){w=w.concat(v[1]);}return w;});}function r(R,u){var v=R.getParent();if(!v&&R.sParentId){v=sap.ui.getCore().byId(R.sParentId);}else if(!v){v=u.parent;}return v;}function s(u,T,v,w){if(u===T&&v<w&&v>-1){return w-1;}return w;}function t(u){var R=d(false,u);return!!R&&Object.keys(R).length>0;}return A;});
