sap.ui.define(["jquery.sap.global","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/Panel","sap/m/List","sap/m/ListItemBase","sap/m/StandardListItem","sap/m/InputListItem","sap/m/Button","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/Label","sap/m/MessageToast","sap/ui/support/supportRules/WindowCommunicationBus","sap/ui/support/supportRules/ui/models/SharedModel","sap/ui/support/supportRules/RuleSerializer"],function($,Controller,JSONModel,Panel,List,ListItemBase,StandardListItem,InputListItem,Button,Toolbar,ToolbarSpacer,Label,MessageToast,CommunicationBus,SharedModel,RuleSerializer){"use strict";return Controller.extend("sap.ui.support.supportRules.ui.controllers.Analysis",{onInit:function(){this.model=SharedModel;this.setCommunicationSubscriptions();CommunicationBus.publish("analysisInit");this.hackListItemBase();this.getView().setModel(this.model);},setCommunicationSubscriptions:function(){CommunicationBus.subscribe("updatesupportRules",this.updatesupportRules,this);CommunicationBus.subscribe("verifyRuleCreateResult",function(d){var r=d.result,n=RuleSerializer.deserialize(d.newRule,true);if(r=="success"){this.model.getProperty("/libraries").forEach(function(b){if(b.title=="temporary"){b.rules.push(n);}});var e=this.model.getProperty("/newEmptyRule");this.model.setProperty("/newRule",jQuery.extend(true,{},e));this.goToRuleProperties();this.createRulesUI();var l=this.getView().byId("ruleSetContainer").getContent().length-1;var a=this.getView().byId("ruleSetContainer").getContent()[l];a.setExpanded(true);this.model.setProperty("/selectedRule",n);}else{MessageToast.show("Add rule failed because: "+r);}},this);CommunicationBus.subscribe("verifyRuleUpdateResult",function(d){var r=d.result,u=RuleSerializer.deserialize(d.updateRule,true);if(r==="success"){var a=this.model.getProperty("/editRuleSource");var l=this.model.getProperty('/libraries');l.forEach(function(b,c){if(b.title==='temporary'){b.rules.forEach(function(e,f){if(e.id===a.id){b.rules[f]=u;}});}});this.model.checkUpdate(true);this.model.setProperty('/selectedRule',u);this.goToRuleProperties();}else{MessageToast.show("Update rule failed because: "+r);}},this);},createNewRulePress:function(e){var i=e.getParameter("item"),a=i.getText();if(a==='New Rule'){var b=this.model.getProperty("/newEmptyRule");this.model.setProperty("/newRule",jQuery.extend(true,{},b));this.goToCreateRule();}else{var s=jQuery.extend(true,{},this.model.getProperty("/selectedRule"));this.model.setProperty("/newRule",s);this.model.checkUpdate(true,false);this.goToCreateRule();}},goToRuleProperties:function(){var n=this.getView().byId("rulesNavContainer");n.to(this.getView().byId("rulesDisplayPage"),"show");},hackListItemBase:function(){var t=this,o=ListItemBase.prototype.ontap,a=ListItemBase.prototype.updateSelectedDOM,b=ListItemBase.prototype.onAfterRendering;ListItemBase.prototype.onAfterRendering=function(){b.apply(this,arguments);if(this.getParent().getMode()==="MultiSelect"){this.$().removeClass("sapMLIBSelected");}};ListItemBase.prototype.ontap=function(e){if(this.getParent().getMode()!=="MultiSelect"){o.call(this,e);return;}if($(e.target).hasClass("sapMCbBg")||$(e.target).hasClass("sapMCb")){o.call(this,e);}else{t.model.setProperty("/selectedRuleStringify","");t.markLIBAsSelected(this);var s=this.getBindingContext().getObject();t.model.setProperty("/selectedRule",s);t.model.setProperty("/selectedRuleStringify",t.createRuleString(s));}};ListItemBase.prototype.updateSelectedDOM=function(s,T){a.call(this,s,T);if(this.getParent().getMode()==="MultiSelect"){T.removeClass("sapMLIBSelected");}};},createRuleString:function(r){var s="{\n",c=0,k=Object.keys(r).length;for(var a in r){var v=r[a];c++;s+="\t";s+=a+": ";if(a==="check"){s+=v.split("\n").join("\n\t");}else{s+=JSON.stringify(v);}if(c<k){s+=",";}s+="\n";}s+="}";return s;},markLIBAsSelected:function(l){if(!l){var s=this.model.getProperty("/selectedRule/title");this.getView().byId("ruleSetContainer").getContent().forEach(function(a){a.getContent()[0].getItems().forEach(function(b){if(b.getLabel()===s){l=b;}});});}this.getView().$().find(".sapMLIB").removeClass("sapMLIBSelected");l.$().addClass("sapMLIBSelected");},onAfterNavigate:function(e){var t=e.getParameter("to"),a=this;if(t===this.getView().byId("rulesDisplayPage")){setTimeout(function(){a.markLIBAsSelected();},250);}},selectAll:function(l){var t=this;this.visitAllRules(function(r,a,b){if(l===b){t.model.setProperty("/libraries/"+b+"/rules/"+a+"/selected",true);}});},deselectAll:function(l){var t=this;this.visitAllRules(function(r,a,b){if(l===b){t.model.setProperty("/libraries/"+b+"/rules/"+a+"/selected",false);}});},updateRule:function(){var o=this.model.getProperty("/editRuleSource/id"),u=this.model.getProperty("/editRule");if(this.checkFunctionString(u.check)){CommunicationBus.publish("verifyUpdateRule",{oldId:o,updateObj:RuleSerializer.serialize(u)});}},updatesupportRules:function(d){d=RuleSerializer.deserialize(d);var l=[],t=this;for(var i in d){var r=[],a=d[i].ruleset._mRules;for(var j in a){var b=a[j];b.libName=i;b.selected=true;r.push(b);}l.push({title:i,type:"library",rules:r});}var f=l[0].rules[0];t.model.setProperty("/selectedRuleStringify","");t.model.setProperty("/selectedRule",f);t.model.setProperty("/selectedRuleStringify",t.createRuleString(f));t.model.setProperty("/libraries",l);t.createRulesUI();var p=t.getView().byId("ruleSetContainer").getContent()[0];p.setExpanded(true);},createRulesUI:function(){var l=this.model.getProperty("/libraries"),r=0,t=this,v=this.getView().byId("ruleSetContainer");v.getContent().forEach(function(c,a){v.removeContent(c);});l.forEach(function(a,b){var c=a.title==="temporary"?new sap.m.Button({icon:"sap-icon://edit",press:function(E){var s=this.getParent().getBindingContext().getObject();t.model.setProperty("/editRuleSource",s);t.model.setProperty("/editRule",jQuery.extend(true,{},s));t.model.checkUpdate(true,true);var n=t.getView().byId("rulesNavContainer");n.to(t.getView().byId("ruleUpdatePage"),"show");}}):null;var d=new List({mode:"MultiSelect",includeItemInSelection:true,items:{path:"/libraries/"+b+"/rules",template:new InputListItem({label:"{title}",selected:"{selected}",content:c})}});if(a.rules.length===undefined){r=1;}else{r=a.rules.length;}var e=new Panel({width:"100%",expandable:true,expanded:false,content:d,headerToolbar:new Toolbar({content:[new Label({text:a.title+" ("+r+")"}),new ToolbarSpacer(),new Button({text:"Select all",press:function(){t.selectAll(b);}}),new Button({text:"Deselect all",press:function(){t.deselectAll(b);}})]})});v.addContent(e);});},addLinkToNewRule:function(){var t=this.model.getProperty("/tempLink"),c=jQuery.extend(true,{},t);this.model.getProperty("/newRule/resolutionurls").push(c);this.model.checkUpdate(true,true);},addLinkToEditRule:function(){var t=this.model.getProperty("/tempLink"),c=jQuery.extend(true,{},t);this.model.getProperty("/editRule/resolutionurls").push(c);this.model.checkUpdate(true,true);},goToCreateRule:function(){var n=this.getView().byId("rulesNavContainer");n.to(this.getView().byId("rulesCreatePage"),"show");},checkFunctionString:function(functionString){try{eval("var testAsignedVar = "+functionString);}catch(err){MessageToast.show("Your check function contains errors, and can't be evaluated:"+err);return false;}return true;},addNewRule:function(){var n=this.model.getProperty("/newRule");if(this.checkFunctionString(n.check)){CommunicationBus.publish("verifyNewRule",RuleSerializer.serialize(n));}},rulesToolbarITHSelect:function(e){if(e.getParameter("key")==="jsonOutput"){var n=this.model.getProperty("/newRule"),s=this.createRuleString(n);this.model.setProperty("/newRuleStringified",s);}},rulesToolbarEditITHSelect:function(e){if(e.getParameter("key")==="jsonOutput"){var n=this.model.getProperty("/editRule"),s=this.createRuleString(n);this.model.setProperty("/updateRuleStringified",s);}},visitAllRules:function(c){var l=this.model.getProperty("/libraries");l.forEach(function(a,b){a.rules.forEach(function(r,d){c(r,d,b);});});}});});
