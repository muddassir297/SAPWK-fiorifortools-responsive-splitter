/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObject","sap/ui/model/json/JSONModel","sap/ui/support/supportRules/Analyzer","sap/ui/support/supportRules/CoreFacade","sap/ui/support/supportRules/ExecutionScope","sap/ui/support/supportRules/Highlighter","sap/ui/support/supportRules/WindowCommunicationBus","sap/ui/support/supportRules/RuleSerializer","sap/ui/support/supportRules/RuleSet","sap/ui/support/supportRules/IssueManager","sap/ui/support/supportRules/DataCollector","sap/ui/support/supportRules/ReportProvider"],function(q,M,J,A,C,E,H,a,R,b,I,D,c){"use strict";var d=null;var m=null;var e=M.extend("sap.ui.support.Main",{constructor:function(){if(!m){var t=this;this._oCore=null;this._rulesCreated=false;this._mRulesets={};this._setCommunicationSubscriptions();this._oAnalyzer=new A();M.apply(this,arguments);q.sap.support={analyze:function(){return m.analyzeAll();},getIssueHistory:function(){if(t._oAnalyzer.running()){return null;}return I.getHistory();}};var f=document.createEvent("CustomEvent");f.initCustomEvent("supportToolLoaded",true,true,{});}else{q.sap.log.warning("Only one support tool allowed");return m;}}});e.prototype.startPlugin=function(){var t=this;sap.ui.getCore().registerPlugin({startPlugin:function(o){t._oCore=o;t._oDataCollector=new D(o);t._oCoreFacade=C(o);t._oExecutionScope=null;t._createCoreSpies();o.attachLibraryChanged(t._onLibraryChanged,t);var s=o.getConfiguration()["xx-support"];if(s.indexOf("silent")===-1){sap.ui.require(["sap/ui/support/supportRules/ui/IFrameController"],function(f){d=f;d.injectFrame();});}else{t._updatesupportRules();}},stopPlugin:function(){d._stop();t._oCore=null;t._oCoreFacade=null;t._oDataCollector=null;t._oExecutionScope=null;}});};e.prototype._onLibraryChanged=function(o){if(o.getParameter("stereotype")==="library"&&this._rulesCreated){this._updatesupportRules();}};e.prototype._createCoreSpies=function(){var t=this,n=500;this._dirtyTimeoutHandle=null;var s=function(N){var o=t._oCore[N];t._oCore[N]=function(){o.apply(t._oCore,arguments);clearTimeout(t._dirtyTimeoutHandle);t._dirtyTimeoutHandle=setTimeout(function(){a.publish("coreStateChanged");},n);};};s("registerElement");s("deregisterElement");};e.prototype._setCommunicationSubscriptions=function(){a.subscribe("verifyNewRule",function(t){var f=R.deserialize(t),g=this._mRulesets.temporary.ruleset,r=g.addRule(f);a.publish("verifyRuleCreateResult",{result:r,newRule:R.serialize(f)});},this);a.subscribe("verifyUpdateRule",function(f){var t=R.deserialize(f.updateObj),g=this._mRulesets.temporary.ruleset,r=g.updateRule(f.oldId,t);a.publish("verifyRuleUpdateResult",{result:r,updateRule:R.serialize(t)});},this);a.subscribe("getAvailableComponents",function(){a.publish("postAvailableComponents",Object.keys(this._oCore.mObjects.component));},this);a.subscribe("onAnalyzePressed",function(f){this.analyze(f.selectedRules,f.executionContext);},this);a.subscribe("analysisInit",function(){this._updatesupportRules();},this);a.subscribe("onViewReportPressed",function(r){var f=this._getReportData(r);var h=c.getReportHtml(f);var g=window.open("","_blank");if(g.document.getElementById("sap-report-content")){g.document.getElementById("sap-report-content").innerHtml=h;}else{g.document.write('<div id="sap-report-content">'+h+'</div>');}g.document.title="Report";},this);a.subscribe("onDownloadReportPressed",function(r){var f=this._getReportData(r);var h=c.getReportHtml(f);var g='<!DOCTYPE HTML><html><head><title>Report</title></head><body><div id="sap-report-content">'+h+'</div></body></html>';var i={"issues":f.issues};var j={"appInfos":f.application};this._oDataCollector.add("technicalInfo.json",f.technical,"json");this._oDataCollector.add("issues.json",i,"json");this._oDataCollector.add("appInfos.json",j,"json");this._oDataCollector.add("report.html",g);this._oDataCollector.download();this._oDataCollector.clear();},this);a.subscribe("markElement",function(i){var $=sap.ui.getCore().byId(i).$();$.css("background-color","red");},this);a.subscribe("openUrl",function(u){var w=window.open(u,"_blank");w.focus();},this);a.subscribe("treeElementHover",function(f){H.highlight(f);},this);a.subscribe("toggleFrameHidden",function(h){d.toggleHide(h);});};e.prototype._updatesupportRules=function(){var l=sap.ui.getCore().getLoadedLibraries();for(var n in l){try{if(!this._mRulesets[n]){sap.ui.requireSync([n.replace(/\./g,"/")+"/library.support"]);this._mRulesets[n]=q.sap.getObject(n).library.support;}}catch(f){q.sap.log.info("No support file found.");}}this._initTempRulesLib();this._rulesCreated=true;a.publish("updatesupportRules",R.serialize(this._mRulesets));};e.prototype._initTempRulesLib=function(){if(this._mRulesets.temporary){return;}this._mRulesets.temporary={lib:{name:"temporary"},ruleset:new b({name:"temporary",niceName:"Temporary ruleset"})};};e.prototype.analyze=function(r,f){if(this._oAnalyzer&&this._oAnalyzer.running()){return;}this._oAnalyzer.reset();var t=this;this._oExecutionScope=E(this._oCore,f);r.forEach(function(g){var l=t._mRulesets[g.libName],h=l.ruleset.getRules()[g.ruleId];t._oAnalyzer.addTask([h.title],function(o){t._analyzeSupportRule(o,f);},[h]);});I.clearIssues();return this._oAnalyzer.start();};e.prototype.analyzeAll=function(){if(this._oAnalyzer&&this._oAnalyzer.running()){return;}this._oAnalyzer.reset();var t=this;this._oExecutionScope=E(this._oCore,{type:"core"});Object.keys(t._mRulesets).map(function(l){var r=t._mRulesets[l].ruleset.getRules();Object.keys(r).map(function(f){var g=r[f];t._oAnalyzer.addTask([g.title],function(o){t._analyzeSupportRule(o,{type:"core"});},[g]);});});I.clearIssues();return this._oAnalyzer.start();};e.prototype._done=function(){var i=this._createIssuesViewModel(),f=this._createElementTree();a.publish("analyzeFinish",{issues:i,elementTree:f,elapsedTime:this._oAnalyzer.getElapsedTimeString()});};e.prototype._createElementTree=function(){var f=this._copyElementsStructure(),g=[];this._setContextElementReferences(f);for(var i in f){if(f[i].skip){continue;}g.push(f[i]);}return[{content:g,id:"WEBPAGE",name:"WEBPAGE"}];};e.prototype._setContextElementReferences=function(f){var g=this._oCore.mElements;for(var h in f){var i=f[h],p=g[h]==undefined?undefined:g[h].getParent();if(g[h]instanceof sap.ui.core.ComponentContainer){var j=g[h],k=j.getComponent();i.content.push(f[k]);f[k].skip=true;}if(p){var l=p.getId();if(!f[l]){continue;}f[l].content.push(f[h]);f[h].skip=true;}}};e.prototype._copyElementsStructure=function(){var f={},t=this;var g=function(j,k){for(var i in j){var l=j[i],n={content:[],id:l.getId(),name:(k==undefined)?l.getMetadata().getName():k};f[l.getId()]=n;}};g(this._oExecutionScope.getElements());this._oExecutionScope.getElements().forEach(function(i){if(i instanceof sap.ui.core.ComponentContainer){var j=i.getComponent(),k=t._oCore.mObjects.component[j];g([k],"sap-ui-component");}});switch(this._oExecutionScope._getType()){case"core":g(this._oCoreFacade.getUIAreas(),"sap-ui-area");g(this._oCoreFacade.getComponents(),"sap-ui-component");break;case"parent":var p=this._oExecutionScope._getContext().parentId;g([this._oCore.mElements[p]]);break;case"components":var h=this._oExecutionScope._getContext().components;h.forEach(function(i){g([t._oCore.mObjects.component[i]],"sap-ui-component");});break;}return f;};e.prototype._createIssuesViewModel=function(){var v=[];I.walkIssues(function(i){var f=i.context.id==="WEBPAGE"?"sap.ui.core":sap.ui.getCore().byId(i.context.id).getMetadata().getName();v.push({severity:i.severity,name:i.rule.title,description:i.rule.description,resolution:i.rule.resolution,resolutionUrls:i.rule.resolutionurls,audiences:i.rule.audiences,categories:i.rule.categories,details:i.details,ruleLibName:i.rule.libName,ruleId:i.rule.id,context:{className:f,id:i.context.id}});});return v;};e.prototype._getReportData=function(r){return{issues:this._createIssuesViewModel(),technical:this._oDataCollector.getTechInfoJSON(),application:this._oDataCollector.getAppInfo(),scope:{executionScope:this._oExecutionScope,scopeDisplaySettings:{executionScopes:r.executionScopes,executionScopeTitle:r.executionScopeTitle}},analysisDuration:this._oAnalyzer.getElapsedTimeString(),analysisDurationTitle:r.analysisDurationTitle};};e.prototype._analyzeSupportRule=function(r,f){r.check(I.createCheckFunctionProxy(r),this._oCoreFacade,this._oExecutionScope);a.publish("progressUpdate",{currentProgress:this._oAnalyzer.getProgress()});if(this._iDoneTimer){q.sap.clearDelayedCall(this._iDoneTimer);}this._iDoneTimer=q.sap.delayedCall(100,this,"_done");};var m=new e();return m;},true);
