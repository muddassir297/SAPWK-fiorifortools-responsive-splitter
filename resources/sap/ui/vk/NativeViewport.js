/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/core/ResizeHandler","./Loco","./ViewportHandler","./Messages"],function(q,l,C,R,L,V,M){"use strict";var N=C.extend("sap.ui.vk.NativeViewport",{metadata:{library:"sap.ui.vk",properties:{limitZoomOut:{type:"boolean",group:"Behavior",defaultValue:false}},publicMethods:["beginGesture","endGesture","pan","rotate","zoom","tap","queueCommand","getViewInfo","setViewInfo","loadUrl"],events:{"resize":{parameters:{oldSize:"object",size:"object"}},"move":{parameters:{pan:"object",zoom:"float"}}}}});N.prototype.init=function(){if(C.prototype.init){C.prototype.init(this);}this._canvas=null;this._canvas=document.createElement("div");this._canvas.style.textAlign="left";this._canvas.id=q.sap.uid();this._resizeListenerId=null;this._viewportHandler=new V(this);this._loco=new L();this._loco.addHandler(this._viewportHandler);this._img=null;this._svg=null;this._svgError=null;this._reset();this._gx=0;this._gy=0;this._errorImageWidth=550;this._errorImageHeight=512;this._imageW=0;this._imageH=0;this._s4BestFit=0;this._update=function(){};this._svgid=this.getId()+"-svg";this._doBestFitAfterResize=false;};N.prototype.exit=function(){this._loco.removeHandler(this._viewportHandler);this._viewportHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}if(C.prototype.exit){C.prototype.exit.apply(this);}};N.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}};N.prototype.onAfterRendering=function(){if(this._canvas){var d=this.getDomRef();d.appendChild(this._canvas);this._resizeListenerId=R.register(this,this._handleResize.bind(this));}};N.prototype._handleResize=function(e){this.fireResize({oldSize:e.oldSize,size:e.size});if(this._doBestFitAfterResize){this._doBestFitAfterResize=false;this._bestFit();}this._update();};N.prototype._reset=function(){this._x=0;this._y=0;this._s=1.0;this._r=0;};N.prototype._updateIMG=function(){if(this._img!=null){var x=this._x-(this._imageW-this._canvas.clientWidth)/2;var y=this._y-(this._imageH-this._canvas.clientHeight)/2;var t="matrix("+this._s+",0,0,"+this._s+","+x+","+y+")";this._img.style.transform=t;this._img.style.webkitTransform=t;this._img.style.msTransform=t;this._img.style.MozTransform=t;this._img.style.OTransform=t;}};N.prototype._updateSVG=function(){if(this._svg!=null){var x=this._x-(this._imageW-this._canvas.clientWidth)/2;var y=this._y-(this._imageH-this._canvas.clientHeight)/2;if((this.x<0)&&(this.y<0)){x=0;y=0;}var t="matrix("+this._s+",0,0,"+this._s+","+x+","+y+");";this._svg.setAttribute("style","transform:"+t+"webkitTransform:"+t+"msTransform:"+t+"MozTransform:"+t+"OTransform:"+t);}};N.prototype._updateError=function(){if(this._svgError!=null){var x=this._x-(this._imageW-this._canvas.clientWidth)/2;var y=this._y-(this._imageH-this._canvas.clientHeight)/2;if((this.x<0)&&(this.y<0)){x=0;y=0;}var t="matrix("+this._s+",0,0,"+this._s+","+x+","+y+");";this._svgError.setAttribute("style","transform:"+t+"webkitTransform:"+t+"msTransform:"+t+"MozTransform:"+t+"OTransform:"+t);}};N.prototype._bestFit=function(){if(this._canvas.children[0]&&this._canvas.children[0].getBoundingClientRect()){var w=this._canvas.clientWidth/this._canvas.children[0].getBoundingClientRect().width,h=this._canvas.clientHeight/this._canvas.children[0].getBoundingClientRect().height,s=w<h?w:h;this.zoom(s);var o=q(this._canvas.children[0]).position().left-q(this._canvas).position().left,a=q(this._canvas.children[0]).position().top-q(this._canvas).position().top,i=this._canvas.children[0].getBoundingClientRect().width,b=this._canvas.children[0].getBoundingClientRect().height,v=this._canvas.getBoundingClientRect().width,c=this._canvas.getBoundingClientRect().height;var d=(v-i)/2-o,e=(c-b)/2-a;this.pan(d,e);this._s4BestFit=this._s;}};N.prototype.loadUrl=function(u,o,a,b,c){if(/^(svg)$/.test(c.toLowerCase())){while(this._canvas.lastChild){this._canvas.removeChild(this._canvas.lastChild);}this._reset();this._svg=document.createElement("object");this._svg.setAttribute("type","image/svg+xml");this._svg.setAttribute("data",u);this._svg.setAttribute("id",this._svgid);this._svg.setAttribute("class","SVGImage");this._canvas.appendChild(this._svg);var s=document.createElement("div");this._canvas.appendChild(s);s.style.position="absolute";s.style.top=0;s.style.left=0;s.style.height="100%";s.style.width="100%";this._svg.style.visibility="hidden";this._svg.onload=function(){setTimeout(function(){this._imageW=this._svg.getBoundingClientRect().width;this._imageH=this._svg.getBoundingClientRect().height;this._s=1;this._update=this._updateSVG.bind(this);this._bestFit();o();this._svg.onload=undefined;}.bind(this),0);}.bind(this);this._svg.src=u;this._svg.onerror=function(){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT1.summary),M.VIT1.code,"sap.ui.vk.NativeViewport");a();if(this._svg.parentNode===this._canvas){this._canvas.removeChild(this._svg);}}.bind(this);return this;}else if(/^(jpg|png|gif|bmp|tif|tiff)$/.test(c.toLowerCase())){while(this._canvas.lastChild){this._canvas.removeChild(this._canvas.lastChild);}this._reset();this._img=new Image();this._img.onload=function(){this._imageW=this._img.width;this._imageH=this._img.height;setTimeout(function(){this._canvas.appendChild(this._img);this._update=this._updateIMG.bind(this);this._bestFit();}.bind(this),0);o();}.bind(this);this._img.onerror=function(){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT2.summary),M.VIT2.code,"sap.ui.vk.NativeViewport");a();};this._img.src=u;return this;}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT3.summary),M.VIT3.code,"sap.ui.vk.NativeViewport");a();}};N.prototype.loadFailed=function(t){while(this._canvas.lastChild){this._canvas.removeChild(this._canvas.lastChild);}this._reset();this._svgError=document.createElement("div");this._svgError.className="svgErrorContainer";this._svgErrorElement=document.createElementNS("http://www.w3.org/2000/svg","svg");this._svgErrorElement.setAttribute("width","550px");this._svgErrorElement.setAttribute("height","512px");this._svgErrorElement.setAttribute("viewBox","-244 -244 512 512");this._svgErrorElement.setAttribute("enable-background","new -244 -244 512 512");this._svgErrorElement.setAttribute("id","SVGError");var a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("fill","#FFFFFF");a.setAttribute("x","-244");a.setAttribute("y","-244");a.setAttribute("width","512");a.setAttribute("height","512");a.setAttribute("opacity","0.1");this._svgErrorElement.appendChild(a);var b=document.createElementNS("http://www.w3.org/2000/svg","path");b.setAttribute("fill","#474747");b.setAttribute("d","M12.833,89.742c-70.781,0-128.366-57.584-128.366-128.366c0-70.781,57.584-128.365,128.366-128.365 s128.365,57.584,128.365,128.365C141.198,32.158,83.614,89.742,12.833,89.742z M12.833-146.989 c-59.753,0-108.366,48.612-108.366,108.365c0,59.752,48.613,108.366,108.366,108.366S121.198,21.129 121.198-38.624 C121.198-98.376,72.586-146.989,12.833-146.989z");b.setAttribute("opacity","0.3");this._svgErrorElement.appendChild(b);var c=document.createElementNS("http://www.w3.org/2000/svg","rect");c.setAttribute("fill","#474747");c.setAttribute("x","-2.167");c.setAttribute("y","-120.847");c.setAttribute("width","30");c.setAttribute("height","119.447");c.setAttribute("fill","#474747");c.setAttribute("opacity","0.3");this._svgErrorElement.appendChild(c);var d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.setAttribute("fill","#474747");d.setAttribute("x","-2.167");d.setAttribute("y","13.6");d.setAttribute("width","30");d.setAttribute("height","30");d.setAttribute("opacity","0.3");this._svgErrorElement.appendChild(d);var e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("fill","#474747");e.setAttribute("d","M10.833,87.33c-70.781,0-128.366-57.584-128.366-128.365c0-70.781,57.584-128.365,128.366-128.365 s128.365,57.584,128.365,128.365C139.198,29.746,81.614,87.33,10.833,87.33z M10.833-149.4 c-59.753,0-108.366,48.612-108.366,108.365S-48.92,67.33,10.833,67.33S119.198,18.718,119.198-41.035S70.586-149.4,10.833-149.4z");this._svgErrorElement.appendChild(e);var f=document.createElementNS("http://www.w3.org/2000/svg","rect");f.setAttribute("fill","#474747");f.setAttribute("x","-4.167");f.setAttribute("y","-123.259");f.setAttribute("width","30");f.setAttribute("height","119.447");f.setAttribute("fill","#474747");this._svgErrorElement.appendChild(f);var g=document.createElementNS("http://www.w3.org/2000/svg","rect");g.setAttribute("fill","#474747");g.setAttribute("x","-4.167");g.setAttribute("y","11.188");g.setAttribute("width","30");g.setAttribute("height","30");g.setAttribute("fill","#474747");this._svgErrorElement.appendChild(g);var h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("id","textError");h.setAttribute("left","auto");h.setAttribute("right","auto");h.setAttribute("y","150");h.setAttribute("x","10");h.setAttribute("display","block");h.setAttribute("text-anchor","middle");h.setAttribute("fill","#474747");h.setAttribute("style","font-family:Arial");h.setAttribute("font-size","32");h.textContent=t?t:sap.ui.vk.getResourceBundle().getText("VIEWPORT_MESSAGEUNSUPPORTEDFILEFORMAT");this._svgErrorElement.appendChild(h);this._svgError.appendChild(this._svgErrorElement);this._canvas.appendChild(this._svgError);this._imageW=this._errorImageWidth;this._imageH=this._errorImageHeight;this._update=this._updateError.bind(this);this._doBestFitAfterResize=true;setTimeout(function(){this._bestFit();}.bind(this),0);q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT4.summary),M.VIT4.code,"sap.ui.vk.NativeViewport");return this;};N.prototype.beginGesture=function(x,y){this._gx=(x-this._canvas.clientWidth/2-this._x)/this._s;this._gy=(y-this._canvas.clientHeight/2-this._y)/this._s;return this;};N.prototype.endGesture=function(){this._gx=0;this._gy=0;return this;};N.prototype.pan=function(d,a){this._x+=d;this._y+=a;this._update();this.fireMove({pan:{x:d,y:a},zoom:1.0});return this;};N.prototype.rotate=function(d,a){this._x+=d;this._y+=a;this._update();this.fireMove({pan:{x:d,y:a},zoom:1.0});return this;};N.prototype.zoom=function(z){var g=this._gx*this._s;var a=this._gy*this._s;var n=this._s*z;var b=(this.getLimitZoomOut())?this._s4BestFit*0.25:0.0001;var c=500;if((n>b)&&(n<c)){this._s=n;}else if(n<c){z=b/this._s;this._s=b;}else{z=c/this._s;this._s=c;}var d=this._gx*this._s;var e=this._gy*this._s;var f=g-d;var h=a-e;this._x+=f;this._y+=h;this._update();this.fireMove({pan:{x:f,y:h},zoom:z});return this;};N.prototype.tap=function(x,y,i){if(i){this._bestFit();}return this;};N.prototype.queueCommand=function(c){c();return this;};N.prototype.getViewInfo=function(){var v={};v.camera=[this._s,0,0,this._s,this._x,this._y];return v;};N.prototype.setViewInfo=function(v){var c=v.camera;this._s=c[0];this._x=c[4];this._y=c[5];this._update();return this;};N.prototype.getOutputSize=function(){var c=this.getViewInfo().camera,b=this.getDomRef().getBoundingClientRect();return{left:b.width/2+c[4],top:b.height/2+c[5],sideLength:this._canvas.children[0].getBoundingClientRect().width};};var r=2;var p=2;[{key:"left",dx:-p,dy:0},{key:"right",dx:+p,dy:0},{key:"up",dx:0,dy:-p},{key:"down",dx:0,dy:+p}].forEach(function(i){N.prototype["onsap"+i.key]=function(e){this.beginGesture(this.$().width()/2,this.$().height()/2);this.pan(i.dx,i.dy);this.endGesture();e.preventDefault();e.stopPropagation();};});[{key:"left",dx:-r,dy:0},{key:"right",dx:+r,dy:0},{key:"up",dx:0,dy:-r},{key:"down",dx:0,dy:+r}].forEach(function(i){N.prototype["onsap"+i.key+"modifiers"]=function(e){if(e.shiftKey&&!(e.ctrlKey||e.altKey||e.metaKey)){this.beginGesture(this.$().width()/2,this.$().height()/2);this.rotate(i.dx,i.dy);this.endGesture();e.preventDefault();e.stopPropagation();}};});[{key:"minus",d:0.98},{key:"plus",d:1.02}].forEach(function(i){N.prototype["onsap"+i.key]=function(e){this.beginGesture(this.$().width()/2,this.$().height()/2);this.zoom(i.d);this.endGesture();e.preventDefault();e.stopPropagation();};});return N;});
