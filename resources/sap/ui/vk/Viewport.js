/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/core/ResizeHandler","./Loco","./ViewportHandler","./Smart2DHandler","./GraphicsCore","./Messages"],function(q,l,C,R,L,V,S,G,M){"use strict";var d={encodedProjectionType:{},decodedProjectionType:{perspective:sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE,orthographic:sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC},encodedBindingType:{},decodedBindingType:{minimum:sap.ve.dvl.DVLCAMERAFOVBINDING.MIN,maximum:sap.ve.dvl.DVLCAMERAFOVBINDING.MAX,horizontal:sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ,vertical:sap.ve.dvl.DVLCAMERAFOVBINDING.VERT}};d.encodedProjectionType[sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE]="perspective";d.encodedProjectionType[sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC]="orthographic";d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.MIN]="minimum";d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.MAX]="maximum";d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ]="horizontal";d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.VERT]="vertical";var a=C.extend("sap.ui.vk.Viewport",{metadata:{library:"sap.ui.vk",publicMethods:["setGraphicsCore","getGraphicsCore","setScene","setViewStateManager","beginGesture","endGesture","pan","rotate","zoom","tap","hitTest","queueCommand","getViewInfo","setViewInfo"],properties:{showDebugInfo:"boolean",showAllHotspots:{type:"boolean",defaultValue:false},hotspotColorABGR:{type:"int",defaultValue:0xc00000ff},backgroundColorTopABGR:{type:"int",defaultValue:0xff000000},backgroundColorBottomABGR:{type:"int",defaultValue:0xffffffff},width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"}},events:{urlClicked:{parameters:{nodeId:"string",url:"string"},enableEventBubbling:true},nodeClicked:{parameters:{nodeId:"string",x:"int",y:"int"},enableEventBubbling:true},pan:{parameters:{dx:"int",dy:"int"}},zoom:{parameters:{zoomFactor:"float"}},resize:{parameters:{size:"object"}},viewActivated:{parameters:{type:{type:"string"}}}}}});a.prototype.init=function(){if(C.prototype.init){C.prototype.init(this);}this._graphicsCore=null;this._dvl=null;this._dvlRendererId=null;this._canvas=null;this._resizeListenerId=null;this._is2D=false;this._viewportHandler=new V(this);this._loco=new L();this._loco.addHandler(this._viewportHandler);this._smart2DHandler=null;this._lastPlayedStep=null;};a.prototype.exit=function(){this._loco.removeHandler(this._viewportHandler);this._viewportHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this.setViewStateManager(null);this.setScene(null);this.setGraphicsCore(null);if(C.prototype.exit){C.prototype.exit.apply(this);}};a.prototype.setGraphicsCore=function(g){if(g!=this._graphicsCore){if(g&&this._graphicsCore&&this._graphicsCore._getViewportCount()>0){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT18.summary),M.VIT18.code,"sap.ui.vk.Viewport");}if(this._graphicsCore){if(this._graphicsCore._unregisterViewport(this)){if(this._graphicsCore._getViewportCount()===0){this._dvl.Core.StopRenderLoop();}}}this._dvlRendererId=null;this._dvl=null;this._graphicsCore=g;if(this._graphicsCore){var s=this._graphicsCore._getViewportCount()===0;this._dvl=this._graphicsCore._getDvl();this._dvlRendererId=this._dvl.Core.GetRendererPtr();this._setCanvas(this._graphicsCore._getCanvas());this._graphicsCore._registerViewport(this);if(s){this._dvl.Core.StartRenderLoop();}this.setShowDebugInfo(this.getShowDebugInfo());this._dvl.Client.attachStepEvent(function(e){if(e.type===sap.ve.dvl.DVLSTEPEVENT.DVLSTEPEVENT_STARTED){this._lastPlayedStep=e.stepId;}}.bind(this));}}return this;};a.prototype.getGraphicsCore=function(){return this._graphicsCore;};a.prototype._setCanvas=function(c){var s=this.getDomRef()&&this._canvas!==c;this._canvas=c;if(s){this.invalidate();}return this;};a.prototype.setScene=function(s){if(this._dvlRendererId){this._dvl.Renderer.AttachScene(s&&s._getDvlSceneId()||null);this._dvlSceneId=s?s._getDvlSceneId():null;if(s){this._dvl.Client.attachUrlClicked(this._fireUrlClicked,this);var i=this._isSmart2DContent()||this._isSmart2DContentLegacy();if(i){this._dvl.Renderer.SetBackgroundColor(1,1,1,1,1,1,1,1);}else{var t=this._getDecomposedABGR(this.getBackgroundColorTopABGR());var b=this._getDecomposedABGR(this.getBackgroundColorBottomABGR());this._dvl.Renderer.SetBackgroundColor(t.red,t.green,t.blue,t.alpha,b.red,b.green,b.blue,b.alpha);}this.fireViewActivated({type:i?"2D":"3D"});}else{this._dvl.Client.detachUrlClicked(this._fireUrlClicked,this);if(this._smart2DHandler){var c=new L();c.removeHandler(this._smart2DHandler);}}}return this;};a.prototype._isSmart2DContent=function(){var h=sap.ui.vk.dvl.getJSONObject(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneId,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_HOTSPOTS).ChildNodes);return h&&h.length>0;};a.prototype._isSmart2DContentLegacy=function(){var c=this._dvl.Scene.GetCurrentCamera(this._dvlSceneId),b=this._dvl.Camera.GetRotation(c),e=this._dvl.Camera.GetProjection(c);return b[0]===90&&b[1]===-90&&b[2]===0&&e===sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC;};a.prototype._initializeSmart2DHandler=function(){if(this._viewStateManager){if(this._smart2DHandler){this._loco.removeHandler(this._smart2DHandler);}this._smart2DHandler=new S(this,this._viewStateManager);this._loco.addHandler(this._smart2DHandler);}if(this.getShowAllHotspots()){var n=this._viewStateManager.getNodeHierarchy(),h=n.getHotspotNodeIds();this.showHotspots(h,true);}};a.prototype._fireUrlClicked=function(b){this.fireUrlClicked({url:b.url,nodeId:b.nodeId});};a.prototype._getStepAndProcedureIndexes=function(b,s){var c=-1,e=-1,f=false;for(var i=0;i<b.length;i++){if(!f){for(var j=0;j<b[i].steps.length;j++){if(b[i].steps[j].id===s){e=j;c=i;f=true;break;}}}else{break;}}return{stepIndex:e,procedureIndex:c};};a.prototype.getViewInfo=function(b){var g=function(x){var y=x===undefined?{}:q.extend(true,{},x);y.animation=y.animation===false?false:true;if(!y.camera!==false){y.camera=(y.camera===undefined||typeof y.camera!=="object")?{}:y.camera;y.camera.position=y.position===false?false:true;y.camera.rotation=y.rotation===false?false:true;y.camera.projectionType=y.projectionType===false?false:true;y.camera.bindingType=y.bindingType===false?false:true;}if(!y.visibility){y.visibility=false;}else{y.visibility=typeof y.visibility!=="object"?{}:y.visibility;y.visibility=y.visibility===undefined||typeof y.visibility!=="object"?{}:y.visibility;y.visibility.mode=y.visibility.mode===undefined?sap.ui.vk.VisibilityMode.Complete:y.visibility.mode;if(y.visibility.mode!==sap.ui.vk.VisibilityMode.Complete&&y.visibility.mode!==sap.ui.vk.VisibilityMode.Differences){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT28.summary),M.VIT28.code,"sap.ui.vk.Viewport");}y.visibility.compressed=y.visibility.compressed===true?true:false;}return y;};if(this._dvlSceneId===null||this._dvlSceneId===undefined){return null;}var v=g(b),c={};if(v.camera){c.camera={};var e=this._dvl.Scene.GetCurrentCamera(this._dvlSceneId);if(v.camera.rotation){var f=this._dvl.Camera.GetRotation(e),h={yaw:f[0],pitch:f[1],roll:f[2]};c.camera.rotation=h;}if(v.camera.position){var i=this._dvl.Camera.GetOrigin(e),j={x:i[0],y:i[1],z:i[2]};c.camera.position=j;}if(v.camera.projectionType){c.camera.projectionType=d.encodedProjectionType[this._dvl.Camera.GetProjection(e)];if(d.encodedProjectionType[this._dvl.Camera.GetProjection(e)]==="perspective"){c.camera.fieldOfView=this._dvl.Camera.GetFOV(e);}else if(d.encodedProjectionType[this._dvl.Camera.GetProjection(e)]==="orthographic"){c.camera.zoomFactor=this._dvl.Camera.GetOrthoZoomFactor(e);}}if(v.camera.bindingType){c.camera.bindingType=d.encodedBindingType[this._dvl.Camera.GetFOVBinding(e)];}}if(this._viewStateManager&&v.visibility){c.visibility={};switch(v.visibility.mode){case sap.ui.vk.VisibilityMode.Complete:var k=this._viewStateManager.getVisibilityComplete();c.visibility.visible=k.visible;c.visibility.hidden=k.hidden;break;case sap.ui.vk.VisibilityMode.Differences:c.visibility.changes=this._viewStateManager.getVisibilityChanges();break;default:q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT28.summary),M.VIT28.code,"sap.ui.vk.Viewport");}c.visibility.mode=v.visibility.mode;c.visibility.compressed=v.visibility.compressed;}if(v.animation){var s=this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneId,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_STEP_INFO),m=s.StepId!==sap.ve.dvl.DVLID_INVALID;var n=m?s.StepId:this._lastPlayedStep,t=m?s.StepTime:0,u=this._dvl.Scene.RetrieveProcedures(this._dvlSceneId),w=this._getStepAndProcedureIndexes(u.procedures,n);c.animation={animationTime:t,stepIndex:w.stepIndex,procedureIndex:w.procedureIndex};}return c;};a.prototype.setViewInfo=function(v){if(v.animation){var b=this._dvl.Scene.RetrieveProcedures(this._dvlSceneId);if(b.procedures.length>0&&v.animation.stepIndex!==-1&&v.animation.procedureIndex!==-1){if(v.animation.procedureIndex>=0&&v.animation.procedureIndex<b.procedures.length){if(v.animation.stepIndex>=0&&v.animation.stepIndex<b.procedures[v.animation.procedureIndex].steps.length){var c=v.animation.animationTime||0,s=b.procedures[v.animation.procedureIndex].steps[v.animation.stepIndex].id;this._dvl.Scene.ActivateStep(this._dvlSceneId,s,false,false,0);setTimeout(function(){this._dvl.Scene.PauseCurrentStep(this._dvlSceneId);}.bind(this),c*1000);}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT26.summary),M.VIT26.code,"sap.ui.vk.Viewport");}}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT27.summary),M.VIT27.code,"sap.ui.vk.Viewport");}}else{this.resetView({camera:true,visibility:true,transition:false});}}else{this.resetView({camera:true,visibility:true,transition:false});}if(v.camera){var e=d.decodedProjectionType[v.camera.projectionType];var f=this._dvl.Scene.CreateCamera(this._dvlSceneId,e,sap.ve.dvl.DVLID_INVALID);if(v.camera.projectionType){switch(e){case d.decodedProjectionType.perspective:this._dvl.Camera.SetFOV(f,v.camera.fieldOfView);break;case d.decodedProjectionType.orthographic:this._dvl.Camera.SetOrthoZoomFactor(f,v.camera.zoomFactor);break;default:q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT19.summary),M.VIT19.code,"sap.ui.vk.Viewport");}}if(v.camera.position){this._dvl.Camera.SetOrigin(f,v.camera.position.x,v.camera.position.y,v.camera.position.z);}if(v.camera.rotation){this._dvl.Camera.SetRotation(f,v.camera.rotation.yaw,v.camera.rotation.pitch,v.camera.rotation.roll);}if(v.camera.bindingType){var g=d.decodedBindingType[v.camera.bindingType];this._dvl.Camera.SetFOVBinding(f,g);}this._dvl.Scene.ActivateCamera(this._dvlSceneId,f);this._dvl.Scene.DeleteNode(this._dvlSceneId,f);}if(v.visibility){var n=this._viewStateManager.getNodeHierarchy(),h=new Map(),i=n.findNodesByName();q.sap.require("sap.ui.vk.NodeProxy");i.forEach(function(t){var u=new sap.ui.vk.NodeProxy(n,t),w=q.grep(u.getVeIds(),function(w){return w.type==="VE_LOCATOR";})[0].fields[0].value;u.destroy();h.set(w,t);});switch(v.visibility.mode){case sap.ui.vk.VisibilityMode.Complete:var j=v.visibility.compressed?v.visibility.visible:v.visibility.visible,k=v.visibility.compressed?v.visibility.hidden:v.visibility.hidden;j.forEach(function(t){this._viewStateManager.setVisibilityState(h.get(t),true,false);}.bind(this));k.forEach(function(t){this._viewStateManager.setVisibilityState(h.get(t),false,false);}.bind(this));break;case sap.ui.vk.VisibilityMode.Differences:var m=v.visibility.compressed?v.visibility.changes:v.visibility.changes;m.forEach(function(t){var u=h.get(t);this._viewStateManager.setVisibilityState(u,!this._viewStateManager.getVisibilityState(u),false);}.bind(this));break;default:q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT28.summary),M.VIT28.code,"sap.ui.vk.Viewport");}}};a.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}};a.prototype.getOutputSize=function(){var b=this.getViewInfo().camera.bindingType,c=this.getDomRef().getBoundingClientRect(),v=c.width,e=c.height,f;switch(d.decodedBindingType[b]){case sap.ve.dvl.DVLCAMERAFOVBINDING.MIN:f=Math.min(v,e);break;case sap.ve.dvl.DVLCAMERAFOVBINDING.MAX:f=Math.max(v,e);break;case sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ:f=v;break;case sap.ve.dvl.DVLCAMERAFOVBINDING.VERT:f=e;break;default:break;}return{left:(v-f)/2,top:(e-f)/2,sideLength:f};};a.prototype.onAfterRendering=function(){if(this._canvas){var b=this.getDomRef();b.appendChild(this._canvas);this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:b.clientWidth,height:b.clientHeight}});}};a.prototype._handleResize=function(e){if(this._dvlRendererId&&this._canvas){var b=window.devicePixelRatio||1;var c=e.size.width*b;var f=e.size.height*b;this._dvl.Renderer.SetDimensions(c,f);this._dvl.Renderer.SetOptionF(sap.ve.dvl.DVLRENDEROPTIONF.DVLRENDEROPTIONF_DPI,96*b);this._canvas.width=c;this._canvas.height=f;this._canvas.style.width=e.size.width+"px";this._canvas.style.height=e.size.height+"px";this.fireResize({size:{width:e.size.width,height:e.size.height}});return true;}};a.prototype.setViewStateManager=function(v){this._viewStateManager=v;if(this._viewStateManager&&(this._isSmart2DContent()||this._isSmart2DContentLegacy())){this._initializeSmart2DHandler();}return this;};a.prototype.showHotspots=function(n,s,c){var b=function(e,c,j){var k=e.createNodeProxy(j);k.setTintColorABGR(c);e.destroyNodeProxy(k);};if(!Array.isArray(n)){n=[n];}var h=c===undefined?this.getHotspotColorABGR():c;if(!s){h=0;}var e=this._viewStateManager.getNodeHierarchy();if(this._isSmart2DContent()){var f=[];n.forEach(function(j){var k=sap.ui.vk.dvl.getJSONObject(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneId,j,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN).ChildNodes);Array.prototype.push.apply(f,k);}.bind(this));Array.prototype.push.apply(f,n);f.forEach(b.bind(null,e,h));}else{var g=[];var i=function(j){var f=e.getChildren(j);Array.prototype.push.apply(g,f);f.forEach(i);};n.forEach(i);Array.prototype.push.apply(g,n);g.forEach(b.bind(null,e,h));}return this;};a.prototype._getDecomposedABGR=function(i){return{red:(i>>>0&0xff)/255,green:(i>>>8&0xff)/255,blue:(i>>>16&0xff)/255,alpha:(i>>>24&0xff)/255};};a.prototype._setBackgroundColor=function(){var t=this._getDecomposedABGR(this.getBackgroundColorTopABGR()),b=this._getDecomposedABGR(this.getBackgroundColorBottomABGR());this._dvl.Renderer.SetBackgroundColor(t.red,t.green,t.blue,t.alpha,b.red,b.green,b.blue,b.alpha);};a.prototype.setBackgroundColorTopABGR=function(i){this.setProperty("backgroundColorTopABGR",i,true);this._setBackgroundColor();return this;};a.prototype.setBackgroundColorBottomABGR=function(i){this.setProperty("backgroundColorBottomABGR",i,true);this._setBackgroundColor();return this;};a.prototype.shouldRenderFrame=function(){return this._dvlRendererId&&this._dvl.Renderer.ShouldRenderFrame();};a.prototype.renderFrame=function(){if(this._dvlRendererId){this._dvl.Renderer.RenderFrame(this._dvlRendererId);}return this;};a.prototype.renderFrameEx=function(v,b){if(this._dvlRendererId){this._dvl.Renderer.RenderFrameEx.apply(this,[].concat(v,b),this._dvlRendererId);}return this;};a.prototype.resetView=function(b){if(b!==undefined&&!q.isPlainObject(b)){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT31.summary),M.VIT31.code,"sap.ui.vk.Viewport");}var c={camera:true,transition:true,visibility:false};q.extend(c,b);if(c.camera||c.visibility){var e=(c.camera?sap.ve.dvl.DVLRESETVIEWFLAG.CAMERA:0)|(c.transition?sap.ve.dvl.DVLRESETVIEWFLAG.SMOOTHTRANSITION:0)|(c.visibility?sap.ve.dvl.DVLRESETVIEWFLAG.VISIBILITY:0);if(this._dvlRendererId){this._dvl.Renderer.ResetView(e,this._dvlRendererId);this._lastPlayedStep=null;}}return this;};a.prototype.canIsolateNode=function(n){if(this._dvlRendererId){return this._dvl.Renderer.CanIsolateNode(n,this._dvlRendererId);}else{return false;}};a.prototype.setIsolatedNode=function(n){if(this._dvlRendererId){this._dvl.Renderer.SetIsolatedNode(n,this._dvlRendererId);}return this;};a.prototype.getIsolatedNode=function(){if(this._dvlRendererId){return this._dvl.Renderer.GetIsolatedNode(this._dvlRendererId);}else{return sap.ve.dvl.DVLID_INVALID;}};a.prototype.hitTest=function(x,y){if(this._dvlRendererId){return this._dvl.Renderer.HitTest(x*window.devicePixelRatio,y*window.devicePixelRatio,this._dvlRendererId).id;}else{return sap.ve.dvl.DVLID_INVALID;}};a.prototype.setShowDebugInfo=function(v){this.setProperty("showDebugInfo",v,true);if(this._dvlRendererId){this._dvl.Renderer.SetOption(sap.ve.dvl.DVLRENDEROPTION.DVLRENDEROPTION_SHOW_DEBUG_INFO,v,this._dvlRendererId);}return this;};a.prototype.beginGesture=function(x,y){if(this._dvlRendererId){var b=window.devicePixelRatio||1;this._dvl.Renderer.BeginGesture(x*b,y*b,this._dvlRendererId);}return this;};a.prototype.endGesture=function(){if(this._dvlRendererId){this._dvl.Renderer.EndGesture(this._dvlRendererId);}return this;};a.prototype.pan=function(b,c){if(this._dvlRendererId){var e=window.devicePixelRatio||1;this._dvl.Renderer.Pan(b*e,c*e,this._dvlRendererId);this.firePan({dx:b,dy:c});}return this;};a.prototype.rotate=function(b,c){if(this._dvlRendererId){var e=window.devicePixelRatio||1;this._dvl.Renderer.Rotate(b*e,c*e,this._dvlRendererId);}return this;};a.prototype.zoom=function(b){if(this._dvlRendererId){this._dvl.Renderer.Zoom(b,this._dvlRendererId);this.fireZoom({zoomFactor:b});}return this;};a.prototype.tap=function(x,y,i){if(this._dvlRendererId){var b=window.devicePixelRatio||1;var c=x*b,e=y*b;if(!i){var n=this.hitTest(x,y);if(n!=sap.ve.dvl.DVLID_INVALID){var f={nodeId:n,x:x,y:y};this.fireNodeClicked(f,true,true);}}this._dvl.Renderer.Tap(c,e,i,this._dvlRendererId);}return this;};a.prototype.queueCommand=function(c){if(this._dvlRendererId){this._dvl.Renderer._queueCommand(c,this._dvlRendererId);}return this;};var o={x:-2,y:-2};var r=2;var p=5;[{key:"left",dx:-r,dy:0},{key:"right",dx:+r,dy:0},{key:"up",dx:0,dy:-r},{key:"down",dx:0,dy:+r}].forEach(function(i){a.prototype["onsap"+i.key]=function(e){this.beginGesture(o.x,o.y);this.rotate(i.dx,i.dy);this.endGesture();this.renderFrame();e.preventDefault();e.stopPropagation();};});[{key:"left",dx:-p,dy:0},{key:"right",dx:+p,dy:0},{key:"up",dx:0,dy:-p},{key:"down",dx:0,dy:+p}].forEach(function(i){a.prototype["onsap"+i.key+"modifiers"]=function(e){if(e.shiftKey&&!(e.ctrlKey||e.altKey||e.metaKey)){this.beginGesture(o.x,o.y);this.pan(i.dx,i.dy);this.endGesture();this.renderFrame();e.preventDefault();e.stopPropagation();}};});[{key:"minus",d:0.98},{key:"plus",d:1.02}].forEach(function(i){a.prototype["onsap"+i.key]=function(e){this.beginGesture(this.$().width()/2,this.$().height()/2);this.zoom(i.d);this.endGesture();this.renderFrame();e.preventDefault();e.stopPropagation();};});return a;});
