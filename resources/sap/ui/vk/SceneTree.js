/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/table/TreeTable","sap/ui/table/Column","sap/ui/model/json/JSONModel","sap/m/Title","./CheckEye","./NodeProxy"],function(q,l,C,T,a,J,b,c,N){"use strict";var S=C.extend("sap.ui.vk.SceneTree",{metadata:{library:"sap.ui.vk",properties:{},events:{},associations:{},aggregations:{_tree:{type:"sap.ui.table.TreeTable",multiple:false,visibility:"hidden"}}}});var g=function(i,s){return sap.ui.vk.getResourceBundle().getText(i?"SCENETREE_VISIBILITYSTATEVISIBLE":"SCENETREE_VISIBILITYSTATEHIDDEN");};S.prototype._createNodeForSceneTree=function(n,d,v){var e=v.getVisibilityState(d);return{name:n,id:d,visible:e,checkEyeTooltip:g(e,this)};};S.prototype.setScene=function(s,v){if(this._nodeSelectionChangedBinding==undefined){this._nodeSelectionChangedBinding=this._nodeSelectionChanged.bind(this);this._nodeVisibilityChangedBinding=this._nodeVisibilityChanged.bind(this);}if(this._viewStateManager){this._viewStateManager.detachSelectionChanged(this._nodeSelectionChangedBinding);this._viewStateManager.detachSelectionChanged(this._nodeVisibilityChangedBinding);}this._scene=s;this._viewStateManager=v;if(this._viewStateManager){this._viewStateManager.attachSelectionChanged(this._nodeSelectionChangedBinding);this._viewStateManager.attachVisibilityChanged(this._nodeVisibilityChangedBinding);}this.refresh();};S.prototype.init=function(){if(C.prototype.init){C.prototype.init.apply(this);}var _=new b({text:sap.ui.vk.getResourceBundle().getText("SCENETREE_TITLE"),tooltip:sap.ui.vk.getResourceBundle().getText("SCENETREE_TITLE")});_.onAfterRendering=function(){var $=this.$();$.addClass("sapUiVkTitle");};this._visibilityColumnHeader=new c({checked:true,tooltip:g(true,this),change:function(e){var i=e.getParameters("checked").checked;this.setTooltip(g(i,this));this._toggleVisibilityForAllChildren(this._model.getData(),i);}.bind(this)});this._tree=new T({title:_,columnHeaderHeight:32,columns:[new a({label:sap.ui.vk.getResourceBundle().getText("SCENETREE_NAME"),tooltip:sap.ui.vk.getResourceBundle().getText("SCENETREE_NAME"),template:new sap.m.Text({text:"{name}",maxLines:1,tooltip:"{name}"}),resizable:false}),new a({label:this._visibilityColumnHeader,template:new c({checked:"{visible}",tooltip:"{checkEyeTooltip}"}),width:"2.7em",resizable:false,hAlign:"Center"})],selectionMode:"MultiToggle",selectionBehavior:"RowSelector",visibleRowCountMode:"Auto",expandFirstLevel:false,collapseRecursive:true,rowHeight:32});this.setAggregation("_tree",this._tree,true);this._model=new J();this._tree.setModel(this._model);this._tree.bindRows({path:"/"});this._tree.attachRowSelectionChange(this._nodeSelection.bind(this));this._tree.getBinding("rows").attachChange(this._dataChange.bind(this));this._viewStateManager=null;this._scene=null;this._syncing=false;this._selected={};this._toggled={};this._vsmSelected={};this._forwardTimer=0;this._reverseTimer=0;this._vSyncing=false;this._lastChangeIsExpand=false;this._forwardVTimer=0;this._reverseVTimer=0;this._scrollTimer=0;this._totalNodes=null;};S.prototype.exit=function(){};S.prototype.onBeforeRendering=function(){this._tree.setVisible(true);};S.prototype._pathToNode=function(p,d,t){p=p.substr(1);if(d==undefined){d=this._model.getData();}var n=d;var e=n;var f="";while(p.length>0){var h=p.indexOf("/");if(h>=0){f=p.substr(0,h);p=p.substr(h+1);}else{f=p;p="";}e=n;n=e[f];}if(t!=undefined){e[f]=t;}return n;};S.prototype._indexToNodeId=function(i){var d=this._tree.getContextByIndex(i);if(d){var n=this._pathToNode(d.sPath,d.oModel.oData);return n.id;}else{return null;}};S.prototype._deselectHidden=function(){var v=this._vsmSelected;var d=this._viewStateManager;var e=[];var u={};for(var i=0;;i++){var f=this._indexToNodeId(i);if(f==null){break;}if(v.hasOwnProperty(f)){u[f]=true;}}for(var k in v){if(v.hasOwnProperty(k)&&v[k]==true&&!u.hasOwnProperty(k)&&k!=""){e.push(k);v[k]=false;}}if(e.length>0){this._syncing=true;d.setSelectionState(e,false,true);this._syncing=false;}};S.prototype._nodeSelection=function(e){if(this._tree.getBinding("rows")._aSelectedContexts!=undefined){return;}if(!this._syncing){if(this._forwardTimer>0){clearTimeout(this._forwardTimer);}var p=e.mParameters;var d=p.rowIndices;var f=this._tree.getSelectedIndices();if(d.length>=1&&f.length==1){if(d.indexOf(f[0])!=-1){this._deselectHidden();}}for(var i=0;i<d.length;i++){var h=d[i];if(this._toggled.hasOwnProperty(h)){this._toggled[h]=!this._toggled[h];}else{this._toggled[h]=true;}if(!this._selected.hasOwnProperty(h)){this._selected[h]=false;}}this._forwardTimer=setTimeout(this._resyncSelectionForward.bind(this,d),100);}};S.prototype._nodeSelectionChanged=function(e){if(!this._syncing){if(this._reverseTimer>0){clearTimeout(this._reverseTimer);}var s=e.mParameters.selected;var d=e.mParameters.unselected;for(var i=0;i<d.length;i++){if(this._vsmSelected[d[i]]!=undefined){delete this._vsmSelected[d[i]];}}for(var j=0;j<s.length;j++){this._vsmSelected[s[j]]=true;}if(s.length==1){this._expandToNode(s[0],this._resyncSelectionReverse.bind(this));}else{this._reverseTimer=setTimeout(this._resyncSelectionReverse.bind(this),100,true);}}};S.prototype._resyncSelectionForward=function(t){this._forwardTimer=0;if(this._syncing){return false;}this._syncing=true;for(var i in this._selected){if(this._selected.hasOwnProperty(i)){var d=this._indexToNodeId(parseInt(i,10));if(d==null||d==""){continue;}var e=this._selected[i];if(this._toggled[i]){e=!e;}if(t.indexOf(parseInt(i,10))!==-1){this._viewStateManager.setSelectionState(d,e,true);if(!e){var n=this._viewStateManager.getNodeHierarchy();var f=n.getAncestors(d);var p=f[f.length-1];if(this._viewStateManager._selectedNodes.has(p)){this._viewStateManager.setSelectionState(p,false);var s=this._tree.getSelectedIndices();for(var j=0,h=s.length;j<h;j++){var k=s[j];if(p===this._indexToNodeId(k)){this._selected[k]=false;break;}}this._vsmSelected[p]=false;}}}this._selected[i]=e;this._vsmSelected[d]=e;}}this._toggled={};this._syncing=false;};S.prototype._resyncSelectionReverse=function(s){this._reverseTimer=0;if(this._syncing){return;}this._syncing=true;var v=this._viewStateManager;var t=this._tree;var d=0;this._selected={};for(var i=0;;i++){var e=this._indexToNodeId(i);if(e==null||e==""){break;}var f=v.getSelectionState(e);if(f){this._selected[i]=true;d++;}if(f!=t.isIndexSelected(i)){if(f){t.addSelectionInterval(i,i);}else{t.removeSelectionInterval(i,i);}}}this._syncing=false;};S.prototype._expandToNode=function(n,d){var t=this._totalNodes;var e=function(m,o){o.forEach(function(r){m=m[r];});return m;};var f=function(m,r,o){var u;if((r<m)||(r>=(m+o))){u=r-(o/2);}else{u=m;}u=u>0?Math.floor(u):0;return u;};var s=function(m,r){var o=m.getVisibleRowCount(),u=m.getFirstVisibleRow(),v=f(u,r,o);if(v!==u){m.setFirstVisibleRow(v);}};var h=function(m,n){var r=null,o;for(var u=0;u<t;u++){o=m.getContextByIndex(u);if(o){var v=o.getPath().split("/");v.shift();var w=o.getModel().getData();if(e(w,v).id===n){r=u;break;}}}return r;};var i=this._scene.getDefaultNodeHierarchy(),j=i.getAncestors(n);var k=function(m,o,j,r){if(r.getParameter("reason")==="expand"){m(o,j);}};var p=function(m,j){setTimeout(function(){if(j.length){var o=j.shift();var r=h(m,o);if(r!==null){m.expand(r);}}else{var u=h(m,n);if(u!==null){s(m,u);m.getBinding("rows").detachChange(k.bind(this,p));d();}}},70);};this._tree.getBinding("rows").attachChange(k.bind(this,p,this._tree,j));p(this._tree,j);};S.prototype._dataChange=function(e){if(this._viewStateManager==null||this._scene==null||this._vSyncing){return;}if(this._lastChangeIsExpand){this._lastChangeIsExpand=false;return;}if(this._forwardVTimer>0){clearTimeout(this._forwardVTimer);}this._forwardVTimer=setTimeout(this._resyncVisibilityForward.bind(this),100);};S.prototype._resyncVisibilityForward=function(){if(!this._vSyncing){this._vSyncing=true;this._forwardVTimer=0;this._setNodeVisibilityRecursive(this._model.getData(),this._viewStateManager);this._vSyncing=false;}};S.prototype._enumerateChildrenIntoArray=function(n,d){var e=this._scene.getDefaultNodeHierarchy();e.enumerateChildren(n,function(p){var i=p.getNodeId();d.push(i);if(p.getHasChildren()){this._enumerateChildrenIntoArray(i,d);}});};S.prototype._setNodeVisibilityRecursive=function(n,v){if(n.id!=null&&v.getVisibilityState(n.id)!=n.visible){v.setVisibilityState(n.id,n.visible,true);if(n[0]!=undefined){if(this._reverseVTimer>0){clearTimeout(this._reverseVTimer);}this._reverseVTimer=setTimeout(this._resyncVisibilityReverse.bind(this),100);}}else{for(var i=0;n[i]!=null;i++){this._setNodeVisibilityRecursive(n[i],v);}}};S.prototype._toggleVisibilityForAllChildren=function(n,d){for(var i=0;n[i]!=null;i++){this._viewStateManager.setVisibilityState(n[i].id,d,true);}};S.prototype._nodeVisibilityChanged=function(e){if(!this._vSyncing){if(this._reverseVTimer>0){clearTimeout(this._reverseVTimer);}this._reverseVTimer=setTimeout(this._resyncVisibilityReverse.bind(this),100);}};S.prototype._resyncVisibilityReverse=function(){if(!this._vSyncing){this._vSyncing=true;this._forwardVTimer=0;this._getNodeVisibilityRecursive(this._model.getData(),this._viewStateManager);this._tree.getModel().refresh(true);this._vSyncing=false;}};S.prototype._getNodeVisibilityRecursive=function(n,v){if(n.id!=null){n.visible=v.getVisibilityState(n.id);n.checkEyeTooltip=g(n.visible,this);}for(var i=0;n[i]!=null;i++){this._getNodeVisibilityRecursive(n[i],v);}};S.prototype.refresh=function(){if(this._scene==null){this._model.setData([]);return;}var n=this._scene.getDefaultNodeHierarchy();var t={};this._totalNodes=0;var d=function(t,e){e.forEach(function(f,i){var h=new N(n,f);var j=this._createNodeForSceneTree(h.getName(),h.getNodeId(),this._viewStateManager);t[i]=j;h.destroy();this._totalNodes++;d.bind(this)(t[i],n.getChildren(f));}.bind(this));};d.bind(this)(t,n.getChildren());this._model.setData(t);this._tree.setModel(this._model);this._tree.bindRows({path:"/"});this._tree.getBinding("rows").attachChange(this._dataChange.bind(this));this._visibilityColumnHeader.setChecked(true);this._visibilityColumnHeader.setTooltip(g(true,this));};S.prototype.onAfterRendering=function(){};return S;},true);
