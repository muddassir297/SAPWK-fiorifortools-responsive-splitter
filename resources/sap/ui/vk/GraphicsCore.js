/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/base/EventProvider","./ve/thirdparty/html2canvas","./ve/dvl","./Scene","./NodeHierarchy","./ContentResource","./DownloadManager","./ViewStateManager","./DvlException","./Messages"],function(q,l,E,H,D,S,N,C,a,V,b,M){"use strict";var c=q.sap.log;function g(s){return s instanceof File?"local":"remote";}function d(s){return s instanceof File?s.name:s;}var e=function(s){Object.defineProperties(this,{source:{value:s,writable:false,enumerable:true},_refCount:{value:0,writable:true,enumerable:false}});};e.prototype.isInUse=function(){return this._refCount>0;};e.prototype.addRef=function(){++this._refCount;return this;};e.prototype.release=function(){--this._refCount;return this;};e.prototype.destroy=function(){};var f=function(s,v,i){e.call(this,s);Object.defineProperties(this,{content:{value:i,writable:false,enumerable:true},vdsSourceDatum:{value:v,writable:false,enumerable:true}});};f.prototype=Object.create(e.prototype);f.prototype.constructor=f;f.prototype.destroy=function(){if(this.vdsSourceDatum){this.vdsSourceDatum.release();}e.prototype.destroy.call(this);};var h=function(i,s,r){Object.defineProperties(this,{dvlSceneId:{value:i,writable:false,enumerable:true},sourceDatum:{value:s,writable:false,enumerable:true},root:{value:!!r,writable:false,enumerable:true},_refCount:{value:0,writable:true,enumerable:false}});};h.prototype.isInUse=function(){return this._refCount>0;};h.prototype.addRef=function(){++this._refCount;return this;};h.prototype.release=function(){--this._refCount;return this;};h.prototype.destroy=function(){if(this.sourceDatum){this.sourceDatum.release();}};var j=function(i,m){Object.defineProperties(this,{source:{value:i.getSource()},sourceType:{value:i.getSourceType()},sourceId:{value:i.getSourceId(),writable:true},name:{value:i.getName()},localMatrix:{value:i.getLocalMatrix(),writable:true},password:{value:i.getPassword()},children:{value:i.getContentResources().map(function(i){return new j(i);})},dvlSceneDatum:{value:null,writable:true},nodeProxy:{value:null,writable:true},fake:{value:!!m},sourceProperties:{value:null,writable:true}});i._shadowContentResource=this;};j.prototype.destroy=function(){if(this.dvlSceneDatum){this.dvlSceneDatum.release();}};var k=function(v,s){Object.defineProperties(this,{vkScene:{value:v},shadowContentResource:{value:s}});};var G=E.extend("sap.ui.vk.GraphicsCore",{metadata:{publicMethods:["buildSceneTree","createViewStateManager","destroyScene","destroyViewStateManager","getApi","loadContentResourcesAsync","showDebugInfo"]},constructor:function(r,w){E.apply(this);var s=q.extend({},r,{filePackagePrefixURL:q.sap.getResourcePath("sap/ve")+"/"});this._dvlClientId=q.sap.uid();this._dvl=sap.ve.dvl.createRuntime(s);this._dvl.CreateCoreInstance(this._dvlClientId);sap.ui.vk.dvl.checkResult(this._dvl.Core.Init(this._DVLMajorVersion,this._DVLMinorVersion));var u=sap.ui.getCore();u.attachLocalizationChanged(this._onlocalizationChanged,this);sap.ui.vk.dvl.checkResult(this._dvl.Core.SetLocale(u.getConfiguration().getLanguageTag()));this._canvas=this._createRenderingCanvasAndContext(w);this._dvl.Core.InitRenderer();this._sourceData=[];this._dvlSceneData=[];this._vkSceneData=[];this._viewports=[];this._viewStateManagers=[];},_DVLMajorVersion:6,_DVLMinorVersion:2});G.prototype.destroy=function(){sap.ui.getCore().detachLocalizationChanged(this._onlocalizationChanged,this);this._viewports.slice().forEach(function(v){v.setGraphicsCore(null);});this._viewports=null;this._cleanupVkSceneData();this._vkSceneData=null;this._cleanupDvlSceneData();this._dvlSceneData=null;this._cleanupSourceData();this._sourceData=null;this._viewStateManagers.slice().forEach(this.destroyViewStateManager.bind(this));this._viewStateManagers=null;this._webGLContext=null;this._canvas=null;this._dvl.Core.DoneRenderer();this._dvl.Core.Release();this._dvl=null;E.prototype.destroy.apply(this);};G.prototype._createRenderingCanvasAndContext=function(w){var i=document.createElement("canvas");i.id=q.sap.uid();this._webGLContext=this._dvl.Core.CreateWebGLContext(i,w);return i;};G.prototype._getCanvas=function(){return this._canvas;};G.prototype._getWebGLContext=function(){return this._webGLContext;};G.prototype._getDvl=function(){return this._dvl;};G.prototype._getDvlClientId=function(){return this._dvlClientId;};G.prototype._findSourceData=function(p){var i=Object.getOwnPropertyNames(p);return this._sourceData.filter(function(m){return i.every(function(n){return p[n]===m[n];});});};G.prototype._destroySourceDatum=function(s){if(!(s instanceof f)){this._dvl.Core.DeleteFileByUrl(d(s.source),g(s.source));}s.destroy();return this;};G.prototype._cleanupSourceData=function(){var n=false;for(var i=this._sourceData.length-1;i>=0;--i){var s=this._sourceData[i];if(!s.isInUse()){var r=s instanceof f?s.vdsSourceDatum:null;this._sourceData.splice(i,1);this._destroySourceDatum(s);if(r&&!r.isInUse()){n=true;}}}if(n){this._cleanupSourceData();}return this;};G.prototype._findDvlSceneData=function(p){var i=Object.getOwnPropertyNames(p);return this._dvlSceneData.filter(function(m){return i.every(function(n){return p[n]===m[n];});});};G.prototype._destroyDvlSceneDatum=function(i){this._dvl.Scene.Release(i.dvlSceneId);i.destroy();return this;};G.prototype._cleanupDvlSceneData=function(){for(var i=this._dvlSceneData.length-1;i>=0;--i){var m=this._dvlSceneData[i];if(!m.isInUse()){this._dvlSceneData.splice(i,1);this._destroyDvlSceneDatum(m);}}};G.prototype._findVkSceneData=function(p){var i=Object.getOwnPropertyNames(p);return this._vkSceneData.filter(function(m){return i.every(function(n){return p[n]===m[n];});});};G.prototype._cleanupVkSceneData=function(){for(var i=this._vkSceneData.length-1;i>=0;--i){this.destroyScene(this._vkSceneData[i].vkScene);}};G.prototype._destroyShadowContentResource=function(v,s){if(s.children){s.children.forEach(this._destroyShadowContentResource.bind(this,v));}if(s.nodeProxy){this._dvl.Scene.DeleteNode(v._getDvlSceneId(),s.nodeProxy.getNodeId());v.getDefaultNodeHierarchy().destroyNodeProxy(s.nodeProxy);}s.destroy();};G.prototype._filterContentResources=function(i,m){var r=[];i.forEach(function enumerate(n){if(m(n)){r.push(n);}n.getContentResources().forEach(enumerate);});return r;};G.prototype._getContentResourcesWithMissingPasswords=function(i){var l=this._dvl.Library;return this._filterContentResources(i,function(m){var s=m.getSource();return s&&(l.RetrieveInfo(d(s),g(s)).flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED)&&!m.getPassword();});};G.prototype._getContentResourcesWithEncryptedVds3=function(i){var l=this._dvl.Library;return this._filterContentResources(i,function(m){var s=m.getSource();if(s){var n=l.RetrieveInfo(d(s),g(s));return n.major<=3&&(n.flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED);}else{return false;}});};G.prototype._collectSourceProperties=function(s){var i=this._dvl.Library.RetrieveInfo(d(s.source),g(s.source));s.sourceProperties={version:{major:i.major,minor:i.minor}};if(i.flags&(sap.ve.dvl.DVLFILEFLAG.PAGESCOMPRESSED|sap.ve.dvl.DVLFILEFLAG.WHOLEFILECOMPRESSED)){s.sourceProperties.compressed=true;}if(i.flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED){s.sourceProperties.encrypted=true;}return this;};G.prototype.loadContentResourcesAsync=function(i,o,n){var t=this,s=[],v=new Map();i.forEach(function enumerate(m){var w=m.getSource();if(w&&s.indexOf(w)<0&&t._findSourceData({source:w}).length===0){s.push(w);if(m.getSourceType()==="vdsl"){v.set(w,{});}}m.getContentResources().forEach(enumerate);});var p=[];if(s.length>0){var r;var u=new a(s).attachItemSucceeded(function(w){var x=w.getParameter("source");var y=w.getParameter("response");if(v.has(x)){var z=sap.ui.vk.utf8ArrayBufferToString(y);if(z.trim().length===0){r=r||[];r.push({source:x,status:M.VIT22.code,statusText:sap.ui.vk.getResourceBundle().getText(M.VIT22.summary)});c.error(sap.ui.vk.getResourceBundle().getText(M.VIT22.summary),M.VIT22.code,"sap.ui.vk.GraphicsCore");return;}else{var A=z.split(/\n|\r\n/);var m=A[0].match(/^file=(.+)$/);if(!m){r=r||[];r.push({source:x,status:M.VIT23.code,statusText:sap.ui.vk.getResourceBundle().getText(M.VIT23.summary)});c.error(sap.ui.vk.getResourceBundle().getText(M.VIT23.summary),M.VIT23.code,"sap.ui.vk.GraphicsCore");return;}else{var B=v.get(x);B.content=A;var F=m[1];var I=F;var J=new URI(I);if(J.is("relative")){if(x instanceof File){r=r||[];r.push({source:x,status:M.VIT24.code,statusText:sap.ui.vk.getResourceBundle().getText(M.VIT24.summary)});c.error(sap.ui.vk.getResourceBundle().getText(M.VIT24.summary),M.VIT24.code,"sap.ui.vk.GraphicsCore");return;}else{var K=new URI(x);F=J.absoluteTo(K).href();}}B.referencedSource=F;B.content[0]=B.content[0].replace(I,this._dvl.Core.GetFilename(B.referencedSource,"remote"));if(s.indexOf(B.referencedSource)<0&&this._findSourceData({source:B.referencedSource}).length===0){s.push(B.referencedSource);u.queue(B.referencedSource);}}}}else{var L=x instanceof File;var O=L?x.name:x;var P=g(x);this._dvl.Core.CreateFileFromArrayBuffer(y,O,P);p.push(new e(x));}},this).attachAllItemsCompleted(function(m){if(r){p.forEach(this._destroySourceDatum.bind(this));}else{Array.prototype.push.apply(this._sourceData,p);v.forEach(function(w,x){var y=this._findSourceData({source:w.referencedSource})[0];var z=new f(x,y,w.content.join("\n"));this._sourceData.push(z);y.addRef();}.bind(this));}if(o){o(r);}},this).attachItemFailed(function(m){r=r||[];r.push({source:m.getParameter("source"),status:m.getParameter("status"),statusText:m.getParameter("statusText")});},this);if(n){u.attachItemProgress(n,this);}u.start();}else if(o){o();}return this;};G.prototype._mergeContentResource=function(i,n,m,o,s){var p=this._dvl.Scene.CreateNode(i,m,s.name,o);s.nodeProxy=n.createNodeProxy(p);if(s.localMatrix){s.nodeProxy.setLocalMatrix(s.localMatrix);}if(s.source){var r=this._findSourceData({source:s.source})[0];var t=this._findDvlSceneData({sourceDatum:r,root:false})[0];if(!t){t=new h(sap.ui.vk.dvl.getPointer(r instanceof f?this._dvl.Core.LoadSceneFromVDSL(r.content,s.password):this._dvl.Core.LoadSceneByUrl(d(s.source),s.password,g(s.source))),r,false);this._dvlSceneData.push(t);r.addRef();this._collectSourceProperties(s);if(s.sourceProperties.version.major>=4){c.warning(sap.ui.vk.getResourceBundle().getText(M.VIT20.summary),M.VIT20.code,"sap.ui.vk.GraphicsCore");}}s.dvlSceneDatum=t;t.addRef();this._dvl.Scene.RetrieveSceneInfo(t.dvlSceneId,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN).ChildNodes.forEach(function(u){this._dvl.Scene.CreateNodeCopy(i,u,p,sap.ve.dvl.DVLCREATENODECOPYFLAG.COPY_CHILDREN);}.bind(this));}s.children.forEach(this._mergeContentResource.bind(this,i,n,p,undefined));};G.prototype.buildSceneTree=function(i){if(i.length===0){return null;}var r;var m;var s=i.map(function(p){return new j(p);});if(s.length===1){m=s[0];if(m.source){var n=this._findSourceData({source:m.source})[0];r=new h(sap.ui.vk.dvl.getPointer(n instanceof f?this._dvl.Core.LoadSceneFromVDSL(n.content,m.password):this._dvl.Core.LoadSceneByUrl(d(m.source),m.password,g(m.source))),n,true);n.addRef();this._collectSourceProperties(m);if(m.sourceProperties.version.major>=4){c.warning(sap.ui.vk.getResourceBundle().getText(M.VIT20.summary),M.VIT20.code,"sap.ui.vk.GraphicsCore");}}else{r=new h(this._dvl.Core.CreateEmptyScene(),null,true);}}else{var o=new C({sourceType:"vds",sourceId:q.sap.uid()});m=new j(o,true);o.destroy();o=null;Array.prototype.push.apply(m.children,s);s=[m];r=new h(this._dvl.Core.CreateEmptyScene(),null,true);}this._dvlSceneData.push(r);m.dvlSceneDatum=r;r.addRef();var v=new S(this,r.dvlSceneId);this._vkSceneData.push(new k(v,m));m.children.forEach(this._mergeContentResource.bind(this,r.dvlSceneId,v.getDefaultNodeHierarchy(),null,undefined));return v;};G.prototype.updateSceneTree=function(v,m,o){if(m.length===0){return null;}var n=this._getContentResourcesWithEncryptedVds3(m);if(n.length>0){c.error(sap.ui.vk.getResourceBundle().getText(M.VIT25.summary),M.VIT25.code,"sap.ui.vk.GraphicsCore");if(o){o({contentResourcesWithEncryptedVds3:n});}return null;}var p=this._getContentResourcesWithMissingPasswords(m);if(p.length>0){c.error(sap.ui.vk.getResourceBundle().getText(M.VIT21.summary),M.VIT21.code,"sap.ui.vk.GraphicsCore");if(o){o({contentResourcesWithMissingPasswords:p});}return null;}if(!v){return this.buildSceneTree(m);}var r=this._findVkSceneData({vkScene:v})[0].shadowContentResource;var s=!!r.source;var t=m.length===1&&!!m[0].getSource();if(!(s&&t&&r.source===m[0].getSource()||!s&&!t&&r.fake===m.length>1)){return this.buildSceneTree(m);}var u=this;var w=v._getDvlSceneId();var x=v.getDefaultNodeHierarchy();function y(z,m,A){function B(J,K){if(!J&&!K){return true;}else if(!!J^!!K){return false;}else{return J.source===K.getSource()&&J.sourceType===K.getSourceType()&&J.name===K.getName()&&J.password===K.getPassword();}}function F(J,K){K._shadowContentResource=J;J.sourceId=K.getSourceId();J.localMatrix=K.getLocalMatrix();if(J.nodeProxy){J.nodeProxy.setLocalMatrix(J.localMatrix);}}var i=0;var I=q.sap.arrayDiff(z,m,B,true);I.forEach(function(J){for(;i<J.index;++i){y(z[i].children,m[i].getContentResources(),z[i].nodeProxy.getNodeId());F(z[i],m[i]);}if(J.type==="delete"){u._destroyShadowContentResource(v,z[J.index]);z.splice(J.index,1);}else if(J.type==="insert"){var K;if(i<z.length&&z[i].nodeProxy){K=z[i].nodeProxy.getNodeId();}var L=new j(m[J.index]);u._mergeContentResource(w,x,A,K,L);z.splice(J.index,0,L);++i;}});for(;i<z.length;++i){y(z[i].children,m[i].getContentResources(),z[i].nodeProxy&&z[i].nodeProxy.getNodeId());F(z[i],m[i]);}}y(r.fake?r.children:[r],m,0);x.fireChanged();return v;};G.prototype.destroyScene=function(v){var i;for(i=0;i<this._vkSceneData.length;++i){if(this._vkSceneData[i].vkScene===v){break;}}if(i===this._vkSceneData.length){c.warning("Scene with id '"+v.getId()+"' is not created by this GraphicsCore.");return this;}var m=this._vkSceneData.splice(i,1)[0];this._destroyShadowContentResource(v,m.shadowContentResource);v.destroy();return this;};G.prototype._registerViewport=function(v){if(this._viewports.indexOf(v)>=0){return false;}this._viewports.push(v);return true;};G.prototype._unregisterViewport=function(v){var i=this._viewports.indexOf(v);if(i<0){return false;}this._viewports.splice(i,1);return true;};G.prototype._getViewportCount=function(){return this._viewports.length;};G.prototype.createViewStateManager=function(n,s,i){var v=new V(n,s,i);this._viewStateManagers.push(v);return v;};G.prototype.destroyViewStateManager=function(v){var i=this._viewStateManagers.indexOf(v);if(i>=0){this._viewStateManagers.splice(i,1)[0].destroy();}return this;};G.prototype.showDebugInfo=function(i){this._viewports.forEach(function(v){v.setShowDebugInfo(i);});return this;};G.prototype.getApi=function(i){switch(i){case sap.ui.vk.GraphicsCoreApi.LegacyDvl:return this._dvl;default:return null;}};G.prototype.collectGarbage=function(){this._cleanupDvlSceneData();this._cleanupSourceData();return this;};G.prototype._onlocalizationChanged=function(i){if(i.getParameter("changes").language){sap.ui.vk.dvl.checkResult(this._dvl.Core.SetLocale(sap.ui.getCore().getConfiguration().getLanguageTag()));}};G.prototype.setDecryptionHandler=function(i){this._dvl.Client.setDecryptionHandler(i);return this;};G.prototype.getDecryptionHandler=function(){return this._dvl.Client.getDecryptionHandler();};return G;});
