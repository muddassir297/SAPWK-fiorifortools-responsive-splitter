/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","./Scene","./ContentResource","sap/ui/layout/Splitter","sap/ui/layout/SplitterLayoutData","./FlexibleControl","./FlexibleControlLayoutData","sap/ui/core/ResizeHandler","./DvlException","./Messages","./ProgressIndicator","./Notifications"],function(q,l,C,S,a,b,c,F,d,R,D,M,P,N){"use strict";var f=q.sap.log;sap.ui.lazyRequire("sap.ui.vk.NativeViewport");sap.ui.lazyRequire("sap.ui.vk.Overlay");sap.ui.lazyRequire("sap.ui.vk.SceneTree");sap.ui.lazyRequire("sap.ui.vk.StepNavigation");sap.ui.lazyRequire("sap.ui.vk.Toolbar");sap.ui.lazyRequire("sap.ui.vk.Viewport");var V=C.extend("sap.ui.vk.Viewer",{metadata:{library:"sap.ui.vk",properties:{enableOverlay:{type:"boolean",defaultValue:false},enableSceneTree:{type:"boolean",defaultValue:true},showSceneTree:{type:"boolean",defaultValue:true},enableStepNavigation:{type:"boolean",defaultValue:true},enableNotifications:{type:"boolean",defaultValue:true},showStepNavigation:{type:"boolean",defaultValue:false},showStepNavigationThumbnails:{type:"boolean",defaultValue:true},enableToolbar:{type:"boolean",defaultValue:true},enableFullScreen:{type:"boolean",defaultValue:false},enableProgressIndicator:{type:"boolean",defaultValue:true},width:{type:"sap.ui.core.CSSSize",defaultValue:"auto"},height:{type:"sap.ui.core.CSSSize",defaultValue:"auto"},toolbarTitle:{type:"string",defaultValue:""},shouldTrackVisibilityChanges:{type:"boolean",defaultValue:false},runtimeSettings:{type:"object"},webGLContextAttributes:{type:"object"},showAllHotspots:{type:"boolean",defaultValue:false},hotspotColorABGR:{type:"int",defaultValue:0xc00000ff}},publicMethods:["getGraphicsCore","getNativeViewport","getScene","getViewport","getViewStateManager"],aggregations:{contentResources:{type:"sap.ui.vk.ContentResource"},overlay:{type:"sap.ui.vk.Overlay",multiple:false},toolbar:{type:"sap.ui.vk.Toolbar",multiple:false,visibility:"hidden"},progressIndicator:{type:"sap.ui.vk.ProgressIndicator",multiple:false,visibility:"hidden"},viewport:{type:"sap.ui.vk.Viewport",multiple:false,visibility:"hidden"},nativeViewport:{type:"sap.ui.vk.NativeViewport",multiple:false,visibility:"hidden"},stepNavigation:{type:"sap.ui.vk.StepNavigation",multiple:false,visibility:"hidden"},sceneTree:{type:"sap.ui.vk.SceneTree",multiple:false,visibility:"hidden"},layout:{type:"sap.ui.vk.FlexibleControl",multiple:false,visibility:"hidden"},viewStateManager:{type:"sap.ui.vk.ViewStateManager",multiple:false,visibility:"hidden"},messagePopover:{type:"sap.ui.vk.Notifications",multiple:false,visibility:"hidden"}},events:{contentResourceChangesProcessed:{},sceneLoadingSucceeded:{parameters:{scene:{type:"sap.ui.vk.Scene"}}},sceneLoadingFailed:{parameters:{reason:{type:"object"}}},sceneDestroying:{parameters:{scene:{type:"sap.ui.vk.Scene"}}},selectionChanged:{parameters:{selected:{type:"string[]"},unselected:{type:"string[]"}}},fullScreen:{parameters:{isFullScreen:{type:"boolean"}}},urlClicked:{parameters:{nodeId:"string",url:"string"}},nodeClicked:{parameters:{nodeId:"string",x:"int",y:"int"}}}}});V.prototype.applySettings=function(s){if(s){this._runtimeSettings=s.runtimeSettings;this._webGLContextAttributes=s.webGLContextAttributes;delete s.runtimeSettings;delete s.webGLContextAttributes;}C.prototype.applySettings.apply(this,arguments);this._componentsState={sceneTree:{defaultEnable:this.getEnableSceneTree(),shouldBeEnabled:true,userInteractionShow:this.getShowSceneTree()},stepNavigation:{defaultEnable:this.getEnableStepNavigation(),userInteractionShow:this.getShowStepNavigation()},progressIndicator:{defaultEnable:this.getEnableProgressIndicator()},messagePopover:{defaultEnable:this.getEnableNotifications()}};this.setEnableSceneTree(false);this.setEnableStepNavigation(false);};V.prototype.init=function(){this._messagePopover=new N();this.setAggregation("messagePopover",this._messagePopover);this._messagePopover.attachAllMessagesCleared(function(){this._messagePopover.setVisible(false);this._updateLayout();},this);this._messagePopover.attachMessageAdded(function(){this._messagePopover.setVisible(true);this._updateLayout();},this);f.debug("sap.ui.vk.Viewer.init() called.");if(C.prototype.init){C.prototype.init.apply(this);}this._scheduleContentResourcesUpdateTimerId=null;this._resizeListenerId=null;this._busyIndicatorCounter=0;this._toolbar=null;this._viewport=null;this._nativeViewport=null;this._redlineDesign=null;this._stepNavigation=null;this._mainScene=null;this._sceneTree=null;this._overlayManager={initialized:false,changed:false,control:null,onNativeViewportMove:function(e){var p=e.getParameter("pan");var z=e.getParameter("zoom");this.control.setPanAndZoom(p.x,p.y,z);},onViewportZoom:function(e){var z=e.getParameter("zoomFactor");this.control.setPanAndZoom(0,0,z);},onViewportPan:function(e){var g=e.getParameter("dx");var h=e.getParameter("dy");this.control.setPanAndZoom(g,h,1);}};this._overlayManager.delegate={onAfterRendering:this._onAfterRenderingOverlay.bind(this,this._viewport,this._nativeViewport,this._overlayManager)};this._updateSizeTimer=0;this._fullScreenToggle=false;this._content=new b(this.getId()+"-splitter",{orientation:"Horizontal"});this._stackedViewport=new F({width:"100%",height:"100%",layout:"Stacked"});this._layout=new F(this.getId()+"-flexibleControl",{width:"100%",height:"100%",layout:"Vertical"});this._stackedViewport.setLayoutData(new c({size:"100%",minSize:160,resizable:true}));this._content.addContentArea(this._stackedViewport);this.setAggregation("layout",this._layout);this.setTooltip(sap.ui.vk.getResourceBundle().getText("VIEWER_TITLE"));if(this.getEnableProgressIndicator()){this._createProgressIndicator();}};V.prototype.exit=function(){f.debug("sap.ui.vk.Viewer.exit() called.");if(this._scheduleContentResourcesUpdateTimerId){q.sap.clearDelayedCall(this._scheduleContentResourcesUpdateTimerId);this._scheduleContentResourcesUpdateTimerId=null;}if(this._viewport){this._viewport.detachEvent("viewActivated",this._onViewportViewActivated,this);}this._setMainScene(null);this._toolbar=null;this._messagePopover=null;this._sceneTree=null;this._nativeViewport=null;this._stepNavigation=null;this._viewport=null;this._componentsState=null;this._setViewStateManager(null);if(this._graphicsCore){this._graphicsCore.destroy();this._graphicsCore=null;}if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}if(C.prototype.exit){C.prototype.exit.apply(this);}};V.prototype._setMainScene=function(s,e){if(s){if(s!==this._mainScene){this._mainScene=s;this._showViewport();this._viewport.setScene(this._mainScene);this._setViewStateManager(this._graphicsCore.createViewStateManager(this._mainScene.getDefaultNodeHierarchy(),this.getShouldTrackVisibilityChanges(),e));this._viewport.setViewStateManager(this.getViewStateManager());if(this._componentsState.sceneTree.defaultEnable){this._instantiateSceneTree();this._sceneTree.setScene(this._mainScene,this.getViewStateManager());this.setEnableSceneTree(true);if(this._componentsState.sceneTree.userInteractionShow&&this._componentsState.sceneTree.shouldBeEnabled){this.setShowSceneTree(true);this._sceneTree.setVisible(true);}else{this.setShowSceneTree(false);}}if(this._componentsState.stepNavigation.defaultEnable){this._instantiateStepNavigation();this._stepNavigation.setScene(this._mainScene);this.setEnableStepNavigation(true);if(this._componentsState.stepNavigation.userInteractionShow){this.setShowStepNavigation(true);this._stepNavigation.setVisible(true);}else{this.setShowStepNavigation(false);}}}else{this.getViewStateManager().setCanTrackVisibilityChanges(e);}if(this._sceneTree){this._sceneTree.refresh();}if(this._stepNavigation){this._stepNavigation.refresh(s);}}else{this._mainScene=null;this._setViewStateManager(null);if(this._viewport){this._viewport.setScene(null);}if(this._sceneTree){this._sceneTree.setScene(null,null);}if(this._stepNavigation){this._stepNavigation.setScene(null);}this.setEnableSceneTree(false);this.setEnableStepNavigation(false);}return this;};V.prototype._destroyMainScene=function(){if(this._mainScene){var s=this._mainScene;this.fireSceneDestroying({scene:s});this._setMainScene(null);this._graphicsCore.destroyScene(s);}else if(this._nativeViewport){this.fireSceneDestroying({scene:null});}return this;};V.prototype.getGraphicsCore=function(){if(!this._graphicsCore){q.sap.require("sap.ui.vk.GraphicsCore");this._graphicsCore=new sap.ui.vk.GraphicsCore(this._getRuntimeSettings(),q.extend({antialias:true,alpha:true,premultipliedAlpha:true},this._getWebGLContextAttributes()));if(this._deferredDecryptionHandler){this._graphicsCore.setDecryptionHandler(this._deferredDecryptionHandler);delete this._deferredDecryptionHandler;}}return this._graphicsCore;};V.prototype.getScene=function(){return this._mainScene;};V.prototype.getViewStateManager=function(){return this.getAggregation("viewStateManager");};V.prototype._setViewStateManager=function(v){if(!this._graphicsCore){return this;}if(v===this.getViewStateManager()){return this;}if(this.getViewStateManager()){this._graphicsCore.destroyViewStateManager(this.getViewStateManager());}this.setAggregation("viewStateManager",v,true);return this;};V.prototype.getViewport=function(){return this._viewport;};V.prototype.getNativeViewport=function(){return this._nativeViewport;};V.prototype.getRedlineDesign=function(){return this._redlineDesign;};V.prototype._getRuntimeSettings=function(){return this._runtimeSettings;};V.prototype._getWebGLContextAttributes=function(){return this._webGLContextAttributes;};V.prototype.getOverlay=function(){return this._overlayManager.control;};V.prototype.setEnableOverlay=function(p){if(p!==this.getProperty("enableOverlay")){this.setProperty("enableOverlay",p);this._overlayManager.changed=true;}return this;};V.prototype.setEnableSceneTree=function(p){this.setProperty("enableSceneTree",p,true);if(!p){this.setProperty("showSceneTree",false);}this._updateLayout();return this;};V.prototype.setEnableNotifications=function(p){this.setProperty("enableNotifications",p,true);this._messagePopover.setVisible(false);this._updateLayout();return this;};V.prototype.setShowSceneTree=function(p){this.setProperty("showSceneTree",p,true);this._updateLayout();return this;};V.prototype.setEnableStepNavigation=function(p){this.setProperty("enableStepNavigation",p,true);if(!p){this.setProperty("showStepNavigation",false);}this._updateLayout();return this;};V.prototype.setShowStepNavigation=function(p){this.setProperty("showStepNavigation",p,true);this._updateLayout();return this;};V.prototype.setEnableToolbar=function(p){this.setProperty("enableToolbar",p,true);this._updateLayout();return this;};V.prototype.setEnableFullScreen=function(p){var i=function(j){return j.fullScreen||j.webkitIsFullScreen||j.mozFullScreen||j.msFullscreenElement;};this.setProperty("enableFullScreen",p,true);this._fullScreenToggle=true;var e=this.getProperty("enableFullScreen");var g=false;if(e){if(!i(document)){if(!this._fullScreenHandler){this._fullScreenHandler=function(j){if(!i(document)){document.removeEventListener("fullscreenchange",this._fullScreenHandler.bind(this));document.removeEventListener("mozfullscreenchange",this._fullScreenHandler.bind(this));document.removeEventListener("webkitfullscreenchange",this._fullScreenHandler.bind(this));document.removeEventListener("MSFullscreenChange",this._fullScreenHandler.bind(this));this.removeStyleClass("sapVizKitViewerFullScreen");this._updateSize();this.fireFullScreen({isFullScreen:false});}};document.addEventListener("fullscreenchange",this._fullScreenHandler.bind(this));document.addEventListener("mozfullscreenchange",this._fullScreenHandler.bind(this));document.addEventListener("webkitfullscreenchange",this._fullScreenHandler.bind(this));document.addEventListener("MSFullscreenChange",this._fullScreenHandler.bind(this));}g=true;var h=document.getElementsByTagName("body")[0];if(h.requestFullScreen){h.requestFullScreen();}else if(h.webkitRequestFullScreen){h.webkitRequestFullScreen();}else if(h.mozRequestFullScreen){h.mozRequestFullScreen();}else if(h.msRequestFullscreen){h.msRequestFullscreen();}else{g=false;}if(g){this.addStyleClass("sapVizKitViewerFullScreen");}}}else if(i(document)){g=true;if(document.cancelFullScreen){document.cancelFullScreen();}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}else{g=false;}if(g){this.removeStyleClass("sapVizKitViewerFullScreen");}}if(g){this._updateSize();this.fireFullScreen({isFullScreen:e});}return this;};V.prototype.getShowAllHotspots=function(){return this.getViewport()?this.getViewport().getShowAllHotspots():this.getProperty("showAllHotspots");};V.prototype.setShowAllHotspots=function(v){this.setProperty("showAllHotspots",v,true);if(this.getViewport()){this.getViewport().setShowAllHotspots(v);}return this;};V.prototype.getHotspotColorABGR=function(){return this.getViewport()?this.getViewport().getHotspotColorABGR():this.getProperty("hotspotColorABGR");};V.prototype.setHotspotColorABGR=function(v){this.setProperty("hotspotColorABGR",v,true);if(this.getViewport()){this.getViewport().setHotspotColorABGR(v);}return this;};V.prototype.setRuntimeSettings=function(s){f.error(sap.ui.vk.getResourceBundle().getText(M.VIT29.summary),M.VIT29.code,"sap.ui.vk.Viewer");};V.prototype.setWebGLContextAttributes=function(o){f.error(sap.ui.vk.getResourceBundle().getText(M.VIT30.summary),M.VIT30.code,"sap.ui.vk.Viewer");};V.prototype.invalidate=function(o){if(o instanceof a){this._scheduleContentResourcesUpdate();return;}C.prototype.invalidate.apply(this,arguments);};V.prototype._queueContentResourcesUpdateIfNeeded=function(e){if(e==="contentResources"){this._scheduleContentResourcesUpdate();return true;}};V.prototype.addAggregation=function(e,o,s){if(this._queueContentResourcesUpdateIfNeeded(e)){s=true;}return C.prototype.addAggregation.call(this,e,o,s);};V.prototype.insertAggregation=function(e,o,i,s){if(this._queueContentResourcesUpdateIfNeeded(e)){s=true;}return C.prototype.insertAggregation.call(this,e,o,i,s);};V.prototype.removeAggregation=function(e,o,s){if(e==="contentResources"){var r=C.prototype.removeAggregation.call(this,e,o,true);if(r){this._scheduleContentResourcesUpdate();}return r;}else{return C.prototype.removeAggregation.call(this,e,o,s);}};V.prototype.removeAllAggregation=function(e,s){if(this._queueContentResourcesUpdateIfNeeded(e)){s=true;}return C.prototype.removeAllAggregation.call(this,e,s);};V.prototype.destroyAggregation=function(e,s){if(this._queueContentResourcesUpdateIfNeeded(e)){s=true;}return C.prototype.destroyAggregation.call(this,e,s);};V.prototype._scheduleContentResourcesUpdate=function(){if(!this._scheduleContentResourcesUpdateTimerId){this._scheduleContentResourcesUpdateTimerId=q.sap.delayedCall(0,this,function(){this._scheduleContentResourcesUpdateTimerId=null;var t=this;function g(k){t.setBusy(true);var m=t.getGraphicsCore();var o;if(t._componentsState.progressIndicator.defaultEnable){t._progressIndicator.reset();t._progressIndicator.setNumberOfFiles(k.length);t._progressIndicator.setVisible(true);m._dvl.Client.NotifyFileLoadProgress=function(e,p){t._progressIndicator.updateRenderStatus(p);return 1;};o=function(e){var p=e.getParameter("source");var r=e.getParameter("loaded");var s=e.getParameter("total");t._progressIndicator.updateDownloadStatus(p,r,s);};}m.loadContentResourcesAsync(k,function(s){try{if(s){if(t.getEnableNotifications()===false){t._destroyMainScene();t._showNativeViewport();var p=sap.ui.vk.getResourceBundle().getText("VIEWPORT_MESSAGEERRORLOADINGFILE");t._nativeViewport.loadFailed(p);}f.error(sap.ui.vk.getResourceBundle().getText(M.VIT13.summary),M.VIT13.code,"sap.ui.vk.Viewer");t.fireSceneLoadingFailed({reason:{sourcesFailedToDownload:s}});}else{var r;var u=m.updateSceneTree(t.getScene(),k,function(x){r=x;});if(u!==t._mainScene){t._destroyMainScene();}var v=false;if(t.getShouldTrackVisibilityChanges()){v=!k.some(function(x){var y=x.getSourceProperties().version;return y&&y.major<4;});}if(t.getRedlineDesign()){t.getRedlineDesign().updatePanningRatio();}t._setMainScene(u,v);if(t.getEnableOverlay()&&t.getViewport()._is2D){t._overlayManager.changed=true;t._showOverlay();}if(u){t.fireSceneLoadingSucceeded({scene:u});}else{t.fireSceneLoadingFailed({reason:r});}}}catch(e){var w=sap.ui.vk.getResourceBundle().getText(M.VIT14.summary);if(e instanceof D){w+="\ncode: "+e.code+", message: "+e.message;}else if(e instanceof Error){w+="\nmessage: "+e.message;}else{w+="\n"+e.toString();}f.error(w,M.VIT14.code,"sap.ui.vk.Viewer");t._destroyMainScene();t.fireSceneLoadingFailed({reason:{error:e,errorMessage:w}});}finally{t.fireContentResourceChangesProcessed();t.setBusy(false);t._progressIndicator.setVisible(false);}},o);}function h(k){function o(){if(t.getEnableOverlay()){t._overlayManager.changed=true;t._showOverlay();}t.fireSceneLoadingSucceeded({scene:null});t.fireContentResourceChangesProcessed();}function e(){t.fireSceneLoadingFailed();t.fireContentResourceChangesProcessed();if(t.getEnableNotifications()===false){var p=sap.ui.vk.getResourceBundle().getText("VIEWPORT_MESSAGEERRORLOADINGFILE");t._nativeViewport.loadFailed(p);}}t._destroyMainScene();if(k.length===1){t._showNativeViewport();var r=k[0];var s=r.getSource();if(s instanceof File){var m=new FileReader();m.onload=function(p){t._nativeViewport.loadUrl(m.result,o,e,null,r.getSourceType());};m.readAsDataURL(s);}else{t._nativeViewport.loadUrl(s,o,e,null,r.getSourceType());}}else{f.error(sap.ui.vk.getResourceBundle().getText(M.VIT15.summary),M.VIT15.code,"sap.ui.vk.Viewer");t.fireContentResourceChangesProcessed();}}var n=true;var i;var j;var k=this.getContentResources();if(k.length>0){j=a.collectCategories(k);if(j.length===0){if(this._viewport&&this._viewport.getVisible()){i=sap.ui.vk.ContentResourceSourceCategory["3D"];n=false;}else if(this._nativeViewport&&this._nativeViewport.getVisible()){i=sap.ui.vk.ContentResourceSourceCategory["2D"];n=false;}}else if(j.length===1){i=j[0];if(i==="unknown"){f.error(sap.ui.vk.getResourceBundle().getText(M.VIT16.summary),M.VIT16.code,"sap.ui.vk.Viewer");if(this._nativeViewport==null){this._showNativeViewport();}if(this.getEnableNotifications()===false){this._nativeViewport.loadFailed();}this._showNativeViewport(false);}else{n=false;}}else if(j.length>1){f.error(sap.ui.vk.getResourceBundle().getText(M.VIT17.summary),M.VIT17.code,"sap.ui.vk.Viewer");}}if(n){this._destroyMainScene();this.fireContentResourceChangesProcessed();return;}if(i===sap.ui.vk.ContentResourceSourceCategory["3D"]){g(k);}else if(i===sap.ui.vk.ContentResourceSourceCategory["2D"]){h(k);}});}return this;};V.prototype.onBeforeRendering=function(){if(this._fullScreenToggle){this._fullScreenToggle=false;}else{this._showToolbar();}this._showOverlay();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}};V.prototype.onAfterRendering=function(){var e=this.getDomRef();this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:e.clientWidth,height:e.clientHeight}});};V.prototype._handleResize=function(e){this._updateSize();if(this.getRedlineDesign()){var x=this.getRedlineDesign().exportJSON();this.getRedlineDesign().removeAllRedlineElements();q.sap.delayedCall(200,this,function(){var v;if(this.getViewport()&&this.getViewport().getVisible()){v=this.getViewport().getOutputSize();}else if(this.getNativeViewport()&&this.getNativeViewport().getVisible()){v=this.getNativeViewport().getOutputSize();}this.getRedlineDesign().setProperty("virtualLeft",v.left,true);this.getRedlineDesign().setProperty("virtualTop",v.top,true);this.getRedlineDesign().setProperty("virtualSideLength",v.sideLength,true);this.getRedlineDesign().invalidate();this.getRedlineDesign().importJSON(x);});}};V.prototype._updateSize=function(){if(this._updateSizeTimer){clearTimeout(this._updateSizeTimer);}this._updateSizeTimer=setTimeout(this._doUpdateSize.bind(this),100);};V.prototype._doUpdateSize=function(){var e=this.getId()+"-flexibleControl";var g=document.getElementById(e);if(!g){return;}g.style.width="100%";g.style.height="100%";var h=g.clientHeight;var s=[];for(var i=0;i<4;i++){s[i]=document.getElementById(e+"Content_"+i);}h-=s[0].clientHeight;for(var j=2;j<4;j++){if(s[j]!=null&&s[j].style.visibility!="hidden"){h-=s[j].clientHeight;}}if(s[1]){s[1].style.height=h+"px";}if(this._stackedViewport){this._stackedViewport.setLayoutData(new c({minSize:160,resizable:true}));}};V.prototype.isTreeBinding=function(n){return n==="contentResources";};V.prototype.setBusy=function(e){if(e){if(this._busyIndicatorCounter===0){this.setBusyIndicatorDelay(0);C.prototype.setBusy.call(this,true);}this._busyIndicatorCounter+=1;}else{this._busyIndicatorCounter-=1;if(this._busyIndicatorCounter==0){C.prototype.setBusy.call(this,false);}}};V.prototype._showToolbar=function(){if(!this._toolbar){this._toolbar=new sap.ui.vk.Toolbar({title:this.getToolbarTitle()});this._toolbar.setViewer(this);this.setAggregation("toolbar",this._toolbar);}this._toolbar.setVisible(this.getEnableToolbar());this._updateLayout();return this;};V.prototype._createProgressIndicator=function(){if(!this._progressIndicator){this._progressIndicator=new P({visible:false});this.setAggregation("progressIndicator",this._progressIndicator);}else{this._progressIndicator.reset();}};V.prototype._updateLayout=function(){this._layout.setWidth(this.getWidth());this._layout.removeAllContent();this._layout.setHeight(this.getHeight());var h=this.getHeight();var e=[0,0,0];if(h=="auto"){h=400;}else if(h.substr(h.length-1)=="%"){h=400;}else{h=parseInt(h,10);}if(this._toolbar!=null&&this.getEnableToolbar()){e[0]=48;}if(this._stepNavigation!=null&&this.getShowStepNavigation()){e[2]=150;}e[1]=h-e[0]-e[2];if(this._toolbar!=null&&this.getEnableToolbar()){this._toolbar.setVisible(true);this._toolbar.setLayoutData(new d({size:e[0]+"px"}));this._layout.insertContent(this._toolbar,0);}else if(this._toolbar!=null){this._toolbar.setVisible(false);}if(this._sceneTree!=null&&this.getShowSceneTree()&&this.getEnableSceneTree()){this._sceneTree.setVisible(true);this._sceneTree.setLayoutData(new c({size:"320px",minSize:200,resizable:true}));this._content.insertContentArea(this._sceneTree,0);}else if(this._sceneTree!=null){this._content.removeContentArea(this._sceneTree);this._sceneTree.setVisible(false);}this._content.setLayoutData(new d({size:e[1]+"px"}));this._layout.addContent(this._content);if(this._messagePopover!=null){e[1]-=e[0];}if(this._stepNavigation!=null&&this.getShowStepNavigation()&&this.getEnableStepNavigation()){if(this._graphicsCore!=null&&!this._stepNavigation.hasGraphicsCore()){this._stepNavigation.setGraphicsCore(this._graphicsCore);}this._stepNavigation.setLayoutData(new d({size:e[2]+"px"}));this._layout.addContent(this._stepNavigation);}if(this._messagePopover!==null&&this._messagePopover.getAggregation("_messagePopover").getItems().length>0&&this.getEnableNotifications()){this._messagePopover.setVisible(true);this._messagePopover.setLayoutData(new d({size:e[0]+"px"}));this._layout.addContent(this._messagePopover);}else{this._content.removeContentArea(this._messagePopover);this._messagePopover.setVisible(false);}if(this._toolbar){this._toolbar.refresh();}this._updateSize();};V.prototype._instantiateSceneTree=function(){if(!this._sceneTree){this._sceneTree=new sap.ui.vk.SceneTree();this.setAggregation("sceneTree",this._sceneTree);}return this;};V.prototype._instantiateStepNavigation=function(){if(!this._stepNavigation){this._stepNavigation=new sap.ui.vk.StepNavigation(this.getId()+"-stepNavigation",{showThumbnails:this.getShowStepNavigationThumbnails()});this.setAggregation("stepNavigation",this._stepNavigation);}return this;};V.prototype._showViewport=function(){if(!this._viewport){this._viewport=new sap.ui.vk.Viewport(this.getId()+"-viewport",{showAllHotspots:this.getShowAllHotspots(),hotspotColorABGR:this.getHotspotColorABGR()});this.setAggregation("viewport",this._viewport);this._viewport.attachEvent("viewActivated",this._onViewportViewActivated,this);this._viewport.setGraphicsCore(this.getGraphicsCore());}if(this._nativeViewport){this._nativeViewport.setVisible(false);}this._stackedViewport.removeAllContent();this._stackedViewport.addContent(this._viewport);this._viewport.setVisible(true);return this;};V.prototype._showNativeViewport=function(){if(!this._nativeViewport){this._nativeViewport=new sap.ui.vk.NativeViewport(this.getId()+"-nativeViewport",{limitZoomOut:true});this.setAggregation("nativeViewport",this._nativeViewport);}if(this._viewport){this._viewport.setVisible(false);}this._stackedViewport.removeAllContent();this._stackedViewport.addContent(this._nativeViewport);this._nativeViewport.setVisible(true);return this;};V.prototype._showOverlay=function(){var o=this._overlayManager;if(o.changed){var O;if(this.getEnableOverlay()){if(!o.initialized){if(!(O=this.getAggregation("overlay"))){O=new sap.ui.vk.Overlay();}O.setZoomOnResize(false);o.control=O;o.initialized=true;}else{O=o.control;O.reset();}if(this._nativeViewport&&this._nativeViewport.getVisible()){O.setTarget(this._nativeViewport);o.savedLimitZoomOutState=this._nativeViewport.getLimitZoomOut();this._nativeViewport.setLimitZoomOut(true);this._nativeViewport.attachEvent("move",o.onNativeViewportMove,o);}else if(this._viewport&&this._viewport.getVisible()){O.setTarget(this._viewport);o.savedLimitZoomOutState=false;this._viewport.attachEvent("zoom",o.onViewportZoom,o);this._viewport.attachEvent("pan",o.onViewportPan,o);}this._stackedViewport.addContent(O);this._stackedViewport.addDelegate(o.delegate);}else{this._nativeViewport.detachEvent("move",o.onNativeViewportMove,o);this._stackedViewport.removeDelegate(o.delegate);this._stackedViewport.removeContent(o.control);this._nativeViewport.setLimitZoomOut(o.savedLimitZoomOutState);}o.changed=false;}};V.prototype._onAfterRenderingOverlay=function(e){var o=this._overlayManager.control.getDomRef();if(o&&(this._nativeViewport||this._viewport)){var v=this._nativeViewport&&this._nativeViewport.getVisible()?this._nativeViewport.getDomRef():this._viewport.getDomRef();if(o.parentNode!==v){o.parentNode.style.display="none";}v.appendChild(o);o.style.width="100%";o.style.height="100%";}};V.prototype.setDecryptionHandler=function(h){if(this._graphicsCore){this._graphicsCore.setDecryptionHandler(h);}else{this._deferredDecryptionHandler=h;}return this;};V.prototype.getDecryptionHandler=function(){return this._graphicsCore?this._graphicsCore.getDecryptionHandler():this._deferredDecryptionHandler;};V.prototype._instantiateRedlineDesign=function(r){if((this.getViewport()&&this.getViewport().getVisible())||(this.getNativeViewport()&&this.getNativeViewport().getVisible())){q.sap.require("sap.ui.vk.RedlineDesign");var e=this.getViewport()&&this.getViewport().getVisible()?this.getViewport():this.getNativeViewport();var v=e.getOutputSize();this._redlineDesign=new sap.ui.vk.RedlineDesign({visible:false,virtualTop:v.top,virtualLeft:v.left,virtualSideLength:v.sideLength,redlineElements:r});}return this;};V.prototype.activateRedlineDesign=function(r){r=r||[];this._instantiateRedlineDesign(r);this.getRedlineDesign().placeAt(this._stackedViewport);this.getRedlineDesign().setVisible(true);var o=function(i){var j=i.getParameter("deltaX"),k=i.getParameter("deltaY");this.getViewport().queueCommand(function(j,k){this.getViewport().pan(j,k);this.getViewport().endGesture();}.bind(this,j,k));};var e=function(i){var j=i.getParameter("originX"),k=i.getParameter("originY"),z=i.getParameter("zoomFactor");this.getViewport().queueCommand(function(j,k,z){this.getViewport().beginGesture(j,k);this.getViewport().zoom(z);this.getViewport().endGesture();}.bind(this,j,k,z));};var g=function(i){var j=i.getParameter("deltaX"),k=i.getParameter("deltaY");this.getNativeViewport().queueCommand(function(){this.getNativeViewport().pan(j,k);this.getNativeViewport().endGesture();}.bind(this));};var h=function(i){var j=i.getParameter("originX"),k=i.getParameter("originY"),z=i.getParameter("zoomFactor");this.getNativeViewport().queueCommand(function(j,k,z){this.getNativeViewport().beginGesture(j,k);this.getNativeViewport().zoom(z);this.getNativeViewport().endGesture();}.bind(this,j,k,z));};if(this.getNativeViewport()&&this.getNativeViewport().getVisible()){this.getRedlineDesign().attachEvent("pan",g.bind(this));this.getRedlineDesign().attachEvent("zoom",h.bind(this));}else if(this.getViewport()&&this.getViewport().getVisible()){this.getRedlineDesign().attachEvent("pan",o.bind(this));this.getRedlineDesign().attachEvent("zoom",e.bind(this));}return this;};V.prototype.destroyRedlineDesign=function(){if(this.getRedlineDesign()){this.getRedlineDesign().destroy();this._redlineDesign=null;}return this;};V.prototype._onViewportViewActivated=function(e){this._componentsState.sceneTree.shouldBeEnabled=e.getParameter("type")==="3D";};return V;});
