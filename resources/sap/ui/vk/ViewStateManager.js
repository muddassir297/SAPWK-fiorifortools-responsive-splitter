/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/base/ManagedObject"],function(q,l,M){"use strict";var N;var a=q.sap.log;var V=function(){this._visibilityChanges=new Set();this._requiresClearing=false;};V.prototype.getInfo=function(n){var f=function(v){return v.type==="VE_LOCATOR";};q.sap.require("sap.ui.vk.NodeProxy");var c=[];this._visibilityChanges.forEach(function(d){var e=new sap.ui.vk.NodeProxy(n,d),v=q.grep(e.getVeIds(),f)[0].fields[0].value;e.destroy();c.push(v);});return c;};V.prototype.getRequiresClearing=function(){return this._requiresClearing;};V.prototype.setRequiresClearing=function(r){this._requiresClearing=r;};V.prototype.clear=function(){this._visibilityChanges.clear();};V.prototype.trackNodeId=function(n){if(this._visibilityChanges.has(n)){this._visibilityChanges.delete(n);}else{this._visibilityChanges.add(n);}};var b=M.extend("sap.ui.vk.ViewStateManager",{metadata:{publicMethods:["enumerateSelection","getNodeHierarchy","getSelectionState","getVisibilityState","setSelectionState","setVisibilityState","getVisibilityChanges"],events:{visibilityChanged:{parameters:{visible:{type:"string[]"},hidden:{type:"string[]"}},enableEventBubbling:true},selectionChanged:{parameters:{selected:{type:"string[]"},unselected:{type:"string[]"}},enableEventBubbling:true}}},constructor:function(n,s,c){a.debug("sap.ui.vk.ViewStateManager.constructor() called.");M.apply(this);var d=n.getScene();this._nodeHierarchy=n;this._dvlSceneId=d._getDvlSceneId();this._dvl=d.getGraphicsCore()._getDvl();this._dvlClientId=d.getGraphicsCore()._getDvlClientId();this._dvl.Client.attachNodeVisibilityChanged(this._handleNodeVisibilityChanged,this);this._dvl.Client.attachNodeSelectionChanged(this._handleNodeSelectionChanged,this);this._canTrackVisibilityChanges=c;this._shouldTrackVisibilityChanges=s;this._nodeHierarchy.attachChanged(this._handleNodeHierarchyChanged,this);this._handleNodeHierarchyChanged();this._selectedNodes=new N();this._newlyVisibleNodes=[];this._newlyHiddenNodes=[];this._visibilityTimerId=null;this._selectionTimerId=null;}});b.prototype.destroy=function(){a.debug("sap.ui.vk.ViewStateManager.destroy() called.");if(this._selectionTimerId){q.sap.clearDelayedCall(this._selectionTimerId);this._selectionTimerId=null;}if(this._visibilityTimerId){q.sap.clearDelayedCall(this._visibilityTimerId);this._visibilityTimerId=null;}this._newlyHiddenNodes=null;this._newlyVisibleNodes=null;this._selectedNodes=null;if(this._dvl){this._dvl.Client.detachNodeSelectionChanged(this._handleNodeSelectionChanged,this);this._dvl.Client.detachNodeVisibilityChanged(this._handleNodeVisibilityChanged,this);this._dvl.Client.detachStepEvent(this._handleStepEvent,this);}this._dvlClientId=null;this._dvlSceneId=null;this._dvl=null;this._scene=null;this._nodeHierarchy.detachChanged(this._handleNodeHierarchyChanged,this);M.prototype.destroy.apply(this);};b.prototype.getNodeHierarchy=function(){return this._nodeHierarchy;};b.prototype.getVisibilityChanges=function(){return(this._getShouldTrackVisibilityChanges()&&this.getCanTrackVisibilityChanges())?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null;};b.prototype.getVisibilityComplete=function(){var n=this.getNodeHierarchy(),c=n.findNodesByName(),v=[],h=[];q.sap.require("sap.ui.vk.NodeProxy");c.forEach(function(d){var e=new sap.ui.vk.NodeProxy(n,d),f=q.grep(e.getVeIds(),function(f){return f.type==="VE_LOCATOR";})[0].fields[0].value;e.destroy();if(this.getVisibilityState(d)){v.push(f);}else{h.push(f);}}.bind(this));return{visible:v,hidden:h};};b.prototype.getVisibilityState=function(n){if(Array.isArray(n)){return n.map(function(c){return(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneId,c,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE)!==0;}.bind(this));}else{var c=n;return(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneId,c,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE)!==0;}};b.prototype.setVisibilityState=function(n,v,r){if(!Array.isArray(n)){n=[n];}var c=q.sap.unique((r?this._collectNodesRecursively(n):n)).filter(function(d){var i=(sap.ui.vk.dvl.getJSONObject(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneId,d,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE)!==0;return i!==v;}.bind(this));if(c.length>0){c.forEach(function(d){this._dvl.Scene.ChangeNodeFlags(this._dvlSceneId,d,sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE,v?sap.ve.dvl.DVLFLAGOPERATION.DVLFLAGOP_SET:sap.ve.dvl.DVLFLAGOPERATION.DVLFLAGOP_CLEAR);}.bind(this));this.fireVisibilityChanged({visible:v?c:[],hidden:v?[]:c});}return this;};b.prototype._handleNodeVisibilityChanged=function(p){if(p.clientId===this._dvlClientId&&p.sceneId===this._dvlSceneId){this[p.visible?"_newlyVisibleNodes":"_newlyHiddenNodes"].push(p.nodeId);if(!this._visibilityTimerId){this._visibilityTimerId=q.sap.delayedCall(0,this,function(){if(this._getShouldTrackVisibilityChanges()&&this.getCanTrackVisibilityChanges()){this._newlyVisibleNodes.forEach(this._visibilityTracker.trackNodeId.bind(this._visibilityTracker));this._newlyHiddenNodes.forEach(this._visibilityTracker.trackNodeId.bind(this._visibilityTracker));if(this._visibilityTracker.getRequiresClearing()){this._visibilityTracker.setRequiresClearing(false);this._visibilityTracker.clear();}}this._visibilityTimerId=null;this.fireVisibilityChanged({visible:this._newlyVisibleNodes.splice(0,this._newlyVisibleNodes.length),hidden:this._newlyHiddenNodes.splice(0,this._newlyHiddenNodes.length)});}.bind(this));}}};b.prototype.enumerateSelection=function(c){this._selectedNodes.forEach(c);return this;};b.prototype.getSelectionState=function(n){if(Array.isArray(n)){return n.map(function(c){return(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneId,c,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED)!==0;}.bind(this));}else{var c=n;return(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneId,c,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED)!==0;}};b.prototype.setSelectionState=function(n,s,r){if(!Array.isArray(n)){n=[n];}var c=q.sap.unique((r?this._collectNodesRecursively(n):n)).filter(function(e){var i=(sap.ui.vk.dvl.getJSONObject(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneId,e,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED)!==0;return i!==s;}.bind(this));if(c.length>0){var d=this._selectedNodes[s?"add":"delete"].bind(this._selectedNodes);c.forEach(function(e){this._dvl.Scene.ChangeNodeFlags(this._dvlSceneId,e,sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED,s?sap.ve.dvl.DVLFLAGOPERATION.DVLFLAGOP_SET:sap.ve.dvl.DVLFLAGOPERATION.DVLFLAGOP_CLEAR);d(e);}.bind(this));this.fireSelectionChanged({selected:s?c:[],unselected:s?[]:c});}return this;};b.prototype._handleNodeSelectionChanged=function(p){if(p.clientId===this._dvlClientId&&p.sceneId===this._dvlSceneId){if(!this._selectionTimerId){this._selectionTimerId=q.sap.delayedCall(0,this,function(){this._selectionTimerId=null;var c=new N(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneId,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_SELECTED).SelectedNodes);var n=[];this._selectedNodes.forEach(function(e){if(!c.has(e)){n.push(e);}});var d=[];c.forEach(function(e){if(!this._selectedNodes.has(e)){d.push(e);}}.bind(this));this._selectedNodes=c;this.fireSelectionChanged({selected:d,unselected:n});});}}};b.prototype._handleNodeHierarchyChanged=function(){if(this._getShouldTrackVisibilityChanges()&&this.getCanTrackVisibilityChanges()){if(!this._visibilityTracker){this._visibilityTracker=new V();this._dvl.Client.attachStepEvent(this._handleStepEvent,this);}}};b.prototype._handleStepEvent=function(e){if(e.type===sap.ve.dvl.DVLSTEPEVENT.DVLSTEPEVENT_STARTED){this._visibilityTracker.setRequiresClearing(true);}};b.prototype.getCanTrackVisibilityChanges=function(){return this._canTrackVisibilityChanges;};b.prototype.setCanTrackVisibilityChanges=function(c){this._canTrackVisibilityChanges=c;};b.prototype._getShouldTrackVisibilityChanges=function(){return this._shouldTrackVisibilityChanges;};b.prototype._collectNodesRecursively=function(n){var r=[];var c=function(d){var e=typeof d==="string"?d:d.getNodeId();r.push(e);if((sap.ui.vk.dvl.getJSONObject(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneId,e,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_CLOSED)===0){this._nodeHierarchy.enumerateChildren(e,c);}}.bind(this);n.forEach(c);return r;};N=function(c){c=c||[];if(this._builtin){if(sap.ui.Device.browser.msie){this._set=new Set();c.forEach(this._set.add.bind(this._set));}else{this._set=new Set(c);}}else{this._set=c.slice();}};N.prototype={constructor:N,_builtin:!!Set,add:function(v){if(this._builtin){this._set.add(v);}else if(this._set.indexOf()<0){this._set.push(v);}return this;},"delete":function(v){if(this._builtin){return this._set.delete(v);}else{var i=this._set.indexOf(v);if(i>=0){this.splice(i,1);return true;}else{return false;}}},clear:function(){if(this._builtin){this._set.clear();}else{this._set.splice(0,this._set.length);}},has:function(v){if(this._builtin){return this._set.has(v);}else{return this._set.indexOf(v)>=0;}},forEach:function(c,t){this._set.forEach(c,t);}};return b;});
