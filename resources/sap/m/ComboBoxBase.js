/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','./Dialog','./ComboBoxTextField','./Toolbar','./Button','./Bar','./Text','./Title','./SelectList','./Popover','sap/ui/core/InvisibleText','sap/ui/core/IconPool','sap/ui/core/ValueStateSupport','./library'],function(q,D,C,T,B,a,b,c,S,P,I,d,V,l){"use strict";var e=C.extend("sap.m.ComboBoxBase",{metadata:{library:"sap.m",defaultAggregation:"items",aggregations:{items:{type:"sap.ui.core.Item",multiple:true,singularName:"item",bindable:"bindable"},picker:{type:"sap.ui.core.PopupInterface",multiple:false,visibility:"hidden"}},events:{loadItems:{}}}});var p;e.prototype.updateItems=function(r){this.bItemsUpdated=false;this.destroyItems();this.updateAggregation("items");this.bItemsUpdated=true;if(this.hasLoadItemsEventListeners()){this.onItemsLoaded();}};e.prototype.refreshItems=function(){this.bItemsUpdated=false;this.refreshAggregation("items");};e.prototype.loadItems=function(f,o){var g=typeof f==="function";if(this.hasLoadItemsEventListeners()&&(this.getItems().length===0)){this._bOnItemsLoadedScheduled=false;if(g){o=q.extend({action:f,busyIndicator:true,busyIndicatorDelay:300},o);this.aMessageQueue.push(o);if((this.iLoadItemsEventInitialProcessingTimeoutID===-1)&&(o.busyIndicator)){this.iLoadItemsEventInitialProcessingTimeoutID=setTimeout(function onItemsNotLoadedAfterDelay(){this.setInternalBusyIndicatorDelay(0);this.setInternalBusyIndicator(true);}.bind(this),o.busyIndicatorDelay);}}if(!this.bProcessingLoadItemsEvent){this.bProcessingLoadItemsEvent=true;this.fireLoadItems();}}else if(g){f.call(this);}};e.prototype.onItemsLoaded=function(){this.bProcessingLoadItemsEvent=false;clearTimeout(this.iLoadItemsEventInitialProcessingTimeoutID);if(this.bInitialBusyIndicatorState!==this.getBusy()){this.setInternalBusyIndicator(this.bInitialBusyIndicatorState);}if(this.iInitialBusyIndicatorDelay!==this.getBusyIndicatorDelay()){this.setInternalBusyIndicatorDelay(this.iInitialBusyIndicatorDelay);}for(var i=0,m,n,f;i<this.aMessageQueue.length;i++){m=this.aMessageQueue.shift();i--;f=(i+1)===this.aMessageQueue.length;n=f?null:this.aMessageQueue[i+1];if(typeof m.action==="function"){if((m.name==="input")&&!f&&(n.name==="input")){continue;}m.action.call(this);}}};e.prototype.hasLoadItemsEventListeners=function(){return this.hasListeners("loadItems");};e.prototype._scheduleOnItemsLoadedOnce=function(){if(!this._bOnItemsLoadedScheduled&&!this.isBound("items")&&this.hasLoadItemsEventListeners()&&this.bProcessingLoadItemsEvent){this._bOnItemsLoadedScheduled=true;setTimeout(this.onItemsLoaded.bind(this),0);}};e.prototype.getPickerInvisibleTextId=function(){if(!sap.ui.getCore().getConfiguration().getAccessibility()){return"";}var r=sap.ui.getCore().getLibraryResourceBundle("sap.m");if(!p){p=new I({text:r.getText("COMBOBOX_AVAILABLE_OPTIONS")}).toStatic().getId();}return p;};e.prototype.init=function(){C.prototype.init.apply(this,arguments);this.setPickerType(sap.ui.Device.system.phone?"Dialog":"Dropdown");if(sap.ui.Device.system.phone){this.attachEvent("_change",this.onPropertyChange,this);}this.createPicker(this.getPickerType());this.bItemsUpdated=false;this.bOpenedByKeyboardOrButton=false;this._oPickerValueStateText=null;this.bProcessingLoadItemsEvent=false;this.iLoadItemsEventInitialProcessingTimeoutID=-1;this.aMessageQueue=[];this.bInitialBusyIndicatorState=this.getBusy();this.iInitialBusyIndicatorDelay=this.getBusyIndicatorDelay();this._bOnItemsLoadedScheduled=false;this._bDoTypeAhead=true;};e.prototype.onBeforeRendering=function(){var n=this.getValueState()===sap.ui.core.ValueState.None;C.prototype.onBeforeRendering.apply(this,arguments);if(!this.isPickerDialog()&&n){this._showValueStateText(false);}};e.prototype.exit=function(){C.prototype.exit.apply(this,arguments);if(this.getList()){this.getList().destroy();this._oList=null;}if(this._oPickerValueStateText){this._oPickerValueStateText.destroy();}clearTimeout(this.iLoadItemsEventInitialProcessingTimeoutID);this.aMessageQueue=null;};e.prototype.ontouchstart=function(E){if(!this.getEnabled()||!this.getEditable()){return;}E.setMarked();if(this.isOpenArea(E.target)){this.addStyleClass(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Pressed");}};e.prototype.ontouchend=function(E){if(!this.getEnabled()||!this.getEditable()){return;}E.setMarked();if(!this.isOpen()&&this.isOpenArea(E.target)){this.removeStyleClass(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Pressed");}};e.prototype.ontap=function(E){C.prototype.ontap.apply(this,arguments);var f=this.getRenderer().CSS_CLASS_COMBOBOXBASE,o=E.srcControl;if(!this.getEnabled()||!this.getEditable()){return;}E.setMarked();if(o.isOpenArea&&o.isOpenArea(E.target)){if(this.isOpen()){this.close();this.removeStyleClass(f+"Pressed");return;}this.loadItems();this.bOpenedByKeyboardOrButton=true;this.open();}if(this.isOpen()){this.addStyleClass(f+"Pressed");}};e.prototype.onsapshow=function(E){if(!this.getEnabled()||!this.getEditable()){return;}E.setMarked();if(E.keyCode===q.sap.KeyCodes.F4){this.onF4(E);}if(this.isOpen()){this.close();return;}this.selectText(0,this.getValue().length);this.loadItems();this.bOpenedByKeyboardOrButton=true;this.open();};e.prototype.onF4=function(E){E.preventDefault();};e.prototype.onsapescape=function(E){if(this.getEnabled()&&this.getEditable()&&this.isOpen()){E.setMarked();E.preventDefault();this.close();}else{C.prototype.onsapescape.apply(this,arguments);}};e.prototype.onsaphide=e.prototype.onsapshow;e.prototype.onsapfocusleave=function(E){if(!E.relatedControlId){C.prototype.onsapfocusleave.apply(this,arguments);return;}var r=sap.ui.getCore().byId(E.relatedControlId);if(r===this){return;}var o=this.getAggregation("picker"),f=r&&r.getFocusDomRef();if(o&&q.sap.containsOrEquals(o.getFocusDomRef(),f)){return;}C.prototype.onsapfocusleave.apply(this,arguments);};e.prototype.getPopupAnchorDomRef=function(){return this.getDomRef();};e.prototype.addContent=function(o){};e.prototype.getList=function(){if(this.bIsDestroyed){return null;}return this._oList;};e.prototype.setPickerType=function(s){this._sPickerType=s;};e.prototype.getPickerType=function(){return this._sPickerType;};e.prototype.setValueState=function(v){var A,s=this.getValueStateText(),f=this.getShowValueStateMessage();this._sOldValueState=this.getValueState();C.prototype.setValueState.apply(this,arguments);A=V.getAdditionalText(this);if(s){this._showValueStateText(f);this._setValueStateText(s);}else if(v===sap.ui.core.ValueState.None){this._showValueStateText(false);}else{this._showValueStateText(f);this._setValueStateText(A);}this._alignValueStateStyles();return this;};e.prototype.setValueStateText=function(t){C.prototype.setValueStateText.apply(this,arguments);this._setValueStateText(this.getValueStateText());return this;};e.prototype.setShowValueStateMessage=function(s){C.prototype.setShowValueStateMessage.apply(this,arguments);this._showValueStateText(this.getShowValueStateMessage());return this;};e.prototype._showValueStateText=function(s){var o;if(this.isPickerDialog()){if(this._oPickerValueStateText){this._oPickerValueStateText.setVisible(s);}}else{o=this._getPickerCustomHeader();if(o){o.setVisible(s);}}};e.prototype._setValueStateText=function(t){var h;if(this.isPickerDialog()){this._oPickerValueStateText=this.getPickerValueStateText();this._oPickerValueStateText.setText(t);}else{h=this._getPickerCustomHeader();if(h){h.getContentLeft()[0].setText(t);}}};e.prototype._getPickerCustomHeader=function(){var i,o,f=this.getPicker(),s=this.getRenderer().CSS_CLASS_COMBOBOXBASE+"PickerTitle";if(!f){return;}if(f.getCustomHeader()){return f.getCustomHeader();}i=new c({textAlign:"Left"}).addStyleClass(s);o=new a({visible:false,contentLeft:i});f.setCustomHeader(o);return o;};e.prototype._alignValueStateStyles=function(){var o=this._sOldValueState,f=this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Picker",s=f+"ValueState",O=f+o+"State",g=f+this.getValueState()+"State",h;if(this.isPickerDialog()&&this._oPickerValueStateText){this._oPickerValueStateText.addStyleClass(s);this._oPickerValueStateText.removeStyleClass(O);this._oPickerValueStateText.addStyleClass(g);}else{h=this._getPickerCustomHeader();if(h){h.addStyleClass(s);h.removeStyleClass(O);h.addStyleClass(g);}}};e.prototype.shouldValueStateMessageBeOpened=function(){var s=C.prototype.shouldValueStateMessageBeOpened.apply(this,arguments);return(s&&!this.isOpen());};e.prototype.onPropertyChange=function(o,f){var n=o.getParameter("newValue"),s=o.getParameter("name"),m="set"+s.charAt(0).toUpperCase()+s.slice(1),g=(f&&f.srcControl)||this.getPickerTextField();if(/\bvalue\b|\benabled\b|\bname\b|\bplaceholder\b|\beditable\b|\btextAlign\b|\btextDirection\b|\bvalueState\b/.test(s)&&g&&(typeof g[m]==="function")){g[m](n);}};e.prototype.isPickerDialog=function(){return this.getPickerType()==="Dialog";};e.prototype.getPickerValueStateText=function(){var o=this.getPicker();if(!this._oPickerValueStateText){this._oPickerValueStateText=new b({width:"100%"});o.insertContent(this._oPickerValueStateText,0);}return this._oPickerValueStateText;};e.prototype.createPicker=function(s){};e.prototype.onBeforeClose=function(){this.bOpenedByKeyboardOrButton=false;};e.prototype.getPicker=function(){if(this.bIsDestroyed){return null;}return this.createPicker(this.getPickerType());};e.prototype.getPickerTextField=function(){var o=this.getPicker(),s=o.getSubHeader();return s&&s.getContent()[0]||null;};e.prototype.getPickerTitle=function(){var o=this.getPicker(),h=o&&o.getCustomHeader();if(this.isPickerDialog()&&h){return h.getContentMiddle()[0];}return null;};e.prototype.createDialog=function(){var t=this,o=this.createPickerTextField(),f=o._handleEvent;o._handleEvent=function(E){f.apply(this,arguments);if(/keydown|sapdown|sapup|saphome|sapend|sappagedown|sappageup|input/.test(E.type)){t._handleEvent(E);}};return new D({stretch:true,customHeader:t.createPickerHeader(),buttons:this.createPickerCloseButton(),subHeader:new T({content:o}),beforeOpen:function(){t.updatePickerHeaderTitle();},ariaLabelledBy:t.getPickerInvisibleTextId()||undefined});};e.prototype.createPickerHeader=function(){var t=this,i=d.getIconURI("decline");return new a({contentMiddle:new c(),contentRight:new B({icon:i,press:function(){t.close();t.revertSelection();}})});};e.prototype.revertSelection=function(){};e.prototype.updatePickerHeaderTitle=function(){var o=this.getPicker(),r=sap.ui.getCore().getLibraryResourceBundle("sap.m"),L,f;if(!o){return;}f=this.getLabels();if(f.length){L=f[0];if(L&&(typeof L.getText==="function")){this.getPickerTitle().setText(L.getText());}}else{this.getPickerTitle().setText(r.getText("COMBOBOX_PICKER_TITLE"));}};e.prototype.createPickerCloseButton=function(){var t=this,o,r=sap.ui.getCore().getLibraryResourceBundle("sap.m");return new B({text:r.getText("COMBOBOX_CLOSE_BUTTON"),press:function(){o=t.getPickerTextField();t.updateDomValue(o.getValue());t.onChange();t.close();}});};e.prototype.hasContent=function(){return this.getItems().length>0;};e.prototype.findFirstEnabledItem=function(i){var L=this.getList();return L?L.findFirstEnabledItem(i):null;};e.prototype.findLastEnabledItem=function(i){var L=this.getList();return L?L.findLastEnabledItem(i):null;};e.prototype.open=function(){var o=this.getPicker();if(o){o.open();}return this;};e.prototype.getVisibleItems=function(){var L=this.getList();return L?L.getVisibleItems():[];};e.prototype.isItemSelected=function(){};e.prototype.getKeys=function(f){f=f||this.getItems();for(var i=0,k=[];i<f.length;i++){k[i]=f[i].getKey();}return k;};e.prototype.getSelectableItems=function(){var L=this.getList();return L?L.getSelectableItems():[];};e.prototype.findItem=function(s,v){var L=this.getList();return L?L.findItem(s,v):null;};e.prototype.getItemByText=function(t){return this.findItem("text",t);};e.prototype.scrollToItem=function(i){var o=this.getPicker(),f=o.getDomRef("cont"),g=i&&i.getDomRef();if(!o||!f||!g){return;}var h=f.scrollTop,j=g.offsetTop,k=f.clientHeight,m=g.offsetHeight;if(h>j){f.scrollTop=j;}else if((j+m)>(h+k)){f.scrollTop=Math.ceil(j+m-k);}};e.prototype.clearFilter=function(){for(var i=0,f=this.getItems();i<f.length;i++){f[i].bVisible=true;}};e.prototype.onItemChange=function(o){};e.prototype.clearSelection=function(){};e.prototype.setInternalBusyIndicator=function(f){this.bInitialBusyIndicatorState=this.getBusy();return this.setBusy.apply(this,arguments);};e.prototype.setInternalBusyIndicatorDelay=function(i){this.iInitialBusyIndicatorDelay=this.getBusyIndicatorDelay();return this.setBusyIndicatorDelay.apply(this,arguments);};e.prototype.addItem=function(i){this.addAggregation("items",i);if(i){i.attachEvent("_change",this.onItemChange,this);}this._scheduleOnItemsLoadedOnce();return this;};e.prototype.insertItem=function(i,f){this.insertAggregation("items",i,f,true);if(i){i.attachEvent("_change",this.onItemChange,this);}this._scheduleOnItemsLoadedOnce();return this;};e.prototype.getItemAt=function(i){return this.getItems()[+i]||null;};e.prototype.getFirstItem=function(){return this.getItems()[0]||null;};e.prototype.getLastItem=function(){var i=this.getItems();return i[i.length-1]||null;};e.prototype.getEnabledItems=function(i){var L=this.getList();return L?L.getEnabledItems(i):[];};e.prototype.getItemByKey=function(k){var L=this.getList();return L?L.getItemByKey(k):null;};e.prototype.isOpen=function(){var o=this.getAggregation("picker");return!!(o&&o.isOpen());};e.prototype.close=function(){var o=this.getAggregation("picker");if(o){o.close();}return this;};e.prototype.removeItem=function(i){var L=this.getList();i=L?L.removeItem(i):null;if(i){i.detachEvent("_change",this.onItemChange,this);}return i;};e.prototype.removeAllItems=function(){var L=this.getList(),f=L?L.removeAllItems():[];this.clearSelection();for(var i=0;i<f.length;i++){f[i].detachEvent("_change",this.onItemChange,this);}return f;};e.prototype.destroyItems=function(){var L=this.getList();if(L){L.destroyItems();}return this;};return e;},true);
