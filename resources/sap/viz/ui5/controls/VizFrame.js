/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['sap/viz/library','sap/ui/core/theming/Parameters','sap/viz/ui5/theming/Util','./ResponsiveLegend','./common/BaseControl','./common/feeds/AnalysisObject','./common/feeds/FeedItem','./common/helpers/VizControlsHelper','./common/helpers/VizFrameOptionsHelper','./common/helpers/DefaultPropertiesHelper','./common/utils/Constants','sap/ui/Device'],function(l,P,U,R,B,A,F,V,a,D,C,b){"use strict";var c=sap.viz.vizservices.__internal__.BindingService;var d=sap.viz.vizservices.__internal__.PropertyService;var f=B.extend("sap.viz.ui5.controls.VizFrame",{metadata:{library:"sap.viz",properties:{vizType:{type:"string",group:"Misc",defaultValue:"column"},vizProperties:{type:"object",group:"Misc",defaultValue:null},vizScales:{type:"object",group:"Misc",defaultValue:null},vizCustomizations:{type:"object",group:"Misc",defaultValue:null},legendVisible:{type:"boolean",group:"Misc",defaultValue:true}},aggregations:{dataset:{type:"sap.viz.ui5.data.Dataset",multiple:false},feeds:{type:"sap.viz.ui5.controls.common.feeds.FeedItem",multiple:true,singularName:"feed"}},events:{renderComplete:{},selectData:{},deselectData:{}}}});f.prototype.init=function(){sap.viz.ui5.controls.common.BaseControl.prototype.init.apply(this,arguments);this._wrapApi('setModel',function(){this._invalidateDataset=true;}.bind(this));this._wrapApi('setDataset',function(){this._invalidateDataset=true;}.bind(this));this._wrapApi('destroyDataset',function(){this._invalidateDataset=true;}.bind(this));this._wrapApi('addFeed',function(){this._invalidateFeeds=true;}.bind(this));this._wrapApi('removeFeed',function(){this._invalidateFeeds=true;}.bind(this));this._wrapApi('destroyFeeds',function(){this._invalidateFeeds=true;}.bind(this));this._vizFrame=null;this._currentTheme=null;this._connectPopover=null;this._currentTemplate=null;this._errorType=null;this._bulletProperties={plotArea:{}};this._waterfallProperties={plotArea:{}};this._clearVariables();this._templateCache={};this.data("sap-ui-fastnavgroup","true",true);};f.prototype.applySettings=function(){sap.ui.core.Control.prototype.applySettings.apply(this,arguments);};f.prototype.exit=function(){sap.viz.ui5.controls.common.BaseControl.prototype.exit.apply(this,arguments);this._clearVariables();if(this._vizFrame){this._vizFrame.destroy();}this._vizFrame=null;};f.prototype._clearVariables=function(){this._clearRequestedProperties();this._bulletProperties={plotArea:{}};this._waterfallProperties={plotArea:{}};this._cachedDataset=null;this._connectPopover=null;this._templateCache=null;};f.prototype._clearRequestedProperties=function(){this.setProperty('vizProperties',null);this.setProperty('vizScales',null);this.setProperty('vizCustomizations',null);};f.prototype.getVizUid=function(){return this.getId();};f.prototype.setUiConfig=function(u){sap.viz.ui5.controls.common.BaseControl.prototype.setUiConfig.apply(this,arguments);};f.prototype.setVizType=function(v){var o=this._getCalculatedType();if(v!==this.getVizType()){this._invalidateVizType=true;}this.setProperty('vizType',v,true);var n=this._getCalculatedType();if(o!==n&&this._vizFrame&&!this._pendingRerendering){var u=this._userFeeds||{feeds:this.getFeeds(),vizType:o};if(u.vizType===n){this.destroyFeeds();u.feeds.forEach(function(e){this.addFeed(e);},this);this._userFeeds=null;}else{this._switchFeeds(o,this._getCalculatedType(),u);}}else{this.invalidate();}return this;};f.prototype._switchFeeds=function(e,t,u){var i=F.toLightWeightFmt(this.getFeeds());var n=sap.viz.vizservices.BVRService.switchFeeds(e,i,t).feedItems;var j=V.getFeedDefsMap(t);n.forEach(function(m){if(m.id&&j[m.id]){m.type=j[m.id].type;}});var k=F.fromLightWeightFmt(n);u.feeds.forEach(function(m){this.removeFeed(m,true);},this);this.vizUpdate({feeds:k});this._userFeeds=u;};f.prototype.invalidate=function(o){if(o instanceof sap.viz.ui5.data.Dataset){this._invalidateDataset=true;}if(o instanceof F){this._userFeeds=null;}sap.viz.ui5.controls.common.BaseControl.prototype.invalidate.call(this,o);};f.prototype.getVizProperties=function(){if(this._vizFrame){return this._mergeProperties(this._mergeProperties({},this._vizFrame.properties()||{}),this.getProperty('vizProperties')||{});}else{return this.getProperty('vizProperties');}};f.prototype.getVizScales=function(){if(this._vizFrame){return jQuery.extend(this._vizFrame.scales()||[],this.getProperty('vizScales'));}else{return this.getProperty('vizScales');}};f.prototype.zoom=function(e){if(this._vizFrame){this._vizFrame.zoom({target:"plotArea",direction:e.direction});}};f.prototype.setVizProperties=function(v){var t=this._getCalculatedType();if(v&&(t==="info/bullet"||t==="info/vertical_bullet")){a.processBulletProperty(this._bulletProperties,v);}if(v&&(t==="info/timeseries_waterfall")){a.processWaterfallProperty(this._waterfallProperties,v);}var o=sap.viz.api.serialization.migrate({'type':this._getCalculatedType(),'properties':v});if(this._vizFrame&&!this._pendingRerendering){if(this._errorType!==C.ERROR_TYPE.NODATA){this._updateDescription();}try{this._vizFrame.update(o);}catch(e){this._handleErr(e);}}else{this.setProperty('vizProperties',this._mergeProperties(this.getProperty('vizProperties')||{},o.properties||{}));this.setVizScales(o.scales);this.invalidate();}return this;};f.prototype.setVizScales=function(v){if(this._vizFrame&&!this._pendingRerendering){try{this._vizFrame.scales(v);}catch(e){this._handleErr(e);}}else{this.setProperty('vizScales',jQuery.extend(this.getProperty('vizScales')||[],v||[]));this.invalidate();}return this;};f.prototype.getLegendVisible=function(){return this.getVizProperties().legendGroup.computedVisibility;};f.prototype.setLegendVisible=function(v){this.setVizProperties({'legend':{'visible':v},'sizeLegend':{'visible':v}});return this;};f.prototype.vizSelection=function(p,o){if(this._vizFrame){try{var r=this._vizFrame.selection.apply(this._vizFrame,arguments);if(r===this._vizFrame){r=this;}}catch(e){return null;}return r;}else{return null;}};f.prototype.vizUpdate=function(o){if(this._vizFrame){if(o.data||o.feeds){if(o.properties){this.setVizProperties(o.properties);}if(o.scales){this.setVizScales(o.scales);}if(o.customizations){this.setVizCustomizations(o.customizations);}if(o.data){this.setDataset(o.data);}if(o.feeds){this.destroyFeeds();o.feeds.forEach(function(i){this.addFeed(i);}.bind(this));}}else{try{this._vizFrame.update(o);}catch(e){this._handleErr(e);}}}};f.prototype.setVizCustomizations=function(o){if(f._isCustomizationAPISupportedVizType(this._getCalculatedType())){if(this._vizFrame&&!this._pendingRerendering){try{this._vizFrame.customizations(o);}catch(e){this._handleErr(e);}}else{this.setProperty('vizCustomizations',this._mergeProperties(this.getProperty('vizCustomizations')||{},o||{}));}}return this;};f.prototype.getVizCustomizations=function(){if(this._vizFrame){return this._mergeProperties(this._mergeProperties({},this._vizFrame.customizations()||{}),this.getProperty('vizCustomizations')||{});}else{return this.getProperty('vizCustomizations');}};f._isCustomizationAPISupportedVizType=function(v){return jQuery.inArray(v,['info/column','info/dual_column','info/bar','info/dual_bar','info/stacked_bar','info/stacked_column','info/100_stacked_bar','info/100_stacked_column','info/100_dual_stacked_bar','info/100_dual_stacked_column','info/dual_stacked_bar','info/dual_stacked_column','info/line','info/horizontal_line','info/dual_line','info/dual_horizontal_line','info/bubble',"info/scatter",'info/combination','info/horizontal_combination','info/stacked_combination','info/horizontal_stacked_combination','info/dual_stacked_combination','info/dual_horizontal_stacked_combination','info/timeseries_combination','info/timeseries_bullet','info/dual_timeseries_combination','info/dual_combination','info/dual_horizontal_combination'])!==-1;};f.prototype.getResponsiveLegend=function(){if(this._vizFrame){return sap.viz.ui5.controls.ResponsiveLegend.createInstance(this._vizFrame.responsiveLegend());}};f.prototype.exportToSVGString=function(o){var r="<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100%\" height=\"100%\"/>";if(this._vizFrame){r=this._vizFrame.exportToSVGString(o);}return r;};f.prototype._getScopeString=function(){var s=P.getActiveScopesFor(this);return JSON.stringify(s);};f.prototype._scopingChangedFun=function(e){var E=e.getParameter("element");var i=false;if(this===E){i=true;}else{var n=this;while(n){n=n.getParent();if(n===E){i=true;break;}}}if(i){var s=this._getScopeString();if(this._sCurrentScopeChain!==undefined&&this._sCurrentScopeChain!==s){this._themeChangedHandler();var r={forceThemeChange:true};this._renderVizFrame(r);}}};f.prototype._createContainerDiv=function(){jQuery(this._app$).attr("data-sap-ui-preserve",true);var v=this.$().find("."+C.CSS_PREFIX+'-viz-frame');if(v.length===0){v=jQuery(document.createElement('div'));v.addClass(C.CSS_PREFIX+'-viz-frame');v.appendTo(this._app$);}if(!this.$().find("."+C.CSS_PREFIX+'-viz-description').length){var e=jQuery(document.createElement('div'));e.addClass(C.CSS_PREFIX+'-viz-description');e.appendTo(this._app$);e.attr('tabindex',0);var i=jQuery(document.createElement('div'));i.addClass(C.CSS_PREFIX+'-viz-description-title');i.appendTo(e);var j=jQuery(document.createElement('div'));j.addClass(C.CSS_PREFIX+'-viz-description-detail');j.appendTo(e);var k=jQuery(document.createElement('div'));k.addClass(C.CSS_PREFIX+'-viz-description-message');k.appendTo(e);}};f.prototype._createVizFrame=function(o){sap.ui.getCore().attachThemeScopingChanged(this._scopingChangedFun,this);o.container=this.$().find("."+C.CSS_PREFIX+'-viz-frame').get(0);var v=this._vizFrame=new sap.viz.vizframe.VizFrame(o,{'controls':{'morpher':{'enabled':false}},'throwError':true});v.on('selectData',function(e){this.fireEvent("selectData",e);}.bind(this));v.on('deselectData',function(e){this.fireEvent("deselectData",e);}.bind(this));v.on('initialized',function(e){this.fireEvent("renderComplete",e);}.bind(this));v.on('scroll',function(e){this.fireEvent("_scroll",e);}.bind(this));return v;};f.prototype._emptyVizFrame=function(k){var v=this.$().find("."+C.CSS_PREFIX+'-viz-frame');if(v.length===0){return;}else if(!k){v.empty();}else{v.find(".v-info").remove();}sap.ui.getCore().detachThemeScopingChanged(this._scopingChangedFun,this);};f.prototype._migrate=function(t,e){e.forEach(function(j){var m=sap.viz.api.serialization.feedsIdToBindingId(t,j.getUid());if(m){j.setProperty('uid',m,true);}});if(t==="info/bullet"||t==="info/vertical_bullet"||t==="info/timeseries_bullet"){var i=false;e.forEach(function(j){i=i||j.getUid()==='actualValues';});if(!i){e.forEach(function(j){if(j.getUid()==='valueAxis'){j.setUid('actualValues');if(j.getValues().length>1){e.push(new F({'uid':'additionalValues','type':'Measure','values':[j.getValues()[1]]}));j.setValues([j.getValues()[0]]);}}});}}};function g(e){for(var i=e.length-1;i>=0;i--){var j=e[i];if(j.feed&&j.feed==="color"&&j.palette){return i;}}return-1;}f.prototype._checkProps=function(e,o,i){if(e==='fiori'){a.decorateFiori(o,i,this.getVizProperties());}if(o.properties){o.properties=d.removeInvalid(o.type,o.properties);}if(o.type==="info/bullet"||o.type==="info/vertical_bullet"){o.properties=this._mergeProperties(o.properties||{},this._bulletProperties);a.decorateBullet(o,i);}if(o.type==="info/timeseries_bullet"){a.decorateTimeBullet(o);}if(o.type==="info/timeseries_waterfall"){a.decorateWaterfall(o,i);o.properties=this._mergeProperties(o.properties||{},this._waterfallProperties);}};function h(e,i,o){var m=d.mergeProperties;var j=sap.viz.ui5.theming.Util.readCSSParameters;var k=D.get(d,e,i);var n=D.getExtraProp(i);return m(e,k,j(e,o),n);}f.prototype._getTemplateProps=function(e,i){var m=d.mergeProperties;var j,k;var n={};for(k=0;k<C.CORE_CHART_TYPES.length;k++){j=C.CORE_CHART_TYPES[k];n[j]=h(j,e,this);}if(i.properties){for(k=0;k<C.CORE_CHART_TYPES.length;k++){j=C.CORE_CHART_TYPES[k];n[j]=m(j,i.properties[j],n[j]);n[j]=d.removeInvalid(j,n[j]);}}return n;};f.prototype._getOptions=function(t,e){var o={'type':t,'properties':{}};if(this._invalidateDataset){o.data=this._getVizDataset();if(this.__pendingDataRequest){return null;}this._invalidateDataset=false;}if(this._invalidateFeeds){o.bindings=this._getVizBindings(t,e);this._invalidateFeeds=false;}if(this.getProperty('vizProperties')){o.properties=this.getProperty('vizProperties');}if(this.getProperty('vizScales')){o.scales=this.getProperty('vizScales');}if(this.getProperty('vizCustomizations')){o.customizations=this.getProperty('vizCustomizations');}if(this._aRuntimeScales){o.sharedRuntimeScales=this._aRuntimeScales;}o.template=this._currentTemplate;return o;};f.prototype._setCustomMessages=function(o){this._errorInfo=o;this._handleDescription(this._errorType);};f.prototype._renderVizFrame=function(r){var e=(this.getUiConfig()||{}).applicationSet;var t=this._getCalculatedType();var i=this.getFeeds();var m=d.mergeProperties;var o={_invalidateDataset:this._invalidateDataset,_invalidateVizType:this._invalidateVizType,_invalidateFeeds:this._invalidateFeeds};this._migrate(t,i);var j=false,k=sap.ui.getCore().getConfiguration().getTheme();if((r&&r.forceThemeChange)||(this._currentTheme!==k)){j=true;}o.theme=k;if(!(this._invalidateFeeds||this._invalidateDataset||j||this._invalidateVizType)){return;}this._createContainerDiv();try{var n=this._getOptions(t,i);if(!n){return;}this._currentTheme=k;if(this._isExtension()){var p=h(t,e);n.properties=m(t,p,n.properties);}this._checkProps(e,n,i,t);if(this._invalidateVizType){this._invalidateVizType=false;}if(!this._vizFrame){if(n.data){this._createVizFrame(n);this._clearRequestedProperties();}}else{this._vizFrame.update(n);this._clearRequestedProperties();}if(this._connectPopover){this._connectPopover();}var v=this._getVizDataset();if(v&&v._FlatTableD&&(!v._FlatTableD._data.length)){throw C.ERROR_MESSAGE.NODATA;}else{this._errorType=null;this._updateDescription();}}catch(q){if(!this._vizFrame){this._invalidateDataset=o._invalidateDataset;this._invalidateVizType=o._invalidateVizType;this._invalidateFeeds=o._invalidateFeeds;this._currentTheme=o.theme;this._emptyVizFrame(!!this._vizFrame);}this._handleErr(q);}};f.prototype._themeChangedHandler=function(e){var i=(this.getUiConfig()||{}).applicationSet;var j=i||"";var m="";this._sCurrentScopeChain=this._getScopeString();if(this._sCurrentScopeChain){m=this._sCurrentScopeChain;}var t=sap.ui.getCore().getConfiguration().getTheme();var n=t+"_"+j+"_"+C.TEMPLATE_POSTFIX+m;this._currentTemplate=n;var k=sap.viz.api.env.Template.get();var o=sap.viz.extapi.env.Template;if(!o.isRegistered(n)||e){o.unregister(n);var p;if(k.indexOf(C.TEMPLATE_POSTFIX)>-1){p=o.getPackage('standard_fiori')||o.getPackage('default');}else{p=o.current();}if(!this._templateCache[n]){this._templateCache[n]=this._getTemplateProps(i,p);}var q=this._templateCache[n];p.properties=p.properties||{};p.scales=p.scales||{};for(var r in q){if(q.hasOwnProperty(r)){p.properties[r]=q[r];var s=p.scales[r];if(s){var u=g(s);if(u>-1){s.splice(u,1);}}}}p.id=n;p.name=n;o.register(p);}};f.prototype.onThemeChanged=function(e){if(this._app$&&this.$()){this._themeChangedHandler(e.triggeredBy&&e.triggeredBy==='themedesigner');this.invalidate();}};f.prototype._getVizDataset=function(){var e=this.getDataset();if(e){if(this._isExtension()){var m=this._getMetadata();if(m){if(m.dataType==='raw'){return e.getRawDataset();}else if(m.dataType==='sap.viz.api.data.CrosstableDataset'){V.updateAxis(e.getDimensions(),this._getCalculatedType(),this.getFeeds());return e.getVIZCrossDataset();}else{return e.getVIZFlatDataset();}}else{V.updateAxis(e.getDimensions(),this._getCalculatedType(),this.getFeeds());return e.getVIZCrossDataset();}}else{return e.getVIZFlatDataset();}}else{return null;}};f.prototype._getVizBindings=function(t,e){if(e&&e.length){var i=F.toLightWeightFmt(e);i=sap.viz.vizservices.BVRService.suggestFeeds(t,i,[{'id':'MND','type':'MND'}]).feedItems;if(this._isExtension()){var m=this._getMetadata();if(m){if(m.dataType==='sap.viz.api.data.CrosstableDataset'){return c.generateBindings(t,i,'CrossTableDataset');}else{return c.generateBindings(t,i,'FlatTableDataset');}}else{return c.generateBindings(t,i,'CrossTableDataset');}}else{return c.generateBindings(t,i,'FlatTableDataset');}}else{return null;}};f.prototype._getMetadata=function(){var m;try{m=sap.viz.api.metadata.Viz.get(this._getCalculatedType());}catch(e){m=null;}return m;};f.prototype._onConnectPopover=function(e){if(arguments.length>0){this._connectPopover=e;}return this._connectPopover;};f.prototype._createChildren=function(){this._themeChangedHandler();this._renderVizFrame();};f.prototype._updateChildren=function(){this._renderVizFrame();};f.prototype._validateSize=function(e){if(!this._app$||!this.$()||(e&&e.size&&(e.size.height==0||e.size.width==0))){return;}var i={'width':this.$().width(),'height':this.$().height()};if(this._vizFrame){var s=this._vizFrame.size();if(!s||s.width!==i.width||s.height!==i.height){this._vizFrame.size({'width':i.width,'height':i.height});}}};f.prototype._getCalculatedType=function(){if(this._isExtension()){return this.getVizType();}else{return this._getInfoType();}};f.prototype._isExtension=function(){return C.CORE_CHART_TYPES.indexOf(this._getInfoType())===-1;};f.prototype._getInfoType=function(){var v=this.getVizType();if(v.indexOf("info/")===-1){return'info/'+v;}else{return v;}};f.prototype._mergeProperties=function(t,p){return d.mergeProperties(this._getCalculatedType(),t,p);};f.prototype._wrapApi=function(n,e){this[n]=function(){var r=f.prototype[n].apply(this,arguments);e();return r;}.bind(this);};f.prototype._pendingDataRequest=function(p){if(arguments.length){this.__pendingDataRequest=!!p;}else{return this.__pendingDataRequest;}};f.prototype._updateDescription=function(e){var i=this.$().find("."+C.CSS_PREFIX+'-viz-description');var t=i.find("."+C.CSS_PREFIX+'-viz-description-title');var j=i.find("."+C.CSS_PREFIX+'-viz-description-detail');var m=i.find("."+C.CSS_PREFIX+'-viz-description-message');if(!i.length){return;}if(!e){i.hide();}else{i.show();t.empty();j.empty();m.empty();if(e.title){t.show().text(e.title);}if(e.detail){j.show().text(e.detail);}if(e.message){m.show().text(e.message);}}};f.prototype._handleDescription=function(e,i){var j;if(!e){return;}if(this._errorInfo&&this._errorInfo[e]){j={message:this._errorInfo[e]};}else if(e===C.ERROR_TYPE.INVALIDDATA){j={title:sap.viz.extapi.env.Language.getResourceString("IDS_ERROR_INVALIDE_DATA"),detail:sap.viz.extapi.env.Language.getResourceString("IDS_ERROR_INVALIDE_DATA_DESCRIPTION")}}else if(e===C.ERROR_TYPE.MULTIPLEUNITS){j={title:sap.viz.extapi.env.Language.getResourceString("IDS_ERROR_INVALIDE_DATA"),detail:sap.viz.extapi.env.Language.getResourceString("IDS_ERROR_INVALIDE_DATA_MULTIPLEUNITS")};}else if(e===C.ERROR_TYPE.NODATA){j={title:sap.viz.extapi.env.Language.getResourceString("IDS_ERROR_ISNODATA")};}else{j={message:i};}this._updateDescription(j);};f.prototype._handleErr=function(e){var s=(this.getUiConfig()||{}).showErrorMessage!==false;if(s){if(e===C.ERROR_MESSAGE.MULTIPLEUNITS){this._errorType=C.ERROR_TYPE.MULTIPLEUNITS;if(this._vizFrame){this._emptyVizFrame();this._clearVariables();this._vizFrame.destroy();this._vizFrame=null;this._templateCache={};}}else if(e===C.ERROR_MESSAGE.NODATA){this._errorType=C.ERROR_TYPE.NODATA;}else if(e.toString().indexOf("[50060]")>=0){this._errorType=C.ERROR_TYPE.INVALIDDATA;}else{this._errorType=C.ERROR_TYPE.OTHERS;}this._handleDescription(this._errorType,e);}if(this._errorType!==C.ERROR_TYPE.NODATA){this.fireEvent('renderFail',{'id':'renderFail','error':e});}};f.prototype._runtimeScales=function(r,s){if(arguments.length===0){return this._vizFrame?this._vizFrame.runtimeScales():this._aRuntimeScales;}else if(r){this._aRuntimeScales=[].concat(r);if(!s){this.invalidate();}}};f.prototype._states=function(){var r;if(this._vizFrame){r=this._vizFrame.states.apply(this._vizFrame,arguments);}return r===this._vizFrame?this:r;};return f;});
