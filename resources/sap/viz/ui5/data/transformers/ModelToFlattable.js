/*
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['sap/viz/ui5/controls/common/utils/Constants'],function(C){"use strict";var M=function(){this.reset();this._pagingUnit=null;};M.prototype.reset=function(O){this._oVIZFlatTable=null;this._aFlatContextLookup=null;};var o=Object.prototype.toString;function a(i){return o.call(i)==='[object Array]';}M.prototype.getVizDataset=function(b,d,m,c,i,e,p,f){if(!this._oVIZFlatTable&&sap.viz.__svg_support){this._createVIZFlatTable(b,d,m,e,p,f);}return this._oVIZFlatTable||null;};M.prototype.findContext=function(c){if(this._aFlatContextLookup&&typeof c==='object'&&c._context_row_number!==undefined){return this._aFlatContextLookup[c._context_row_number];}};M.prototype._createVIZFlatTable=function(b,d,m,c,p,e){var f=(!c||c.startIndex===undefined)?0:c.startIndex;var l;if(!c||c.length===undefined){if(b){l=b.getLength();}}else{l=c.length;}var g=['_context_row_number'];if(e){if(!a(e)){e=[e];}for(var i=0;i<e.length;++i){var n=e[i];var s=!(n.showInTooltip===false);if(n.id){n=n.id;}g.push({id:n,showInTooltip:s});}}var A=[],h=[],k=[],q={'metadata':{'fields':[]},'context':g,'data':[]},r=[];jQuery.each(d,function(i,j){A.push({def:j,vAdapter:j._getAdapter(),dAdapter:j._getDisplayValueAdapter()});var x=j.getDataType();q.metadata.fields.push({'id':j.getIdentity()||j.getName(),'name':j.getName()||j.getIdentity(),'semanticType':'Dimension','dataType':x,'inResult':j._getInResult(),'timeUnitType':j._getTimeUnit()});});jQuery.each(m,function(i,j){h.push({def:j,adapter:j._getAdapter()});var x={'id':j.getIdentity()||j.getName(),'name':j.getName()||j.getIdentity(),'semanticType':'Measure'};x.formatString=j.getFormat();if(j.getUnit()){x.unit=j.getUnit();}x.unitBinding=j._getUnitBinding();var R=j.getRange();if(R&&R.length){x.min=R[0];x.max=R[1];}q.metadata.fields.push(x);});var t,u,v,w=sap.ui.require("sap/ui/model/analytics/AnalyticalBinding"),O=sap.ui.require("sap/ui/model/odata/ODataListBinding");if(b){if((w&&b instanceof w)||(O&&b instanceof O)){if(p){t=p.iStartIndex;u=p.iLength;if(p.bEnabled){q.metadata.options={pagination:{mode:p.sMode,ratio:p.thumbRatio}};}this._iRenderedPageNo=p.iPageNo;}else{t=0;if(w&&b instanceof w){u=+b.getTotalSize();}else{u=+b.getLength();}u=Math.max(u,0);}v=b.getContexts(t,u);}else{v=b&&b.getContexts(f,l);}}if(!v||v.length===0){this.reset();this._oVIZFlatTable=new sap.viz.api.data.FlatTableDataset(q);return;}if(p&&(!this._pagingUnit||p.sMode==="reset")){this._pagingUnit=[];}jQuery.each(v,function(I,x){if(!q.data[I]){q.data[I]=[];}for(var i=0;i<A.length;i++){var y=A[i].vAdapter(x);if(y instanceof Date){y=y.getTime();}var V=A[i].dAdapter(x);q.data[I].push(V.enableDisplayValue?{v:y,d:V.value}:y);}for(var j=0;j<h.length;j++){var y=h[j].adapter(x);q.data[I].push(y);var U=h[j].def._getUnitBinding();var z=x.getProperty(U);if(U){if(k[j]){if(k[j]==="*"||k[j]!==z||(p&&this._pagingUnit[j]!==z)){throw C.ERROR_MESSAGE.MULTIPLEUNITS;}}else{k[j]=z;if(p&&!this._pagingUnit[j]){this._pagingUnit[j]=z;}}}}r[I]=x;}.bind(this));this._aFlatContextLookup=r;q.metadata.fields.filter(function(j){return(j.semanticType==="Measure");}).forEach(function(j,f){if(j.unitBinding&&k[f]){j.unit=k[f];delete j.unitBinding;}});this._oVIZFlatTable=new sap.viz.api.data.FlatTableDataset(q);};M.prototype.getRenderedPageNo=function(){return this._iRenderedPageNo;};return M;},true);
