/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['sap/viz/ui5/data/DimensionDefinition','sap/viz/ui5/data/MeasureDefinition','sap/viz/ui5/controls/common/feeds/FeedItem','sap/viz/ui5/controls/common/feeds/AnalysisObject','sap/chart/TimeUnitType','sap/chart/utils/DateFormatUtil','sap/chart/utils/ChartUtils','sap/chart/utils/RoleMapper'],function(D,M,F,A,T,a,C,R){"use strict";var s=function(){return sap.viz.vizservices.BVRService.suggestFeeds.apply(null,arguments);};var b=function(f,i){var r=sap.viz.vizservices.FeedService.validate(f,i);if(!r.valid){var k=r.results?r.results.bindings:null;if(k&&Object.keys(k).every(function(m){return k[m].allowMND&&(!k[m].missing||k[m].missing===1)&&!k[m].incorrect;})){return{valid:true};}}return r;};var _=[{"types":"*","toViz":{"category|category2":"categoryAxis","series":"color","axis1|axis2|axis3|axis4":"valueAxis"}},{"types":"column|bar|stacked_bar|stacked_column|line|combination|100_stacked_bar|100_stacked_column|stacked_combination|horizontal_stacked_combination","toViz":{}},{"types":"scatter|bubble|time_bubble|timeseries_scatter|timeseries_bubble","toViz":{"category|category2":"@context","axis1":"valueAxis","axis2":"valueAxis2"}},{"types":"bubble|time_bubble","toViz":{"axis3":"bubbleWidth"}},{"types":"pie|donut","toViz":{"category|series|category2":"color","axis1|axis2|axis3|axis4":"size"}},{"types":"bullet|vertical_bullet","toViz":{"axis1|axis2|axis3|axis4":"@semanticBulletMsrs"}},{"types":"dual_combination|dual_horizontal_combination|dual_stacked_bar|100_dual_stacked_bar|dual_stacked_column|100_dual_stacked_column|dual_bar|dual_column|dual_line|dual_stacked_combination|dual_horizontal_stacked_combination","toViz":{"axis1":"valueAxis","axis2|axis3|axis4":"valueAxis2"}},{"types":"timeseries_line|timeseries_column|timeseries_combination|timeseries_stacked_column|timeseries_100_stacked_column","toViz":{"category":"timeAxis"}},{"types":"timeseries_scatter","toViz":{"category":R,"axis2|axis3":false}},{"types":"timeseries_bubble","toViz":{"category":R,"axis2":false,"axis3":"bubbleWidth"}},{"types":"dual_timeseries_combination","toViz":{"category":"timeAxis","axis1":"valueAxis","axis2|axis3|axis4":"valueAxis2"}},{"types":"heatmap","toViz":{"category":"categoryAxis","category2|series":"categoryAxis2","axis1|axis2|axis3|axis4":"color"}},{"types":"waterfall|horizontal_waterfall","toViz":{"series":"waterfallType"}},{"types":"timeseries_bullet","toViz":{"category|series":"timeAxis","axis1|axis2|axis3|axis4":"@semanticBulletMsrs"}},{"types":"timeseries_waterfall","toViz":{"category|series":"timeAxis"}}].reduce(function(m,f){var i=Object.keys(f.toViz).reduce(function(i,k){k.split("|").forEach(function(r){i[r]=f.toViz[k];return i;});return i;},{});f.types.split("|").forEach(function(k){if(!m.hasOwnProperty(k)){m[k]=[];}m[k].push(i);});return m;},{});var c=Object.keys(_).reduce(function(m,f){if(f!=="*"){m[f]=jQuery.extend.apply(null,[true,{}].concat(_["*"].concat(_[f])));}return m;},{});function d(f,k,v){var i=(typeof k==="function")?k:function(o){return o[k];};return f.reduce(function(o,m){var n=i(m),r=(typeof v==="function")?v(m):m;if(n&&!o[n]){o[n]=[r];}else if(n){o[n].push(r);}return o;},{});}function e(m,f){var o={},r;f.forEach(function(v){var i=v.getRole();if(m.hasOwnProperty(i)){var k=m[i];if(k){if(typeof k==="function"){if(!r){r=new k();}k=r.toFeedingId(v);}if(!o[k]){o[k]=[];}o[k].push(v);}}});return o;}var L={from:F.fromLightWeightFmt,build:function(o){var f=[];jQuery.each(o.dims,function(k,v){f.push({id:k,type:"Dimension",values:v.map(g("Dimension"))});});jQuery.each(o.msrs,function(k,v){f.push({id:k,type:"Measure",values:v.map(g("Measure"))});});return f;}};function g(f){return function(o){var i=o.getName();if(i==="MND"){return{id:"MND",type:"MND"};}var k={id:i,name:i,type:f};if(o instanceof sap.chart.data.TimeDimension){k.dataType="Date";}return k;};}function w(o,l){var n=o.getName(),f=o.getLabel(),i=o.getTextProperty(),k=o.getTextFormatter(),m=o.getDisplayText();var r={identity:n,name:f||n,value:"{"+n+"}"};if(typeof k==="function"){r.displayValue={formatter:k,parts:[{path:n,type:new sap.ui.model.type.String()}]};if(i){r.displayValue.parts.push({path:i,type:new sap.ui.model.type.String()});}}else if(m&&i){r.displayValue="{"+i+"}";}var v=new D(r);if(l&&o instanceof sap.chart.data.TimeDimension){var H=a.getInstance(o.getTimeUnit());if(H){var P=H.parse.bind(H);v.getBindingInfo("value").formatter=function(V){return P(V);};}v.setDataType("Date");v._setTimeUnit(o.getTimeUnit());}return v;}function h(m){var n=m.getName();var o=new M({identity:n,name:m.getLabel()||n,value:"{"+n+"}"});o._setUnitBinding(m.getUnitBinding());return o;}function j(f,i){var m=sap.viz.api.metadata.Viz.get("info/"+f),k=d(m.bindings,"role"),n=d(i,"id"),o=k["layout.category"]||[],S=k["mark.color"]||[];if(o.length===0){return[];}else{var O=[];jQuery.each(o.concat(S),function(r,v){var H=n[v.id];if(H&&H.length>0){jQuery.each(H[0].values,function(J,V){O.push(V.id);});}});return O;}}function l(f){return C.CONFIG.timeChartTypes.indexOf(f)>-1;}function p(f,i,m,k){var r=c[f];var o={dims:e(r,i),msrs:e(r,m)};var n=null,S=null;if(o.dims["@context"]){n=o.dims["@context"];delete o.dims["@context"];}if(o.msrs["@semanticBulletMsrs"]){R.semantics.semanticBulletMsrs(o.msrs,l(f));}if(C.CONFIG.nonSemanticPatternChartType.indexOf(f)===-1&&k){S=R.semantics.semanticPatternMsrs(o,f);n=(n||[]).concat(S.contexts);}else{if(k){jQuery.sap.log.warning('Analytical Chart',f+" doesn't support semantic pattern feature.");}else{jQuery.sap.log.warning('DataPointStyle or seriesStyle have been set.');}}var v=L.build(o);v.contexts=n;if(S){v.semanticTuples=S.semanticTuples;}return v;}var I=[{chartTypes:"bar,column,line,combination,heatmap,bullet,vertical_bullet,stacked_bar,stacked_column,stacked_combination,horizontal_stacked_combination,dual_bar,dual_column,dual_line,dual_stacked_bar,dual_stacked_column,dual_combination,dual_horizontal_combination,dual_stacked_combination,dual_horizontal_stacked_combination,100_stacked_bar,100_stacked_column,100_dual_stacked_bar,100_dual_stacked_column,waterfall,horizontal_waterfall".split(","),feed:"categoryAxis"},{chartTypes:"donut,pie,scatter,bubble".split(","),feed:"color"}];function q(f,k,m){var i,n;for(i=0;i<I.length;i++){if(I[i].chartTypes.indexOf(f)!==-1){n=I[i].feed;break;}}var H=k.some(function(r){return r.id===n;});if(!H){var o=s("info/"+f,k,[{id:"MND",type:"MND"}]).feedItems;k.splice(0,k.length);o.forEach(function(r){if(r.values.length>0){k.push(r);}});k=z(f,k);}for(i=0;i<k.length;i++){if(k[i].id===n&&k[i].type==="Dimension"){k[i].values=k[i].values.concat(m.map(function(r){return{id:r.getName(),name:r.getName(),type:"Dimension",inResult:true};}));}}return b("info/"+f,k);}function t(f){f.forEach(function(o){o._sFixedRole=o.getRole();});}function u(f,i,k){i.forEach(function(o){o.values.forEach(function(m){var n=k.filter(function(n){return n.getName()===m.id;})[0];if(n){jQuery.each(c[f],function(r,v){if(v===o.id){n._sFixedRole=r;return false;}});}});});}function x(k,m,n,r,H){var J=p(k,m,n,H),K=J.contexts,N=J.semanticTuples,O=[];if(N){O=N.filter(function(f){return f.projectedValueStartTime;});}var V=b("info/"+k,J);var P=m.concat(n).concat(r);t(P);if(!V.valid){J=B(k,V,J,m,n);V=b("info/"+k,J);u(k,J,P);}if(V.valid&&r&&r.length>0){var Q=d(m,function(o){return o.getName();});q(k,J,r.filter(function(o){return!Q[o.getName()];}));}var S=J.reduce(function(i,f){f.values.forEach(function(v){i[v.id]=true;});return i;},{});var U=L.from(J);if(K){K.forEach(function(f){S[f.getName()]=true;});U._context=K.map(function(f){var o=f.getName();var v=true;for(var i=0;i<O.length;i++){if(o===O[i].actual||o===O[i].projected){v=false;break;}}return{id:o,showInTooltip:v};});}U._unused=E(J,m,n).filter(function(f){return!S[f];});U._def=G(m,V.valid?r:[],n,S,N,l(k));U._order=j(k,J);U._valid=V.valid;U._semanticTuples=N;return U;}function y(f){return d(sap.viz.api.metadata.Viz.get("info/"+f).bindings,"id");}function z(f,i,m){m=m||y(f);i.forEach(function(o){o.type=m[o.id][0].type;});return i;}function B(f,V,i,m,n){var o=y(f),r=false,H=false;var J=V.results.bindings;Object.keys(J).forEach(function(k){if(!o[k]){return;}if(o[k][0].type==="Measure"){H=true;}if(o[k][0].type==="Dimension"&&!(J[k].allowMND&&(!J[k].missing||J[k].missing===1))){r=true;}});var K=i.filter(function(k){return!((k.type==="Dimension")?r:H);}),N=K.reduce(function(k,Q){(Q.values||[]).forEach(function(v){k[v.id]=true;});return k;},{});if(i.contexts){i.contexts.forEach(function(k){N[k.getName()]=true;});}var O=m.map(g("Dimension")),P=n.map(g("Measure"));var S=s("info/"+f,K,O.concat(P).filter(function(k){return!N[k.id];})).feedItems;z(f,S,o);return S;}function E(i,k,m){var U=i.reduce(function(n,f){f.values.forEach(function(v){n[v.id]=true;});return n;},{});return k.concat(m).filter(function(n){return!U[n.getName()];}).map(function(n){return n.getName();});}function G(f,k,m,v,S,l){var o;if(l){var n;for(var i=0;i<f.length;i++){if(f[i]instanceof sap.chart.data.TimeDimension){n=f[i];break;}}o=a.getInstance(n.getTimeUnit());}return{dim:f.reduce(function(V,r){if(v[r.getName()]){V.push(w(r,l));}return V;},[]).concat(k.map(function(r){var H=w(r);H._setInResult(true);return H;})),msr:m.reduce(function(V,r){if(v[r.getName()]){V.push(h(r));}return V;},[]).concat((S||[]).reduce(function(r,H){if(H.timeAxis&&H.projectedValueStartTime){r.push(new M({identity:H.actual+"-"+H.projected,name:((H.labels&&H.labels.actual)||H.actual)+"-"+((H.labels&&H.labels.projected)||H.projected),value:{parts:[H.timeAxis,H.actual,H.projected],formatter:function(J){var K=J,N;if(J&&J.length>1){var O=J[0];if(O){if(o){var P=o.parse(O);if(P){N=P.getTime();}}else{N=new Date(O).getTime();}if(N&&(N<H.projectedValueStartTime)){K=J[1];}else{K=J[2];}}}return K;}}}));}return r;},[]))};}return{fit:x,compatible:function(f,i,m){var n="info/"+f,r={used:{},error:null,compatible:true};var H=p(f,i,m),V=b(n,H);if(!V.valid){H=B(f,V,H,i,m);V=b(n,H);r.needFix=true;}if(V.valid){r.used=d(H,function(o){return o.type;},function(o){return o.values.filter(function(v){return v.type==="Dimension"||v.type==="Measure";}).map(function(v){return v.id;});});jQuery.each(r.used,function(k,v){r.used[k]=v.reduce(function(o,O){return o.concat(O);},[]);});}else{r.compatible=false;var J=sap.viz.api.metadata.Viz.get(n).bindings,K=d(J,"type",function(o){return o.id;}),N={dim:0,msr:0,time:0};jQuery.each(V.results.bindings,function(k,v){if(!v.missing){return;}if(K.Dimension.indexOf(k)!==-1&&!(v.allowMND&&v.missing===1)){N[k==="timeAxis"?"time":"dim"]+=v.missing;}else if(K.Measure.indexOf(k)!==-1){N.msr+=v.missing;}});r.error={missing:N};}return r;}};});
