jQuery.sap.declare("sap.zen.crosstab.EventHandler");jQuery.sap.require("sap.zen.crosstab.TouchHandler");jQuery.sap.require("sap.zen.crosstab.SelectionHandler");jQuery.sap.require("sap.zen.crosstab.rendering.CrossRequestManager");jQuery.sap.require("sap.zen.crosstab.rendering.RenderingConstants");jQuery.sap.require("sap.zen.crosstab.utils.Utils");jQuery.sap.require("sap.zen.crosstab.keyboard.CrosstabKeyboardNavHandler");
sap.zen.crosstab.EventHandler=function(c){"use strict";var t=this;var r=c.getRenderEngine();var C=r.getCrossRequestManager();var d=c.getDataArea();var R=c.getRowHeaderArea();var o=c.getColumnHeaderArea();var D=c.getDimensionHeaderArea();var h=null;var k=new sap.zen.crosstab.keyboard.CrosstabKeyboardNavHandler(c,this);var m=null;var p=false;var T=null;var j=null;var O=0;var b=false;var i=0;var l=0;var s="";var I=null;this.handleHierarchyClick=function(e,q,u){var v=f(q);var H=v.getHierarchyAction();var w=v.getDrillState();if(w!=="L"){C.saveTableDimensions();C.saveHScrollInfo(u);C.saveVScrollInfo(u);n(H);}sap.zen.crosstab.utils.Utils.cancelEvent(e);};this.handleSortClick=function(e,q,u){var v=f(q);var S=v.getSortAction();if(S||c.getTestProxy().getTestAction()){C.saveVScrollInfo(u);C.saveHScrollInfo(u);C.saveColWidths();if(!c.getTestProxy().getTestAction()){n(S);}}sap.zen.crosstab.utils.Utils.cancelEvent(e);};this.findTargetId=function(e){var q=null;var J;var u;u=$(e).attr("xtabspacer-cellid");if(u&&u.length>0){q=u;}else{J=$(e).closest("div");if(J.length>0){var v=J.attr("id");if(v){var w=v.indexOf("_contentDiv");if(w>-1){q=v.slice(0,w);}}}}return q;};this.executeOnClickAction=function(e){if(p){return;}m=null;p=false;var q=e.target.id;if(!q){q=t.findTargetId(e.target);}if(!q){return;}var u=g(q);if(u==="sort"){t.handleSortClick(e,q,u);}else if(u==="hier"){t.handleHierarchyClick(e,q,u);}else if(u==="__ce"){t.handleClickOnCell(e,q);}else if(u==="vhlp"){t.handleValueHelpClick(q);}sap.zen.crosstab.utils.Utils.cancelEvent(e);};this.handleClickOnCell=function(e,q){if(c.hasLoadingPages()){sap.zen.crosstab.utils.Utils.cancelEvent(e);return;}if(q){var u=c.getUtils().getCellIdFromContenDivId(q);if(u){var M=sap.ui.getCore().getControl(u);if(M){if(M.isEntryEnabled()){t.handleInputEnabledCell(q,-1,-1);}else{if(c.getSelectionMode()!==undefined&&c.getSelectionMode()!==""){var F="";if(e.ctrlKey){F="CTRL";}else if(e.shiftKey){F="SHIFT";}c.getSelectionHandler().handleCellClick(M,F);}}}}}};this.postPlanningValue=function(){if(c.isPlanningMode()===true&&I&&I.length>0){var J=$(document.activeElement);if(J.is("input")&&I.attr("id")===J.attr("id")){var e=I.val()||"";if(e!==s){I.blur();}}}};this.provideInputEnabledCell=function(M,q,u,S,v){I=u.find("input");if(I.length===0){var w=u.text();var x=u.html();var y=M.getArea().isDataArea();var z=null;var A=function(V){var U=M.getUnit();if(U&&U!==""){var e=V.toUpperCase().indexOf(U.toUpperCase());if(e!==-1){if(e===0){V=V.substring(e+U.length);}else{V=V.substring(0,e);}}}var J=c.calculateOffset(M);V=$.trim(V);var K=c.getTransferDataCommand();K=K.replace("__ROW__",M.getRow()+"");K=K.replace("__COL__",(M.getCol()-J)+"");K=K.replace("__VALUE__",V);K=K.replace("__CTYPE__",M.getPassiveCellType());C.saveVScrollInfo("plan");C.saveHScrollInfo("plan");C.saveColWidths();n(K,true);};var B=function(e){if(I.val()!==w){A(I.val());var J=$('<div/>').text(w).html();x=x.replace(J,I.val());}F(e);};var E=function(e){var J=true;var q=null;var K=null;var L=null;if(e&&e.relatedTarget&&e.relatedTarget.id&&c.getValueHelpStatus()!==sap.zen.crosstab.VHLP_STATUS_OPENING){q=e.relatedTarget.id;L=$('#'+q);K=c.getTableDiv();J=L.closest(K).length>0;}return J;};var F=function(e){var J=$('#'+q+"_contentDiv");J.html(x);if(z&&y){J.width(z);}if(E(e)===true){J.focus();}else{k.reset();s="";I.off("keydown focusout");I=null;}};var G=function(e){if(e.which===27){F();sap.zen.crosstab.utils.Utils.cancelEvent(e);}if(e.which===13){if(I.val()!==w){sap.zen.crosstab.utils.Utils.cancelEvent(e);A(I.val());}else{F();if(c.isIE8Mode()){k.keyboardNavKeyHandler(e);}}}if(e.which===38||e.which===40){return true;}if(e.which===37||e.which===39){if(!e.ctrlKey&&!e.altKey&&!e.shiftKey){sap.zen.crosstab.utils.Utils.stopEventPropagation(e);}return true;}if(e.which===115&&!y){t.invokeValueHelp(M,"vhlp_"+M.getId());}};var H=0;if(y){H=u.innerWidth();z=sap.zen.crosstab.utils.Utils.getWidthFromStyle(u);}u.html("<input id=\""+q+"_input"+"\" type=\"text\" value=\""+w+"\" />");if(y){u.width(H+"px");}I=$('#'+q+"_input");if(sap.zen.crosstab.utils.Utils.isMainMode()){I.addClass("sapzencrosstab-EntryEnabledInput-MainMode");}else{I.addClass("sapzencrosstab-EntryEnabledInput");}I.on("keydown",G);I.focus();c.getUtils().selectTextInInputField(I,S,v);I.on("focusout",B);}else{c.getUtils().selectTextInInputField(I,S,v);}s=I.val()||"";};this.handleValueHelpClick=function(e){var q=f(e);t.invokeValueHelp(q,e);};this.invokeValueHelp=function(e,q){if(e){k.focusNewCell(e,-1,-1);var u=c.getCallValueHelpCommand();var v=c.calculateOffset(e);C.saveVScrollInfo("plan");C.saveHScrollInfo("plan");C.saveColWidths();u=u.replace("__ROW__",e.getRow());u=u.replace("__COL__",e.getCol()-v);u=u.replace("__DOM_REF_ID__",q);n(u,true);}};this.handleInputEnabledCell=function(e,S,q){if(e){e=c.getUtils().getCellIdFromContenDivId(e);if(e){var M=sap.ui.getCore().getControl(e);if(M){if(M.getArea().isDataArea()||M.getArea().isRowHeaderArea()){k.focusNewCell(M,S,q);}}}}};this.sendSelectCommand=function(e){var q=-1;var u=-1;var A="";if(e){var v=e.getArea();if(v.isRowHeaderArea()){A="ROWS";}else if(v.isColHeaderArea()){A="COLUMNS";}else{A="DATA";}q=e.getRow();u=e.getCol();}var w=c.getOnSelectCommand();w=w.replace("__ROW__",q+"");w=w.replace("__COL__",u+"");w=w.replace("__AXIS__",A);n(w,true);};this.resetColWidths=function(e,u,L){var E=e.getCol()+e.getColSpan()-1;var q=0;var v=e.getCol()+e.getColSpan()-e.getEffectiveColSpan();for(q=E;q>=v;q--){u.resetColWidth(q);L.resetColWidth(q);u.setUserResizedCol(q);L.setUserResizedCol(q);}};this.doColResize=function(e){var u=e.getArea();if(u.isColHeaderArea()){var d=c.getDataArea();this.resetColWidths(e,u,d);}else if(u.isDimHeaderArea()){var R=c.getRowHeaderArea();this.resetColWidths(e,u,R);}c.invalidate();};this.executeOnDblClickAction=function(e){var q=e.target.id;var u=g(q);var v;if(u==="resi"){v=f(q);t.doColResize(v);sap.zen.crosstab.utils.Utils.cancelEvent(e);}};this.attachEvents=function(){var q=$("#"+c.getId()+"_renderSizeDiv");q.unbind("dblclick");q.bind("dblclick",this.executeOnDblClickAction);q.unbind("mousedown");q.bind("mousedown",this.executeOnMouseDown);if(c.getPropertyBag().isMobileMode()||c.getPropertyBag().isTestMobileMode()){q.unbind('click');q.bind('click',function(e){sap.zen.crosstab.utils.Utils.cancelEvent(e);});q.unbind('mousedown');q.bind('mousedown',function(e){sap.zen.crosstab.utils.Utils.cancelEvent(e);});T=new sap.zen.crosstab.TouchHandler(this,c);T.registerTouchEvents(q);k.setEnabled(false);}else{q.unbind("mouseup",this.executeOnMouseUp);q.bind("mouseup",this.executeOnMouseUp);q.unbind('click');q.bind('click',this.executeOnClickAction);if(c.isSelectable()===true&&c.isHoveringEnabled()===true){q.unbind('mouseover');q.bind('mouseover',this.executeOnMouseEnter);q.unbind('mouseout');q.bind('mouseout',this.executeOnMouseOut);}k.setEnabled(c.isPlanningMode());k.attachEvents(q);if(c.getUserHeaderWidthCommand()&&c.getUserHeaderWidthCommand().length>0){this.attachEventsToResizeHeaderDiv();q.unbind("mousemove",this.handleMouseMoveHeaderResizeHandle);q.bind("mousemove",this.handleMouseMoveHeaderResizeHandle);}}};this.handleMouseMoveHeaderResizeHandle=function(e){var q;var u;var N;var M;var v=c.getPropertyBag().getMaxHeaderWidth();if(j){b=true;if(c.getPropertyBag().isRtl()){q=parseInt(j.css("right"),10);u=O-e.clientX;}else{q=parseInt(j.css("left"),10);u=e.clientX-O;}O=e.clientX;M=Math.min(l,i);if(v>0){M=Math.min(M,v);}N=Math.max(1,Math.min(q+u,M));if(c.getPropertyBag().isRtl()){j.css("right",N+"px");}else{j.css("left",N+"px");}sap.zen.crosstab.utils.Utils.cancelEvent(e);}};this.handleMouseUpHeaderResizeHandle=function(e){var M=r.getLeftAreaContainerWidth();var L;var w="";if(c.getPropertyBag().isRtl()){L=parseInt(j.css("right"),10);}else{L=parseInt(j.css("left"),10);}w=L+"";r.sendHeaderLimit(w,false);b=false;j.removeClass("sapzencrosstab-headerResizeHandleActive");j=null;$(document).unbind("mouseup",t.handleMouseUpHeaderResizeHandle);sap.zen.crosstab.utils.Utils.cancelEvent(e);};this.onMouseDownHeaderResizer=function(e){j=$(e.currentTarget);i=$('#'+c.getId()+"_renderSizeDiv").outerWidth();l=r.getLeftAreaContainerWidth();O=e.clientX;$(document).on("mouseup",t.handleMouseUpHeaderResizeHandle);sap.zen.crosstab.utils.Utils.cancelEvent(e);};this.attachEventsToResizeHeaderDiv=function(){var e=$('#'+c.getId()+"_headerResizeHandle");e.unbind("hover");e.hover(function(){e.addClass("sapzencrosstab-headerResizeHandleActive");},function(){if(!b){e.removeClass("sapzencrosstab-headerResizeHandleActive");}});e.unbind("mousedown",this.onMouseDownHeaderResizer);e.bind("mousedown",this.onMouseDownHeaderResizer);e.unbind("mouseup",this.executeOnMouseUp);e.bind("mouseup",this.executeOnMouseUp);e.unbind("mousemove",this.handleMouseMoveHeaderResizeHandle);e.bind("mousemove",this.handleMouseMoveHeaderResizeHandle);};this.executeOnMouseDown=function(e){var q=e.target.id;var u=g(q);if(u==="resi"){sap.zen.crosstab.utils.Utils.cancelEvent(e);}else{m=q;}};function a(q,e){var u=false;var v=$('#'+q)[0];if(v){var w=v.getBoundingClientRect();var H=(w.left<e.clientX)&&(e.clientX<w.right);var V=(w.bottom>e.clientY)&&(e.clientY>w.top);u=H&&V;}return u;}this.executeOnMouseUp=function(e){if(j){t.handleMouseUpHeaderResizeHandle(e);}else{p=false;if(m){var q=c.getUtils().getCellIdFromContenDivId(m);if(a(q,e)){var u=sap.ui.getCore().getControl(q);if(u){if(c.isPlanningMode()){var v=$('#'+m)[0];var P=null;if(v){P=c.getUtils().getSelectionParams(v);}if(P.iSelectionStartPos>=0||P.iSelectionEndPos>=0){p=true;t.handleInputEnabledCell(e.target.id,P.iSelectionStartPos,P.iSelectionEndPos);}}}}else{if(!c.isDragAction()){sap.zen.crosstab.utils.Utils.cancelEvent(e);sap.zen.crosstab.utils.Utils.stopEventPropagation(e);}p=true;}}}};this.restoreFocusOnCell=function(){k.restoreFocusOnCell();};function g(e){var A=e.slice(0,4);return A;}function f(e){var q=e.slice(5);return sap.ui.getCore().getControl(q);}function n(A,e){if(A){if(!e){}c.getUtils().executeCommandAction(A);}}this.handleHoverEntry=function(e){if(e){var q=c.getUtils().getCellIdFromContenDivId(e);if(q&&q!==undefined){var M=sap.ui.getCore().getControl(q);if(M&&M!==undefined){c.getSelectionHandler().handleCellHoverEntry(M);}}}};this.executeOnMouseEnter=function(e){var P=null;var q=e.target.id;if(c.hasLoadingPages()){sap.zen.crosstab.utils.Utils.cancelEvent(e);return;}if(!q){q=t.findTargetId(e.target);}if(!q){return;}P=g(q);if(P==="__ce"){t.handleHoverEntry(q);}sap.zen.crosstab.utils.Utils.cancelEvent(e);};this.executeOnMouseOut=function(e){c.getSelectionHandler().handleCellHoverOut(e);sap.zen.crosstab.utils.Utils.cancelEvent(e);};this.enableClick=function(){p=false;m=null;};};
