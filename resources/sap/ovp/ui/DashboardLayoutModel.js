sap.ui.define([],function(){"use strict";var L=function(u,c){this.uiModel=u;this.setColCount(c);this.aCards=[];this.oLayoutVars=null;this.oUndoBuffer={};this.bSequenceLayout=null;this.oCurrLayoutVar=null;this.sManifestLayoutsJSON=null;this.iDisplaceRow=9999;};L.prototype.setColCount=function(c){if(!c){this.iColCount=5;}else if(c!==this.iColCount){if(this.bLayoutChanged){this._updateCurrentLayoutVariant();this.oUndoBuffer={};this.bLayoutChanged=false;}this.iColCount=c;}};L.prototype.setLayoutVars=function(l){var a=null;var c=null;if(this.oCurrLayoutVar&&this.oCurrLayoutVar.__ovpDBLVarId){c=this.oCurrLayoutVar.__ovpDBLVarId;}for(a in l){if(l.hasOwnProperty(a)&&l[a]){this.oLayoutVars[a]=l[a];}}if(c){this.oCurrLayoutVar=this.oLayoutVars[c];}this._buildGrid();this._removeSpaceBeforeCard();};L.prototype.setManifestLayoutsJSON=function(m){this.sManifestLayoutsJSON=m;};L.prototype.updateCardVisibility=function(c){var i=0;var l;var a;this.oLayoutVars["C"+this.iColCount]=this.extractCurrentLayoutVariant();for(i=0;i<c.length;i++){for(l in this.oLayoutVars){if(this.oLayoutVars[l].hasOwnProperty(c[i].id)){a=this.oLayoutVars[l];if(a[c[i].id].hasOwnProperty("visible")&&a[c[i].id].visible===false&&c[i].visibility){a[c[i].id].col=0;a[c[i].id].row=0;}a[c[i].id].visible=c[i].visibility;}}this.oCurrLayoutVar=this.oLayoutVars["C"+this.iColCount];}this._setCardsLayoutFromVariant(this.aCards,this.oCurrLayoutVar);this._removeSpaceBeforeCard();};L.prototype.getColCount=function(){return this.iColCount;};L.prototype.getCards=function(c){if(this.aCards.length===0||c&&c!==this.iColCount){if(c){this.setColCount(c);}this._buildGrid();}return this.aCards;};L.prototype.getCardById=function(c){var C=null;var i=0;for(i=0;i<this.aCards.length;i++){C=this.aCards[i];if(C.id===c){break;}}return C;};L.prototype.getCardsByGrid=function(g,a){var c={};var i=0;var C={};var m=[];for(i=0;i<this.aCards.length;i++){C=this.aCards[i];if(C.id===a||!C.dashboardLayout.visible){continue;}c.y1=C.dashboardLayout.row;c.x1=C.dashboardLayout.column;c.y2=C.dashboardLayout.row+C.dashboardLayout.rowSpan-1;c.x2=C.dashboardLayout.column+C.dashboardLayout.colSpan-1;if(this._checkOverlap(c,g)){m.push(C);}}return m;};L.prototype.getLayoutVariants4Pers=function(){var v=null;var p=JSON.parse(JSON.stringify(this.oLayoutVars));for(v in p){if(p[v].__ovpDBLVarSource==="auto"||p[v].__ovpDBLVarSource==="manifest"){delete p[v];}}return p;};L.prototype.getCardByGridPos=function(g){this._sortCardsByCol(this.aCards);var i=0;var c={};for(i=0;i<this.aCards.length;i++){c=this.aCards[i];if(c.dashboardLayout.column<=g.column&&(c.dashboardLayout.column+c.dashboardLayout.colSpan-1)>=g.column&&c.dashboardLayout.row<=g.row&&(c.dashboardLayout.row+c.dashboardLayout.rowSpan-1)>=g.row){return c;}}};L.prototype._readVariants=function(u){var v={};this.oLayoutVars={};var l=null;if(!this.sManifestLayoutsJSON){l=this.uiModel.getProperty("/dashboardLayout");if(l){this.sManifestLayoutsJSON=JSON.stringify(l);}}if(u){l=JSON.parse(this.sManifestLayoutsJSON);}else{l=this.uiModel.getProperty("/dashboardLayout");}this.bSequenceLayout=true;if(!l){return;}for(var a in l){if(l.hasOwnProperty(a)&&l[a]){v=l[a];v.id=a;if(u){v.__ovpDBLVarSource="manifest";v.__ovpDBLVarId="C"+parseInt(v.id.replace(/[^0-9\.]/g,""),10);}this.oLayoutVars["C"+parseInt(v.id.replace(/[^0-9\.]/g,""),10)]=v;this.bSequenceLayout=false;}}};L.prototype.resetToManifest=function(){this.oCurrLayoutVar=null;this.oLayoutVars=null;this._buildGrid(true);};L.prototype._buildGrid=function(u){var i=0;var l=null;if(this.aCards.length===0){this.aCards=this.uiModel.getProperty("/cards");}if(!this.oLayoutVars||u){this._readVariants(u);}if(this.bSequenceLayout){this._sliceSequenceSausage();l=this.oLayoutVars["C"+this.iColCount];l.__ovpDBLVarSource="auto";this.bSequenceLayout=false;}else if(this.oLayoutVars["C"+this.iColCount]){l=this.oLayoutVars["C"+this.iColCount];}else if(this.oCurrLayoutVar){this._sliceSequenceSausage(this.oCurrLayoutVar);l=this.oLayoutVars["C"+this.iColCount];l.__ovpDBLVarSource="auto";}else{for(i=this.iColCount;i>0;i--){if(this.oLayoutVars["C"+i]){this._sliceSequenceSausage(this.oLayoutVars["C"+i]);l=this.oLayoutVars["C"+this.iColCount];l.__ovpDBLVarSource="auto";break;}}}if(!l){for(var o in this.oLayoutVars){this._sliceSequenceSausage(this.oLayoutVars[o]);l=this.oLayoutVars["C"+this.iColCount];l.__ovpDBLVarSource="auto";break;}}this.oCurrLayoutVar=l;this._setCardsLayoutFromVariant(this.aCards,this.oCurrLayoutVar);this._sortCardsByCol(this.aCards);};L.prototype._setCardsLayoutFromVariant=function(c,l){var C={};var o={};var i=0;for(i=0;i<c.length;i++){C=c[i];o=l[C.id];if(o){C.dashboardLayout={};if(o.colSpan){C.dashboardLayout.colSpan=o.colSpan;}else{C.dashboardLayout.colSpan=1;}if(o.rowSpan){C.dashboardLayout.rowSpan=o.rowSpan;}else{C.dashboardLayout.rowSpan=12;}if(o.hasOwnProperty("visible")&&o.visible===false){C.dashboardLayout.visible=false;}else{C.dashboardLayout.visible=true;if(o.col===0||o.row===0){this._displaceCardToEnd(C);}else{C.dashboardLayout.column=o.col;C.dashboardLayout.row=o.row;}if(o.autoSpan){C.dashboardLayout.autoSpan=o.autoSpan;}if(C.dashboardLayout.colSpan>this.iColCount){C.dashboardLayout.colSpan=this.iColCount;}}}else{this._setCardSpanFromDefault(C);this._displaceCardToEnd(C);l[C.id]={col:C.dashboardLayout.column,row:C.dashboardLayout.row,colSpan:C.dashboardLayout.colSpan,rowSpan:C.dashboardLayout.rowSpan};l.__ovpDBLVarSource="auto";}if(C.dashboardLayout.column>this.iColCount){this._displaceCardToEnd(C);jQuery.sap.log.warning("DashboardLayout: card ("+C.id+") in invalid column -> moved to end");}if(C.dashboardLayout.column+C.dashboardLayout.colSpan-1>this.iColCount){C.dashboardLayout.colSpan=Math.min(C.dashboardLayout.colSpan,this.iColCount);this._displaceCardToEnd(C);jQuery.sap.log.warning("DashboardLayout: card ("+C.id+") too wide -> moved to end");}}this.validateGrid(true);};L.prototype._displaceCardToEnd=function(c){c.dashboardLayout.column=1;c.dashboardLayout.row=this.iDisplaceRow;this.iDisplaceRow+=c.dashboardLayout.rowSpan;};L.prototype._setCardSpanFromDefault=function(c){if(!c.dashboardLayout){c.dashboardLayout={};}if(!c.settings.defaultSpan||c.settings.defaultSpan==="auto"){c.dashboardLayout.autoSpan=true;c.dashboardLayout.colSpan=1;c.dashboardLayout.rowSpan=12;}else{if(c.settings.defaultSpan&&c.settings.defaultSpan.cols){c.dashboardLayout.colSpan=Math.min(c.settings.defaultSpan.cols,this.iColCount);}else{c.dashboardLayout.colSpan=1;}if(c.settings.defaultSpan&&c.settings.defaultSpan.rows){c.dashboardLayout.rowSpan=c.settings.defaultSpan.rows;}else{c.dashboardLayout.rowSpan=12;}}};L.prototype._sliceSequenceSausage=function(u){var i=0;var j=0;var c=0;var C=0;var m=0;var o={};var s=[];if(!u){this._sortCardsSausage(this.aCards);}for(i=0;i<this.iColCount;i++){s.push({col:i+1,rows:0});}for(i=0;i<this.aCards.length;i++){o=this.aCards[i];if(!o.dashboardLayout){o.dashboardLayout={};}if(!u||!u.hasOwnProperty(o.id)){this._setCardSpanFromDefault(o);}else{if(u[o.id].hasOwnProperty("visible")){o.dashboardLayout.visible=u[o.id].visible;}if(u[o.id].colSpan&&u[o.id].colSpan>0){o.dashboardLayout.colSpan=u[o.id].colSpan;}else{o.dashboardLayout.colSpan=1;}if(u[o.id].rowSpan&&u[o.id].rowSpan>0){o.dashboardLayout.rowSpan=u[o.id].rowSpan;}else{o.dashboardLayout.rowSpan=12;}}if(o.dashboardLayout.hasOwnProperty("visible")&&o.dashboardLayout.visible===false){o.dashboardLayout.column=0;o.dashboardLayout.row=0;continue;}else if(!o.dashboardLayout.hasOwnProperty("visible")){o.dashboardLayout.visible=true;}if(o.dashboardLayout.colSpan>this.iColCount){o.dashboardLayout.colSpan=this.iColCount;}if(C<this.iColCount){c=C+1;}else{c=1;}if(c+o.dashboardLayout.colSpan-1>this.iColCount){c=1;}C=c+o.dashboardLayout.colSpan-1;o.dashboardLayout.column=c;m=0;for(j=o.dashboardLayout.column;j<o.dashboardLayout.column+o.dashboardLayout.colSpan;j++){if(s[j-1].rows>m){m=s[j-1].rows;}}o.dashboardLayout.row=m+1;for(j=o.dashboardLayout.column;j<o.dashboardLayout.column+o.dashboardLayout.colSpan;j++){s[j-1].rows=m+o.dashboardLayout.rowSpan;}}this.oLayoutVars["C"+this.iColCount]=this.extractCurrentLayoutVariant();};L.prototype._sortCardsSausage=function(c){c.sort(function(a,b){if(a.sequencePos&&b.sequencePos){if(a.sequencePos<b.sequencePos){return-1;}else if(a.sequencePos>b.sequencePos){return 1;}else{return 0;}}else if(a.sequencePos&&!b.sequencePos){return-1;}else if(!a.sequencePos&&b.sequencePos){return 1;}else{if(a.id<b.id){return-1;}else if(a.id>b.id){return 1;}else{return 0;}}});};L.prototype._sortCardsByCol=function(c){c.sort(function(a,b){if(!a.dashboardLayout&&b.dashboardLayout){return 1;}else if(a.dashboardLayout&&!b.dashboardLayout){return-1;}if(a.dashboardLayout.column&&a.dashboardLayout.row&&a.dashboardLayout.column===b.dashboardLayout.column){if(a.dashboardLayout.row<b.dashboardLayout.row){return-1;}else if(a.dashboardLayout.row>b.dashboardLayout.row){return 1;}}else if(a.dashboardLayout.column){return a.dashboardLayout.column-b.dashboardLayout.column;}else{return 0;}});};L.prototype._sortCardsByRow=function(c){c.sort(function(a,b){if(!a.dashboardLayout&&b.dashboardLayout){return 1;}else if(a.dashboardLayout&&!b.dashboardLayout){return-1;}if(a.dashboardLayout.column&&a.dashboardLayout.row&&a.dashboardLayout.row===b.dashboardLayout.row){if(a.dashboardLayout.column<b.dashboardLayout.column){return-1;}else if(a.dashboardLayout.column>b.dashboardLayout.column){return 1;}}else if(a.dashboardLayout.row){return a.dashboardLayout.row-b.dashboardLayout.row;}else{return 0;}});};L.prototype._checkOverlap=function(a,b){var x,y=false;if((a.x1>=b.x1&&a.x1<=b.x2)||(a.x2>=b.x1&&a.x2<=b.x2)||(b.x1>=a.x1&&b.x2<=a.x2)){x=true;}if((a.y1>=b.y1&&a.y1<=b.y2)||(a.y2>=b.y1&&a.y2<=b.y2)||(b.y1>=a.y1&&b.y2<=a.y2)){y=true;}return(x&&y);};L.prototype.undoLastChange=function(){if(this.oUndoBuffer.layoutVariant){this.oLayoutVars["C"+this.iColCount]=this.oUndoBuffer.layoutVariant;this.oUndoBuffer={};}};L.prototype.resizeCard=function(c,s,m){this._registerChange("resize");var r=this.getCardById(c);if(!r){return[];}var d=s.colSpan-r.dashboardLayout.colSpan;var a=s.rowSpan-r.dashboardLayout.rowSpan;if(d===0&&a===0){return{resizeCard:r,affectedCards:[]};}else if(m&&r.dashboardLayout.autoSpan){r.dashboardLayout.autoSpan=false;}if(!m||(a&&d===0)){this._arrangeCards(r,{"row":s.rowSpan,"column":r.dashboardLayout.colSpan},'resize');}else{this._arrangeCards(r,{"row":s.rowSpan,"column":s.colSpan},'resize');}r.dashboardLayout.colSpan=s.colSpan;r.dashboardLayout.rowSpan=s.rowSpan;return{resizeCard:r,affectedCards:this.aCards};};L.prototype._removeSpaceBeforeCard=function(){this._sortCardsByRow(this.aCards);var d={},t=[];for(var i=1;i<=this.iColCount;i++){d[i]=1;}for(var j=0;j<this.aCards.length;j++){var a=this.aCards[j].dashboardLayout.column;var u=this.aCards[j].dashboardLayout.column+this.aCards[j].dashboardLayout.colSpan-1;if(this.aCards[j].dashboardLayout.colSpan>1){for(var k=a;k<=u;k++){t.push(d[k]);}var m=Math.max.apply(Math,t);for(var l=a;l<=u;l++){d[l]=m+this.aCards[j].dashboardLayout.rowSpan;}this.aCards[j].dashboardLayout.row=m;}else{if((this.aCards[j].dashboardLayout.row!==d[a])){this.aCards[j].dashboardLayout.row=d[a];}d[a]=this.aCards[j].dashboardLayout.row+this.aCards[j].dashboardLayout.rowSpan;}}this._updateCurrentLayoutVariant();return this.aCards;};L.prototype._arrangeCards=function(c,n,d){this._sortCardsByRow(this.aCards);var a=[];var f=false;if(d==="drag"){c.dashboardLayout.row=n.row;c.dashboardLayout.column=n.column;}else if(d==="resize"){c.dashboardLayout.rowSpan=n.row;c.dashboardLayout.colSpan=n.column;}a.push(c);for(var i=0;i<a.length;i++){for(var j=0;j<this.aCards.length;j++){if(a[i].id===this.aCards[j].id||!a[i].dashboardLayout.visible){continue;}else{f=this._checkOverlapOfCards(a[i],this.aCards[j]);if(f===true){this.aCards[j].dashboardLayout.row=a[i].dashboardLayout.row+a[i].dashboardLayout.rowSpan;a.push(this.aCards[j]);}}}}};L.prototype._checkOverlapOfCards=function(o,a){var b=o.dashboardLayout.row;var c=o.dashboardLayout.row+o.dashboardLayout.rowSpan;var d=o.dashboardLayout.column;var e=o.dashboardLayout.column+o.dashboardLayout.colSpan;var f=a.dashboardLayout.row;var g=a.dashboardLayout.row+a.dashboardLayout.rowSpan;var h=a.dashboardLayout.column;var i=a.dashboardLayout.column+a.dashboardLayout.colSpan;var j=false,k=false;if((h>=d&&h<e)||(i>d&&i<=e)||(h<=d&&i>=e)){j=true;}if((f>=b&&f<c)||(g>b&&g<=c)||(f<=b&&g>=c)){k=true;}return j&&k;};L.prototype.condenseCardArray=function(a){this._sortCardsByCol(a);return a.reduce(function(c,b){if(c.indexOf(b)<0){c.push(b);}return c;},[]);};L.prototype.extractCurrentLayoutVariant=function(){var i=0;var c={};var v={};for(i=0;i<this.aCards.length;i++){c=this.aCards[i];v[c.id]={col:c.dashboardLayout.column,row:c.dashboardLayout.row,colSpan:c.dashboardLayout.colSpan,rowSpan:c.dashboardLayout.rowSpan,visible:c.dashboardLayout.visible};if(c.dashboardLayout.autoSpan){v[c.id].autoSpan=c.dashboardLayout.autoSpan;}}if(this.oCurrLayoutVar&&this.oCurrLayoutVar.__ovpDBLVarSource){v.__ovpDBLVarSource=this.oCurrLayoutVar.__ovpDBLVarSource;}v.__ovpDBLVarId="C"+this.iColCount;return v;};L.prototype._updateCurrentLayoutVariant=function(){this.oCurrLayoutVar=this.extractCurrentLayoutVariant();this.oLayoutVars["C"+this.iColCount]=this.oCurrLayoutVar;};L.prototype._getCurrentLayoutVariant=function(){return this.oCurrLayoutVar;};L.prototype._registerChange=function(a){this.bLayoutChanged=true;this.oCurrLayoutVar.__ovpDBLVarSource="user";this.oUndoBuffer.action=a;this.oUndoBuffer.layoutVariant=this.extractCurrentLayoutVariant();};L.prototype._extractGrid=function(s){var f=s;var a="";if(f==="col"){a="row";}else if(f==="row"){a="col";}else{jQuery.sap.log.error("DashboardLayoutModel._getCurrentLayoutVariant: param sortBy has to be col or row!");}var c=[];var i=0;var r=0;var b=0;for(i=0;i<this.aCards.length;i++){var d=this.aCards[i].dashboardLayout;if(d.visible===false){continue;}for(r=d.row;r<d.row+d.rowSpan;r++){for(b=d.column;b<d.column+d.colSpan;b++){c.push({col:b,row:r,card:this.aCards[i]});}}}c.sort(function(e,g){if(e[f]===g[f]){if(e[a]<g[a]){return-1;}else if(e[a]>g[a]){return 1;}}else{return e[f]-g[f];}});return c;};L.prototype.validateGrid=function(r){var g=true;var i=0;var c=this._extractGrid("row");var p=c[0];var a={};var d=[];for(i=1;i<c.length;i++){a=c[i];if(a.col>this.iColCount||a.col<0){g=false;d.push(a.card);jQuery.sap.log.warning("DashboardLayout: Cell is outside (col/row): "+a.col+"/"+a.row);}if(a.col===p.col&&a.row===p.row){g=false;d.push(a.card);jQuery.sap.log.warning("DashboardLayout: Cell has two tenants (col/row//id1/id2: "+a.col+"/"+a.row+"//"+p.card.id+"/"+a.card.id);}p=a;}if(r&&d.length>0){d=this.condenseCardArray(d);for(i=0;i<d.length;i++){this._displaceCardToEnd(d[i]);}this._removeSpaceBeforeCard();g=true;jQuery.sap.log.info("DashboardLayout: invalid grid repaired");}return g;};return L;},true);
