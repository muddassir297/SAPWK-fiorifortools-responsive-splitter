/*!
* SAP APF Analysis Path Framework
*
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.require("sap.apf.ui.utils.constants");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require('sap.apf.modeler.ui.utils.representationTypesHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.stepPropertyMetadataHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.representationHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.representationBasicDataHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.sortDataHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.nullObjectChecker');jQuery.sap.require('sap.apf.modeler.ui.utils.optionsValueModelBuilder');(function(){'use strict';var p,c,C,r,P,R,s,o,a,S;var n=new sap.apf.modeler.ui.utils.NullObjectChecker();var b=new sap.apf.modeler.ui.utils.OptionsValueModelBuilder();var l=sap.apf.core.constants.representationMetadata.labelDisplayOptions;function _(B){B.byId("idVisualization").setText(c.getText("visualization"));B.byId("idChartTypeLabel").setText(c.getText("chartType"));B.byId("idChartTypeLabel").setTooltip(c.getText("chartType"));B.byId("idBasicData").setText(c.getText("basicData"));B.byId("idSorting").setText(c.getText("sorting"));}function d(B,D){var E;var I=R.getPictureOfRepresentationType(r.getRepresentationType());var F=C.getCategoriesForStep(P.getId());if(F.length===1){E={id:r.getId(),icon:I};if(D){E.name=D;}B.getView().getViewData().updateSelectedNode(E);}else{B.getView().getViewData().updateTree();}}function e(B,D){var T=c.getText("representation")+": "+D;B.getView().getViewData().updateTitleAndBreadCrumb(T);}function f(B){r.setRepresentationType(B);var D="TableRepresentation";if(B===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION||B===sap.apf.ui.utils.CONSTANTS.representationTypes.TREE_TABLE_REPRESENTATION){D=undefined;}r.setAlternateRepresentationType(D);}function g(B){var I;var D=jQuery.Deferred();s.getEntityTypeMetadataAsPromise().done(function(E){var F=s.getDimensionsProperties(E);var G=R.getKindsForDimensionPropertyType(B);G.forEach(function(K,H){I=false;var J;var L;var M=F[H];if(r.getDimensions().length!==0){if(r.getDimensions()[H]){if(r.getDimensionKind(r.getDimensions()[H])){I=true;}}}if(!I&&M){J=s.hasTextPropertyOfDimension(E,M);L=J?l.KEY_AND_TEXT:l.KEY;r.addDimension(M);r.setLabelDisplayOption(M,L);r.setDimensionKind(M,G[0]);}});D.resolve();});return D.promise();}function h(B){var D=jQuery.Deferred(),E,I;var F;s.getEntityTypeMetadataAsPromise().done(function(G){F=R.getKindsForMeasurePropertyType(B);E=s.getMeasures(G);F.forEach(function(K,H){I=false;var J=E[H];if(r.getMeasures().length!==0){if(r.getMeasures()[H]){if(r.getMeasureKind(r.getMeasures()[H])){I=true;}}}if(!I&&J){r.addMeasure(J);r.setMeasureKind(J,K);}});D.resolve();});return D.promise();}function i(B){var D=jQuery.Deferred();var E,F;if(B==="TableRepresentation"){if(r.getProperties().length===0){F=R.getKindsForPropertyType(B);E=s.getProperties()[0];r.addProperty(E);r.setPropertyKind(E,F[0]);D.resolve();}else{D.resolve();}}else if(B==="TreeTableRepresentation"){D.resolve();}else{g(B).done(function(){h(B).done(function(){D.resolve();});});}return D.promise();}function j(B){var V=[],M;V=s.getRepresentationTypesArray();M=b.prepareModel(V);B.byId("idChartType").setModel(M);B.byId("idChartType").setSelectedKey(r.getRepresentationType());}function k(){if(p&&p.arguments&&p.arguments.stepId){P=C.getStep(p.arguments.stepId);}}function m(){var D=c.getRepresentationTypes()[0].id;if(P.getType()==="hierarchicalStep"){D="TreeTableRepresentation";}return D;}function q(B){var D;var E=jQuery.Deferred();if(p&&p.arguments&&p.arguments.representationId){r=P.getRepresentation(p.arguments.representationId);}if(!n.checkIsNotUndefined(r)){r=P.createRepresentation();D=m();f(D);d(B,c.getText(D));C.setIsUnsaved();i(D).done(function(){return E.resolve();});}else{D=r.getRepresentationType();z().done(function(){i(D).done(function(){return E.resolve();});});}return E.promise();}function t(B){var D=new sap.m.Button({id:B.createId("idPreviewButton"),text:c.getText("preview"),press:B.handlePreviewButtonPress.bind(B)});var F=B.getView().getViewData().oFooter;F.addContentRight(D);}function u(B){var T=B.getView().getViewData().oConfigurationHandler.getTextPool();var V={oTextReader:c.getText,oConfigurationEditor:C,oTextPool:T,oParentObject:r,oParentStep:P,oRepresentationTypeHandler:R};var D=new sap.ui.controller("sap.apf.modeler.ui.controller.representationCornerTexts");var E=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.cornerTexts",type:sap.ui.core.mvc.ViewType.XML,id:B.createId("representationCornerTexts"),viewData:V,controller:D});B.byId("idCornerTextsVBox").insertItem(E);B.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON,E.getController().setChartIcon.bind(E.getController()));}function v(){r.getDimensions().forEach(function(D){r.removeDimension(D);});r.getMeasures().forEach(function(M){r.removeMeasure(M);});}function w(){var D,M;if(r.getRepresentationType()==="TableRepresentation"){D=r.getDimensions();M=r.getMeasures();D.forEach(function(B){r.addProperty(B);r.setPropertyTextLabelKey(B,r.getDimensionTextLabelKey(B));r.setPropertyKind(B,sap.apf.core.constants.representationMetadata.kind.COLUMN);C.setIsUnsaved();});M.forEach(function(B){r.addProperty(B);r.setPropertyTextLabelKey(B,r.getMeasureTextLabelKey(B));r.setPropertyKind(B,sap.apf.core.constants.representationMetadata.kind.COLUMN);C.setIsUnsaved();});v();}}function x(D){var B;s.getEntityTypeMetadataAsPromise().done(function(E){B=s.hasTextPropertyOfDimension(E,D);if(B){r.setLabelDisplayOption(D,l.KEY_AND_TEXT);}else{r.setLabelDisplayOption(D,l.KEY);}C.setIsUnsaved();});}function y(){var B=jQuery.Deferred();s.getEntityTypeMetadataAsPromise().done(function(E){r.getDimensions().forEach(function(D){if(r.getLabelDisplayOption(D)===undefined){x(D);}});B.resolve();});return B.promise();}function z(){w();return y();}function A(B){a.instantiateBasicData();S.instantiateRepresentationSortData();u(B);}sap.ui.controller("sap.apf.modeler.ui.controller.representation",{onInit:function(){var B=this;var V=B.getView().getViewData();c=V.oCoreApi;p=V.oParams;C=V.oConfigurationEditor;R=new sap.apf.modeler.ui.utils.RepresentationTypesHandler(c.getRepresentationTypes());_(B);k();s=new sap.apf.modeler.ui.utils.StepPropertyMetadataHandler(c,P);q(B).done(function(){o=new sap.apf.modeler.ui.utils.RepresentationHandler(r,R,c.getText);a=new sap.apf.modeler.ui.utils.RepresentationBasicDataHandler(B.getView(),s,o);S=new sap.apf.modeler.ui.utils.SortDataHandler(B.getView(),r,s,c.getText);A(B);B.setDetailData();});},setDetailData:function(){var B=this;j(B);if(P.getType()!=="hierarchicalStep"){t(B);}},handleChangeForChartType:function(E){var B=this;var N=E.getParameter("selectedItem").getKey();var D=c.getText(N);var O=r.getRepresentationType();f(N);d(B,D);e(B,D);if(!R.isChartTypeSimilar(O,N)){B.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.REMOVEALLPROPERTIESFROMPARENTOBJECT);v();i(N).done(function(){a.instantiateBasicData();B.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON);C.setIsUnsaved();});}else{a.instantiateBasicData();B.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON);C.setIsUnsaved();}},handlePreviewButtonPress:function(){var B=this;var D={oParentStep:P,oRepresentation:r,oConfigurationHandler:B.getView().getViewData().oConfigurationHandler,oCoreApi:c,oRepresentationHandler:o,oStepPropertyMetadataHandler:s,oRepresentationTypeHandler:R};sap.ui.view({id:B.createId("idPreviewContentView"),viewName:"sap.apf.modeler.ui.view.previewContent",type:sap.ui.core.mvc.ViewType.XML,viewData:D});},onExit:function(){var B=this;B.getView().getViewData().oFooter.removeContentRight(B.byId("idPreviewButton"));a.destroyBasicData();S.destroySortData();B.byId("idCornerTextsVBox").destroyItems();}});}());
