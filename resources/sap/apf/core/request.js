/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare('sap.apf.core.request');jQuery.sap.require('sap.apf.utils.utils');jQuery.sap.require('sap.apf.core.utils.filter');jQuery.sap.require('sap.apf.core.utils.filterTerm');jQuery.sap.require("sap.apf.core.utils.filterSimplify");(function(){'use strict';sap.apf.core.Request=function(I,c){var m=I.instances.messageHandler;var C=I.instances.coreApi;var s=c.service;var a=c.selectProperties;var u=C.getUriGenerator();var M;if(s===undefined){M=m.createMessageObject({code:'5015',aParameters:[c.id]});m.putMessage(M);}var b=C.getMetadata(s);this.type=c.type;this.sendGetInBatch=function(f,d,r,S){b.done(function(o){var U=o.getUriComponents(c.entityType);var e,g;if(U){e=U.entitySet;g=U.navigationProperty;}m.check(e!==undefined,'Invalid request configuration: An entityset does not exist under the service '+c.entityType);m.check(g!==undefined,'Invalid request configuration: A usable navigation does not exist for the service '+c.entityType);var F;var h;w(f);if(f&&f.getProperties){F=f.restrictToProperties(o.getFilterableProperties(e));if(C.getStartParameterFacade().isFilterReductionActive()){h=new sap.apf.core.utils.FilterReduction();F=h.filterReduction(m,F);}}v(r);var p=r&&r.paging;var j=r&&r.orderby;var k=u.buildUri(m,e,a,F,f,j,p,undefined,t,g,o);var l=[{requestUri:k,method:'GET',headers:{'Accept-Language':sap.ui.getCore().getConfiguration().getLanguage(),'x-csrf-token':C.getXsrfToken(s)}}];q();var R={method:'POST',headers:{'x-csrf-token':C.getXsrfToken(s)},requestUri:u.getAbsolutePath(s)+'$batch',serviceMetadata:o.getODataModel().getServiceMetadata(),data:{__batchRequests:l}};var n=function(i,x){var y={};C.getEntityTypeMetadata(c.service,c.entityType).done(function(z){var A='';if(i&&i.__batchResponses&&i.__batchResponses[0].data){y.data=i.__batchResponses[0].data.results;y.metadata=z;if(i.__batchResponses[0].data.__count){y.count=parseInt(i.__batchResponses[0].data.__count,10);}if(i.__batchResponses[1]&&i.__batchResponses[1].data){y.selectionValidation=i.__batchResponses[1].data.results;}}else if(i&&i.__batchResponses[0]&&i.__batchResponses[0].response&&i.__batchResponses[0].message){A=x.requestUri;var B=i.__batchResponses[0].message;var D=i.__batchResponses[0].response.body;var G=sap.apf.utils.extractOdataErrorResponse(D);var H=i.__batchResponses[0].response.statusCode;y=m.createMessageObject({code:'5001',aParameters:[H,B,G,A]});m.putMessage(y);}else{A=x.requestUri||k;y=m.createMessageObject({code:'5001',aParameters:['unknown','unknown error','unknown error',A]});m.putMessage(y);}d(y,false);});};var E=function(i){var x='unknown error';var y;var z='unknown error';var A=k;if(i.message!==undefined){x=i.message;}var H='unknown';if(i.response&&i.response.statusCode){H=i.response.statusCode;z=i.response.statusText||'';A=i.response.requestUri||k;}if(i.messageObject&&i.messageObject.type==='messageObject'){m.putMessage(i.messageObject);d(i.messageObject);}else{y=m.createMessageObject({code:'5001',aParameters:[H,x,z,A]});m.putMessage(y);d(y);}};C.odataRequest(R,n,E,OData.batchHandler);function q(){if(S&&S.requiredFilterProperties&&S.selectionFilter){var i=F.copy();i.addAnd(S.selectionFilter);if(C.getStartParameterFacade().isFilterReductionActive()){i=h.filterReduction(m,i);}var x=u.buildUri(m,e,S.requiredFilterProperties,i,f,undefined,undefined,undefined,t,g,o);l.push({requestUri:x,method:'GET',headers:{'Accept-Language':sap.ui.getCore().getConfiguration().getLanguage(),'x-csrf-token':C.getXsrfToken(s)}});}}function t(P,i){var x="'";var y=o.getPropertyMetadata(e,P);if(y&&y.dataType){return sap.apf.utils.formatValue(i,y.dataType.type);}if(typeof i==='number'){return i;}return x+sap.apf.utils.escapeOdata(i)+x;}function v(r){var P,i;if(!r){return;}P=Object.getOwnPropertyNames(r);for(i=0;i<P.length;i++){if(P[i]!=='orderby'&&P[i]!=='paging'){m.putMessage(m.createMessageObject({code:'5032',aParameters:[e,P[i]]}));}}}function w(f){var i=o.getFilterableProperties(e);var x='';var y=o.getEntityTypeAnnotations(e);var z;if(y.requiresFilter!==undefined&&y.requiresFilter==='true'){if(y.requiredProperties!==undefined){x=y.requiredProperties;}}if(x===''){return;}if(jQuery.inArray(x,i)===-1){z=m.createMessageObject({code:'5006',aParameters:[e,x]});m.putMessage(z);}var P=f.getProperties();if(jQuery.inArray(x,P)===-1){z=m.createMessageObject({code:'5005',aParameters:[e,x]});m.putMessage(z);}}});};};}());
