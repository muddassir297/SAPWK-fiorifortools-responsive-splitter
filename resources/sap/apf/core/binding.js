/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.binding");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require("sap.apf.core.utils.filter");jQuery.sap.require("sap.apf.core.utils.filterTerm");(function(){'use strict';sap.apf.core.Binding=function(I,b,f,r){var t=this;this.type="binding";var n=0;var R=[];var a=[];var c=[];var C;var s;this.oTitle=b.oTitle;this.oLongTitle=b.oLongTitle;var d=b.requiredFilters;this.destroy=function(){R.forEach(function(o){if(o&&o.destroy){o.destroy();}});R=[];a=[];c=[];C=undefined;s=undefined;};function e(F,o){if(I.exits&&I.exits.binding&&I.exits.binding.afterGetFilter){return I.exits.binding.afterGetFilter(F,t.getSelectedRepresentation(),I.instances.coreApi,b,o);}return F;}this.getFilter=function(o){var S=this.getSelectedRepresentation();var m=sap.apf.core.constants.filterMethodTypes;var i=[];var j;if(S.getFilterMethodType()===m.filter){var F=S.getFilter().getInternalFilter();if(s){return e(s.getInternalFilter().overwriteWith(F),o);}return e(F,o);}if(S.getSelectionAsArray){i=S.getSelectionAsArray();}else{return e(new sap.apf.core.utils.Filter(I.instances.messageHandler),o);}if(i===undefined){j=sap.apf.core.utils.Filter.createEmptyFilter(I.instances.messageHandler,d);return e(j,o);}if(i.length===c.length||i.length===0){return e(new sap.apf.core.utils.Filter(I.instances.messageHandler),o);}j=sap.apf.core.utils.Filter.createFromArray(I.instances.messageHandler,d,c,i);return e(j,o);};this.getRequestOptions=function(i){if(jQuery.isFunction(this.getSelectedRepresentation().getRequestOptions)){return this.getSelectedRepresentation().getRequestOptions(i);}return{};};function g(o){return o.getFilterMethodType()===sap.apf.core.constants.filterMethodTypes.startFilter;}this.setFilter=function(F){var o=this.getSelectedRepresentation();s=F;if(g(o)){o.setFilter(s);}};this.setData=function(D){I.instances.messageHandler.check(D!==undefined,"aDataResponse is undefined (binding function setData)");c=D.data;C=D.metadata;this.getSelectedRepresentation().setData(D.data,D.metadata,D.count,D.selectionValidation);};this.updateTreetable=function(i,m,j,k){this.getSelectedRepresentation().updateTreetable(i,m,j,k);};this.getRepresentationInfo=function(){var j=jQuery.extend(true,[],a);for(var i=0;i<j.length;i++){delete j[i].id;delete j[i].type;delete j[i].constructor;}return j;};this.getSelectedRepresentationInfo=function(){I.instances.messageHandler.check(n>=0&&n<a.length,"index in array boundaries");var o=jQuery.extend(true,{},a[n]);delete o.id;delete o.type;delete o.constructor;return o;};this.getSelectedRepresentation=function(){I.instances.messageHandler.check(n>=0&&n<R.length,"selectedRepresentation in array boundaries");return R[n];};this.setSelectedRepresentation=function(r){I.instances.messageHandler.check(typeof r==="string","setSelectedRepresentation() - sRepresentationId missing");var t=this;var o=this.getSelectedRepresentation();var S=j(r,b.representations);var N=k(S);n=S.index;if(c!==undefined&&C!==undefined){N.setData(c,C);}if(N.adoptSelection){N.adoptSelection(o);}function j(r,l){for(var i=0;i<l.length;i++){if(r===l[i].id){return{config:l[i],constructor:f.getConfigurationById(l[i].representationTypeId).constructor,index:i};}}I.instances.messageHandler.check(false,"Representation config not found");}function k(i){var l;if(R[i.index]===undefined){if(i.config.parameter&&i.config.parameter.alternateRepresentationTypeId){i.config.parameter.alternateRepresentationType=f.getConfigurationById(i.config.parameter.alternateRepresentationTypeId);}i.config.parameter.requiredFilters=b.requiredFilters;l=t.convertSortToOrderBy(i.config.parameter);R[i.index]=I.instances.coreApi.createRepresentation(i.constructor,l);return R[i.index];}return R[i.index];}};this.serialize=function(){return{selectedRepresentation:t.getSelectedRepresentation().serialize(),selectedRepresentationId:t.getSelectedRepresentationInfo().representationId};};this.deserialize=function(S){t.setSelectedRepresentation(S.selectedRepresentationId);t.getSelectedRepresentation().deserialize(S.selectedRepresentation);return t;};this.convertSortToOrderBy=function(p){var i;if(p.sort&&!p.orderby){i=jQuery.extend(true,{},p);if(p.alternateRepresentationType){i.alternateRepresentationType=p.alternateRepresentationType;}i.orderby=[{property:p.sort.sortField,ascending:!p.sort.descending}];delete i.sort;return i;}i=p;return i;};R[0]=undefined;var h=false;b.representations.forEach(function(i,j){var k=i.representationTypeId;a[j]=jQuery.extend(true,{},f.getConfigurationById(k));a[j].representationId=i.id;if(r===a[j].representationId){h=true;}a[j].representationLabel=i.label;a[j].thumbnail=i.thumbnail;a[j].parameter=jQuery.extend(true,{},i.parameter);});if(h){this.setSelectedRepresentation(r);}else if(a.length>0){this.setSelectedRepresentation(a[0].representationId);}if(!h&&r){I.instances.messageHandler.putMessage(I.instances.messageHandler.createMessageObject({code:'5037',aParameters:[r]}));}};}());
