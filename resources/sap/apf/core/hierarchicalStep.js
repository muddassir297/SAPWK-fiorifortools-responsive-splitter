/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.hierarchicalStep");jQuery.sap.require("sap.apf.core.step");jQuery.sap.require("sap.apf.core.utils.uriGenerator");jQuery.sap.require("sap.ui.model.odata.v2.ODataModel");(function(){'use strict';sap.apf.core.HierarchicalStep=function(m,s,f,r,c){sap.apf.core.Step.call(this,m,s,f,r);var a;var b;this.type="hierarchicalStep";var d=f.getConfigurationById(s.request).service;var e=f.getConfigurationById(s.request).entityType;var g=c.getAnnotationsForService(d);var h=s.hierarchyProperty;var i=jQuery.Deferred();jQuery.when(c.getMetadata(d),c.getEntityTypeMetadata(d,e)).then(function(k,l){var n=k.getHierarchyAnnotationsForProperty(e,h);if(n.type==="messageObject"){m.putMessage(n);}else{a=j(h,n);}i.resolve(k,n,l);});var M=new sap.ui.model.odata.v2.ODataModel(d,{annotationURI:g});function j(h,k){var l=[h];for(var n in k){l.push(k[n]);}l=l.concat(f.getConfigurationById(s.request).selectProperties);return sap.apf.core.utils.uriGenerator.getSelectString(l);}this.update=function(k,l){i.done(function(n,o,p){var q=k.restrictToProperties(n.getFilterableProperties(e));var F=!q.isEqual(b);if(!F){l({},true);return;}var t="/"+sap.apf.core.utils.uriGenerator.generateOdataPath(m,n,e,k,n.getUriComponents(e).navigationProperty);var u={};u.path=t;if(!q.isEmpty()){u.filters=[q.mapToSapUI5FilterExpression()];}u.parameters={select:a,operationMode:sap.ui.model.odata.OperationMode.Server,useServerSideApplicationFilters:true,treeAnnotationProperties:o};this.getBinding().updateTreetable(u,M,l,p);}.bind(this));};this.setData=function(k,l){b=l.copy();};};})();
