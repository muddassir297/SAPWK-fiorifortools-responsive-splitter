/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.path");(function(){'use strict';sap.apf.core.Path=function(I){this.type="path";var m=I.instances.messageHandler;var c=I.instances.coreApi;var s=[];var a=[];var n=0;this.destroy=function(){a=[];s.forEach(function(i){i.destroy();});s=[];};this.getSteps=function(){return jQuery.extend(true,[],s);};this.addStep=function(S,i){s.push(S);this.update(i);};this.makeStepActive=function(S){var i=this.stepIsInPath(S);m.check(i,"An unknown step can't be an active step.",sap.apf.core.constants.message.code.errorCheckWarning);if(i){if(this.stepIsActive(S)===false){a.push(S);}}};this.makeStepInactive=function(S){var i=this.stepIsActive(S);m.check(i,"Only an active step can be removed from the active steps.",sap.apf.core.constants.message.code.errorCheckWarning);if(i){var j=jQuery.inArray(S,a);a.splice(j,1);}};this.stepIsActive=function(S){var i=jQuery.inArray(S,a);if(i>=0){return true;}return false;};this.stepIsInPath=function(S){var i=jQuery.inArray(S,s);if(i>=0){return true;}return false;};this.getActiveSteps=function(){return jQuery.extend(true,[],a);};this.getCumulativeFilterUpToActiveStep=function(){var j=jQuery.Deferred();f().done(function(C){var o=C.copy();var i,l=s.length;for(i=0;i<l;i++){o=o.addAnd(s[i].getFilter());if(this.stepIsActive(s[i])){j.resolve(o);return;}}j.resolve(o);}.bind(this));return j.promise();};this.moveStepToPosition=function(S,i,j){var k=jQuery.inArray(S,s);var t=i;m.check(typeof i==="number"&&i>=0&&i<s.length,"Path: moveStepToPosition invalid argument for nPosition");m.check(k>=0&&k<s.length,"Path: moveStepToPosition invalid step");if(k===i){return;}s.splice(k,1);s.splice(t,0,S);this.update(j);};this.removeStep=function(S,i){var j=this.stepIsInPath(S);var k=this.stepIsActive(S);var l=jQuery.inArray(S,s);m.check(j,"Path: remove step - invalid step");s.splice(l,1);if(k){this.makeStepInactive(S);}this.update(i);S.destroy();};this.update=function(S){if(!s[0]){return;}var i;var C=s[0];f().done(function(o){n++;i=n;C.update(o,j);function j(r,l){var p=jQuery.inArray(C,s);var M;if(i===n){if(r instanceof Error){var q=p+1;M=m.createMessageObject({code:"5002",aParameters:[q],callingObject:C});M.setPrevious(r);m.putMessage(M);C.setData({data:[],metadata:undefined},o);S(C,true);p++;C=s[p];while(C){C.setData({data:[],metadata:undefined},o);S(C,true);p++;C=s[p];}return;}if(!l){C.setData(r,o);}S(C,!l);if(i!==n){return;}C.determineFilter(o.copy(),k);}}function k(F){o=h(o,F,C.getContextInfo());var l=jQuery.inArray(C,s);o.addAnd(F);C=s[l+1];if(C){C.update(o,j);}else{c.storeApfState();o=undefined;}}});};this.serialize=function(){return{path:{steps:b(),indicesOfActiveSteps:g()}};};this.deserialize=function(S){d(S.path.steps,this);e(S.path.indicesOfActiveSteps,this);};function g(){var k=[];for(var i=0;i<s.length;i++){for(var j=0;j<a.length;j++){if(s[i]===a[j]){k.push(i);}}}return k;}function b(){var S=[];for(var i=0;i<s.length;i++){S.push(s[i].serialize());}return S;}function d(S,p){var o=p.update;p.update=function(){};var i=0;for(i=0;i<S.length;i++){c.createStep(S[i].stepId);}for(i=0;i<s.length;i++){s[i].deserialize(S[i]);}p.update=o;}function e(j,C){for(var i=0;i<j.length;i++){var k=j[i];C.makeStepActive(s[k]);}}function f(){var i=jQuery.Deferred();jQuery.when(c.getCumulativeFilter(),c.getSmartFilterBarAsPromise()).done(function(j,k){var l;var r=j.copy();if(k){l=k.getFilters();l.forEach(function(o){r.addAnd(sap.apf.core.utils.Filter.transformUI5FilterToInternal(m,o));});}i.resolve(r);});return i;}function h(i,j,S){if(I.exits&&I.exits.path&&I.exits.path.beforeAddingToCumulatedFilter){return I.exits.path.beforeAddingToCumulatedFilter(i,j,S);}return i;}};}());
