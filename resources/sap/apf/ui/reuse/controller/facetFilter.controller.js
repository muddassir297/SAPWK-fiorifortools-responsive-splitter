/*!
* SAP APF Analysis Path Framework
* 
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.require('sap.apf.ui.utils.facetFilterListHandler');jQuery.sap.require('sap.apf.ui.utils.facetFilterListConverter');jQuery.sap.require('sap.apf.ui.utils.facetFilterValueFormatter');(function(){'use strict';var c={};var f={};var s;var F=new sap.apf.ui.utils.FacetFilterListConverter();function _(o,G){var i=o.getModel();var j=new sap.apf.ui.utils.FacetFilterValueFormatter();G.oFormatterArgs.aFilterValues=G.aFilterValues;var k=j.getFormattedFFData(G.oFormatterArgs);var m=F.getFFListDataFromFilterValues(k,G.oFormatterArgs.sSelectProperty);G.oFilterRestrictionPropagationPromiseForValues.done(function(n,N){_(o,{aFilterValues:n,oFilterRestrictionPropagationPromiseForValues:N,oFormatterArgs:G.oFormatterArgs});});i.setSizeLimit(m.length);i.setData(m);i.updateBindings();}function a(o){var C=this;C.getView().byId("idAPFFacetFilter").removeList(o);}function b(i,o){var j;i.forEach(function(k){k.selected=false;});o.forEach(function(k){for(j=0;j<i.length;j++){if(k==i[j].key){i[j].selected=true;break;}}});return i;}function d(o,C,G){var i=o.getId();var j=o.getModel();var k=j.getData();G.oFilterRestrictionPropagationPromiseForSelectedValues.done(function(n,N){o.removeSelectedKeys();d(o,C,{aSelectedFilterValues:n,oFilterRestrictionPropagationPromiseForSelectedValues:N});});c[i]=G.aSelectedFilterValues;k=b(k,G.aSelectedFilterValues);j.setData(k);j.updateBindings();}function e(C){var D=jQuery.Deferred();var n=0;var l=C.getView().byId("idAPFFacetFilter").getLists().length;g(C);C.getView().byId("idAPFFacetFilter").getLists().forEach(function(o){(f[o.getId()].getFacetFilterListData().then(_.bind(null,o),a.bind(C,o))).then(function(){f[o.getId()].getSelectedFFValues().then(function(G){d(o,C,G);n++;if(n===l){D.resolve();}});});});return D.promise();}function g(C){C.getView().byId("idAPFFacetFilter").removeAllLists();var v=C.getView().getViewData();var i=v.aConfiguredFilters;var o;i.forEach(function(j){o=new sap.m.FacetFilterList({title:v.oCoreApi.getTextNotHtmlEncoded(j.getLabel()),multiSelect:j.isMultiSelection(),key:j.getPropertyName(),growing:false,listClose:C.onListClose.bind(C)});o.bindItems("/",new sap.m.FacetFilterItem({key:'{key}',text:'{text}',selected:'{selected}'}));var m=new sap.ui.model.json.JSONModel([]);o.setModel(m);C.getView().byId("idAPFFacetFilter").addList(o);});h(C);}function h(C){var v=C.getView().getViewData();var i;f={};v.aConfiguredFilters.forEach(function(o,n){i=C.getView().byId("idAPFFacetFilter").getLists()[n].getId();f[i]=new sap.apf.ui.utils.FacetFilterListHandler(v.oCoreApi,v.oUiApi,o,F);});}sap.ui.controller("sap.apf.ui.reuse.controller.facetFilter",{onInit:function(){var C=this;if(sap.ui.Device.system.desktop){C.getView().addStyleClass("sapUiSizeCompact");}s=false;e(C);},onListClose:function(E){var C=this;var o=E.getSource();var S=[],i,j,k,l,m,n;i=o.getSelectedItems();S=i.map(function(I){return I.getKey();});j=o.getId();k=c[j];if(k!==undefined){l=JSON.stringify(S.sort());m=JSON.stringify(k.sort());n=(l===m);if(!n){c[j]=S;s=true;f[j].setSelectedFFValues(S);if(C.getView().getViewData().aConfiguredFilters.length>C.getView().byId("idAPFFacetFilter").getLists().length){e(C).done(function(){C.getView().getViewData().oUiApi.selectionChanged(true);});}else{C.getView().getViewData().oUiApi.selectionChanged(true);}}}},onResetPress:function(){var C=this;if(s||C.getView().getViewData().oCoreApi.isDirty()){C.getView().getViewData().oStartFilterHandler.resetVisibleStartFilters();C.getView().getViewData().oUiApi.selectionChanged(true);s=false;}}});}());
